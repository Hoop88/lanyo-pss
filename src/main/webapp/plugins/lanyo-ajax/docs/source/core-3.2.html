<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />    
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">﻿<div id="cls-Lanyo_Ajax"></div>/**
 * @class Lanyo_Ajax
 * 
 * 蓝源RIA框架基本设置，可以用来配置一些平台的功能特性
 * 在项目中会根据实际应用情况使用apply等方法来定制。
 * <pre>
 * <code>
 *  //例子：
Ext.apply(Lanyo_Ajax,{
    permissionCheck:false,
    extVersion:'ext-3.2',
    script:'/demo-script',
    PersonalityUrl:"#",
    formatUrl:function(baseUrl,cmd){
        return  baseUrl+"?cmd="+cmd;
    }
});
 * </pre>
 * </code>
 * 
 * @singleton  
 */
Lanyo_Ajax={
	<div id="prop-Lanyo_Ajax-version"></div>/**
	 * 蓝源RIA平台的版本号
	 * @type String
	 */
    version:"1.0",
    <div id="prop-Lanyo_Ajax-title"></div>/**
     * 蓝源RIA平台的名称
     * @type String
     */
    title:"蓝源Ajax快速开发框架",
    <div id="prop-Lanyo_Ajax-permissionCheck"></div>/**
     * 蓝源RIA平台是否开启权限检查。如果开启了权限检查，在使用CrudPanel或者CrudListPanel的时候，会向后台请求权限的判断
     * @type Boolean
     */
    permissionCheck:true,
    <div id="prop-Lanyo_Ajax-permissionCheckAction"></div>/**
     * 如果开启了权限检查，这个参数用来指定请求权限判断的后台地址
     * @type String
     */
    permissionCheckAction:"permissionCheck.ejf",
    <div id="prop-Lanyo_Ajax-extVersion"></div>/**
     * 指定RIA平台使用的EXTJS的代码版本。可选值目前有'ext-2.2'和'ext-3.2'
     * @type String
     */
    extVersion:'ext-3.2',
    <div id="prop-Lanyo_Ajax-script"></div>/**
     * <p>
     * 指定RIA平台延迟加载js的请求地址。如果是使用后台加载的话，该参数指定后台返回JS的地址，如果是前台加载js，则可以直接指定为js的地址
     * 例如：如果项目所有的js都放在/demo-script下
     * 那么这里就指定为script:'/demo-script',
     * </p>
     * @type String
     */
    script:'extApp.ejf?cmd=loadScript&script=',
    <div id="prop-Lanyo_Ajax-PersonalityUrl"></div>/**
     * RIA平台集成了个性化定制（包括皮肤，前台portal等）的前后台集成，如果要使用该个性化功能，该参数指定了个性化请求和保存地址
     * @type String
     */
    PersonalityUrl:"manage.ejf",
    <div id="prop-Lanyo_Ajax-formatUrl"></div>/**
     * RIA平台针对CRUD集成到CrudPanel和CrudListPanel中和后台请求关联的URL样式。
     * for struts2的动态方法调用，使用：return baseUrl+"!"+cmd+".action"
     * 也可以定制自己的请求样式。参考Demo
     * @type String
     */
    formatUrl:function(baseUrl,cmd){
        return   baseUrl+"?cmd="+cmd;
    }
};

Ext.form.Field.prototype.msgTarget = 'side';
Ext.BLANK_IMAGE_URL =  String.format('/plugins/extjs/{0}/resources/images/default/s.gif',Lanyo_Ajax.extVersion);
Ext.chart.Chart.CHART_URL = String.format('/plugins/extjs/{0}/resources/charts.swf',Lanyo_Ajax.extVersion);
Ext.QuickTips.init();

<div id="prop-Lanyo_Ajax-namespace"></div>/**
 * lanyo框架,基本包
 */
Ext.namespace("EasyJF.Ext","Ejf.Ext","EasyJF.Ext.Msg");

<div id="cls-EasyJF.Ext.Msg"></div>/**
 * @class EasyJF.Ext.Msg
 * 
 * 对Ext.Msg的包装，加入了一些缺省的设置。
 */
Ext.apply(EasyJF.Ext.Msg,{
	<div id="method-EasyJF.Ext.Msg-alert"></div>/**
	 * <p>
	 * 对Ext.Msg.alert的包装，加入了一些缺省设置
	 * <li>title默认为'操作提示'</li>
	 * <li>type默认为Ext.Msg.INFO</li>
	 * <li>宽度默认为240</li>
	 * </p>
	 * 
	 * @param {Object/String} msg 提示的消息,如果是Object，则认为是自定义的设置对象
	 * @param {String} title 提示窗口的标题
	 * @param {String} fn callback方法
	 * @param {Object} scope callback方法执行的域
	 * @param {Object} type 提示的图片，为以下可选值：
		Ext.MessageBox.INFO
		Ext.MessageBox.WARNING
		Ext.MessageBox.QUESTION
		Ext.MessageBox.ERROR 
	 * 
	 */
    alert:function(msg,title,fn,scope,type){
        var obj = {
                title:title||'操作提示',
                msg:msg,
                scope:scope||window,
                fn:fn,
                icon : type||Ext.Msg.INFO,
                buttons:Ext.Msg.OK,width:240
            };
        if(typeof msg == 'object')
            Ext.apply(obj,msg);
        Ext.Msg.show(obj);
    },
    
    <div id="method-EasyJF.Ext.Msg-error"></div>/**
	 * <p>
	 * 扩展的一个专门用于RIA平台中错误提示的方法，扩展自EasyJF.Ext.Msg.alert方法
	 * <li>type默认为Ext.Msg.ERROR</li>
	 * </p>
	 * 
	 * @param {Object/String} msg 提示的消息,如果是Object，则认为是自定义的设置对象
	 * @param {String} title 提示窗口的标题
	 * @param {String} fn callback方法
	 * @param {Object} scope callback方法执行的域
	 */
    error:function(msg,title,fn,scope){
        var expargs = EasyJF.Ext.Msg.error.length;
        var args = Array.prototype.slice.call(arguments,0,expargs);
        if (expargs != args.length) {
            if (args.length < expargs) {
                var i = args.length;
                for (i; i < expargs; i++) {
                    args.push(null);
                }
                args.push(Ext.Msg.ERROR);
            }
        } else {
            args.push(Ext.Msg.ERROR);
        }
        EasyJF.Ext.Msg.alert.apply(this, args);
    }
});

<div id="cls-EasyJF.Ext.Window"></div>/**
 * @class EasyJF.Ext.Window
 * 
 * 显示单例模式的Window,可将自己的面板放入到EasyJF.Ext.Window中。
 * 
 * <pre>
 * <code>
 * //示例：
//创建需要在窗口中显示的panel
var myshowpanel=new MyShowPanel();
//调用工厂方法show来显示窗口
EasyJF.Ext.Window.show({
	single:false,
	width:400,
	height:160,
	scope:this,
	title:"确认信息",
	buttons:['yes','no'],
	items:myshowpanel,
	handler:function(btn,win,fp){
		if(btn=='yes'){
			//my customer handler
		}else{
			win.hide();
		}
	}
});
 * </code>
 * </pre>
 * @singleton  
 */
EasyJF.Ext.Window = function() {
    var components = new Ext.util.MixedCollection();
    components.on('add',function(length, o, key){
        if(length>50){
            components.removeAt(0);
        }
    },this)
    var all = new Ext.util.MixedCollection();
    var buttonText =  {
            ok : "確定",
            cancel : "重置",
            yes : "確定",
            no : "取消"
        };
    var buttonHandler = function(button,btn){
         var win = button.ownerCt.ownerCt;
         Ext.callback(win.handler,win.scope||win,[btn,win,win.getComponent(0)]);
         if(win.autoHide)win.hide();
    }
    return {
        defaultConfig : {
            maxWin:5,
            width : 500,
            height : 300,
            modal : true,
            layout : 'fit',
            single:true,
            constrain : true,
            buttonAlign:'center',
            closeAction : 'hide'
        },
        components:components,
        autoDestroyWin:function(win){
            if(this.all.getCount()>this.defaultConfig.maxWin){
                win.destroy();
                this.autoRemoveProperty.call(win);
                this.all.remove(win);
            }
        },
        autoRemoveProperty:function(){
            delete this.handler;
            delete this.scope;
            delete this.autoHide;
        },
        destroyComp:function(){
            var args = Array.prototype.slice.call(arguments,0);
            Ext.each(args,function(c){
                if(Ext.type(c.destroy)=='function'){
                    c.destroy();
                }
                components.remove(c);
            },this)
        },
        
        <div id="method-EasyJF.Ext.Window-show"></div>/**
         * 调用该方法来显示一个窗口。
         * @param {Object} config 配置显示窗口的对象，包括以下配置项：
         * <ul>
         * <li>single {Boolean} :
         * 		设置是否是单例显示，如果是true，在关闭窗口后会删除窗口中的panel。如果要多次使用该窗口显示同一个panel，single要设置为true。</li>
         * <li>width {Integer} :
         * 		设置窗口的宽度</li>
         * <li>height {Integer} :
         * 		设置窗口高度</li>
         * <li>scope {Object} :
         * 		方法中按钮响应方法的执行域</li>
         * <li>title {String} :
         * 		窗口的显示名称</li>
         * <li>buttons {Array} :
         * 		自定义窗口下显示的按钮，可选值有：'ok','cancel','yes','no'</li>
         * <li>items {Object} ：
         * 		窗口内要显示的面板panel</li>
         * <li>handler {Function} :
         * 		窗口下按钮的响应事件,其中传入的参数有：
         * 		<ul>
         * 			<li>btn :点击的btn代码</li>
         * 			<li>win :当前window</li>
         * 			<li>fp ：窗口中的panel</li>
         *		</ul>
         * </li>
         * <li>layout {String} :
         * 		窗口的布局，默认为fit</li>
         * <li>buttonAlign {String} :
         * 		窗口下按钮的对齐方式，默认为'center'</li>
         * <li>closeAction {String} :
         * 		窗口关闭事件，默认为'hide'</li>
         * </ul>
         */
        show : function(obj) {
            var config = Ext.apply({},obj,this.defaultConfig);
                var win = this.getFreeWin(config);
                win.on('beforehide',this.autoDestroyWin,this,{single:true});
                
                win.on('hide', function(win) {
                	if (config.single) {
                        win.remove(0, true);
                        components.remove(win.getComponent(0));
                        this.autoRemoveProperty.call(win);
                	}else{
                		var cmp = win.remove(0, false);
                		cmp.hide();
                		cmp.getEl().appendTo(Ext.getBody());
                	}
                }, this, {single : true});
                
                win.show();
                win.setTitle(config.title);
                win.setWidth(config.width);
                if(config.height=='auto'){
                    win.autoHeight = true;
                    win.syncSize.defer(1000,win);
                }else{
                    win.autoHeight = false;
                    win.setHeight(config.height);
                }
                win.center();
        },
        buildComponent:function(cmp,compId){
            if(components.get(compId)){
                    return components.get(compId);
            }else if(Ext.type(cmp)=='object'){
                var component = null;
                if(cmp.constructor.prototype.ctype == 'Ext.Component'){
                    component = cmp;    
                }else if(cmp.constructor==Object){
                    component = Ext.ComponentMgr.create(cmp,'panel');
                }else{
                    component = cmp;
                }
                if(compId){
                    components.add(compId,component);
                }
                return component;
            }
        },
        updateButtons:function(win,buttons){
            if(Ext.isArray(buttons) && buttons.length){
                    Ext.each(win.buttons,function(btn){
                        if(buttons.indexOf(btn.id)>=0){
                            btn.show();
                        }else{
                            btn.hide();
                        }
                    },win);
            }else{
                Ext.each(win.buttons,function(btn){btn.hide();},win);
            }
        },
        getFreeWin:function(config){
            var win = null;
            all.each(function(o){
                if(o.hidden){
                    win = o;
                    return false;
                }
            },this);
            var cmp = config.items;
            var buttons = config.buttons;
            var handler = config.handler;
            var scope = config.scope;
            var autoHide = config.autoHide;
            Ext.del(config,'buttons','items','handler','autoHide','scope');
            cmp=this.buildComponent(cmp,config.compId);
            var win = win || this.getWin(Ext.apply(config,{buttons:this.getButtons.call(this)}));
            
            win.autoHide=autoHide;
            win.handler=handler;
            win.scope=scope;
            
            this.updateButtons(win,buttons);
            if(win.items && win.items.getCount()>0)win.remove(0,false);
            if(cmp.hidden)cmp.show();
            win.add(cmp);
            return win;
        },
        all:all,
        getWin : function(config) {
            var win = new Ext.Window(Ext.apply(config, {manager : this.group}));
            all.add(win);
            return win;
        },
        YESNO:['yes','no'],
        YESNOCANCEL:['yes','cancel','no'],
        YES:['yes'],
        getButtons:(function(){
            return [
                    {text:buttonText['yes'],id:'yes',handler:buttonHandler.createDelegate(this,['yes'],1),scope:this},
                    {text:buttonText['cancel'],id:'cancel',handler:buttonHandler.createDelegate(this,['cancel'],1),scope:this},
                    {text:buttonText['no'],id:'no',handler:buttonHandler.createDelegate(this,['no'],1),scope:this}
                ]
        })
    }
}();

<div id="cls-Ext.form.LabelField"></div>/**
 * @class Ext.form.LabelField
 * @extends Ext.form.Field
 * 
 * 用于在FORM表单用div显示数据,类似于Ext的Label。但在使用方法上还是有一些区别。
 * <pre>
 * <code>
 *  //例子：
 *  {xtype:"labelfield",value:"标签名称" />
 * </pre>
 * </code>
 * 
 */
Ext.form.LabelField = Ext.extend(Ext.form.Field, {
	//private
    defaultAutoCreate: {tag: 'div'},
    <div id="cfg-Ext.form.LabelField-fieldClass"></div>/**
     * @cfg {String} fieldClass 默认的字css
     */
    fieldClass:"x-form-item-label",
    //对齐
    style:"padding-top:3px",
    onRender : function(ct, position){
      Ext.form.LabelField.superclass.onRender.call(this, ct, position);
      this.el.dom.name=this.initialConfig.name;
      this.el.dom.value='';
    },
    <div id="cfg-Ext.form.LabelField-renderer"></div>/**
     * 对value的显示进行渲染
     * @cfg {function} renderer 
     */
    <div id="method-Ext.form.LabelField-setValue"></div>/**
     * 设置LabelField的显示值 如果有renderer,则会先调用renderer,然后在显示
     * @param {Object} v
     */
    setValue : function(v){
       Ext.form.LabelField.superclass.setValue.call(this,v);  
       var t=v;    
       if(this.renderer)t=this.renderer(v);
       if(typeof t == window.undefined)t= '';
       this.el.update(t);
    },
    <div id="cfg-Ext.form.LabelField-markInvalid"></div>/**
     * @cfg function  markInvalid 覆盖父类Ext.emptyFn
     */
    markInvalid : Ext.emptyFn,
    <div id="cfg-Ext.form.LabelField-clearInvalid"></div>/**
     * @cfg function  clearInvalid 覆盖父类Ext.emptyFn
     */
    clearInvalid : Ext.emptyFn
});
Ext.reg('labelfield', Ext.form.LabelField);

<div id="cls-Ext.form.LabelFieldReadonly"></div>/**
 * @class Ext.form.LabelFieldReadonly
 * @extends Ext.form.LabelField
 * 
 * 只读的LabelField,Ext.form.LabelField中的getValue,是可以通过getValue来获取设置的值，而LabelFieldReadonly无法获得去值的!
 */
Ext.form.LabelFieldReadonly = Ext.extend(Ext.form.LabelField,{getValue:Ext.emptyFn});
Ext.reg('labelfieldreadonly', Ext.form.LabelField);


<div id="cls-Ext.form.SearchField"></div>/**
 * 通用查询控件
 * @class Ext.form.SearchField
 * @extends Ext.form.TwinTriggerField
 */
Ext.form.SearchField = Ext.extend(Ext.form.TwinTriggerField, {
    onSearch:function(){
    	this.hasSearch = true;
    },
    onClear:function(){
    	if(this.hasSearch){
    		this.hasSearch = false;
    		this.el.dom.value = '';
	    	this.triggers[0].hide();
	    	this.focus();
    	}
    },
    initComponent : function(){
        Ext.form.SearchField.superclass.initComponent.call(this);
        this.addEvents(
            'clear',
            'search'
        );
        this.on('specialkey', function(f, e){
            if(e.getKey() == e.ENTER && !(e.shiftKey||e.ctrlKey||e.altKey)){
                this.onSearch(this,this.getValue(),e);
            }
        }, this);
        this.on({
        	scope : this ,
        	clear : this.onClear,
        	search : this.onSearch
        });
    },
    validationEvent:false,
    validateOnBlur:false,
    hideTrigger1 : true,
    trigger1Class:'x-form-clear-trigger',
    trigger2Class:'x-form-search-trigger',
    width:180,
    hasSearch : false,
    paramName : 'query',
    onTrigger1Click : function(e){
        this.fireEvent("clear",this,this.getValue(),e);
    },
    onTrigger2Click : function(e){
       this.fireEvent("search",this,this.getValue(),e);
    }
});

<div id="cls-SearchField"></div>/**
 * 搜索框
 * @class SearchField
 * @extends Ext.form.TwinTriggerField
 */
EasyJF.Ext.SearchField = Ext.extend(Ext.form.SearchField, {
    validationEvent : false,
    validateOnBlur : false,
    emptyText : '内容关键字......',
    onClear : function() {
        if (this.hasSearch) {
        	EasyJF.Ext.SearchField.superclass.onClear.call(this);
            this.store.removeAll();
            this.store.load();
        }
    },
    onSearch : function() {
        var v = this.getRawValue();
        if (v.length < 1)return this.onTrigger1Click();
        this.store.removeAll();
        this.store.baseParams = {};
        this.store.baseParams[this.paramName] = v;
        var o = {start : 0,searchType:'simple'};
        this.store.reload({
            params : o,
            callback:function(rs){
                if(!rs || rs.length<1){
                    Ext.Msg.alert("提示","没有找到符合条件的记录！");
                }
            }
        });
        this.hasSearch = true;
        this.triggers[0].show();
        this.focus();
    },
    initComponent : function() {
        if (!this.store.baseParams) {
            this.store.baseParams = {};
        }
        EasyJF.Ext.SearchField.superclass.initComponent.call(this);
    }
});
Ext.reg("searchfield",EasyJF.Ext.SearchField);

<div id="cls-EasyJF.Ext.Util"></div>/**
 * @class EasyJF.Ext.Util
 * @single
 * EasyJF实用工具 
 */
EasyJF.Ext.Util={};
Ext.apply(EasyJF.Ext.Util,{
    NormalClass:{},
    theStatus : [["启用", 0],["停用", -1]],
    readOnlyGridCellColor:"#F2F2F2",
    successTag:"<font color=green>&#8730;</font>",
    failureTag:"<font color=red>X</font>",
    objectToString:function(){return this.id?this.id:this},
    recentYears:function(){
        var thisYear=new Date().getFullYear();
        var years=[];
        for(var i=thisYear-5,j=0;i<thisYear+5;i++,j++){
            years[j]=[i,i];
        }
        return years;
    }(),
    isNumber:function(oNum)     // 判断是否是数字
     {
      if(!oNum) return false;
      var strP=/^(-)?\d+(\.\d+)?$/;
      if(!strP.test(oNum)) return false;
      try{
      if(parseFloat(oNum)!=oNum) return false;
      }
      catch(ex)
      {
       return false;
      }
      return true;
     },
    theMonth:function(){
        var m=[];
        for(var i=1;i<=12;i++){
            m[i-1]=[i,i];
        }
    }(),
    linkRenderer : function(v) {
        if (!v)
            return "";
        else
            return String.format("<a style=\"color:blue;font-weight:800;\" title=\"点击后将在新窗口中打开{0}\" href='{0}' target='_blank'>{0}</a>", v);
    },
    booleanRender : function(value, p, record) {
       return value ? "<span style=\"color:green;\">是</span>" : "<span style=\"color:red;\">否</span>";
    },
    dateRender : function(format) {
        format = format || "Y-m-d G:i";
        return Ext.util.Format.dateRenderer(format);
    },
    imgRender : function(v){
        if(!v)
            return "";
        else
            return String.format("<a style=\"color:green;font-weight:800\" title=\"点击后将在新窗口中打开{0}\" href='{0}' target='_blank'>查看</a>",v)
    },
    moneyRender:function(v){
        if(v){
            if(v.toFixed){
            if(v<0)return "<font color=red>"+v.toFixed(2)+"<font>";
            else return v.toFixed(2);
            }
            else return v;
        }
    },
    userRender : function(user) {
        var name = user.name || "guest";
        return name;
    },
    objectRender : function(p,backgroundColor) {
        return function(v, meta) {
            if(backgroundColor)meta.attr = 'style="background-color:'+backgroundColor+';"';
            var s="";
            try{
                s=v?eval("v." + p) : ""
            }
            catch(e){                
            }
            return s;
        }
    },
    comboxRender:function(v){
        if(v){
            return v.text || v.title || v;  
        }
    },
    typesRender:function(types){
        return function(v){         
            for(var i=0;i<types.length;i++){
                try{
                    
                if(types[i][1]===v)return types[i][0];
                }
                catch(e){alert(types)}
            }
            return "";
        }
    },
    readOnlyRender:function(innerRender){
        return function(v, meta){
        var d=v;
        if(innerRender)d=innerRender(d);
        meta.attr = 'style="background-color:'+EasyJF.Ext.Util.readOnlyGridCellColor+';"';
        return d;
        }
    },
    operaterTemplate:new Ext.Template("<a href='{2}' theid='{2}' op='{1}' onclick='return false'><font color='blue'>{0}</font></a>"),
    operaterRender:function(cmd,title){
        return function(v,p,r){
            if(r.get("id"))
            return EasyJF.Ext.Util.operaterTemplate.applyTemplate([title?title:(v?v:""),cmd,r.get("id")]);
        }
    },
    autoCloseMsg:function(){
        Ext.Msg.hide();     
    },
    executeUrl : function(url, params,fn) {
            return function() {
                Ext.Ajax.request({
                    waitMsg:"正在执行操作，请稍候...",
                    url : url,
                    method : 'POST',
                    params : params,
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            Ext.Msg.alert("提示",
                                    "操作失败，失败原因为：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"));
                        else {
                            Ext.Msg.alert("提示",
                                    "操作成功", fn?fn:Ext.emptyFn, this);
                        }
                    },
                    scope : this
                });
            }
    },
    submitForm:function(form,url,callback,scope,failure){
        form.submit({
            url:url,
            waitTitle:"请稍候",
            waitMsg:"正在保存，请稍候",
            success:function(form,action){
                if(callback)callback.call(scope||this,form,action);
        },
        failure : function(form, action) {
                if(failure)failure.call(scope||this,form,action);
                else {
                var msg = "";
                if (action.failureType == Ext.form.Action.SERVER_INVALID) {
                    if(form.notAlert) return "";// 这个在form中配置的一个开关，表示这个form在服务返回有错误信息的时候不弹出信息。
                    for (var p in action.result.errors) {
                        msg += action.result.errors[p] + "  ";
                    }
                } else
                    msg = "数据录入不合法或不完整！";
                    
                Ext.MessageBox.alert("保存失败！", msg);
                }
            },
        scope:scope||this
        });
    }});
Ext.apply(EasyJF.Ext.Util,{
    getEditGridData:function(editGrid,prefix,key,filter){
        function getV(v){
            if(v&&v.value!==undefined)v=v.value;// 根据value属性来得到
            else if(v&& v.id!==undefined)v=v.id;// 根据id属性来得到
            if(v && typeof v=="object" && v.clearTime)v=v.format("Y-m-d");
            return v;       
        }
        var o={};
        var mc=editGrid.getColumnModel().getColumnCount();
        for(var i=0;i<mc;i++){
            var n=editGrid.getColumnModel().getDataIndex(i);
            if(n)o[(prefix?prefix:"")+n]=[];
        }  
        var store=editGrid.store;
        var j=0;
        var numbererField=editGrid.getColumnModel().getColumnById("numberer")?editGrid.getColumnModel().getColumnById("numberer").dataIndex:"";
        for(var i=0;i<store.getCount();i++){
            if(key){// 如果指定了必填项，则要作必填项判断
                var v=store.getAt(i).get(key);
                v=getV(v);
                if(!v)continue;// 如果必填项没有值，则退出
                if(filter && !filter(store.getAt(i))) continue;
                if(typeof v=="object" && !String(v))continue;// 对Object类型进行处理
            }
            for(var n in o){                            
                var f=prefix?n.replace(prefix,""):n;
                if(f==numbererField)o[n][j]=j;// 处理自动排序字段
                else {
                    var v=store.getAt(i).get(f);                
                    v=getV(v);      
                    o[n][j]=(v!==null?v:"");
                }
            }
            j++;
        }       
        return j>0?o:{};
    },
    editGrid2form:function(editGrid,fp){// 把EditorGridPnael中的数据保存到表单隐藏域中
        var c=[];
        var mc=editGrid.getColumnModel().getColumnCount();
        for(var i=0;i<mc;i++){
            c[c.length]=editGrid.getColumnModel().getDataIndex(i);
        }   
        for(var j=0;j<c.length;j++){ 
            var n=c[j];
            // alert(n);
            if(fp.form.findField(n)){
            var s="";   
            for(var i=0;i<editGrid.store.getCount();i++){
                var v=editGrid.store.getAt(i).get(n);
                if(v&&v.value)v=v.value;// 根据value属性来得到
                else if(v&&v.id)v=v.id;// 根据id属性来得到
                s+=(v?v:" ")+";";
            }
            fp.form.findField(n).setValue(s);
            }           
        }
    },
    getGridDataAsString:function(grid){
        var s = [];
        grid.store.each(function(r){
            s.push(r.get("id"))
        });
        return s.join(',');
    },
   appendGridRows:function(grid,storeMapping,rs,dataHandler,keepLastEmptyRow){
        if(rs.length==undefined)rs=[rs];
        var selectRow=grid.getSelectionModel().getSelectedCell?grid.getSelectionModel().getSelectedCell():null;
        var lastSecondRow=grid.store.getCount()-(keepLastEmptyRow?2:1);
        var appendTo=lastSecondRow;
        if(selectRow)
        appendTo=selectRow[0];
        if(appendTo<-1)appendTo=-1;
        if(appendTo==lastSecondRow+1)appendTo=lastSecondRow;        
        for(var i=0;i<rs.length;i++){
        var r=rs[i];
        var obj=dataHandler(r)
        EasyJF.Ext.Util.addGridRow(grid,storeMapping,obj,appendTo+i);
        }
    },
    loadDataGrid:function(grid,data,append){
        grid.getView().scrollToTop();//如果有滚动条,而且滚动条在底部,折可能出现页面闪烁
        var s = grid.getStore();
        s.removeAll();
        if(Ext.isArray(data)){
            var root = s.reader.meta.root;
            if(Ext.isEmpty(root)){
                s.loadData(data,append);
            }else{
                var totalProperty = s.reader.meta.totalProperty;
                var o = {};
                o[root] = data;
                o[totalProperty] = data.length;
                s.loadData(o,append);   
            }
        }else{
            s.loadData(data,append);
        }
    },
    addGridRow:function(grid,storeMapping,obj,appendTo){
        var row=appendTo;
        if(row==undefined){
        var selModel=grid.getSelectionModel();
        var record =selModel.getSelectedCell?selModel.getSelectedCell():null;   
        row=grid.store.getCount()-1;    
        if(record){
            row=record[0];
        }
        }
        var create=Ext.data.Record.create(storeMapping);
        var obj=new create(Ext.apply({},obj||{}));      
        if(grid.stopEditing)grid.stopEditing();
        grid.store.insert(row+1,obj);
        grid.getView().refresh();
    },
    removeGridRow:function(grid,callback){   
        var record = grid.getSelectionModel().getSelectedCell();    
        if(record){
        var store=grid.store;
        Ext.MessageBox.confirm("请确认","确定要删除吗？",function(ret){
            if(ret=="yes"){
                var r=store.getAt(record[0]);
                if(callback) callback(r);
                store.remove(r);
                grid.getView().refresh();
                if(store.getCount()>0)grid.getSelectionModel().select(record[0]-1<0?0:record[0]-1,record[1]);
            }});
        }
        else Ext.MessageBox.alert("提示","请选择要删除的记录!");
    },
    reloadGrid:function(grid){
        grid.getStore().removeAll();
        grid.getStore().reload();
    },
    removeGridRows:function(grid){  
        if(!grid.getSelectionModel().getSelections && grid.getSelectionModel().getSelectedCell ){//
            EasyJF.Ext.Util.removeGridRow(grid);
        }
        else{
        var rs = grid.getSelectionModel().getSelections();  
        if(rs&&rs.length>0){
        var store=grid.store;
        Ext.MessageBox.confirm("请确认","确定要删除吗？",function(ret){
            if(ret=="yes"){
                for(var i=0;i<rs.length;i++)store.remove(rs[i]); 
                grid.getView().refresh();
            }});
        }
        }
    },
    setGridColumnHidden:function(fields,hidden,grid){
        if(grid!=null && fields!=null && fields.length){
        for(var i=0;i<fields.length;i++){
        var index = grid.getColumnModel().findColumnIndex(fields[i]);
        if(index>=0){
           grid.getColumnModel().config[index].hideable=!hidden;
           grid.getColumnModel().setHidden(index, hidden);
        }
        }
        }
    }});
  
    
  Ext.apply(EasyJF.Ext.Util,{
    columnPanelBuild:function(){
        var args = Array.prototype.slice.call(arguments,0);
        var formConfig = {};
        if(args[0]){
            if(args[0].FC||args[0].formConfig){
                Ext.apply(formConfig,(args[0].FC||args[0].formConfig));
                args.shift();
            }
        }
        var obj={layout:'column',anchor:"100%",defaults:{border:false},items:[],xtype:"panel",border:false,bodyBorder:false};
        var defaultColumn=(1/args.length).toFixed(2);
        for(var i=0;i<args.length;i++){
            var o=args[i];
            var c={columnWidth:o.columnWidth||defaultColumn,
               layout:'form',
               defaultType:o.defaultType||"textfield",
               defaults:o.defaults||{anchor:"-20"},
               items:o.items
               };
         obj.items[i]=Ext.apply(c,formConfig);
        }
      return obj;
    },
    twoColumnPanelBuild:function(){     
        var args = Array.prototype.slice.call(arguments,0);
        var formConfig = {};
        var obj={layout:'column',anchor:"100%",defaults:{border:false},items:[],xtype:"panel",border:false,bodyBorder:false};
        var max=2;
        if(typeof args[0]=="number"){
            max=args[0];
            args.shift();
        }
        if(args[0]){
            if(args[0].FC||args[0].formConfig){
                Ext.apply(formConfig,(args[0].FC||args[0].formConfig));
                args.shift();
            }
        }
        var cs=[];
        for(var i=0;i<max;i++)
                cs[i]=Ext.apply({
                columnWidth:1/max,
                layout:'form',
                defaultType:"textfield",
                defaults:{anchor:"-20"},
                items:[]
         },formConfig);
         for(var i=0;i<args.length;){
            for(var j=0;j<max;j++,i++){
                    cs[j].items[cs[j].items.length]=(i<args.length?args[i]:{xtype:"panel",border:false});   
            }
        }
        obj.items=cs;
        return obj;
    },     
    oneColumnPanelBuild:function(){
        var obj={layout:'column',anchor:"100%",defaults:{border:false},items:[],xtype:"panel",border:false,bodyBorder:false};
        var lx=arguments.length;
        for(var i=0;i<arguments.length;i++){
            if(arguments[i].hidden)lx--;
        }
        var defaultColumn=(1/lx).toFixed(2),lastColumn=defaultColumn;
        if(defaultColumn*lx>1)lastColumn=defaultColumn-(defaultColumn*lx-1);
        var begin=0,cws=null;
        if(typeof arguments[0]=="object" && arguments[0].constructor==Array){// 第一个如果是数组则用来指定列宽
            cws=arguments[0];
            begin=1;
        }
        for(var i=begin;i<arguments.length;i++){
            var field= arguments[i];
            if(field.xtype=="labelfield" && !field.anchor)field.anchor="-5";
            var c={columnWidth:cws?cws[i-1]:((i==arguments.length-1)?lastColumn:defaultColumn),
               layout:'form',
               defaultType:"textfield",
               defaults:{anchor:field.xtype=="labelfield"?"-10":"-20"},
               items:field                 
               };
            obj.items[i]=c;
        }      
        return obj;
	}
});
EasyJF.Ext.Util.columnBuild = EasyJF.Ext.Util.twoColumnPanelBuild; 
Ext.apply(EasyJF.Ext.Util,{
    TRANS_ID : 0,
    load : function(appName) {
        var transId = ++EasyJF.Ext.Util.TRANS_ID;
        var head = document.getElementsByTagName("head")[0];
        var script = document.createElement("script");
        script.setAttribute("src", appName);
        script.setAttribute("type", "text/javascript");
        script.setAttribute("id","lanyoScript_"+EasyJF.Ext.Util.TRANS_ID);
        head.appendChild(script);
    },
    <div id="method-EasyJF.Ext.Util-loadJSON2Collection"></div>/**
     * 从指定的url加载数组或PageResult类型的JSON对象，并自动存放到本地缓存中
     * 
     * @param {}
     *            varName 缓存明称
     * @param {}
     *            url JSON数据url
     * @param {}
     *            callback 可选参数，回调函数
     * @param {}
     *            shareCache 可选参数，是否共享缓存
     * @param {}
     *            collectionType 可选参数，缓存类型，默认为MixedCollection
     */
    loadJSON2Collection : function(varName,url, callback,shareCache,collectionType) {
         Ext.Ajax.request({
                url : url,
                success : function(req) {
                    try{
                        var ret = Ext.decode(req.responseText);
                        var collection =shareCache||eval("new "+(collectionType||"Ext.util.MixedCollection")+"()");
                        if(Ext.type(ret)=='array'){
                            collection.addAll(ret);
                            EasyJF.Ext.CachedRemoteObject.DATAS[varName]=collection;
                        }
                        else if(Ext.type(ret)=='object' && Ext.type(ret.result)=='array'){
                            collection.addAll(ret.result);
                            EasyJF.Ext.CachedRemoteObject.DATAS[varName]=collection;
                        }
                    }catch(e){}
                    if (callback)callback();    
                },
                scope : this
            });
    },
    loadJSONObject:function(varName,script,callback){
        Ext.Ajax.request({url:script,success:function(req){
            var ret=Ext.decode(req.responseText);
            if(varName)eval("("+varName+"=ret)");
            if(callback)callback();                      
       },scope:this});         
    },
    loadScript:function(className,script,callback,scope,async){
        if(!window[className]){
            Ext.Ajax.request({url:script/*Ext.urlAppend(Global.loadScriptUrl,"script="+script)*/,success:function(req){
                window.eval(req.responseText);
                if(callback){
                    callback.call(scope||window,window[className]);                      
                }
           },scope:this,async:async});
       }
       else if(callback) callback.call(scope||window,window[className]);       
    },
    loadClass:function(cfg,async){
		cfg = cfg || {};
		if(!Ext.isBoolean(cfg) && Ext.isBoolean(async)){
			cfg.async=async;
		}
		if(cfg.script){
			if(Ext.isEmpty(cfg.className)){
				var scriptUrl = cfg.script;
				var ji = scriptUrl.indexOf('.js');
				if(ji>=0){
					var  scriptClassSub = scriptUrl.substring(0,ji);
					var  lastIndex = scriptClassSub.lastIndexOf('/');
					if(lastIndex>=0){
						cfg.className = scriptUrl.substring(lastIndex+1,ji);
					}
				}
			}
			Ejf.Util.loadScript(cfg.className,cfg.script,cfg.callback,cfg.scope,cfg.async);
		}
	},
    asLoadScript : function(script,async) {
        Ext.Ajax.request({
                url : script,
                async : async,
                success : function(req) {
                    eval(req.responseText);
                },
                scope : this
            });
    },
	 <div id="method-EasyJF.Ext.Util-loadJS"></div>/**
     * 在页面打开的时候动态加载脚本程序
     * @param {String} script 脚本名称
     */
    loadJS:function(script){
        document.write("<script src='"+script+"'></script>");
    },
    // 拷贝一颗树节点及所有子节点
    cloneTreeNode : function(nodes) {
        var ns = [];
        for (var i = 0; i < nodes.length; i++) {
            var o = Ext.apply({}, nodes[i]);
            if (nodes[i].children && nodes[i].children.length) {
                o.children = this.cloneTreeNode(nodes[i].children);
            } else
                o.children = [];
            ns.push(o);
        }
        return ns;
    },
    addObject:function(crudClass,callback,script,otherScripts,winReadyAction){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            o.createObject(callback,winReadyAction);
        }
        else {// 从脚本中加载
            var loadSuccess=function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                o.createObject(callback,winReadyAction);                
            };
            if(otherScripts){
                var s=otherScripts.split(";");
                var total=s.length,ld=0;
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);
                        ld++;
                        if(ld>=total){
                            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:loadSuccess,scope:this});
                        }
                    },scope:this});
                    }
            }
            else {
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:loadSuccess,scope:this});
            }
        }
    },
    listObject:function(crudClass,callback,script,otherScripts){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            if(o.list && (typeof o.list=="function"))o=o.list();
            if(callback)callback(o);
        }
        else {// 从脚本中加载
            if(otherScripts){
                var s=otherScripts.split(";");
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                    }});
                    }
            }   
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                if(o.list && (typeof o.list=="function"))o=o.list();
                if(callback)callback(o);
            },scope:this});     
        }
    },
    editObject:function(crudClass,callback,script,otherScripts,id,winReadyAction){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            o.editObject(id,callback,winReadyAction);
        }
        else {// 从脚本中加载
            if(otherScripts){
                var s=otherScripts.split(";");
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                    }});
                    }
            }   
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                o.editObject(id,callback,winReadyAction);
            },scope:this});     
        }
    },
    viewObject:function(crudClass,callback,script,otherScripts,id){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            o.viewObject(id,callback);
        }
        else {// 从脚本中加载
            if(otherScripts){
                var s=otherScripts.split(";");
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                    }});
                    }
            }   
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                o.viewObject(id,callback);
            },scope:this});     
        }
    },
    removeObject:function(crudClass,callback,script,otherScripts,id){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            o.removeObject(id,callback);
        }
        else {// 从脚本中加载
            if(otherScripts){
                var s=otherScripts.split(";");
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                    }});
                    }
            }   
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                o.removeObject(id,callback);
            },scope:this});     
        }
    },
    <div id="method-EasyJF.Ext.Util-buildCombox"></div>/**
     * @param {String} name
     * @param {String} fieldLabel
     * @param {Array} data
     * @param {Mixed} defaultValue
     * @param {Boolean} allowBlank
     * 或者
     * 第一个参数为Object {} 如 ：
     * buildCombox({
     * 		 name : "comboName",
     *       hiddenName : "comboName",
     *       fieldLabel : "comboLabel",
     *       value:"defaultValue",
     *       allowBlank:true
     * })
     */
    buildCombox:function(name,fieldLabel,data,defaultValue,allowBlank){
    		var cfg = {}
			if(Ext.isObject(name)){
				cfg = name;
				data = cfg['data'];
				delete cfg['data'];
			}else if(Ext.isArray(name)){
				data = name ;
				name = null ;
			}else{
				cfg = {
					name : name,
                	hiddenName : name,
                	fieldLabel : fieldLabel,
                	value:defaultValue,
                	allowBlank:allowBlank
				}
			}
	    	var comboCfg = Ext.apply({
	            xtype : "combo",
	            displayField : "title",
	            valueField : "value",
	            store : new Ext.data.SimpleStore({
	                fields : ['title', 'value'],
	                data :  data
	            }),
	            editable : false,
	            mode : 'local',
	            triggerAction : 'all',
	            emptyText : '请选择...'
	        },cfg);
        return 	comboCfg;
    },
    buildRemoteCombox:function(name,fieldLabel,url,fields,displayField,valueField,allowBlank,localStoreVar){
        var comboConfig = {
	         xtype:"smartcombo",
	         lazyRender:true,
	         triggerAction:"all",
	         typeAhead: true,
	         editable:false
       };
       if(arguments.length==1 && Ext.isObject(name)){
       		fields = name.fields;
       		url = name.url || name.dataUrl;
       		Ext.del(name,'fields','url','dataUrl');
       		Ext.apply(comboConfig,name);
       }else{
       	 	Ext.apply(comboConfig,{
       	 		 name:name,
			     hiddenName:name,
			     allowBlank:allowBlank,
			     fieldLabel:fieldLabel,
			     displayField:displayField?displayField:"title",
			     valueField:valueField?valueField:"id"
       	 	});
       }
        var storeConfig = {
            id:"id",
            url:url,        
            root:"result",
            totalProperty:"rowCount",
            remoteSort:true,    
            baseParams:{pageSize:"-1"}, 
            pageSize:"-1",
            fields:fields
        }               
        if(!Ext.isString(localStoreVar)){
            comboConfig.store=new Ext.data.JsonStore(storeConfig);
        }else{
            comboConfig.store = new EasyJF.Ext.CachedRemoteStore(Ext.apply({varName:localStoreVar},comboConfig));
        }
        return comboConfig;
    },
    printGrid:function(grid){
        var win=window.open("");
        win.document.write("<link rel='stylesheet' type='text/css' href='/stylesheet/print.css' />");
        win.document.write(grid.el.dom.innerHTML);
        win.document.close();
    },
    getSelectWin:function(winName,title,width,height,gridClz,config){
            if(!EasyJF.Ext.SelectWin)EasyJF.Ext.SelectWin={};
            if(!EasyJF.Ext.SelectWin[winName]){
                config=config||{};
                var glist=config.grid;
                if(!glist&&gridClz)glist=eval("new "+gridClz+"(config)");
                config=Ext.apply({},{title:title,width:width,height:height,grid:glist},config);
                EasyJF.Ext.SelectWin[winName]=new EasyJF.Ext.GridSelectWin(config);
            }
            return EasyJF.Ext.SelectWin[winName];
    }
});
    
// FCKeditorAPI
Ext.apply(EasyJF.Ext.Util,{
    setDelayEditorContent:function(name,html){
        if(typeof FCKeditorAPI=="object"){
            var editor=FCKeditorAPI.GetInstance(name)
            if(editor)editor.SetHTML(html||"");
        }
    },
    setFCKEditorContent:function(name,html){
        if(typeof FCKeditorAPI=="object"){
            var editor=FCKeditorAPI.GetInstance(name)
            if(editor)editor.SetHTML(html||"");
            else this.setDelayEditorContent.createCallback(name,html).defer(2000);
        }
        else this.setDelayEditorContent.createCallback(name,html).defer(2000);
    },
    getFckById:function(id){
        var fckApi = window.FCKeditorAPI;
        if(!fckApi)return null;
        return fckApi.GetInstance(id);
    },
    getFCKEditorContent:function(name){
        if(typeof FCKeditorAPI=="object"){
            var editor=FCKeditorAPI.GetInstance(name)
            return editor.GetHTML();
        }
        else return "";
    },
    autoFocusFirstRow:function(grid){
        grid.store.on("load",function(){
            if(grid.rendered){
                var sel=grid.getSelectionModel();
                if(!sel.hasSelection() && grid.store.getCount()){
                // grid.getSelectionModel().selectFirstRow();
                grid.getView().focusRow(0);
                }else if(sel.hasSelection()) {
                    grid.getView().focusRow(grid.store.indexOf(grid.getSelectionModel().getSelected()));
                }
                else {
                    grid.focus();
                }
            }
            else {
                grid.on("render",function(g){
                EasyJF.Ext.Util.autoFocusFirstRow(g);
                })
            }
        })
    },
    getExportForm:function(){
            var exportForm=Ext.getCmp("global_export_form");
            if(!exportForm){
                exportForm=new Ext.form.FormPanel({fileUpload:true,hidden:true,items:{}});
                var fe=document.createElement("div");
                document.body.appendChild(fe);
                exportForm.render(fe);
            }
            return exportForm;
    },
    <div id="method-EasyJF.Ext.Util-executePanleButtons"></div>/**
     * 执行Panel上的某一个按钮
     * 
     * @param {}
     *            p
     * @param {}
     *            btn
     */
    executePanleButtons:function(p,btn){
        if(p.buttons&&p.buttons.length){
        for(var i=0,bs=p.buttons;i<bs.length;i++){
            if(bs[i].id==btn){
                if(!(bs[i].disabled||bs[i].hidden) && bs[i].handler)bs[i].handler.call();
                break;
            }
        }
        }
    },  
    <div id="method-EasyJF.Ext.Util-executeLocalCommand"></div>/**
     * 执行本地命令
     * 
     * @param {}
     *            cmd 命令名称
     * @param {}
     *            value 参数值
     */
    executeLocalCommand:function(cmd,value,callback){
        LanyoBrowser.executeLocalCommand(cmd,value,callback);
    },
    ajaxRequest:function(url, params, scope, success, failure,
        successOp) {
    Ext.Ajax.request({
                url : url,
                params : params || {},
                scope : scope || this,
                success : success || function(response,options) {
                    var data = Ext.decode(response.responseText);
                    if (data.success) {
                        if (successOp)
                            successOp.call(this,data,options);
                        else if(data.msg){
                            EasyJF.Ext.Msg.alert(data.msg);
                        }
                    } else if(data.msg){
                        Ext.Msg.errorMsg(null, data.msg);
                    }
                },
            failure : failure || function(response) {
                var data = Ext.decode(response.responseText);
                Ext.Msg.errorMsg(null, data.msg? data.msg: (data.errors && data.errors.msg? data.errors.msg: "未知错误原因!"));
            }
        });
}
});


LanyoBrowser = {
    client: { serverUrl: "", usbKey: "", loginKey: "", orgId: "", userName: "" },
    user: {},
    usb: {},
    ids: [],
    cmds: [],
    getId: function() {
        var id = Math.random(1000).toString();
        while (this.cmds.indexOf(id) >= 0) {
            id = Math.random(1000).toString();
        }
        return id;
    },   
    executeLocalCommand: function(cmd, value, callback) {
        var id = this.getId();
        this.ids.push(id);
        if (callback) {
            var o = { id: id, fn: callback };
            this.cmds.push(o);
        }
        window.status = "LOCALCMD:" + id + ":" + cmd + ":" + (value || "");
        return id;
    },   
    sendLocalCommandResult: function(id, value) {
        var cmd = null;
        for (var i = 0; i < this.cmds.length; i++) {
            if (this.cmds[i].id == id) {
                cmd = this.cmds[i];
                break;
            }
        }
        if (cmd) {
            if (cmd.fn) cmd.fn(value);
            this.cmds.remove(cmd);
        }
        this.ids.remove(id);
        var sdom = document.getElementById(id);
        if (sdom) {
            document.getElementsByTagName("head")[0].removeChild(sdom);
        }
    }
};
EasyJF.Ext.FormWindow=Ext.extend(Ext.Window,{
    confirmSave:false,
    checkFormDirty:function(){
        var fp=this.getComponent(0);
        if(fp&&fp.form)
       	 	return fp.form.isDirty();
        else return false;
    },
    hide : function(animateTarget, cb, scope){
        if(this.hidden || this.fireEvent("beforehide", this) === false) return;
        
        if(this.confirmSave && this.checkFormDirty()){
            Ext.MessageBox.show({
                   title:'是否要保存录入的数据?',
                   msg: '您所编辑的表单中含有末保存的数据,是否要保存修改后的内容?',
                   buttons: Ext.Msg.YESNOCANCEL,
                   fn:function(btn){
                    if(btn=="no"){
                        EasyJF.Ext.FormWindow.superclass.hide.call(this,animateTarget, cb, scope);
                    }else if(btn=="yes"){
                        if(this.crudService){
                            this.crudService.save(EasyJF.Ext.FormWindow.superclass.hide.createDelegate(this,[animateTarget, cb, scope]),this.autoClose);
                        }
                    }
                    else if(btn=="cancel"){
                        // doNothing
                    }
                   },
                   icon: Ext.MessageBox.QUESTION,
                   scope:this
                });
        }
        else {
            EasyJF.Ext.FormWindow.superclass.hide.call(this,animateTarget, cb, scope);
        }
    }
});

EasyJF.Ext.CascadeForm = Ext.extend(Ext.FormPanel,{
	<div id="cfg-EasyJF.Ext.Util-editCmps"></div>/**
	 * @cfg {String} editCmps
	 *  如 : Ext.grid.EditorGridPanel 
	 */
	<div id="cfg-EasyJF.Ext.Util-layout"></div>/**
	 * Form 的布局
	 *@cfg {String} layout
	 */
	layout : 'border',
	formElements:['west','north','east','south'],
	<div id="method-EasyJF.Ext.Util-createContent"></div>/**
	 * 创建Form主体部分
	 */
	createContent:function(){
		var cf = this.buildContentForm();
		this.addEditCmps(cf);
		return cf;
	},
	<div id="method-EasyJF.Ext.Util-buildWestForm"></div>/**
	 * 构建西部表单面板
	 */
	buildWestForm : function(){},
	<div id="method-EasyJF.Ext.Util-buildNorthForm"></div>/**
	 * 构建北部表单面板
	 */
	buildNorthForm : function(){},
	<div id="method-EasyJF.Ext.Util-buildEastForm"></div>/**
	 * 构建东部表单面板
	 */
	buildEastForm : function(){},
	<div id="method-EasyJF.Ext.Util-buildSouthForm"></div>/**
	 * 构建南部表单面板
	 */
	buildSouthForm : function(){},
	<div id="method-EasyJF.Ext.Util-buildContentForm"></div>/**
	 * 构建中心表单面板
	 */
	buildContentForm : function(){},
	<div id="method-EasyJF.Ext.Util-getEditCmps"></div>/**
	 * 获取面板中可以编辑的组件
	 */
	getEditCmps:function(){
		return this.editCmps = this.editCmps || [];
	},
	<div id="method-EasyJF.Ext.Util-addEditCmps"></div>/**
	 * 添加可以编辑的组件
	 * @param {Component/Array[] Component} cmp
	 */
	addEditCmps:function(cmp){
		Ext.each(arguments,function(cmp){
			if(Ext.isArray(cmp)){
				this.addEditCmps(cmp);
				return true;
			}
			if(!this.containsEditCmp(cmp)){
				this.getEditCmps().push(cmp);
			}
		},this);
	},
	<div id="method-EasyJF.Ext.Util-containsEditCmp"></div>/**
	 * 判断该cmp组件在本组建是否存在
	 * @param {Component} cmp
	 */
	containsEditCmp:function(cmp){
		return this.getEditCmps().indexOf(cmp)>=0;
	},
	<div id="method-EasyJF.Ext.Util-getEditorCmpValues"></div>/**
	 * 获取可编辑组建的值
	 * @return {Object}
	 */
	getEditorCmpValues:function(){
		var values = {};
		Ext.each(this.getEditCmps(),function(cmp){
			 var rvs = cmp.getRowsValues();
			 if(rvs){
			 	Ext.apply(values,rvs);
			 }
		},this);
		return values;
	},
	<div id="method-EasyJF.Ext.Util-getValues"></div>/**
	 * 获取表单数据
	 * @return {Object}
	 */
	getValues　: function(){
		var values = this.getForm().getValues();
		var cmpValues =  this.getEditorCmpValues();
		Ext.apply(values,cmpValues);
		return values ;
	},
	<div id="method-EasyJF.Ext.Util-setValues"></div>/**
	 * 设置表单数据
	 * @param {} values
	 */
	setValues : function(values){
		this.getForm().setValues(values);
	},
	onBeforeSubmit:function(){
		var values = this.getEditorCmpValues();
		this.getForm().baseParams = values;
	},
	<div id="method-EasyJF.Ext.Util-submit"></div>/**
	 * 提交表单数据
	 * @param {} options
	 */
	submit　: function(options){
		if(this.onBeforeSubmit()!==false){
			this.getForm().submit(options);
		}
	},
	beforeDestroy : function(){
		this.editCmps = null;
		EasyJF.Ext.CascadeForm.superclass.beforeDestroy.call(this);
	},
	initComponent:function(){
		this.items = [
			{
				layout : 'fit',
				region : 'center',
				border : false,
				items : this.createContent()
			}
		]
		for (var i = 0; i < this.formElements.length; i++) {
			var en = this.formElements[i],cmp;
			var eName = en.substring(0,1).toUpperCase()+en.substring(1);
			if(cmp = this[String.format('build{0}Form',eName)]()){
				cmp.region = en; 
				this.items.push(cmp);
			}
		}
		EasyJF.Ext.CascadeForm.superclass.initComponent.call(this);
	}
}); 

<div id="prop-EasyJF.Ext.Util-CrudFunction"></div>/**
 * 增删改查相关功能
 */
EasyJF.Ext.CrudFunction={
    layout : "fit",
    border : false,
    closable : true,
    autoScroll : true,
    exportData : false,// 是否显示导出excel按钮
    importData:false,// 是否显示导入exdel数据
    printData:false,
    clearData:false, // 是否清楚查询
    allowSearch : true,// 是否允许自定义查询
    showMenu : true,// 用来定义是否显示右键菜单
    showAdd:true,// 默认显示添加按钮
    showEdit:true,// 默认显示编辑按钮
    showRemove:true,// 默认显示删除按钮
    showView : true,// 用来定义是否显示查看面板
    showRefresh:true,// 用来控制CRUD中的refresh按钮显示
    showSearchField:true,// 用来控制searchField按钮显示
    gridForceFit : true,// 强制表格自动适应
    batchRemoveMode:false,// 是否是批量删除模式
    autoLoadGridData:true,// 自动加载表格数据
    columnLock:false,// 表格列锁定
    summaryGrid:false,// 统计表格
    dirtyFormCheck:true,// 是否自动检查编辑表单中的数据项已经修改
    operatorButtonStyle:1,// 1为图文混合,2为文字,3为图标
    customizeQueryObject:false,// 是否开始自定义查询支持
    queryObjectName:null,// 自定义查询对象的名称
    winWidth : 500,// 默认的窗口宽度
    winHeight : 400,// 默认的窗口高度
    winTitle : "数据管理",// 默认的窗口标题
    pageSize : 10,// 每页显示条数
        pagingToolbar : true,// 是否显示工具栏
        defaultCmd:true,// 默认用cmd=list
        viewSave : Ext.emptyFn,// 用来处理视图查看时，保存按钮的回调函数
        initComponent:Ext.emptyFn,
        linkRenderer : EasyJF.Ext.Util.linkRenderer,
        linkRender:EasyJF.Ext.Util.linkRenderer,
        imgRender :EasyJF.Ext.Util.imgRender,
        booleanRender :  EasyJF.Ext.Util.booleanRender,
        dateRender :EasyJF.Ext.Util.dateRender,
        userRender : EasyJF.Ext.Util.userRender,
        objectRender : EasyJF.Ext.Util.objectRender,
        typesRender : EasyJF.Ext.Util.typesRender,
        readOnlyRender:EasyJF.Ext.Util.readOnlyRender,
        operaterRender:EasyJF.Ext.Util.operaterRender,
        singleWindowMode:false,
        booleans:[["是",true],["否",false]],
        crud_operators:[{
            name:"btn_add",
            text : "添加(<u>A</u>)",
            iconCls : 'add',
            method : "create",
            cmd:"save",
            noneSelectRow:true,
            hidden:true
        },{
            name:"btn_edit",
            text : "编辑(<u>E</u>)",
            iconCls : "edit",
            disabled:true,
            method : "edit",
            cmd:"update",
            hidden:true
        },{
            name:"btn_view",
            text : "查看(<u>V</u>)",
            iconCls : "view",
            method : "view",
            disabled:true,
            hidden : true
        },{
            name:"btn_remove",
            text : "删除(<u>D</u>)",
            iconCls : "delete",
            disabled:false,
            method : "removeData",
            cmd:"remove",
            hidden : true
        },{
            name:"btn_refresh",
            text : "刷新",
            iconCls : "refresh",
            method : "refresh",
            noneSelectRow:true
        },{
            name:"btn_advancedSearch",
            text : "高级查询(<u>S</u>)",
            iconCls : "srsearch",
            method : "advancedSearch",
            cmd:"list",
            hidden : true,
            noneSelectRow:true,
            clientOperator:true
        },{
            name:"btn_clearSearch",
            text : "显示全部",
            cls : "x-btn-text-icon",
            iconCls : "search",
            noneSelectRow:true,
            method : "clearSearch",
            hidden : true
        },{
            name:"btn_print",
            text : "打印(<u>P</u>)",
            iconCls:"print-icon",
            disabled:true,
            method : "printRecord",
            hidden : true
        },{
            name:"btn_export",
            text : "导出Excel(<u>O</u>)",
            iconCls : 'export-icon',
            method : "exportExcel",
            noneSelectRow:true,
            hidden : true
        },{
            name:"btn_import",
            text : "导入数据(<u>I</u>)",
            iconCls : 'import-icon',
            method : "importExcel",
            noneSelectRow:true,
            hidden : true
        },'->',{
            type:"searchfield",
            name:"searchField",
            width : 100,
            noneSelectRow:true,
            paramName : 'searchKey',
            clientOperator:true
        }],
        objectAutoRender:function(v){
            if(v&&v.id){
                for(var d in v){
                    if(d!="id" && v[d])return v[d];
                }
                return v.id;
            }else return v;
        },
        search : function() {
            Ext.apply(this.store.baseParams, {
                        searchKey : this.searchField?this.searchField.getValue():""
                    });
            if(this.store.lastOptions&&this.store.lastOptions.params){
            this.store.lastOptions.params.start=0;
            this.store.lastOptions.params.pageSize=this.store.baseParams.pageSize||this.pageSize;
            }
            this.refresh();
        },
        formatUrl:function(cmd){
          return   Lanyo_Ajax.formatUrl(this.baseUrl,cmd);
        },
        importExcel:function(){
            if(!EasyJF.Ext.ImportPanel){
                EasyJF.Ext.ImportPanel=new Ext.form.FormPanel({
                        id:"crudExportPanel",
                        fileUpload:true,
                        items:[{xtype:"fieldset",title:"选择数据文件",autoHeight:true,items:{xtype:"textfield",hideLabel:true,inputType:"file",name:"file",anchor:"100%"}},
                        {xtype:"fieldset",title:"导入说明",html:"",height:60}
                    ]});
            }
            
            var win=this.createGlobalWin("CrudExportWindow",300,210,"导入数据",EasyJF.Ext.ImportPanel,function(){
                var form=EasyJF.Ext.ImportPanel.form;           
                if(form.findField("file").getValue().length<2){
                    Ext.Msg.alert("提示","你没有选择要导入的文件！");
                    return ;
                }
                EasyJF.Ext.ImportPanel.form.submit({
                    url:this.baseUrl,
                    params:{cmd:"import"},
                    waitMsg:"请稍候，正在导入数据",
                    success:function(){
                        Ext.Msg.alert("提示","数据导入成功!",function(){form.findField("file").reset();win.hide();this.store.reload();},this)
                    },
                    failure:function(){
                        this.alert("数据导入出错，请检测所选择的文件格式是否正确?","提示信息");
                    },
                    scope:this
                })
            });
        },
        getExportForm:EasyJF.Ext.Util.getExportForm,
        <div id="method-EasyJF.Ext.Util-exportExcel"></div>/**
         * 导出数据为Excel格式
         */
        exportExcel : function() {
            var params = this.store.baseParams;
            Ext.apply(params, {
                        searchKey : this.searchField?this.searchField.getValue():""
                    });
            /*
             * var s = Ext.urlEncode(params); window.open(this.baseUrl +
             * '?cmd=export&' + s);
             */
            var exportForm=this.getExportForm();
            exportForm.form.submit({
                    url:this.baseUrl,
                    params:Ext.apply({cmd:"export"},this.store.baseParams)
            });
        },  
        printList:function(cmd){
            return function(){
             var params=    Ext.apply(this.store.baseParams,{cmd:(cmd?cmd:"printList")});
             var s = Ext.urlEncode(params);
             window.open(this.baseUrl+"?" + s);
            }              
        },
        printRecord:function(){
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            window.open(this.baseUrl+"?cmd=print&id=" + record.get("id"));  
        },
        clearSearch:function(){
             this.store.baseParams = {};
             this.store.removeAll();
             this.store.load({params:{start:0,pageSize:this.pageSize}});
            // this.refresh();
        },  
        <div id="method-EasyJF.Ext.Util-refresh"></div>/**
         * 重新加载数据
         */
        refresh : function() {
            this.store.removeAll();
            this.store.reload({callback:function(rs){
                if(rs && rs.length<1){this.alert("没有符合条件的数据！","提示信息");
                EasyJF.Ext.Util.autoCloseMsg.defer(2000);}
                },scope:this});
            this.disableOperaterItem("btn_remove","btn_edit","btn_view","btn_print");
            this.focus();
        },  
        initWin : function(width, height, title,callback,autoClose,resizable,maximizable) {
            this.winWidth = width;
            this.winHeight = height;
            this.winTitle = title;
            var winName=autoClose?"CrudEditNewWindow":"CrudEditWindow";
            if(this.singleWindowMode)winName=winName+this.id;
            var win=this.createGlobalWin(winName,width,height,title,this.fp,null,"fp",[{
                                id : "btnSave",
                                text : "保存(<u>K</u>)",
                                handler : function() {
                                    EasyJF.Ext[winName].crudService.save(callback,autoClose);
                                },
                                iconCls : 'save',
                                scope : this
                            }, {
                                id : "btnReset",
                                text : "重置(<u>R</u>)",
                                iconCls : 'clean',
                                handler : function() {
                                    EasyJF.Ext[winName].crudService.reset()
                                },
                                scope : this
                            }, {
                                id : "btnClose",
                                text : "取消(<u>X</u>)",
                                iconCls : 'delete',
                                handler : function() {
                                    EasyJF.Ext[winName].crudService.closeWin(autoClose)
                                },
                                scope : this
                            }],autoClose,resizable?true:false,maximizable?true:false);
            win.confirmSave=this.dirtyFormCheck;
            return win;
        },
        getViewWin : function(autoClose) {
            var width = this.viewWin.width;
            var height = this.viewWin.height;
            var title = this.viewWin.title;
            return  this.createGlobalWin("CrudViewWindow",width,height,title,this.viewPanel,function() {
                                    var w = EasyJF.Ext.CrudViewWindow;
                                    if (w.crudService)
                                        w.crudService.viewSave(this.viewPanel);
                                    w.hide();
                                },"viewPanel",null,autoClose);
        },  
        doSomeWork : function(width,height,title,panel,createPanel,cmd,workWinName,url,autoClose){
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            if(!this[panel])this[panel]=this[createPanel]();
            var win=this.getWorkWin(width,height,title,this[panel],function(){
                if(!this[panel].form.isValid()) return false;
                this[panel].form.submit({
                    url:url?url:this.baseUrl,
                    waitMsg:"正在执行操作，请稍候",
                    params:{cmd:cmd},
                    success:function(){
                        win.hide();
                        this.refresh()
                    },          
                    failure : function(form, action) {
                        var msg = "";
                        if (action.failureType == Ext.form.Action.SERVER_INVALID) {
                            for (var p in action.result.errors) {
                                msg += action.result.errors[p] + "&nbsp;";
                            }
                        } else
                            msg = "数据录入不合法或不完整！";
                        this.alert(msg,"保存失败!");
                    },
                    scope:this          
                });
            },panel,workWinName,autoClose);     
            return win;
           
        },
        // 根据当前的数据创建一个工作窗口
        getWorkWin : function(width,height,title,workPanel,save,pname,winName,autoClose) {
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            var id = record.get("id");
            var win=this.createGlobalWin(winName?winName:"CrudWorkWindow",width,height,title,workPanel,save,pname,null,autoClose);      
            // 显示数据
            for (var n in record.data) {
                var c = win.getComponent(0).findSomeThing(n);
                // if(!c &&
                // win.getComponent(0).getXType()=="form")c=win.getComponent(0).form.findField(n);
                if (c) {
                    var v = record.get(n);
                    if (c.isFormField) {
                        c.setValue(v);
                        c.clearDirty();
                    } else{
                        if(c.renderer)v=c.renderer(v);
                         if (c.setText)
                        c.setText(v);
                        else if (c.getXType && c.getXType() == "panel")
                        c.body.update(v);
                    }
                }
            }
            return win;
        },
        alert:function(msg,title){
            Ext.Msg.alert(title||"提示",msg,function(){
                this.focus();
            },this);
        },
        confirm:function(title,msg,callback){
            Ext.Msg.confirm(title,msg,function(btn){
                if(btn=="yes"){
                    callback();
                }
                else {
                    this.focus();
                }
            },this);
        },
        focusFirstField:function(fp,win){
            fp=fp||this.fp;
            win=win||this.win;
            var fp=win.findByType("form");
                    win.currentFocus=false;
                    if(fp&&fp[0].form.items){
                        fp[0].form.items.each(function(o){
                            if(o.canFocus()){
                                o.focus("",10);
                                win.currentFocus=o;
                                return false;
                            }
                        });
                    }
                    if(!win.currentFocus){
                        if(win.buttons && win.buttons.length){
                            win.buttons[0].focus("",10);
                            win.currentFocus=win.buttons[0];
                        }
            }
        },
        // 得到一个全局的操作窗口，参数width表示窗口宽度，height表示窗口高度，title表示窗口标题，workPanel表示窗口名称，save表示回调函数，作用域为this,pname表示属性名称，比如viewPanel
        createGlobalWin : function(winName,width,height,title,workPanel,save,pname,buttons,autoClose,resizable,maximizable) {
            var win = EasyJF.Ext[winName];
            if (!win) {
                this[pname?pname:workPanel.id]=workPanel;
                var tools=[];
                tools.push({id:"help",handler:this.help});
                EasyJF.Ext[winName] = new EasyJF.Ext.FormWindow({
                    width : width,
                    layout : 'fit',
                    border : false,
                    resizable : resizable,
                    height : height,
                    buttonAlign : "center",
                    title : title,
                    modal : true,
                    defaultButton:0,
                    shadow : true,
                    maximized:false,
                    maximizable:maximizable,// this.enableMaxime,
                    // constrain:true,
                    tools:tools,
                    closeAction : autoClose||this.singleWindowMode?"close":"hide",
                    autoClose:autoClose||this.singleWindowMode,
                    listeners:{close:function(win){
                        if(win.crudService.store && win.crudService.closeSaveWin===false && winName!="CrudSearchWindow"){
                            win.crudService.store.reload();
                        }
                        win.crudService.focusCrudGrid();
                        delete EasyJF.Ext[winName];
                    },maximize:function(win){if(win.maximizable){win.doLayout();win.maximized=true}},// 如果需要实现可最大化和最小化，就要重写maximize和restore事件
                    restore:function(win){if(win.maximizable){win.doLayout();win.maximized=false}},
                    show:function(win){
                    if(win.maximizable)
                    win.tools[win.maximized?"maximize":"restore"].setVisible(win.crudService.maximizable===true);
                    win.tools.help.setVisible(win.crudService.showHelp!=undefined);                 
                    var fp=win.findByType("form");
                    win.crudService.focusFirstField(fp,win);
                    },
                    hide:function(win){
                        if(win.crudService.store && win.crudService.closeSaveWin===false && winName!="CrudSearchWindow"){
                            win.crudService.store.reload();
                        }
                        win.crudService.focus();
                    }
                    },
                    items : [workPanel],
                    buttons : buttons?buttons:[{
                                id : "btnSave",
                                text : "确定(<u>K</u>)",
                                handler : function() {
                                    var w = EasyJF.Ext[winName];
                                    var h=true;
                                    if (save)
                                        h=save.call(w.crudService,autoClose);
                                    if(h){
                                        if(autoClose)w.close();
                                        else w.hide();
                                        }
                                },
                                iconCls : 'save',
                                scope : this
                            }, {
                                id : "btnClose",
                                text : "退出(<u>X</u>)",
                                iconCls : 'delete',
                                handler : function() {
                                    if(autoClose||this.singleWindowMode)EasyJF.Ext[winName].close();
                                    else EasyJF.Ext[winName].hide();
                                },
                                scope : this
                            }],
                    keys:[{key:"k",alt:true,stopEvent:true,fn:function(){
                        EasyJF.Ext.Util.executePanleButtons(win,"btnSave");
                    }
                    },{
                    key:"x",stopEvent:true,alt:true,fn:function(){
                        EasyJF.Ext.Util.executePanleButtons(win,"btnClose");
                    }
                    },{
                    key:"r",stopEvent:true,alt:true,fn:function(){
                        EasyJF.Ext.Util.executePanleButtons(win,"btnReset");
                    }
                    }]      
                });
                win=EasyJF.Ext[winName];                
            } else if (workPanel) {// 更改窗口中的内容，包括全局的事件响应函数等
                if(win.crudService!=this){
                    //win.resizable = resizable;
                    //win.maximizable=maximizable;
// if(win.maximizable&&win.tools["restore"])win.tools["restore"].setVisible(false);
                }
                
                win.setTitle(title);
                win.setWidth(width);
                win.setHeight(height);
                if (win.getComponent(0) != workPanel) {
                    var p=win.remove(0);
                    delete win.crudService[pname?pname:p.id];// 删除上一个
                    win.add(workPanel);
                    this[pname?pname:workPanel.id]=workPanel;
                    win.doLayout();
                }
            }
            win.crudService = this; // crudService用来定义全局的添删改查服务
            this[winName]=win;
            win.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(){win.center();},this);
            if(height=='auto'){
                win.autoHeight = true;
                win.syncSize.defer(1000,win);
            }else{
                win.autoHeight = false;
            }
            return win;
        },
        showWin : function() {
            if (!this.fp) {
                if(!this.createViewPanel && this.viewPanel){
                    this.fp = this.viewPanel;
                }else{
                    this.fp = this.createForm();
                }
            }
            this.win = this.createWin();
            this.win.on("close", function() {
                            delete this.win;
                            delete this.fp;
                        }, this);
            this.win.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(){this.win.center();},this);
        },
        onCreate:function(){
            
        },
        create : function() {
            this.showWin();
            this.fp.form.clearData();
            this.reset();
            this.fp.form.isValid();
            this.onCreate();
            this.formFocus.defer(500,this);
        },
        // 供外部调用创建一个新的对象
        createObject : function(callback,winReadyAction) {
            this.fp = this.createForm();
            this.win = this.createWin(callback,true);
            this.win.on("close", function() {
                            delete this.win;
                            delete this.fp;
            }, this);
            this.win.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(){this.win.center();},this);
            this.reset();
            if(winReadyAction){
                winReadyAction(this.win,this);
            }
            this.fp.form.isValid();
            this.onCreate();
            this.formFocus.defer(500,this);
        },
        onEdit:function(ret,data){
            
        },
        editObject : function(id,callback,winReadyAction) {
            this.fp = this.createForm();
            this.win = this.createWin(callback,true);
            this.win.on("close", function() {
                            delete this.win;
                            delete this.fp;
            }, this);
            this.win.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(){this.win.center();},this);
            var viewCmd=this.viewCmd||"view";
            Ext.Ajax.request({url:this.baseUrl+"?cmd="+viewCmd,params:{id:id},waitMsg:"正在加载数据,请稍侯...",callback:function(options,success,response){
                var r = Ext.decode(response.responseText);
                this.fp.form.setValues(r);
                if(winReadyAction){
                    winReadyAction(this.win,r,this);
                }
                this.onEdit(true,r);
                this.fp.form.isValid();
                this.formFocus.defer(500,this);
                this.fp.form.clearDirty();
            },scope:this});
        },
        edit : function() {
            if(this.btn_edit && this.btn_edit.disabled){this.view();return false;}
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            var id = record.get("id");
            this.showWin();
            this.fp.form.reset();
            this.fp.form.loadRecord(record);
            this.onEdit(true,record.data);
            this.fp.form.clearDirty();
            this.formFocus.defer(500,this);
            return true;
        },
        removeObject : function(id,callback) {
            this.confirm("删除确认","确定要删除吗？", function(ret) {
                            Ext.Ajax.request({
                                url : this.baseUrl + '?cmd=remove',
                                params : {
                                    'id' : id
                                },
                                method : 'POST',
                                success : function(response) {
                                    var r = Ext.decode(response.responseText);
                                    if (!r.success){
                                        this.alert("操作失败，失败原因为：<br/>"+ (r.errors.msg? r.errors.msg: "未知"),"提示信息");
                                    }
                                    else {
                                        this.alert("删除成功","提示信息");
                                        if(callback)callback();
                                    }
                                },
                                scope : this
                            });
                    }.createDelegate(this), this);
        },
        formFocus:function(){
            var field=this.fp.form.items.get(1);// 默认从第一个元素开始
            if(!field || field.disabled)
             this.items.each(function(f){
                if(!f.disabled){
                field=f;
                return false;
                }
             });
             if(field && !field.disabled)
             field.focus("",100);
        },
        validateForm:function(form){
            if(!form.isValid()){
                this.alert("表单数据不合法,请注意必填项及录入的数据格式!","提示",function(){
                this.formFocus();
                },this);
                // Ext.Msg.hide.defer(3000,Ext.Msg);
                return false;
            }
            return true;
        },
        onSave:function(form,action){
            
        },
        beforeSave:function(){
            return true;
        },
        save : function(callback,autoClose,ignoreBeforeSave) {
            if(!this.validateForm(this.fp.form))return false;
            if(ignoreBeforeSave!==true){
                if(this.beforeSave && this.beforeSave()===false)return false;
            }
            var id = this.fp.form.findField("id").getValue();
            var url = this.baseUrl;
            if (this.fp.form.fileUpload) {
                var cmd = this.fp.form.findField("cmd");
                if (cmd == null) {
                    cmd = new Ext.form.Hidden({
                        name : "cmd"
                    });
                    this.fp.add(cmd);
                    this.fp.doLayout();
                }
                cmd.setValue((id ? "update" : "save"));
            } else {
                url=this.formatUrl((id ? "update" : "save"));
            }
            EasyJF.Ext.Util.submitForm(this.fp.form,url,function(form,action){
                this.fp.form.clearDirty();
                if(this.closeSaveWin!==false)this.closeWin(autoClose);
                if(this.store && this.closeSaveWin!==false){
                    this.store.reload();
                }
                if(callback)callback();
                this.fireEvent("saveobject",this,form,action);
                this.onSave(form,action);
                /*
                 * if(this.win && this.closeSaveWin===false){ this.formFocus(); }
                 */
            },this);
        },
        <div id="method-EasyJF.Ext.Util-preview"></div>/**
         * 打印预览
         * 
         * @param {}
         *            callback
         * @param {}
         *            autoClose
         * @return {Boolean}
         */
        preview : function(callback,autoClose) {
            if(!this.validateForm(this.fp.form))return false;
            var id = this.fp.form.findField("id").getValue();
            var url = this.baseUrl;
            if (this.fp.form.fileUpload) {
                var cmd = this.fp.form.findField("cmd");
                if (cmd == null) {
                    cmd = new Ext.form.Hidden({
                        name : "cmd"
                    });
                    this.fp.add(cmd);
                    this.fp.doLayout();
                }
                cmd.setValue("preview");
            } else {
                url += "?cmd=preview";
            }
            var tempHiddens=[];
            var ps = this.fp.form.baseParams;
            if(ps&& typeof ps == 'string')ps=Ext.urlDecode(bp);
            var form=this.fp.form.el.dom;
            function addHiddenKey(key,value){
                var hd = document.createElement('input');
                    hd.type = 'hidden';
                    hd.name = key;
                    hd.value = value;
                    form.appendChild(hd);
                    tempHiddens.push(hd);
            }
            for(var k in ps){
                if(Ext.isArray(ps[k])){
                    for(var i=0;i<ps[k].length;i++){
                        addHiddenKey(k,ps[k][i]?ps[k][i]:"");
                        
                    }                   
                }else if(ps.hasOwnProperty(k)){                 
                    addHiddenKey(k,ps[k]?ps[k]:"");                   
                }
            }
            this.fp.form.el.dom.action=url;
            this.fp.form.el.dom.target="_blank";
            this.fp.form.el.dom.submit();
            if(tempHiddens){ // 删除动态的参数
            for(var i = 0, len = tempHiddens.length; i < len; i++){
                Ext.removeNode(tempHiddens[i]);
                }
            }
        },
       reset : function() {
            if (this.win && this.fp){
                this.fp.form.reset();
            }
        },
        closeWin : function(autoClose) {
            if(this.beforeClose){
                this.beforeClose(function(){
                    if (this.win){
                        if(autoClose)this.win.close();
                        else this.win.hide();
                    }
                    if(this.store && this.closeSaveWin===false){
                        // this.store.reload();
                    }
                });
            }else{
                if (this.win){
                    if(autoClose)this.win.close();
                    else this.win.hide();
                }
                if(this.store && this.closeSaveWin===false){
                    // this.store.reload();
                }
            }
        },      
        removeData : function() {
            if(this.btn_remove.disabled)return false;
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            var mulitId = "";
            if(this.batchRemoveMode){       
                var rs = this.grid.getSelectionModel().getSelections(); 
                for (var i = 0; i < rs.length; i++)
                    mulitId += rs[i].get("id") + ",";
            }
            var m =this.confirm("删除确认",
                    "确定要删除吗？", function(ret) {                      
                            Ext.Ajax.request({
                                url : this.formatUrl('remove'),
                                params : {
                                    'id' : record.get("id"),
                                    'mulitId' : mulitId
                                },
                                method : 'POST',
                                success : function(response,options) {
                                    var r = Ext.decode(response.responseText);
                                    if (r && !r.success)
                                        EasyJF.Ext.Msg.error("失败原因为：<br/>"+ (r.errors.msg? r.errors.msg: "未知"));
                                    else {
                                        Ext.Msg.alert("提示","删除成功",
                                                function() {
                                                    this.store.removeAll();
                                                    this.store.reload();
                                                    this.focus();
                                                }, this);
                                    }
                                    this.fireEvent("removeobject",this,r,options);
                                },
                                scope : this
                            });
                        
                    }.createDelegate(this), this);
            return true;
        },
        executeUrl : function(url, params,fn) {
            return function() {
                Ext.Ajax.request({
                    waitMsg:"正在执行操作，请稍候...",
                    url : url,
                    method : 'POST',
                    params : params,
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            this.alert("操作失败，失败原因为：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"));
                        else {
                            Ext.Msg.alert("提示","操作成功", fn?fn:Ext.emptyFn, this);
                        }
                    },
                    scope : this
                });
            }
        },
        executeCmd : function(cmd, allowBlank) {
            return function(c) {
                var sel=this.grid.getSelectionModel();
                var record = sel.getSelectedCell?(sel.getSelectedCell()?this.grid.store.getAt(sel.getSelectedCell()[0]):null):sel.getSelected();
                if(!c.noneSelectRow){
                if (!record && !allowBlank) {
                    this.alert("请先选择要操作的数据！");
                    return;
                }}
                var id = record ? record.get("id") : "";
                
                Ext.Ajax.request({
                    waitMsg:"正在执行操作，请稍候...",
                    url : this.formatUrl(cmd),
                    params : {
                        'id' : id
                    },
                    method : 'POST',
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            this.alert(
                                    "操作失败，失败原因为：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"));
                        else {
                        Ext.Msg.alert("提示", r.data ? r.data : "操作成功",
                                function() {
                                    this.store.reload();
                                    this.focus();
                                }, this);
                    }
                    },
                    scope : this
                });
            }
        },
        executeMulitCmd : function(cmd) {
            return function() {
                var record = this.grid.getSelectionModel().getSelections();
                if (!record || record.length < 1) {
                    this.alert("请先选择要操作的数据！");
                    return;
                }
                var mulitId = "";
                for (var i = 0; i < record.length; i++){
                    if(record[i].get("id"))
                    mulitId += record[i].get("id") + ",";
                }
                Ext.Ajax.request({
                    waitMsg:"正在执行操作，请稍候...",
                    url : this.formatUrl(cmd),
                    params : {
                        'mulitId' : mulitId
                    },
                    method : 'POST',
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            this.alert(
                                    "操作失败，失败原因为：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"));
                        else {
                        Ext.Msg.alert("提示", r.data ? r.data : "操作成功",
                                function() {
                                    this.store.reload();
                                    this.focus();
                                }, this);
                    }
                    },
                    scope : this
                });
            }
        },
        onView:function(){},
        view : function() {// 通用的查看数据窗口
            if (this.readInfo)
                return this.readInfo();
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！");
                return false;
            }
            var id = record.get("id");
            var win = this.showViewWin();
            for (var n in record.data) {
                var c = win.getComponent(0).findSomeThing(n);
                // if(!c &&
                // win.getComponent(0).getXType()=="form")c=win.getComponent(0).form.findField(n);
                if (c) {                
                    var v = record.get(n);  
                    // alert(n+":"+v);
                    if (c.isFormField) {
                        c.setValue(v);
                        c.clearDirty();
                    } else{
                        if(c.renderer)v=c.renderer(v);
                         if (c.setText)
                        c.setText(v);
                        else if (c.getXType && c.getXType() == "panel")
                        c.body.update(v);
                    }
                    // alert(c.ownerCt.el.dom.innerHTML);
                }
            }
            this.onView(win,record.data);
            // this.fp.form.loadRecord(record);
            return win;
        },
        viewObject:function(id,callback){
            var win = this.showViewWin(true);
            var viewCmd=this.viewCmd||"view";
            Ext.Ajax.request({url:this.formatUrl(viewCmd),params:{id:id},waitMsg:"正在加载数据,请稍侯...",callback:function(options,success,response){
                var r = Ext.decode(response.responseText);
                for (var n in r) {
                var c = win.getComponent(0).findSomeThing(n);
                
                if (c) {                
                    var v = r[n];   
                    if (c.isFormField) {
                        c.setValue(v);
                        c.clearDirty();
                    } else{
                        if(c.renderer)v=c.renderer(v);
                         if (c.setText)
                        c.setText(v);
                        else if (c.getXType && c.getXType() == "panel")
                        c.body.update(v);
                    }
                }
            }
            if(callback)callback(win,r);
            this.onView(win,r);
            },scope:this});
        },
        showViewWin : function(autoClose) {
            if (!this.viewPanel) {
                if(this.createViewPanel){
                    this.viewPanel = this.createViewPanel();
                }else{
                    if(this.fp){
                        this.viewPanel = this.fp;
                    }else{
                        this.viewPanel = this.createForm();
                    }
                }
            }
            var win = this.getViewWin(autoClose);
            return win;
        },
        doSearch:function(){
            var win = EasyJF.Ext.CrudSearchWindow;
            var o = win.getComponent(0).form.getValues(false);          
            var service=win.crudService;
            service.store.baseParams = Ext.apply(o,{searchType:'advancedSearch',pageSize:service.store.baseParams.pageSize||service.pageSize});
            win.hide();
            if(service.searchField&&service.cleanQuickSearch){
                service.searchField.reset();
            }
            service.search();
        },
        advancedSearch : function() {
            return this.superSearchWin(this.searchWin.width, this.searchWin.height,
                    this.searchWin.title);
        },
        <div id="method-EasyJF.Ext.Util-superSearchWin"></div>/**
         * 高级查询
         */
        superSearchWin : function(width, height, title) {
            var isNew = !EasyJF.Ext.CrudSearchWindow;           
            if (!this.searchPanel) {
                if (this.searchFP || this.searchFormPanel) {
                    this.searchPanel = this.searchFP ? this.searchFP() : this
                            .searchFormPanel();
                }
            }
            if (!this.searchPanel)
                return null;// 如果没有定义searchFP或searchFormPanel，则返回
            var win=this.createGlobalWin("CrudSearchWindow",width,height,title,this.searchPanel,null,"searchPanel",[{
                                id:"tb_search",
                                text : "查询",
                                handler : this.doSearch,
                                iconCls : 'search',
                                scope:this
                            }, {
                                text : "重置",
                                iconCls : 'clean',
                                handler : function() {
                                    EasyJF.Ext.CrudSearchWindow.getComponent(0).form
                                            .reset();
                                }
                            }, {
                                text : "关闭",
                                iconCls : 'delete',
                                handler : function() {
                                    EasyJF.Ext.CrudSearchWindow.hide()
                                }
                            }]);
            if(isNew){
                /*
                 * var map = new Ext.KeyMap(win.el,{ key: 13, fn: this.doSearch
                 * });
                 */
            }                                           
            return win;             
        },
        <div id="method-EasyJF.Ext.Util-toggleDetails"></div>/**
         * 改变grid视图的显示方式
         */
        toggleDetails : function(obj) {
            var view = this.grid.getView();
            if (view.showPreview)
                view.showPreview = false;
            else
                view.showPreview = true;
            view.refresh();
        },
        swapSequence : function(down,inform) {
            return function() {
                var record = this.grid.getSelectionModel().getSelected();
                if (!record) {
                    this.alert("请先选择要操作的数据！","提示");
                    return;
                }
                var id = record.get("id");
                Ext.Ajax.request({
                    url : this.formatUrl("swapSequence"),
                    params : {
                        'id' : record.get("id"),
                        down : down ? down : "",
                        parentId : this.parentId,
                        sq : this.grid.store.find("id", id) + 1
                    },
                    method : 'POST',
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            this.alert("操作失败，失败原因：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"),"提示信息");
                        else {
                            if(inform){
                            Ext.Msg.alert("提示","操作成功", function() {
                                        this.store.reload();
                                        this.focus();
                                    }, this);
                            }
                            else {
                                this.store.reload();
                            }
                        }
                    },
                    scope : this
                });
            }
        },
        insertGridButton : function() {
            this.gridButtons.splice(10, 0, arguments);
        },
        showContextMenu : function(g, i, e) {
            if(this.menu){
            var evn = e ? e : g;
            evn.preventDefault();
            if (i>=0) {
                this.grid.getSelectionModel().selectRow(i, false);
            }
            this.menu.showAt(evn.getPoint());
            }
        },
        doOperate:function(grid,rowIndex,columnIndex,e){
                    var tag=e.getTarget("A",3);
                    if(tag){
                        var id=tag.getAttribute("theid");
                        var cmd=tag.getAttribute("op");
                        var cf=tag.getAttribute("cf");
                        if(id&&cmd)
                        this.operate(cmd,id,cf,grid,rowIndex,columnIndex,e);
                    }
        },
        operate:function(cmd,id,cf,grid,rowIndex,columnIndex,e){
            if(cmd=="edit")this.edit();
            else if(cmd=="view")this.view();
            else if(cmd=="remove")this.removeData();
            else {
            if(!cf)this.executeUrl(this.baseUrl,{cmd:cmd,id:id},this.refresh.createDelegate(this))();
            else Ext.Msg.confirm("提示","确认要执行该操作吗?",function(btn){
                if(btn=="yes")this.executeUrl(this.baseUrl,{cmd:cmd,id:id},this.refresh.createDelegate(this))();
                else this.focus();
            },this);
            }
        },
        findOperatorByProperty:function(name,value){
            return this.findOperatorBy(function(o){if(o[name]==value)return true;});
        },
        findOperatorBy:function(callback){
            var objs=[];
            this.operators.each(function(o){
                if(typeof o !="string"){
                    if(callback && callback(o))objs.push(o);
                }
            });
            return objs;
        },
        toggleSingleRowOperator:function(enable){
            var ids=this.findOperatorByProperty("singleRow",true);
            var args=[];
            if(ids && ids.length){
                for(var i=0;i<ids.length;i++)args.push(ids[i].name||ids[i].id);
            }
            if(enable)this.enableOperaterItem(args);
            else this.disableOperaterItem(args);
        },
        toggleAllOperator:function(enable){
            var args=[];
            this.operators.each(function(o){
                if(typeof o !="string"){
                    args.push(o.name||o.id);
                }
            });
            if(enable){
                this.enableOperaterItem(args);
            }
            else {this.disableOperaterItem(args);}
        },
        // 子类中可以重写该钩字方法可用状态
        onRowSelection:function(record,index,sel){
            var sel=this.grid.getSelections();
            if(sel&&sel.length>1){
                this.toggleSingleRowOperator(false);
            }else this.toggleSingleRowOperator(true);
            var ids=this.findOperatorByProperty("batch",true);// 打开支持批量操作的按钮
            var args=[];
            if(ids && ids.length){
                for(var i=0;i<ids.length;i++)args.push(ids[i].name||ids[i].id);
            }
            this.enableOperaterItem(args);
        },
        changeOperaterItem:function(args,callback){
            if(args.length==1 && Ext.isArray(args[0]))args=args[0];
            if(this.grid.getTopToolbar()&&this.grid.getTopToolbar().items){// 已经渲染
                for(var i=0;i<args.length;i++){
                    if(this.menu && this.menu.items){
                    var o=this.menu.items.find(function(c){
                        var n1=c.name||c.id;
                        if(n1==args[i])return true;
                    });
                    if(o)callback(o); 
                    }
                    o=this.grid.getTopToolbar().items.find(function(c){
                        var n1=c.name||c.id;
                        if(n1==args[i])return true;
                    });
                    if(o)callback(o);
                }
            }
            else {
                this.grid.on("render",function(){
                    for(var i=0;i<args.length;i++){
                        var o=this.grid.getTopToolbar().items.find(function(c){
                            var n1=c.name||c.id;
                            if(n1==args[i])return true;
                        });;
                        if(o)callback(o);
                    }
                },this);
            }
        },
        // 让一系列的菜单项变成可用状态
        enableOperaterItem:function(){
            var args=arguments;
            this.changeOperaterItem(args,function(o){if(o.enable)o.enable();});
        },
        // 禁用一系列的菜单项
        disableOperaterItem:function(){
            var args=arguments;
            this.changeOperaterItem(args,function(o){if(o.disable)o.disable();});
        },
        // 显示一系列的菜单及工具栏项
        showOperaterItem:function(){
            var args=arguments;
            this.changeOperaterItem(args,function(o){if(o.show)o.show();});
        },
        // 隐藏一系列的菜单及工具栏项
        hideOperaterItem:function(){
            var args=arguments;
            this.changeOperaterItem(args,function(o){if(o.hide){o.hide();}});
        },
        operatorConfig2Component:function(o,isMenu){
            var co=Ext.apply({},o);
            if(!co.handler){
                    if(co.method && this[co.method]){
                    co.handler=this[co.method];
                    }else
                    if(co.cmd)co.handler=co.batch?this.executeMulitCmd(co.cmd):this.executeCmd(co.cmd);
            }
            if(co.handler&&!co.scope)co.scope=this;
            if(!isMenu){//对按钮的样式作处理
            if(this.operatorButtonStyle==2){
                if(co.icon){co.cls="x-btn-icon";co.text="";}
            }
            else if(this.operatorButtonStyle==3){
                co.icon="";
                co.cls="";
            }}
            var key=co.name||co.id;
            if(key=="searchField")co.store=this.store;
            else if(key=="btn_advancedSearch"){
            co.hidden=!((this.searchFormPanel || this.searchFP) && this.allowSearch);
            }
            return co;
        },
        buildCrudOperator:function(){
            if(!this.operators)this.initOperator();
            var bs=[];
            this.operators.each(function(c){
                if(typeof c =="string"){
                    bs.push(c);
                }
                else {
	                if(!c.showInMenuOnly){
		                var co=this.operatorConfig2Component(c);
		                var key=co.name||co.id;
		                try{
		                	if(Ext.isString(co.type)){
		                		//if(Ext.ComponentMgr.isRegistered(co.type));
			                	this[key]=Ext.create(co,co.type);
		                	}else{
		                		this[key]=new Ext.Toolbar.Button(co);
		                	}
			                bs.push(this[key]);
		                }catch(e){
		                    alert(key+":"+e);
		                }
	                }
                }
            },this);
            
            // 创建菜单
            if (!this.menu) {
                var ms=[];
                this.operators.each(function(c){
                    if(typeof c =="string" ){
                        if(c=="-")ms.push(c);
                    }else {
                        if(!c.showInToolbarOnly){
                        	var co=this.operatorConfig2Component(c,true);
                        	if(!co.type)ms.push(co);
                        }
                    }
                },this);
                ms.push({
                    name:"btn_help",
                    text : "帮助",
                    handler:this.help,
                    scope:this
                });
                this.menu = new Ext.menu.Menu({
                    items : ms
                });
            }
            return bs;
        },
        initOperator:function(){
            this.initDisableOperators();
            this.operators=new Ext.util.MixedCollection();
            for(var i=0;i<this.crud_operators.length;i++){
                var co=this.crud_operators[i];
                if(typeof co =="object"){
                co=Ext.apply({},co);
                if(!co.batch && !co.noneSelectRow)co.singleRow=true;// noneSelectRow表示不需要进行行选择
                }
                var key=co.name||co.id;
                if(key && this.disable_operators.indexOf(key)>=0)continue;// 如果被禁用,则不用加入到operators中
                this.operators.add(co);
            }
            if(this.customizeQueryObject){
                this.operators.add({showInToolbarOnly:true,name:"btn_customizeQuery",cls : "x-btn-icon",icon : "images/icon-png/srsearch.gif", tooltip:"自定义查询",text:"", menu:["-",{text:"保存当前查询条件",handler:this.createQueryObject,scope:this},{text:"管理自定义查询",handler:this.manageQueryObject,scope:this}]}) 
            }
            if (this.gridButtons){
                var bi=(this.disable_operators.indexOf("searchField")>=0?this.operators.getCount()-1:this.operators.getCount()-2);
                this.insertOperator(bi,this.gridButtons);
            }
        },
        insertOperator:function(index,items){
            if(!this.operators){
                this.initOperator();
            }
            if(!Ext.isArray(items))items=[items];
            if(this.operators.getCount()<index)index=this.operators.getCount();
            var haveRender=this.grid&&this.grid.getTopToolbar&&this.grid.getTopToolbar()&&this.grid.getTopToolbar().items;
            for(var i=0;i<items.length;i++){
                var co=items[i];
                if(typeof co =="object"){
                co=Ext.apply({},co);
                if(!co.batch && !co.noneSelectRow)co.singleRow=true;// noneSelectRow表示不需要进行行选择
                }
                this.operators.insert(index+i,co);
                if(haveRender){
                    if(!co.showInMenuOnly){
                    var bo=this.operatorConfig2Component(Ext.apply({},co));
                    this.grid.getTopToolbar().insert(index+i,bo);
                    }
                    if(!co.showInToolbarOnly){
                    var mo=this.operatorConfig2Component(co,true);
                    if(this.menu)this.menu.insert(index+i, new Ext.menu.Item(mo));
                    }
                }
            }
        },
        initDisableOperators:function(){
            if(!this.disable_operators){this.disable_operators=[];}
            if(!this.exportData)this.disable_operators.push("btn_export");
            if(!this.importData)this.disable_operators.push("btn_import");
            if(!this.printData)this.disable_operators.push("btn_print");
            if(!this.clearData)this.disable_operators.push("btn_clearSearch");
            if(!this.allowSearch)this.disable_operators.push("btn_advancedSearch");
            if(!this.showAdd)this.disable_operators.push("btn_add");
            if(!this.showEdit)this.disable_operators.push("btn_edit");
            if(!this.showRemove)this.disable_operators.push("btn_remove");
            if(!this.showView)this.disable_operators.push("btn_view");
            if(!this.showRefresh)this.disable_operators.push("btn_refresh");
            if(!this.showSearchField)this.disable_operators.push("searchfield");
        },
        manageQueryObject:function(){
            var win=new UserQueryObjectWin({crudService:this,objName:this.queryObjectName});
            win.show();
        },
        createQueryObject:function(){
            if (!this.searchQueryObjectPanel) {
                if (this.searchFP || this.searchFormPanel) {
                    this.searchQueryObjectPanel= this.searchFP ? this.searchFP() : this.searchFormPanel();
                    this.searchQueryObjectPanel.insert(0,{fieldLabel : '查询器名称',xtype:"textfield",name:"queryObjectName",anchor:"-20",allowBlank:false});
                    this.searchQueryObjectPanel.insert(1,{fieldLabel : '关键字',xtype:"textfield",name:"searchKey",anchor:"-20"});
                }
            }
            if (!this.searchQueryObjectPanel)
                return null;// 如果没有定义searchFP或searchFormPanel，则返回
            var win=this.createGlobalWin("CrudQueryObjectWindow",this.searchWin.width, this.searchWin.height+60,"保存查询条件",this.searchQueryObjectPanel,null,"searchQueryObjectPanel",[{
                                id:"tb_search",
                                text : "保存",
                                handler : this.saveQueryObject,
                                iconCls : 'search'
                            },{
                                text : "取消",
                                iconCls : 'delete',
                                handler : function() {
                                    EasyJF.Ext.CrudQueryObjectWindow.hide()
                                }
                            }]);
            win.getComponent(0).form.setValues(this.store.baseParams||{});
            win.getComponent(0).form.findField("queryObjectName").setValue("");
        },
        saveQueryObject:function(){
            var win = EasyJF.Ext.CrudQueryObjectWindow;
            if(!win.getComponent(0).form.isValid()){
                Ext.Msg.alert("提示","必填项必须填写!");
                return ;
            }
            var o = win.getComponent(0).form.getValues(false);
            var title=o.queryObjectName;
            delete o.queryObjectName;
            var service=win.crudService;
            
            var params={title:title,content:Ext.urlEncode(o),objName:service.queryObjectName};
            Ext.Ajax.request({url:"userQueryObject.ejf?cmd=save",params:params,success:function(response){
                var ret=Ext.decode(response.responseText);
                if(ret.success){
                this.addQueryObjectOperator([params]);
                Ext.Msg.alert("提示","操作成功!",this.focus,this);
                win.hide();
                }
                else {
                    Ext.Msg.alert("无法保存",ret.errors.msg,function(){win.getComponent(0).form.findField("searchKey").focus();});
                }
            },scope:service});
        },
        searchByQueryObject:function(c){
            if(c.content){
                var params=Ext.urlDecode(c.content);
                if(this.searchField)
                this.searchField.setValue(params.searchField||"");
                this.store.baseParams=params;
                if(this.store.lastOptions&&this.store.lastOptions.params)
                this.store.lastOptions.params.start=0;
            }
            this.refresh();
        },
        addQueryObjectOperator:function(objs){
            if(objs&&objs.length){
                var o=this.operators.find(function(c){
                    var n1=c.name||c.id;
                    if(n1=="btn_customizeQuery")return true;
                });
                if(!o)return;
                var haveRender=this.grid&&this.grid.getTopToolbar&&this.grid.getTopToolbar()&&this.grid.getTopToolbar().items;
                var btn_customizeQuery=this["btn_customizeQuery"];
                for(var i=0;i<objs.length;i++){
                    var co=objs[i];
                    co.scope=this;
                    co.text=co.title;
                    co.name="query_menu"+co.title;
                    co.handler=this.searchByQueryObject;
                    o.menu.splice(0,0,co);
                    if(btn_customizeQuery){
                        btn_customizeQuery.menu.insert(0,new Ext.menu.Item(co));
                    }
                }
                
            }
        },
        removeQueryObjectOperator:function(name){
            var btn_customizeQuery=this["btn_customizeQuery"];
            if(btn_customizeQuery){
                var item=btn_customizeQuery.menu.items.find(function(c){
                    var n1=c.name||c.id;
                    if(n1=="query_menu"+name)return true;
                });
                if(item)btn_customizeQuery.menu.remove(item);
            }
        },
        useOperatorsPermission:function(args){
            var ret=args||this.permissions;
            var args=[];
            for(var i=0;i<ret.length;i++){
                args.push(ret[i]);
                var o=this.operators.find(function(c){
                            var n1=c.name||c.id;
                            if(n1==args[i])return true;
                });
                if(o)o.hidden=false;
            }
            this.showOperaterItem(args);
            this.fireEvent("usepermission",this);
        },
        loadOperatorsPermission:function(){
            var args={},names=[],actions=[],cmds=[];
            var baseUrl=this.baseUrl;
            this.operators.each(function(o){
                if(typeof o !="string"){
                    if(!o.clientOperator && (o.cmd||o.method)){
                        actions.push(o.action||baseUrl);
                        cmds.push(o.cmd||o.method||"");
                        names.push(o.name||o.id||"");
                    }
                }
            });
            if(!this.permissions){
                var objs={names:names,actions:actions,cmds:cmds};
                if(this.customizeQueryObject&&this.queryObjectName){
                    objs.queryObjectName=this.queryObjectName;
                }
                if(Lanyo_Ajax.permissionCheck){
                Ext.Ajax.request({url:(Lanyo_Ajax.permissionCheckAction||"permissionCheck.ejf"),params:objs,callback:function(options,success,response){
                    var ret=Ext.decode(response.responseText);
                    if(ret&&ret.permissions&&ret.permissions.length){// 处理权限
                        this.permissions=ret.permissions;
                        this.useOperatorsPermission();
                    }
                    if(ret&&ret.queryObjects){
                        this.addQueryObjectOperator(ret.queryObjects);
                    }
                },scope:this});
                }
                else {
                     this.permissions=["btn_add","btn_edit","btn_view","btn_remove","btn_refresh"];
                     this.useOperatorsPermission();
                }
            }
            else {
                this.useOperatorsPermission();
            }
        },      
        checkAdnLoadColumnField:function(){
            if(!this.storeMapping){
                var url=this.baseUrl+"?cmd=loadColumnField";
                if(this.entityClzName){
                    url="extApp.ejf?cmd=loadColumnField&entityClzName="+this.entityClzName;
                }
                var ajax=Ext.lib.Ajax.syncRequest("POST",url,"");
                var ret=Ext.decode(ajax.conn.responseText);
                if(ret&&ret.fields){
                this.storeMapping=ret.fields;
                if(ret.columnMap && !this.columns && !this.cm){
                    this.columns=[];
                    for(var index in ret.columnMap){
                        var c=ret.columnMap[index];
                        c.dataIndex=c.name;
                        if(!c.header)c.header=c.name;
                        var d=[];
                        if(this.autoDisplayFields && this.autoDisplayFields.indexOf(c.name)<0){
                            c.hidden=true;
                        }
                        if(this.autoHideFields&&this.autoHideFields.indexOf(c.name)>=0){
                            c.hidden=true;
                        }
                        if(this.disableHideableFields &&this.disableHideableFields.indexOf(c.name)>=0 ){
                            c.hideable=false;
                        }
                        if(c.sortable===undefined){
                            if(c.type!="object"){
                                c.sortable=true;
                            }
                        }
                        if(!c.renderer){// 自动处理Renderer
                        if(c.type=="date"){
                            c.renderer=this.dateRender("Y-m-d");
                        }
                        else if(c.type=="object" || c.type=="map"){
                            c.renderer=this.objectAutoRender;
                        }
                        }
                        else {// 把renderer转换成javascript对象
                        try{c.renderer=Ext.decode(c.renderer);}catch(e){}
                        }
                        this.columns.push(c);
                    }                   
                }
                }
            }
        },
        haveOperatorRights:function(btn){
            return this[btn]&& (!(this[btn].disabled ||this[btn].hidden));
        },
        handleCrudKey:function(e){
            if(!(e.isSpecialKey()||e.altKey||e.getKey()==e.DELETE))return;
            if(e.getKey()==Ext.EventObject.ENTER && !e.ctrlKey){
                e.stopEvent();
                this.edit();
            }
            else if(e.altKey && e.getKey()=='c'.charCodeAt(0) && this.haveOperatorRights("btn_edit") && this.copy){
                e.stopEvent();
                this.copy();
            }
            else if(e.altKey&&e.getKey()=='a'.charCodeAt(0) && this.haveOperatorRights("btn_add")){
                e.stopEvent();
                this.create();
            }
            else if(e.altKey&&e.getKey()=='e'.charCodeAt(0)&& this.haveOperatorRights("btn_edit")){
                e.stopEvent();
                this.edit();
            }
            else if(e.altKey&&e.getKey()=='v'.charCodeAt(0)&& this.haveOperatorRights("btn_view")){
                e.stopEvent();
                this.view();
            }
            else if((e.getKey()==e.DELETE ||(e.altKey&&e.getKey()=='d'.charCodeAt(0))) &&this.haveOperatorRights("btn_remove") ){
                e.stopEvent();
                this.removeData();
            }
            else if(e.altKey&&e.getKey()=='s'.charCodeAt(0)){
                e.stopEvent();
                this.advancedSearch();
                
            }
            else if((e.getKey()==e.PRINT_SCREEN ||(e.altKey&&e.getKey()=='p'.charCodeAt(0))) &&this.haveOperatorRights("btn_print") ){
                e.stopEvent();
                this.printRecord();
            }
            else if(e.altKey&&e.getKey()=='o'.charCodeAt(0)&& this.haveOperatorRights("btn_export")){
                e.stopEvent();
                this.exportExcel();
                
            }
            else if(e.altKey&&e.getKey()=='i'.charCodeAt(0)&& this.haveOperatorRights("btn_import")){
                e.stopEvent();
                this.importExcel();
                
            }
            
        },
        initCrudEventHandler:function(){
            // 双击表格行进入编辑状态
            this.grid.on("celldblclick", this.edit, this);
            this.grid.on("cellclick",this.doOperate,this);
            this.grid.on("keypress",this.handleCrudKey,this);
            this.grid.getSelectionModel().on("rowselect",function(g,index,r){
                    this.onRowSelection(r,index,g);
                },this);
            if (this.showMenu) {
                this.grid.on("rowcontextmenu", this.showContextMenu, this);         
            }
            EasyJF.Ext.Util.autoFocusFirstRow(this.grid);
        },
        focus:function(){
            this.focusCrudGrid();
        },
        focusCrudGrid:function(grid){
            var g=grid||this.grid;
            if(g&&g.rendered){
            var sel=g.getSelectionModel();
            if(sel && sel.hasSelection()) {
                g.getView().focusRow(g.store.indexOf(g.getSelectionModel().getSelected()));
            }else if(g.store.getCount()){
                g.getView().focusRow(0);
            }else {
                g.focus();
            }}
        },
        help:function(){
            // Ext.Msg.show({title:"系统帮助",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,msg:"欢迎使用本系统，本系统由成都蓝源信息技术有限公司开发!<br/>联系电话:028-86272612
            // <br/>网址：<a href='http://www.vifir.com'
            // target='_blank'>http://www.vifir.com</a>",maxWidth:100});
            Ext.Msg.show({title:"系统帮助",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,msg:"欢迎使用本系统!",maxWidth:100});
        }
    }   
<div id="cls-EasyJF.Ext.CrudPanel"></div>/**
 * 增、删、改、查基类
 * 
 * @class EasyJF.Ext.CrudPanel
 * @extends Ext.Panel
 */
EasyJF.Ext.CrudPanel = Ext.extend(Ext.Panel, {
    viewWin : {
        width : 650,
        height : 410,
        title : "详情查看"
    },
    searchWin : {
        width : 630,
        height : 300,
        title : "高级查询"
    },// 查询窗口的高度、宽度及标题
    gridViewConfig : {},// 表格显示视图的自定义配置
    gridConfig : {},// 表格的自定义配置
    baseQueryParameter : {},// 查询初始化参数
    localStoreVar:window.undefined,// 客户端cache的名称
    //private
    bulidGridStore : function(){
    	var storeConfig = {
            id : this.storeId?this.storeId:"id",
            url : this.defaultCmd?(this.formatUrl('list')):this.baseUrl,
            root : "result",
            totalProperty : "rowCount",
            pageSize : this.pageSize,
            remoteSort : true,
            fields : this.storeMapping
        };
        if(Ext.isEmpty(this.localStoreVar,false)){
            this.store = new Ext.data.JsonStore(storeConfig);
        }else{
            this.store = new EasyJF.Ext.CachedRemoteStore(Ext.apply({varName:this.localStoreVar,pageSize:Ext.num(this.pageSize,20)},storeConfig));
        }
        
        this.store.baseParams=Ext.apply({},{limit:this.pageSize||""},this.initQueryParameter||{});
        if(Ext.objPcount(this.baseQueryParameter)){
            this.store.on('beforeload',function(store,options){
                Ext.apply(store.baseParams,this.baseQueryParameter);
            },this);
        }
        this.store.paramNames.sort = "orderBy";
        this.store.paramNames.dir = "orderType";
        return this.store ;
    },
    initComponent : function() {
        this.checkAdnLoadColumnField();
        this.store = this.bulidGridStore();
        
        this.addEvents("saveobject","removeobject");// 增加saveobject及removeobject事件
        EasyJF.Ext.CrudPanel.superclass.initComponent.call(this);
        
        var buttons=this.buildCrudOperator();
        
        var viewConfig = Ext.apply({forceFit : this.gridForceFit}, this.gridViewConfig);
        var gridConfig = Ext.apply(this.gridConfig, {
                        store : this.store,
                        stripeRows : true,
                        trackMouseOver : false,
                        loadMask : true,
                        viewConfig : viewConfig,
                        tbar:buttons,
                        border : false,
                        bbar : this.pagingToolbar ? new Ext.ux.PagingComBo({
                            rowComboSelect:true,
                            pageSize : this.pageSize,
                            store : this.store,
                            displayInfo : true
                        }) : null
                    });
            if(this.summaryGrid){
                if(gridConfig.plugins){
                    if(typeof gridConfig.plugins=="object")gridConfig.plugins=[gridConfig.plugins];
                }
                else gridConfig.plugins=[];
                gridConfig.plugins[gridConfig.plugins.length]=new Ext.ux.grid.GridSummary();
            }   
            if(this.columns){
            	gridConfig.columns=this.columns;
            }else if(this.cm){
            	gridConfig.cm=this.cm;
            }
            if(this.columnLock && Ext.grid.LockingGridPanel){
                if(!gridConfig.columns && gridConfig.cm){
                    gridConfig.columns=gridConfig.cm.config;
                    delete gridConfig.cm;
                }   
           	 	this.grid = new Ext.grid.LockingGridPanel(gridConfig);
            }else{
            	this.grid=new Ext.grid.GridPanel(gridConfig);
            }
	       //	this.grid.colModel.defaultSortable = true;// 设置表格默认排序
	        
	        this.loadOperatorsPermission();
	        // 双击表格行进入编辑状态
	        this.initCrudEventHandler();
	        this.add(this.grid);
	        
	        if(this.autoLoadGridData)this.store.load();
    }
});
Ext.applyIf(EasyJF.Ext.CrudPanel.prototype,EasyJF.Ext.CrudFunction);

// ExtApp的基类，用于实现通过iframe的方式把指定script文件中的指定appClass加载到iframe中显示
ExtAppBasePanel = Ext.extend(Ext.Panel, {
    appClass : "",
    script : "",
    otherScripts : "",
    border : false,
    layout : "fit",
    closable : true,
    initComponent : function() {
        // this.html="<iframe frameborder='0' scrolling='auto'
        // src='extApp.ejf?appClass=BBSDirManagePanel&script=bbs.js'></iframe>";
        ExtAppBasePanel.superclass.initComponent.call(this);
        this.on("resize", function(c) {
            if (!c.framePanel) {
                var h = "<iframe width='100%' height='"
                        + c.body.getHeight(true)
                        + "px' frameborder='0' scrolling='auto' src='extApp.ejf?appClass="
                        + this.appClass + "&script=" + this.script
                        + "&otherScripts=" + this.otherScripts + "&params="+this.params+"'></iframe>";
                c.body.update(h);
                c.framePanel = c.body.dom.firstChild;
            } else {
                c.framePanel.height = c.body.getHeight(true);
            }
        }, this)
    }
});
<div id="cls-EasyJF.Ext.TreeComboField"></div>/**
 * 树状下拉框,基于TriggerFiel可以下拉出一个TreePanel供用户选择 
 * @class EasyJF.Ext.TreeComboField
 * @extends Ext.form.TriggerField
 */
EasyJF.Ext.TreeComboField = Ext.extend(Ext.form.TriggerField, {
            valueField : "id",
            displayField : "name",
            minListWidth : 70,
            haveShow : false,
            editable : false,
            returnObject : false,
            leafOnly : false,
            clicksFinishEdit : 1,
            readOnly:false,
            hiddenNodes:[],
            initEvents : function(){
	            EasyJF.Ext.TreeComboField.superclass.initEvents.call(this);
	                this.keyNav = new Ext.KeyNav(this.el, {
	                  "up" : function(e){
	                    this.inKeyMode = true;
	                    this.selectPrevious();
	                },
	    
	                "down" : function(e){
	                    if(!this.isExpanded()){
	                        this.onTriggerClick();
	                    }else{
	                        this.inKeyMode = true;
	                        this.selectNext();
	                    }
	                },
	                "enter" : function(e){
	                    var sm = this.tree.getSelectionModel();
	                    if(sm.getSelectedNode()){
	                        var node = sm.getSelectedNode();
	                        this.choice(node);
	                        sm.clearSelections();
	                        return ;
	                    }
	                },
	                "esc" : function(e){
	                    this.collapse();
	                },
	            scope : this
	        });
	        this.queryDelay = Math.max(this.queryDelay || 10,
	                this.mode == 'local' ? 10 : 250);
	        this.dqTask = new Ext.util.DelayedTask(this.initQuery, this);
	        if(this.typeAhead){
	            this.taTask = new Ext.util.DelayedTask(this.onTypeAhead, this);
	        }
	        if(this.editable !== false){
	            this.el.on("keyup", this.onKeyUp, this);
	        }
	        if(this.forceSelection){
	            this.on('blur', this.doForce, this);
	        }
        },
        selectPrevious:function(){
                var sm = this.tree.getSelectionModel();
                if(!sm.selectPrevious()){
                    var root = this.tree.getRootNode();
                    sm.select(root);
                    this.el.focus();
                }else{
                    this.el.focus();
                }
            },
            selectNext : function(){
                var sm = this.tree.getSelectionModel();
                if(!sm.selectNext()){
                    var root = this.tree.getRootNode();
                    sm.select(root);
                    this.el.focus();
                }else{
                    this.el.focus();
                }
            },
            onTriggerClick : function() {
                if(this.readOnly || this.disabled){
                    return false;
                }else if (!this.tree.rendered || !this.list) {
                    this.treeId = Ext.id();
                    this.list = new Ext.Layer({
                        id : this.treeId,
                        cls : "x-combo-list",
                        constrain:false
                    });                 
                    if(!this.innerDom)this.innerDom=Ext.getBody().dom;  
                    if(this.tree.rendered){
                        this.list.appendChild(this.tree.el);
                    }
                    else {
                        this.tree.render(this.treeId);
                        var lw = this.listWidth || Math.max(this.wrap.getWidth(), this.minListWidth);                                   
                        this.tree.setWidth(lw);
                        this.tree.on("expandnode",this.restrictHeight,this);
                        this.tree.on("collapsenode",this.restrictHeight,this);
                    }
                }
                else this.restrictHeight();
                this.expand();
            },
            restrictHeight : function(){
                // this.list.dom.style.height = '';
                if(!this.list)return;
                var inner = this.innerDom;                                  
                var h=inner.clientHeight-this.wrap.getBottom();                 
                if(this.tree.el.dom.offsetHeight>=h){
                    this.tree.setHeight(h);
                }
                else {
                    this.tree.setHeight("auto");
                }
               // this.list.alignTo(this.getEl(), "tl-bl?");
            },
           
            filterTree:function(e){
                if(!this.isExpanded())this.expand();
                var text = e.target.value;
                Ext.each(this.hiddenNodes, function(n){
                    n.ui.show();
                });
                if(!text){
                    this.filter.clear();
                    return;
                }
                this.tree.expandAll();
                this.restrictHeight();
                this.filter.filterBy(function(n){
                    return (!n.attributes.leaf || n.text.indexOf(text)>=0);
                });
                
                // hide empty packages that weren't filtered
                this.hiddenNodes = [];
                this.tree.root.cascade(function(n){
                    if(!n.attributes.leaf && n.ui.ctNode.offsetHeight < 3){
                        n.ui.hide();
                        this.hiddenNodes.push(n);
                    }
                },this);
            },
            expand :function(){
                if(this.list){
                    Ext.getDoc().on('mousedown', this.hideIf, this);
                    /*if(!this.tree.body.isScrollable()){
                    	this.tree.setHeight('auto');
                    }*/
                    this.list.show();
                    this.list.alignTo(this.getEl(), "tl-bl?");
                }
                else {
                    this.onTriggerClick();
                }
            },
            collapse : function(){
                 if(this.list){
                 this.list.hide();
                 Ext.getDoc().un('mousedown', this.hideIf, this);
                 }
            },
            onEnable: function(){
                EasyJF.Ext.TreeComboField.superclass.onEnable.apply(this, arguments);
                if(this.hiddenField){
                    this.hiddenField.disabled = false;
                }
            },
            onDisable: function(){
                EasyJF.Ext.TreeComboField.superclass.onDisable.apply(this, arguments);
                if(this.hiddenField){
                    this.hiddenField.disabled = true;
                }
                Ext.getDoc().un('mousedown',this.hideIf,this);
            },
            hideIf:function(e){
                if(!e.within(this.wrap) && !e.within(this.list)){
                   this.collapse();
                }
            },
            initComponent : function() {
                EasyJF.Ext.TreeComboField.superclass.initComponent.call(this);
                this.addEvents('beforeSetValue');
                this.filter = new Ext.tree.TreeFilter(this.tree, {
                    clearBlank: true,
                    autoClear: true
                });
            },
            onRender : function(ct, position) {
                EasyJF.Ext.TreeComboField.superclass.onRender.call(this, ct,
                        position);
                if (this.clicksFinishEdit > 1)
                    this.tree.on("dblclick", this.choice, this);
                else
                    this.tree.on("click", this.choice, this);
                if (this.hiddenName) {
                    this.hiddenField = this.el.insertSibling({
                                tag : 'input',
                                type : 'hidden',
                                name : this.hiddenName,
                                id : (this.hiddenId || this.hiddenName)
                            }, 'before', true);
                    this.hiddenField.value = this.hiddenValue !== undefined
                            ? this.hiddenValue
                            : this.value !== undefined ? this.value : '';
                    this.el.dom.removeAttribute('name');
                }
                if (!this.editable) {
                    this.editable = true;
                    this.setEditable(false);
                }
                else {
                    this.el.on('keydown', this.filterTree, this, {buffer: 350});
                }
            },
            getValue : function(returnObject) {
                if ((returnObject===true) || this.returnObject)
                    return typeof this.value != 'undefined' ? {
                        value : this.value,
                        text : this.text,
                        toString : function() {
                            return this.text;
                        }
                    } : "";
                return typeof this.value != 'undefined' ? this.value : '';
            },
            clearValue : function() {
                if (this.hiddenField) {
                    this.hiddenField.value = '';
                }
                this.setRawValue('');
                this.lastSelectionText = '';
                this.applyEmptyText();
                this.value="";
            },
			validate : function(){
                if(this.disabled || this.validateValue(this.processValue(this.getValue()))){
                    this.clearInvalid();
                    return true;
                }
                return false;
            },
            isValid : function(preventMark){
                if(this.disabled){
                    return true;
                }
                var restore = this.preventMark;
                this.preventMark = preventMark === true;
                var v = this.validateValue(this.processValue(this.getValue()));
                this.preventMark = restore;
                return v;
            },
             <div id="method-EasyJF.Ext.TreeComboField-validateValue"></div>/**
                 * Validates a value according to the field's validation rules
                 * and marks the field as invalid if the validation fails
                 * 
                 * @param {Mixed}
                 *            value The value to validate
                 * @return {Boolean} True if the value is valid, else false
                 */
            validateValue : function(value){
                if(value.length < 1 || value === null){ // if it's blank
                     if(this.allowBlank){
                         this.clearInvalid();
                         return true;
                     }else{
                         this.markInvalid(this.blankText);
                         return false;
                     }
                }
                if(value.length < this.minLength){
                    this.markInvalid(String.format(this.minLengthText, this.minLength));
                    return false;
                }
                if(value.length > this.maxLength){
                    this.markInvalid(String.format(this.maxLengthText, this.maxLength));
                    return false;
                }
                if(this.vtype){
                    var vt = Ext.form.VTypes;
                    if(!vt[this.vtype](value, this)){
                        this.markInvalid(this.vtypeText || vt[this.vtype +'Text']);
                        return false;
                    }
                }
                if(typeof this.validator == "function"){
                    var msg = this.validator(value);
                    if(msg !== true){
                        this.markInvalid(msg);
                        return false;
                    }
                }
                if(this.regex && !this.regex.test(value)){
                    this.markInvalid(this.regexText);
                    return false;
                }
                return true;
            },
            readPropertyValue : function(obj, p) {
                var v = null;
                for (var o in obj) {
                    if (o == p)return true;
                        // v = obj[o];
                }
                return v;
            },
            setValue : function(obj) {
                if (!obj) {
                    this.clearValue();
                    return;
                }
                if(this.fireEvent('beforeSetValue',this,obj)===false){return;}
                var v = obj;
                var text = v;
                var value = this.valueField || this.displayField;
                if (typeof v == "object" && this.readPropertyValue(obj, value)) {
                    text = obj[this.displayField || this.valueField];
                    v = obj[value];
                }
                
                var node = this.tree.getNodeById(v);
                if (node) {
                    text = node.text;
                } else if (this.valueNotFoundText !== undefined) {
                    text = this.valueNotFoundText;
                }
                this.lastSelectionText = text;
                if (this.hiddenField) {
                    this.hiddenField.value = v;
                }
                EasyJF.Ext.TreeComboField.superclass.setValue.call(this, text);
                this.value = v;
                this.text = text;
            },
            setEditable : function(value) {
                if (value == this.editable) {
                    return;
                }
                this.editable = value;
                if (!value) {
                    this.el.dom.setAttribute('readOnly', true);
                    this.el.on('mousedown', this.onTriggerClick, this);
                    this.el.addClass('x-combo-noedit');
                } else {
                    this.el.dom.setAttribute('readOnly', false);
                    this.el.un('mousedown', this.onTriggerClick, this);
                    this.el.removeClass('x-combo-noedit');
                }
            },
            choice : function(node, eventObject) {
                if((!this.leafOnly || node.isLeaf())){
                    if (node.id != "root"){
                        this.setValue(node.id);
                    }
                    else {
                        this.clearValue();
                        this.el.dom.value=node.text;
                    }
                    this.fireEvent('select', this, node);
                    this.collapse();
                    this.fireEvent('collapse', this);
                }else{
                    if (node.id == "root"){
                        this.clearValue();
                        this.el.dom.value=node.text;
                        this.fireEvent('select', this, node);
                        this.collapse();
                        this.fireEvent('collapse', this);
                    }
                }
            },
            validateBlur : function() {
                return !this.list || !this.list.isVisible();
            },
            isExpanded : function(){
                return this.list && this.list.isVisible();
            },
            canFocus:function(){
                return !this.disabled ;
            },
            onDestroy : function() {
                if (this.tree.rendered && this.list) {
                    this.list.hide();                   
                     this.list.destroy();
                    delete this.list;                                   
                }
                EasyJF.Ext.TreeComboField.superclass.onDestroy.call(this);
            }
        });
Ext.reg('treecombo', EasyJF.Ext.TreeComboField);

<div id="cls-EasyJF.Ext.CheckTreeComboField"></div>/**
 * 树状下拉框,可以下拉出一个TreePanel并且支持check选择 
 * @class EasyJF.Ext.CheckTreeComboField
 * @extends EasyJF.Ext.TreeComboField
 */
EasyJF.Ext.CheckTreeComboField = Ext.extend(EasyJF.Ext.TreeComboField, {
            leafOnly : false,// 只允许选择子节点
            editable : true,
            onTriggerClick : function() {
                if(this.disabled)return;
                if (!this.listPanel.rendered || !this.list) {
                    this.treeId = Ext.id();
                    this.list = new Ext.Layer({
                        id : this.treeId,
                        cls : "x-combo-list",
                        constrain:false
                    });                 
                    if(!this.innerDom)this.innerDom=Ext.getBody().dom;
                    if(this.listPanel.rendered){                        
                        this.list.appendChild(this.listPanel.el);
                    }
                    else {                                                  
                    this.listPanel.render(this.treeId);
                    var lw = this.listWidth || Math.max(this.wrap.getWidth(), this.minListWidth);                                   
                    this.listPanel.setWidth(lw);
                    this.tree.on("expandnode",this.restrictHeight,this);
                    this.tree.on("collapsenode",this.restrictHeight,this);
                    }
                    if(this.value)this.setCheckdNode(this.value);
                }
                else this.restrictHeight();     
                this.expand();
            },  
            restrictHeight : function(){
                // this.list.dom.style.height = '';
                if(!this.list)return;
                var inner = this.innerDom;                                  
                var h=inner.clientHeight-this.wrap.getBottom();                 
                if(this.listPanel.el.dom.offsetHeight>=h){
                    this.listPanel.setHeight(h);                    
                }
                else {
                    this.listPanel.setHeight("auto");
                    this.tree.setHeight("auto");
                }
                // alert(this.listPanel.el.dom.offsetHeight);
               // this.list.alignTo(this.getEl(), "tl-bl?");
            },
            initComponent : function() {
                EasyJF.Ext.CheckTreeComboField.superclass.initComponent
                        .call(this);
                this.listPanel = new Ext.Panel({
                        border : false,
                        bodyBorder : false,
                        buttonAlign : "center",
                        layout:"fit",
                        items : this.tree,
                        bbar : [{
                                    text : "确定选择",
                                    handler : this.choice,
                                    scope : this
                                }, {
                                    text : "清空",
                                    handler : this.cleanChoice,
                                    scope : this
                                }, {
                                    text : "取消",
                                    handler : this.cancelChoice,
                                    scope : this
                                }]
                    }); 
                
    
            },
            onRender : function(ct, position) {
                EasyJF.Ext.CheckTreeComboField.superclass.onRender.call(this,
                        ct, position);
                this.tree.on("checkchange", this.checkNode, this);
                
            },
            setCheckdNode:function(v){
                this.cleanCheckNode(this.tree.root);
                var vs=v.split(",");
                for(var i=0;i<vs.length;i++){
                var node=null;
                var valueField=this.valueField;
                this.tree.root.cascade(function(n){                     
                    if(n.attributes[valueField]==vs[i]){                        
                        node=n;
                        return false;
                    }
                });         
                if(node)this.checkNode(node,true);
                }
            },
            cleanCheckNode:function(node){
                var checked=false;
                node.cascade(function(n){
                    if (n.ui.checkbox) {
                        n.attributes.checked = n.ui.checkbox.checked = checked;
                        n.attributes.selectAll = checked;
                        if (checked)
                            n.ui.addClass("x-tree-selected");
                        else
                            n.ui.removeClass("x-tree-selected");
                        }
                }, this);
            },
            checkNode : function(node, checked) {
                node.cascade(function(n) {
                            if (n.ui.checkbox) {
                                n.attributes.checked = n.ui.checkbox.checked = checked;
                                n.attributes.selectAll = checked;
                                if (checked)
                                    n.ui.addClass("x-tree-selected");
                                else
                                    n.ui.removeClass("x-tree-selected");
                            }
                        }, this);
                node.bubble(function(n) {
                    if (n != node) {
                        if (!checked) {
                            n.attributes.selectAll = checked;
                            if (n.attributes.checked) {
                                n.ui.removeClass("x-tree-selected");
                            }
                        } else if (!n.attributes.checked) {
                            n.attributes.checked = n.ui.checkbox.checked = checked;
                        }
                    }
                });
            },
            getValue : function() {
                return typeof this.value != 'undefined' ? this.value : '';
            },
            clearValue : function() {
                if (this.hiddenField) {
                    this.hiddenField.value = '';
                }
                this.setRawValue('');
                this.lastSelectionText = '';
                this.applyEmptyText();
                if(this.list)this.cleanCheckNode(this.tree.root);
            },          
            getNodeValue : function(node) {
                if (node.attributes.selectAll
                        && (!this.leafOnly || node.attributes.leaf)) {
                    if (this.t != "")
                        this.t += ",";
                    if (this.v != "")
                        this.v += ",";
                    var text=node.attributes[this.displayField || this.valueField];
                    if(text===undefined)text=node.text;
                    var value=node.attributes[this.valueField];
                    if(value===undefined)value=node.id;
                    this.t +=text ;
                    this.v += value;
                } else if (node.attributes.checked)
                    node.eachChild(this.getNodeValue, this)
            },
            setValue : function(obj) {
                if (!obj) {
                    this.clearValue();
                    return;
                }
                var v = obj;
                var text = v;
                var value = this.valueField || this.displayField;
                if (typeof v == "object" && this.readPropertyValue(obj, value)) {// 直接传入值
                    
                    text = obj[this.displayField || this.valueField];
                    v = obj[value];
                    if(this.list)this.setCheckdNode(v);
                                    
                } else {// 自动查找树中的选择节点，并设置值
                    var root = this.tree.root;
                    this.t = "";
                    this.v = "";
                    if (root.attributes.selectAll) {
                        this.t = root.text;
                    } else {
                        root.eachChild(this.getNodeValue, this);
                    }
                    text = this.t;
                    v = this.v;
                }
                /*
                 * var node = this.tree.getNodeById(v); if(node){ text =
                 * node.text; }else if(this.valueNotFoundText !== undefined){
                 * text = this.valueNotFoundText; }
                 */
                this.lastSelectionText = text;
                if (this.hiddenField) {
                    this.hiddenField.value = v;
                }
                EasyJF.Ext.TreeComboField.superclass.setValue.call(this, text);
                this.value = v;
                this.text = text;
            },          
            choice : function(notClean) {
                if (notClean)
                    this.setValue(true);
                else
                    this.clearValue();
                this.list.hide();
            },
            cleanChoice : function() {
                this.clearValue();
                this.list.hide();
            },
            cancelChoice : function() {
                this.list.hide();
            },          
            onDestroy : function() {
                if (this.listPanel.rendered && this.list) {
                    this.list.hide();
                    this.list.remove();
                }
                EasyJF.Ext.CheckTreeComboField.superclass.onDestroy.call(this);
            }
        });
Ext.reg('checktreecombo', EasyJF.Ext.CheckTreeComboField);

<div id="cls-EasyJF.Ext.SmartCombox"></div>/**
 * 对ComboBox进行扩展,对象的选择,及其显示,combo中新建数据
 * @class EasyJF.Ext.SmartCombox
 * @extends Ext.form.ComboBox
 */
EasyJF.Ext.SmartCombox = Ext.extend(Ext.form.ComboBox, {
	<div id="cfg-EasyJF.Ext.SmartCombox-returnObject"></div>/**
	 * 设置getValue获取的值，是基本类型，还是对象类型
	 * @cfg {Boolean} returnObject
	 */
    returnObject : false,
    <div id="cfg-EasyJF.Ext.SmartCombox-objectCreator"></div>/**
     * 用来定义新建对象的相关属性
     * @cfg {Boolean} objectCreator
     */
    objectCreator:null,
    createWinReady:function(win){
        if(this.fieldLabel)win.setTitle("新建"+this.fieldLabel);
    },
    <div id="method-EasyJF.Ext.SmartCombox-newObject"></div>/**
     * 创建新对象
     */
    newObject:function(){
        this.collapse();
        var title=this.fieldLabel;
        EasyJF.Ext.Util.addObject(this.objectCreator.appClass, this.reload.createDelegate(this),this.objectCreator.script,
        this.objectCreator.otherScripts,this.createWinReady.createDelegate(this));
    },
    initComponent : function() {
        if(this.objectCreator&&!this.disableCreateObject){
        this.operatorButtons=[{text:"新建",cls:"x-btn-text-icon",icon:"/images/icons/add.png",handler:this.newObject,scope:this}];
        }
        EasyJF.Ext.SmartCombox.superclass.initComponent.call(this);
    },
    initList:function(){
        if(!this.list){
            EasyJF.Ext.SmartCombox.superclass.initList.call(this);
            // this.operatorButtons=[{text:"ddd"}];
            if(this.operatorButtons){// 增加对操作按钮的支持
                if(this.pageTb){
                    this.pageTb.insert(0,this.operatorButtons);
                }
                else {
                this.bottomBar = this.list.createChild({cls:'x-combo-list-ft'});
                this.bottomToolbar = new Ext.Toolbar(this.operatorButtons);
                this.bottomToolbar.render(this.bottomBar);
                this.assetHeight += this.bottomBar.getHeight();
                }
            }
        }
    },
    <div id="method-EasyJF.Ext.SmartCombox-getValueObject"></div>/**
     * 获取SmartCombox对应的"对象"值
     * @param {String} field
     * @return {Object}
     */
    getValueObject : function(field) {
        var val = "";
        if(this.returnObject){
            val = this.getValue().value;
        }else{
            val = this.getValue();
        }
        if (val){   
            var index=this.store.find(field||"id",val);
            if(index>=0){
                var record = this.store.getAt(index);
                return record;
            }
            return null;
        }
        return null;
    },
    <div id="method-EasyJF.Ext.SmartCombox-getValue"></div>/**
     * 获取SmartCombox中的值
     * @param {String} field
     * @return {Object}
     */
    getValue : function() {
        if (this.returnObject){
            var value=this.value;
            if(this.el.dom.value==this.PleaseSelectedValue||this.el.dom.value==this.nullText)return null;
            if(this.selectedIndex>=0){
                var record=this.store.getAt(this.selectedIndex);
                if(record&&record.data){
                var t=record.data[this.displayField||this.valueField];
                if(t!=this.el.dom.value)value=null;
                }
            }
            return {
                value : value,
                text : this.el.dom.value,
                toString : function() {
                    return this.text;
                }
            };
        }
        else
            return EasyJF.Ext.SmartCombox.superclass.getValue.call(this);
    },
    <div id="method-EasyJF.Ext.SmartCombox-setValue"></div>/**
     * 设置SmartCombox的value
     * @param {String/Object/Number...} v
     */
    setValue : function(v) {
        if (v && typeof v == "object" && eval("v." + this.valueField)) {
            var value = eval("v." + this.valueField);
            var text = eval("v." + this.displayField) ? eval("v."
                    + this.displayField) : this.valueNotFoundText;
            this.lastSelectionText = text;
            if (this.hiddenField) {
                this.hiddenField.value = value;
            }
            Ext.form.ComboBox.superclass.setValue.call(this, text);
            this.value = value;
            if(this.store.find(this.valueField,value)<0){
                var o={};
                o[this.valueField]=value;
                o[this.displayField]=text;
                if(this.store&&this.store.insert){
                this.store.insert(0,new Ext.data.Record(o));
                // this.select(0);
                }
            }
        } else if (v === null){
            EasyJF.Ext.SmartCombox.superclass.setValue.call(this, "");
        }
        else{
            EasyJF.Ext.SmartCombox.superclass.setValue.call(this, v);   
        }
    },
    onSelect : function(record, index) {
        if (this.fireEvent('beforeselect', this, record, index) !== false) {
            this.setValue(record.data[this.valueField
                    || this.displayField]);
            this.collapse();                    
            this.fireEvent('select', this, record, index);
        }
    }
});
Ext.reg('smartcombo', EasyJF.Ext.SmartCombox);
<div id="cls-EasyJF.Ext.PopupWindowField"></div>/**
 * 弹出窗口选择按钮 
 * @class EasyJF.Ext.PopupWindowField
 * @extends Ext.form.TriggerField
 */
EasyJF.Ext.PopupWindowField = Ext.extend(Ext.form.TriggerField, {
			win:null,
            valueField : "id",
            displayField : "name",
            haveShow : false,
            editable : false,
            callback:Ext.emptyFn,
            returnObject : false,
            choiceOnly:false,
            getValue : function() {
                if(this.choiceOnly)return this.value;           
                if (this.returnObject)
                    return typeof this.value != 'undefined' ? {
                        value : this.value,
                        text : this.text,
                        toString : function() {
                            return this.text?this.text:this.value;
                        }
                    } : "";
                return typeof this.value != 'undefined' ? this.value : '';
            },
            setValue : function(v) {
                if(this.choiceOnly)return this.value=v;
                if (v && typeof v == "object" && eval("v." + this.valueField)) {
                    var value = eval("v." + this.valueField);
                    var text = eval("v." + this.displayField) ? eval("v."
                            + this.displayField) : this.valueNotFoundText;
                    this.lastSelectionText = text;
                    if (this.hiddenField) {
                        this.hiddenField.value = value;
                    }
                    EasyJF.Ext.PopupWindowField.superclass.setValue.call(this, text);
                    this.value = value;
                    this.text=text;
                } else if (v === null)
                    EasyJF.Ext.PopupWindowField.superclass.setValue.call(this, "");
                else
                    EasyJF.Ext.PopupWindowField.superclass.setValue.call(this, v);
            },          
            onTriggerClick : function() {
                if(this.win){
                    this.win.show();
                }
            },
            onRender : function(ct, position) {
                EasyJF.Ext.PopupWindowField.superclass.onRender.call(this,
                        ct, position);
                if(this.win){
                    this.win.on("select",this.choice,this);
                }
                if (this.hiddenName) {
                    this.hiddenField = this.el.insertSibling({
                                tag : 'input',
                                type : 'hidden',
                                name : this.hiddenName,
                                id : (this.hiddenId || this.hiddenName)
                            }, 'before', true);
                    this.hiddenField.value = this.hiddenValue !== undefined
                            ? this.hiddenValue
                            : this.value !== undefined ? this.value : '';
                    this.el.dom.removeAttribute('name');
                }
                if (!this.editable) {
                    this.editable = true;
                    this.setEditable(false);
                }
                if(this.choiceOnly)this.el.hide();
            },
            choice:function(data,win){
                this.setValue(data);
                this.fireEvent('select',data,win);
            },
            initComponent : function(){
                EasyJF.Ext.PopupWindowField.superclass.initComponent.call(this);
                this.addEvents("select");
                
            },
            validateBlur : function() {
                return !this.win || !this.win.isVisible();
            },
            onDestroy : function() {
                if (this.win&&this.win.isVisible()) {
                    this.win.hide();
                }
                EasyJF.Ext.PopupWindowField.superclass.onDestroy.call(this);
            },
            setEditable : function(value) {
                if (value == this.editable) {
                    return;
                }
                this.editable = value;
                if (!value) {
                    this.el.dom.setAttribute('readOnly', true);
                    this.el.on("dblclick",this.onTriggerClick, this);
                    this.el.on("click",this.onTriggerClick, this);
                    this.el.addClass('x-combo-noedit');
                } else {
                    this.el.dom.setAttribute('readOnly', false);
                    this.el.un('mousedown', this.onTriggerClick, this);
                    this.el.removeClass('x-combo-noedit');
                }
            }
        });
Ext.reg('popupwinfield', EasyJF.Ext.PopupWindowField);

<div id="cls-EasyJF.Ext.GridSelectWin"></div>/**
 * 弹出一个Window供用户选择grid中的数据
 * @class EasyJF.Ext.GridSelectWin
 * @extends Ext.Window
 */
EasyJF.Ext.GridSelectWin = Ext.extend(Ext.Window, {
            title : "选择数据",
            width : 540,
            height : 400,
            layout : "fit",
            buttonAlign : "center",
            closeAction : "hide",
            grid:null,// grid是必须传递的对象
            modal:true,         
            callback : Ext.emptyFn,
            choice : function() {
                var grid=this.grid.grid||this.grid;
                var records = grid.getSelectionModel()
                        .getSelections();
                if (!records || records.length < 1) {
                    Ext.Msg.alert("$!{lang.get('Prompt')}",
                            "$!{lang.get('Select first')}");
                    return false;
                }
                var datas = [];
                for (var i = 0; i < records.length; i++) {
                    datas[i] = records[i].data;
                }
                this.hide();
                this.fireEvent('select', datas, this);
            },
            initComponent : function() {
                this.buttons = [{
                            text : "确定",
                            handler : this.choice,
                            scope : this
                        }, {
                            text : "取消",
                            handler : function() {
                                this.hide();
                            },
                            scope : this
                        }];
                EasyJF.Ext.GridSelectWin.superclass.initComponent.call(this);               
                if(this.grid){
                    var grid=this.grid.grid||this.grid;// 兼容BaseGridList对象
                    grid.on("rowdblclick", this.choice, this);
                    this.add(this.grid);
                }
                this.addEvents("select");
            }
});
<div id="cls-EasyJF.Ext.TreeNodeUtil"></div>/**
 * 
 * @class EasyJF.Ext.TreeNodeUtil
 * @single
 */
EasyJF.Ext.TreeNodeUtil={};
Ext.apply(EasyJF.Ext.TreeNodeUtil,{
            // 级联邮件节点对象，进行指定的操作
            cascadeNode : function(node, fn, scope, args) {
                if (fn.apply(scope || this, args || [node]) !== false) {
                    if (node.children && node.children.length) {
                        for (var i = 0, cs = node.children; i < cs.length; i++){
                            cs[i].parentNode = node; 
                            this.cascadeNode(cs[i], fn, scope, args);
                        }
                    }
                }
            },
            <div id="method-EasyJF.Ext.TreeNodeUtil-deepFindNode"></div>/**
             * 在指定节点中查询特定id的节点
             * 
             * @param {}
             *            id 所要查询的节点id
             * @param {}
             *            node
             * @return {}
             */
            deepFindNode : function(id, node) {
                var ret = null;
                this.cascadeNode(node, function(n) {
                            if (n.id == id) {
                                ret = n;
                                return false;
                            }
                        });
                return ret;
            },
            <div id="method-EasyJF.Ext.TreeNodeUtil-getNodeById"></div>/**
             * 根据节点id查找指定节点
             * 
             * @param {}
             *            id
             * @param {}
             *            objs
             * @return {}
             */
            getNodeById:function(id,objs){
                var ret = this.deepFindNode(id, {
                        id : "root",
                        children : objs
                });
                return ret || null ;
            },           
            findNode : function(id, objs) {
                if (id == "root")
                    return objs;
                else {
                    var ret = this.deepFindNode(id, {
                                id : "root",
                                children : objs
                            });
                    return ret && ret.children ? ret.children : null;
                }
            },
            // 删除缓存中的节点
            localRemove:function(id,cache){
                var obj = Ext.type(cache)=="string"?EasyJF.Cache.get(cache):cache;
                if(obj){
                    var objs = obj.items;
                    var node = this.getNodeById(id,objs);
                    if(node){
                        if(node.parentNode && node.parentNode.children)node.parentNode.children.remove(node);
                        else objs.remove(node);
                        if(obj.fireEvent)obj.fireEvent("removenode",node,obj);
                    }
                }
            },
            // 添加节点到指定缓存中
            localAdd:function(node,parentId,cache){
                var obj = Ext.type(cache)=="string"?EasyJF.Cache.get(cache):cache;
                if(obj){
                    var objs = obj.items;
                    if(parentId){
                    var parentNode = this.getNodeById(parentId,objs);
                    if(parentNode){
                       parentNode.children = parentNode.children || []; 
                       if(parentNode.children && parentNode.children.length==0){
                            parentNode.leaf=false;
                            parentNode.children = [node];
                       }else if(parentNode.children){
                            parentNode.children.push(node);
                       }
                       if(obj.fireEvent)obj.fireEvent("addnode",node,parentNode,obj);
                    }}
                    else {
                        objs.push(node);
                       if(obj.fireEvent)obj.fireEvent("addnode",node,null,obj);
                    }
                }
            },
            // 更新缓存中的节点
            localChange:function(node,cache){
                var obj = Ext.type(cache)=="string"?EasyJF.Cache.get(cache):cache;
                if(obj){
                    var objs = obj.items;
                    var no = this.getNodeById(node.id,objs);
                    if(no){
                        Ext.copyToIf(no,node,["children","cls","loader","parentNode"]);
                        if(obj.fireEvent)obj.fireEvent("updatenode",no,obj);
                    }
                }
            },
            // 移动缓存中的节点
            localMove:function(node,parentId,cache){
                this.localRemove(node.id,cache);
                this.localAdd(node,parentId,cache);
            }
});

<div id="cls-EasyJF.Ext.TreeCollection"></div>/**
 * 树状节点数据存储器，提供了快速查询树节点及内在节点内容变更事件响应等相关方法
 * @class EasyJF.Ext.TreeCollection
 * @extends Ext.util.MixedCollection
 */
EasyJF.Ext.TreeCollection=Ext.extend(Ext.util.MixedCollection,{
            // 删除节点
            removeNode:function(id){
                 EasyJF.Ext.TreeNodeUtil.localRemove(id,this);
                 this.unregisterNode(id);
            },
            // 添加节点
            addNode:function(node,parentId){
                 var n = null; 
                 if(n = this.getNodeById(node.id)){
                    EasyJF.Ext.TreeNodeUtil.localChange(node,this);
                    return ;
                 }
                 EasyJF.Ext.TreeNodeUtil.localAdd(node,parentId ,this);
                 this.registerNode(node);
            },
            // 更新节点
            changeNode:function(node,cache){
                EasyJF.Ext.TreeNodeUtil.localChange(node,this);
            },
            // 移动节点
            moveNode:function(node,parentId,cache){
                EasyJF.Ext.TreeNodeUtil.localMove(node,parentId,this);
            },
            // 注销nodeHash中的节点
           unregisterNode:function(id){
                delete this.nodeHash[id];
           },
           // 往nodeHash中注册节点及所有子节点
           registerNode:function(node){
                 if(node.id)this.nodeHash[node.id] = node;   
                 var children = node.children || (node.attributes&&node.attributes.children) ;
                 if(children && children.length)
                 Ext.each(children,this.registerNode,this);
            },
            // 获得所有节点
            getAllNode:function(){
                return this.nodeHash || {};
            },
            // 根据ID返回节点
            getNodeById:function(id){
                return this.nodeHash[id];
            },
            // 重写MixCollection的addAll方法，并调用registerNode来注册节点
            addAll:function(objs){
                EasyJF.Ext.TreeCollection.superclass.addAll.call(this,objs);
                this.nodeHash = {};
                if(objs){
                    var obj = {id:'root',children:objs};
                    this.registerNode(obj)
                }
            },
            // 清空集合中的所有节点
            clear:function(){
                this.nodeHash = {};
                EasyJF.Ext.TreeCollection.superclass.clear.call(this);
            }
});
<div id="method-EasyJF.Ext.TreeCollection-Ext.CachedRemoteProxy"></div>/**
 * 客户端缓存对象,同时提供在本地执行查询及分页等操作
 * 
 * @param {String} varName
 * @param {String} url
 */
EasyJF.Ext.CachedRemoteProxy = function(c,store){
    this.enableCache=(c.enableCache==window.undefined ? true : c.enableCache);
    this.store = store;
    EasyJF.Ext.CachedRemoteProxy.superclass.constructor.call(this, {
                url : c.url
            });
    Ext.apply(this, c);  
};
EasyJF.Ext.CachedRemoteProxy.DATAS={};
EasyJF.Ext.CacheFilter=new Ext.util.MixedCollection();

EasyJF.Ext.CacheFilter.firstSearch=function(val,regexp){
    if(typeof regexp != 'regexp')regexp = new RegExp("^"+regexp);
    return regexp.test(val);
}
Ext.extend(EasyJF.Ext.CachedRemoteProxy, Ext.data.HttpProxy, {
    quickSearch:function(params,datas){
        if(!datas.getCount())return datas;
        var objs=datas;
        var o=datas.items[0];
        if(!this.disableClientFilter){
            for(var n in params){
                if(n && o[n]!==undefined){              
                    objs=objs.filter(n,params[n]);
                }
            }
        }
        objs = this.cacheFilter(params,objs);
        return objs;
    },
    cacheFilter:function(params,objs){
        var filter = EasyJF.Ext.CacheFilter.key(this.varName);
        if(filter && params){
            if(typeof filter == 'function'){
                return filter.call(this,objs,params);
            }
        }
        return objs;
    },
    getData:function(){
        return EasyJF.Ext.CachedRemoteProxy.DATAS[this.varName];
    },
    loadFromCache : function(params, reader, callback, scope, arg) {
                var datas = this.quickSearch(params, this.getData());
                var o = {
                    rowCount : datas.getCount(),
                    result : []
                };
                var start = 0, limit = -1;
                
                if (params.start)start = Ext.num(parseInt(params.start), 0);
                
                if (params.limit)limit = Ext.num(parseInt(params.limit), -1);
                
                var max = datas.getCount();
                
                if (limit > 0)max = start + limit;
                if (max > datas.getCount())max = datas.getCount();
                if (max < 0)max = this.pageSize;
                o.result = datas.getRange(start, max - 1);
                var result;
                try {
                    result = reader.readRecords(o);
                } catch (e) {
                    this.fireEvent("loadexception", this, o, response, e);
                    callback.call(scope, null, params, false);
                    return;
                }
                this.fireEvent("load", this, o, arg);
                callback.call(scope, result, arg, true);
            },
    /*
     * loadFromCache:function(params, reader, callback, scope, arg){ var
     * datas=this.quickSearch(params,this.getData()); var
     * o={rowCount:datas.getCount(),result:[]}; var start=0,limit=-1;
     * if(params.start)start=Ext.num(parseInt(params.start),0);
     * if(params.limit)limit=Ext.num(parseInt(params.limit),-1); if(limit<0)limit=this.pageSize;
     * var max=datas.getCount(); if(limit>0)max=start+limit; if(max<0)max =
     * this.pageSize; if(max>datas.getCount())max=datas.getCount();
     * //console.dir(params); o.result=datas.getRange(start,max-1); var result;
     * try { result = reader.readRecords(o); }catch(e){
     * this.fireEvent("loadexception", this, o, response, e);
     * callback.call(scope, null, params, false); return; }
     * this.fireEvent("load", this, o, arg); callback.call(scope, result, arg,
     * true); },
     */
    request : function(action, rs, params, reader, callback, scope, options) {
	      params = params || {};       
	      if(this.fireEvent("beforeload", this, params) !== false){
	            if(this.getData().getCount()){
	                this.loadFromCache(params, reader, callback, scope, options);
	            }else {
	            	EasyJF.Ext.CachedRemoteProxy.superclass.request.apply(this,arguments);
	            }
	        }
    },
    onRead : function(action, o, response) {
                /*if (!success) {
                    this.fireEvent("loadexception", this, o, response);
                    o.request.callback.call(o.request.scope, null,
                            o.request.arg, false);
                    return;
                }*/
                if(this.enableCache){
                    try {
                        var json = response.responseText;
                        var obj = eval("(" + json + ")");
                        if(obj && (obj.enableCache===false || obj.enableCache===true)){
                            // this.store.remoteSort=obj.enableCache;
                            this.enableCache = obj.enableCache;
                        }
                        if(this.enableCache){
                            this.getData().clear();
                            this.getData().addAll(Ext.isArray(obj) ? obj : obj.result); 
                            o.params.limit = this.pageSize ? this.pageSize : 10;
                            this.loadFromCache(o.params, o.reader, o.request.callback,o.request.scope, o.request.arg);
                        }else{
                            var result;
                            try {
                                result = o.reader.read(response);
                            } catch (e) {
                                this.fireEvent("loadexception", this, o, response, e);
                                o.request.callback.call(o.request.scope, null,o.request.arg, false);
                                return;
                            }
                            this.fireEvent("load", this, o, o.request.arg);
                            o.request.callback.call(o.request.scope, result, o.request.arg,true);
                        }
                    } catch (e) {
                        this.fireEvent("loadexception", this, o, response, e);
                        o.request.callback.call(o.request.scope, null,o.request.arg, false);
                        return;
                    }
                }else{
                    var result;
                    try {
                        result = o.reader.read(response);
                    } catch (e) {
                        this.fireEvent("loadexception", this, o, response, e);
                        o.request.callback.call(o.request.scope, null,
                                o.request.arg, false);
                        return;
                    }
                    this.fireEvent("load", this, o, o.request.arg);
                    o.request.callback.call(o.request.scope, result, o.request.arg,true);
                }
            },
            add : function(key, obj) {// 增加
                this.getData().add(key, obj);
            },
            remove : function(obj) {// 删除
                this.getData().remove(obj);
            },
            removeKey : function(key) {// 删除
                this.getData().removeKey(key);
            },
            addOrUpdate:function(id, obj){
                this.getData().replace(id, obj);
            },
            update : function(id, obj) {// 修改
                this.getData().replace(id, obj);
            }
});

EasyJF.Ext.CachedRemoteStore = function(c){
    EasyJF.Ext.CachedRemoteStore.superclass.constructor.call(this, Ext.apply(c, {
        proxy: c.proxy || (!c.data ? new EasyJF.Ext.CachedRemoteProxy(c) : undefined),
        reader: new Ext.data.JsonReader(c, c.fields)
    }));
    if(!EasyJF.Ext.CachedRemoteProxy.DATAS[this.varName])
    EasyJF.Ext.CachedRemoteProxy.DATAS[this.varName]=new Ext.util.MixedCollection(true);    
};
Ext.extend(EasyJF.Ext.CachedRemoteStore, Ext.data.Store,{
    refreshCache:function(){// 刷新缓存数据,重新从服务器端加载数据
        this.proxy.getData().clear();
        this.reload();
    },
    enableCache : function(b){
	    this.proxy.enableCache = b ===window.undefined ? true : !!!b; 
	},
    isCache:function(){
                return this.proxy.enableCache;
    },
    sortFn:function(a,b){
                if(!a || b || !a.toUpperCase || !b.toUpperCase){
                    var v1 =a, v2 = b;
                    return v1 > v2 ? 1 : (v1 < v2 ? -1 : 0);
                }
                var i=a.toUpperCase()==b.toUpperCase();
                if(!i)return a.toUpperCase()<b.toUpperCase()?-1:1;
                else{
                    var ret=0;
                    for(var i=0;i<a.length;i++){
                        if(a[i]!==b[i]){
                            return a[i]<b[i]?1:-1;
                        }
                    }
                    return ret ;
                }
            },
      sortData : function(f, direction) {
                direction = direction || 'ASC';
                var st = this.fields.get(f).sortType;
                var fn =this.sortFn;
                this.data.sort(direction, fn);
                if (this.snapshot && this.snapshot != this.data) {
                    this.snapshot.sort(direction, fn);
                }
            },
      sort : function(fieldName, dir){
                if(this.isCache===false){
                   EasyJF.Ext.CachedRemoteStore.superclass.sort.call(this,fieldName, dir);
                        return;
                }
                var f = this.fields.get(fieldName);
                if(!f){
                    return false;
                }
                if(!dir){
                    if(this.sortInfo && this.sortInfo.field == f.name){ // toggle
                                                                        // sort
                                                                        // dir
                        dir = (this.sortToggle[f.name] || "ASC").toggle("ASC", "DESC");
                    }else{
                        dir = f.sortDir;
                    }
                }
                var st = (this.sortToggle) ? this.sortToggle[f.name] : null;
                var si = (this.sortInfo) ? this.sortInfo : null;
        
                this.sortToggle[f.name] = dir;
                this.sortInfo = {field: f.name, direction: dir};
                if(!this.remoteSort){
                    this.applySort();
                    this.fireEvent("datachanged", this);
                }else{
                     var direction = dir || 'ASC';
                     var st2 = this.fields.get(f.name).sortType;
                     var sortFn=this.sortFn;
                     var fn = function(r1, r2){             
                        var v1 = st2(r1[f.name]), v2 = st2(r2[f.name]);
                        return sortFn(v1,v2);
                      };
                    this.proxy.getData().sort(direction,fn);
                    if (!this.load(this.lastOptions)) {
                        if (st) {
                            this.sortToggle[f.name] = st;
                        }
                        if (si) {
                            this.sortInfo = si;
                        }
                    }
                }
            }
});

EasyJF.Ext.CachedRemoteObject = function(varName, url,collectionType,shareCache) {
    this.varName = varName;
    this.url = url;
    this.collectionType=collectionType;
    this.addEvents("load");
    if(shareCache){
        if(!EasyJF.Ext.CachedRemoteObject.shareCaches[varName])
        EasyJF.Ext.CachedRemoteObject.shareCaches[varName]=eval("new "+(collectionType||"Ext.util.MixedCollection")+"()");
    }
    EasyJF.Ext.CachedRemoteObject.superclass.constructor.call(this);
}

EasyJF.Cache=EasyJF.Ext.CachedRemoteObject.DATAS={};
EasyJF.shareCaches=EasyJF.Ext.CachedRemoteObject.shareCaches={};

<div id="cls-EasyJF.Ext.CachedRemoteObject"></div>/**
 * @param {Stirng}  varName 缓存的名称
 * @param {Stirng}  url 获取数据的url
 * @param {Stirng}  collectionType 集合类型，默认为MixedCollection
 * @param {Boolean} shareCache 是否共享缓存
 * @class EasyJF.Ext.CachedRemoteObject
 * @extends Ext.util.Observable
 */
Ext.extend(EasyJF.Ext.CachedRemoteObject, Ext.util.Observable, {
    varName:null,
    url:null,
    getData:function(){
        var obj=EasyJF.Ext.CachedRemoteObject.DATAS[this.varName];
        return obj;
    },
    onload:function(callback){
        this.fireEvent("load",this,EasyJF.Ext.CachedRemoteObject.DATAS[this.varName]);
        if(callback)callback();
    },
    clearData : function() {// 刷新缓存数据,重新从服务器端加载数据
         var obj = EasyJF.Ext.CachedRemoteObject.DATAS[this.varName]; 
         if(obj.clear)obj.clear();
          else  obj = null;
    },
    load:function(callback,params){
        if(EasyJF.Ext.CachedRemoteObject.DATAS[this.varName]){
            this.onload.call(this,callback,params);
            return;
        }
        if(this.varName&&this.url){
        EasyJF.Ext.Util.loadJSON2Collection("EasyJF.Ext.CachedRemoteObject.DATAS['"+this.varName+"']",this.url,this.onload.createDelegate(this,[callback]),EasyJF.shareCaches[this.varName],this.collectionType);   
        }
    }
});
CachedRemoteObject=EasyJF.Ext.CachedRemoteObject;

<div id="method-EasyJF.Ext.CachedRemoteObject-Ext.MemoryTreeLoader"></div>/**
 * 支持本地缓存节点的树加载器
 * 
 * @param {}
 *            config
 */        
EasyJF.Ext.MemoryTreeLoader = function(config) {
    EasyJF.Ext.MemoryTreeLoader.superclass.constructor.call(this, config);
    if (this.varName && (this.dataUrl || this.url)) {
        this.remoteObject = new EasyJF.Ext.CachedRemoteObject(this.varName,
                (this.url || this.dataUrl),"EasyJF.Ext.TreeCollection",true);
        if (!this.lazyLoad) {
            this.remoteObject.load();
        }
    }
    this.shareCache = EasyJF.Ext.CachedRemoteObject.shareCaches[this.varName];
}
Ext.extend(EasyJF.Ext.MemoryTreeLoader, Ext.tree.TreeLoader, {
            varName : null,
            remoteObject : null,
            dataProxy : false,
            autoLeaf:true,
            remoteDataProxy : null,
            transferNode :window.undefined,
            cascadeNode : function(node, fn, scope, args) {
                if (fn.apply(scope || this, args || [node]) !== false) {
                    if (node.children && node.children.length) {
                        for (var i = 0, cs = node.children; i < cs.length; i++)
                            this.cascadeNode(cs[i], fn, scope, args);
                    }
                }
            },
            deepFindNode : function(id, node) {
                var ret = null;
                this.cascadeNode(node, function(n) {
                            if (n.id == id) {
                                ret = n;
                                return false;
                            }
                        });
                return ret;
            },
            findNode : function(id, objs) {
                if (id == "root")
                    return Ext.isArray(objs) ? objs : objs.items;
                else {
                    var ret = this.deepFindNode(id, {
                                id : "root",
                                children : (Ext.isArray(objs) ? objs : objs.items)
                            });
                   
                    return ret && ret.children ? ret.children : null;
                }
            },
            load : function(node, callback) {
                if (this.clearOnLoad) {
                    while (node.firstChild) {
                        node.removeChild(node.firstChild);
                    }
                }
                var objs = this.remoteObject.getData();
                if (objs && objs.length)
                    node.attributes.children = this.findNode(node.id, objs);
                if (this.doPreload(node)) {
                    if (typeof callback == "function") {
                        callback();
                    }
                } else if (this.dataUrl || this.url) {
                    this.requestData(node, callback);
                }
            },
            doPreload : function(node) {
                if (node.attributes.children && node.attributes.children.length) {
                    if (node.childNodes.length < 1) { // preloaded?
                        var cs = node.attributes.children;
                        node.beginUpdate();
                        for (var i = 0, len = cs.length; i < len; i++) {
                            var o=Ext.apply({},cs[i]);
                            var cn = this.createNode(o);
                            if(cn===false)continue;
                            var cn = node.appendChild(this.createNode(o));
                            if (this.preloadChildren) {
                                this.doPreload(cn);
                            }
                        }
                        node.endUpdate();
                    }
                    return true;
                } else {
                    return false;
                }
            },
            createNode : function(attr) {
                attr = Ext.apply({},attr);
                if (this.baseAttrs) {
                    Ext.applyIf(attr, this.baseAttrs);
                }
                if (this.transferNode != window.undefined) {
                    if(typeof this.transferNode == 'function'){
                        attr= this.transferNode(attr);
                    }else if(typeof this.transferNode == 'object'){
                        for(var o in this.transferNode){
                            if(this.transferNode.hasOwnProperty(o) && Ext.isEmpty(attr[o])){
                                attr[o] = attr[this.transferNode[o]];
                            }
                        }
                    } 
                }
                if(this.autoLeaf===true){
                    if(!attr.children || !attr.children.length){
                        attr.leaf = true;
                    }
                } 
                if (this.applyLoader !== false) {
                    attr.loader = this;
                }
                if (typeof attr.uiProvider == 'string') {
                    attr.uiProvider = this.uiProviders[attr.uiProvider]
                            || eval(attr.uiProvider);
                }
                if (attr.nodeType) {
                    return new Ext.tree.TreePanel.nodeTypes[attr.nodeType](attr);
                } else {
                    return attr.leaf
                            ? new Ext.tree.TreeNode(attr)
                            : new Ext.tree.AsyncTreeNode(attr);
                }
            },
            processResponse : function(response, parentNode, callback) {
                var json = response.responseText;
                try {
                    var o = eval("(" + json + ")");
                    
                    var collection = EasyJF.Ext.CachedRemoteObject.shareCaches[this.varName];
                    collection.clear();
                    collection.addAll(o);
                    EasyJF.Ext.CachedRemoteObject.DATAS[this.varName]=collection;
                    o = collection.items;
                    parentNode.beginUpdate();
                    collection.each(function(node){
                        var n = this.createNode(node);
                        if (n)parentNode.appendChild(n);
                    },this);
                    parentNode.endUpdate();
                    if (typeof callback == "function") {
                        callback(this, parentNode);
                    }
                } catch (e) {
                    this.handleFailure(response);
                }
            }
        });
Ext.ns('EasyJF.Ext.Tree'); 
<div id="method-EasyJF.Ext.CachedRemoteObject-Ext.Tree.LocalPlugin"></div>/**
 * 邮件菜单树插件，支持数据同步更新
 * 
 * @param {}
 *            config
 */
EasyJF.Ext.Tree.LocalPlugin=function(config){
    Ext.apply(this,config);
    EasyJF.Ext.Tree.LocalPlugin.superclass.constructor.call(this, config);
}
Ext.extend(EasyJF.Ext.Tree.LocalPlugin,Ext.util.Observable,{
    init : function(tree) {
        this.tree = tree;
        this.loader = this.tree.loader;
        this.tree.on('render', this.initEvents, this);
        this.tree.on('beforedestroy', this.destroyCmp, this);
    },
    destroyCmp:function(){
         delete this.tree;
         delete this.loader;
         var shareCache = this.loader.shareCache;
         shareCache.un("addnode",this.addUINode,this);// 数据变化,则创建新的节点
         shareCache.un("updatenode",this.updateUINode,this);// 更新节点内容
         shareCache.un("removenode",this.removeUINode,this);// 删除节点内容
    },
    initEvents:function(){
         var shareCache = this.loader.shareCache;
         shareCache.on("addnode",this.addUINode,this);// 数据变化,则创建新的节点
         shareCache.on("updatenode",this.updateUINode,this);// 更新节点内容
         shareCache.on("removenode",this.removeUINode,this);// 删除节点内容
   },
    addUINode:function(node,parentNode){
        var parent =this.getNodeById(parentNode.id);
        if(parent){
            parent.leaf=false;
            parent.appendChild(node);
        }
    },
    updateUINode:function(upateNode){
        var node = this.getNodeById(upateNode.id);
        if(node){
             if(Ext.type(this.loader.transferNode)=='function'){
                upateNode = Ext.apply({},upateNode);
                this.loader.transferNode(upateNode);
            }
            node.setText(upateNode.text);
            Ext.copyToIf(node.attributes,upateNode,["children","cls","loader","parentNode"]);
            if(node.getUI() instanceof Ext.ux.tree.ColumnNodeUI){
                node.getUI().updateNode(upateNode);
            }
            if(!Ext.isEmpty(upateNode.qtip)){
                if (node.getUI().getTextEl().setAttributeNS) {
                    node.getUI().getTextEl().setAttributeNS("ext","qtip",upateNode.qtip);
                } else {
                    node.getUI().getTextEl().setAttribute("ext:qtip",upateNode.qtip);
                }
            }
        }
    },
    removeUINode:function(node){
        var parentNode = node.parentNode;
        if(parentNode && parentNode.children.length==0){
            var parentNode = this.getNodeById(parentNode.id);
            if(parentNode){
                parentNode.leaf=true;
                parentNode.getUI().updateExpandIcon();
            }
        }
        var node = this.getNodeById(node.id);
        if(node){
            node.remove();
        }
    }
    ,
    getNodeById:function(id){
        return this.tree.getNodeById(id);
    }
});


BaseGridList = Ext.extend(Ext.Panel, {
        layout : "fit",
        loadData : false,
        pageSize : 10,
        closable : true,
        autoScroll : true,
        pagingToolbar : true,           
        gridForceFit : true,// 强制表格自动适应
        gridViewConfig : {},
        gridConfig : {},// 表格的自定义配置
        showMenu : true,
        menu_refresh: false,
        linkRenderer : EasyJF.Ext.Util.linkRenderer,
        linkRender:EasyJF.Ext.Util.linkRenderer,
        imgRender :EasyJF.Ext.Util.imgRender,
        booleanRender :  EasyJF.Ext.Util.booleanRender,
        dateRender :EasyJF.Ext.Util.dateRender,
        userRender : EasyJF.Ext.Util.userRender,
        objectRender : EasyJF.Ext.Util.objectRender,
        typesRender : EasyJF.Ext.Util.typesRender,
        operaterRender:EasyJF.Ext.Util.operaterRender,
        storeType:Ext.data.JsonStore,
        storeConfig:{},
        emailRender : function(v) {
            return v ? v.email : "未知";
        },  
        refresh : function() {
            this.store.removeAll();
            this.store.reload({callback:function(rs){
                if(rs && rs.length<1){Ext.Msg.alert("提示","没有符合条件的数据！");EasyJF.Ext.Util.autoCloseMsg.defer(2000);}
                }
            });
        },
        showContextMenu : function(g, i, e) {
            var evn = e ? e : g;
            evn.preventDefault();
            if (i) {
                this.grid.getSelectionModel().selectRow(i, false);
            }
            this.menu.showAt(evn.getPoint());
        },  
        doOperate:function(grid,rowIndex,columnIndex,e){
            var tag = e.getTarget("A", 3);
            if (tag) {
                var id = tag.getAttribute("theid");
                var cmd = tag.getAttribute("op");
                var cf=tag.getAttribute("cf");
                if (id && cmd && this.operate)
                    this.operate(cmd, id, cf, grid, rowIndex, columnIndex, e);
            }
        },
        initComponent : function() {
            BaseGridList.superclass.initComponent.call(this);
            if(!this.store){
                this.store = new this.storeType(Ext.apply({
                    id : "id",
                    url : this.url,
                    root : "result",
                    totalProperty : "rowCount",
                    remoteSort : true,
                    fields : this.storeMapping
                },this.storeConfig));
            }
            this.store.paramNames.sort = "orderBy";
            this.store.paramNames.dir = "orderType";
            this.cm.defaultSortable = true;             
            var viewConfig = Ext.apply({
                        forceFit : this.gridForceFit
                    }, this.gridViewConfig);
            var gridConfig=Ext.apply({},{                   
                store : this.store,
                cm : this.cm,
                trackMouseOver : false,
                loadMask : true,
                viewConfig : viewConfig,
                bbar : this.pagingToolbar ? new Ext.PagingToolbar({
                    pageSize : this.pageSize,
                    store : this.store,
                    displayInfo : true
                }) : null
            });
            Ext.apply(gridConfig,this.gridConfig);
            this.menus=this.menus||[];
            if(this.menu_refresh)
            this.menus[this.menus.length]={id:"menu_refresh",cls:"x-btn-text-icon",icon:"images/icons/arrow_refresh.png",text:"刷新",handler:this.refresh,scope:this};
            this.menu=new Ext.menu.Menu({items:this.menus});
            // if(this.gridConfig)gridConfig=Ext.apply(this.gridConfig,gridConfig);
            if(this.gridTbar)gridConfig.tbar=this.gridTbar;
            if(this.gridBorder===false||this.gridBorder)gridConfig.border=this.gridBorder;
            if(this.columnLock && Ext.grid.LockingGridPanel){
            if(!gridConfig.columns && gridConfig.cm){
                gridConfig.columns=gridConfig.cm.config;
                delete gridConfig.cm;
            }   
            this.grid = new Ext.grid.LockingGridPanel(gridConfig);
            }
            else this.grid=new Ext.grid.GridPanel(gridConfig);
            this.grid.on("rowcontextmenu",function(g,n,e){
                if(!this.showMenu) return false;
                if(g.getSelectionModel().selectRow)g.getSelectionModel().selectRow(n);
                this.menu.showAt(e.getPoint());
                e.preventDefault();
            },this);
            this.add(this.grid);
            if (this.loadData) this.store.load();
        }
 });
/*
UserSelectCombo = Ext.extend(Ext.form.ComboBox, {
            editable : false,
            searchByUser : function(text, v) {
                this.store.baseParams.searchKey = v;
                this.store.reload();
            },
            initList : function() {
                UserSelectCombo.superclass.initList.call(this);
                if (this.pageTb) {
                    this.pageTb.add("用户名");
                    this.pageTb.add({
                        xtype : "textfield",
                        id : "searchKey",
                        width : 50,
                        listeners : {
                            "change" : this.searchByUser,
                            scope : this
                        }
                    });
                    this.pageTb.addButton({
                        text : "查询"
                    });
                }
            }
        });
Ext.reg('userselectcombo', UserSelectCombo);*/

HTMLEditor = Ext.extend(Ext.form.HtmlEditor, {
    // enableFont:false,
    codeStyle : '<br/><pre style="border-right: #999999 1px dotted; padding-right: 5px; border-top: #999999 1px dotted; padding-left: 5px; font-size: 12px; padding-bottom: 5px; margin-left: 10px; border-left: #999999 1px dotted; margin-right: 10px; padding-top: 5px; border-bottom: #999999 1px dotted; background-color: #eeeeee">{0}</pre><br/>',
    onRender : function(ct, position) {
        HTMLEditor.superclass.onRender.call(this, ct, position);        
        if (this.keys) {
            if (!this.keys.length) {
                this.keyMap = new Ext.KeyMap(this.getEditorBody(), this.keys);
            } else {
                this.keyMap = new Ext.KeyMap(this.getEditorBody(), this.keys[0]);
                for (var i = 1; i < this.keys.length; i++)
                    this.keyMap.addBinding(this.keys[i]);
            }
            this.keyMap.stopEvent = true;
        }
    },
    showEmoteSelect : function() {
        emoteSelectWin.editor = this;
        emoteSelectWin.show();
    },
    addImage : function() {
        function insertImage() {
            var editor = this;
            win.upload(function(ret) {
                if (ret) {
                    var s = "<br/><img src=" + ret.path;
                    if (ret.width)
                        s += " width=" + ret.width;
                    if (ret.height)
                        s += " height=" + ret.height;
                    s += " /><br/>";
                    editor.insertAtCursor(s);
                    win.close();
                }
            });
        };
        var win = new UploadImageWindow({
            modal : true,
            iconCls : "icon-img",
            buttons : [{
                        text : "确定",
                        handler : insertImage,
                        scope : this
                    }, {
                        text : "取消",
                        handler : function() {
                            win.close();
                        }
                    }]
        });
        win.show();
    },
    addCode : function() {
        function insertCode() {
            var value = win.getComponent("codes").getValue();
            this.insertAtCursor(String.format(this.codeStyle, value));
            win.close();
        };
        var win = new Ext.Window({
            title : "添加代码",
            width : 500,
            height : 300,
            modal : true,
            iconCls : "icon-code",
            layout : "fit",
            items : {
                xtype : "textarea",
                id : "codes"
            },
            buttons : [{
                        text : "确定",
                        handler : insertCode,
                        scope : this
                    }, {
                        text : "取消",
                        handler : function() {
                            win.close();
                        }
                    }]
        });
        win.show();
    },
    createToolbar : function(editor) {
        HTMLEditor.superclass.createToolbar.call(this, editor);
        this.tb.insertButton(16, {
                    cls : "x-btn-icon",
                    icon : "images/qq/img.gif",
                    handler : this.addImage,
                    scope : this
                });
        this.tb.insertButton(17, {
                    cls : "x-btn-icon",
                    icon : "images/qq/code.gif",
                    handler : this.addCode,
                    scope : this
                });
        this.tb.insertButton(18, {
                    cls : "x-btn-icon",
                    icon : "images/emote/main.jpg",
                    handler : this.showEmoteSelect,
                    scope : this
                });

    },
    validateValue : function(value) {
        if (value.length > this.maxLength) {
            var s = String.format(this.maxLengthText, this.maxLength);
            this.markInvalid(s);
            return false;
        }
        return true;
    }
});
Ext.reg('myhtmleditor', HTMLEditor);

// 用来存放IFrames中的panel引用，以id为单位
IFrames={};

EasyJF.Ext.CrudListPanel=function(config){
    var c= config || {};
    Ext.apply(this,c);
    this.addEvents("saveobject","removeobject");
    EasyJF.Ext.CrudListPanel.superclass.constructor.call(this);
};

Ext.extend(EasyJF.Ext.CrudListPanel, Ext.util.Observable,{
        viewWin : {
            width : 650,
            height : 410,
            title : "详情查看"
        },
        searchWin : {
            width : 630,
            height : 300,
            title : "高级查询"
        },// 查询窗口的高度、宽度及标题
        gridViewConfig : {},// 表格显示视图的自定义配置
        gridConfig : {},// 表格的自定义配置
        baseQueryParameter : {}// 查询初始化参数
    });
Ext.apply(EasyJF.Ext.CrudListPanel.prototype,EasyJF.Ext.CrudFunction,{
    afterList:Ext.emptyFn,
    list:function(){
            this.initComponent();
            this.checkAdnLoadColumnField();
            this.store = new Ext.data.JsonStore({
                id : this.storeId?this.storeId:"id",
                url : this.formatUrl('list'),
                root : "result",
                totalProperty : "rowCount",
                remoteSort : true,
                fields : this.storeMapping
            });
            if(Ext.objPcount(this.baseQueryParameter)){
                this.store.on('beforeload',function(store,options){
                    Ext.apply(store.baseParams,this.baseQueryParameter);
                },this);
            }
            this.store.baseParams=Ext.apply({},{limit:this.pageSize||""},this.initQueryParameter||{});
            this.store.paramNames.sort = "orderBy";
            this.store.paramNames.dir = "orderType";
            
            var buttons=this.buildCrudOperator();
            var viewConfig = Ext.apply({
                        forceFit : this.gridForceFit
            }, this.gridViewConfig);
            var gridConfig = Ext.apply(this.gridConfig, {
                        store : this.store,
                        stripeRows : true,
                        trackMouseOver : false,
                        loadMask : true,
                        viewConfig : viewConfig,
                        tbar:buttons,
                        border : false,
                        bbar : this.pagingToolbar ? new Ext.ux.PagingComBo({
                            rowComboSelect:true,
                            pageSize : this.pageSize,
                            store : this.store,
                            displayInfo : true
                        }) : null
                    });
            if(this.summaryGrid){
                if(gridConfig.plugins){
                    if(typeof gridConfig.plugins=="object")gridConfig.plugins=[gridConfig.plugins];
                }
                else gridConfig.plugins=[];
                gridConfig.plugins[gridConfig.plugins.length]=new Ext.ux.grid.GridSummary();
            }       
            if(this.columns)gridConfig.columns=this.columns;
            else if(this.cm)gridConfig.cm=this.cm;
            if(this.columnLock && Ext.grid.LockingGridPanel){
                if(!gridConfig.columns && gridConfig.cm){
                    gridConfig.columns=gridConfig.cm.config;
                    delete gridConfig.cm;
                }   
            this.grid = new Ext.grid.LockingGridPanel(gridConfig);
            }
            else this.grid=new Ext.grid.GridPanel(gridConfig);
            
            this.grid.colModel.defaultSortable = true;// 设置表格默认排序
            this.panel=new Ext.Panel({
                id:this.id,
                title:this.title,               
                closable :this.closable,
                autoScroll : this.autoScroll,
                layout : this.layout,
                border : this.border,
                listeners:{close:function(){delete this.panel;},scope:this}
                });
            this.panel.add(this.grid);
            this.loadOperatorsPermission();
            // 双击表格行进入编辑状态
            this.initCrudEventHandler();
            // this.disableOperaterItem("btn_edit","btn_remove","btn_view");
            this.afterList();
            if(this.autoLoadGridData)this.store.load();
            this.panel.service=this;
            return this.panel;
        }
});
EasyJF.Ext.Util.HelpIconPlugin = Ext.extend(Ext.util.Observable, {
    init:function(field) {
    Ext.apply(field, {
      onRender:field.onRender.createSequence(function(ct, position) {
        // If field has the fieldLabel object, add the helpIcon
        if(this.fieldLabel && this.helpText) {
          var label = this.el.findParent('.x-form-element', 5, true) || this.el.findParent('.x-form-field-wrap', 5, true);
          
          this.helpIcon = label.createChild({
            cls:(this.helpIconCls || 'ux-helpicon-icon')
          ,    style:'width:16px; height:18px; position:absolute; left:0; top:0; display:block; background:transparent no-repeat scroll 0 2px;'
          });
          
          this.alignHelpIcon = function(){
            var el = this.wrap ? this.wrap : this.el; 
            this.helpIcon.alignTo(el, 'tl-tr', [2, 0]);
          }
          // Redefine alignErrorIcon to move the errorIcon (if it exist) to
            // the right of helpIcon
          if(this.alignErrorIcon) {
            this.alignErrorIcon = function() {
              this.errorIcon.alignTo(this.helpIcon, 'tl-tr', [2, 0]);
            }
          }
          
          this.on('resize', this.alignHelpIcon, this);
          // Register QuickTip for icon
          Ext.QuickTips.register({
            target:this.helpIcon
          , title:(this.helpTitle || '')
          , text:(this.helpText || 'No help defined yet!')
          , enabled:true
          });
        }
      }) 
    }); 
    } 
}); 
Ext.namespace("Ext.ux.panel");
Ext.ux.panel.DDTabPanel = Ext.extend(Ext.TabPanel, {
    arrowOffsetX : -9,
    arrowOffsetY : -8,
    border : false,
    enableTabScroll : true,
    layoutOnTabChange : true,
    autoScroll : true,
    resizeTabs : true,
    tabWidth : 136,
    minTabWidth : 136,
    titleLength : 100,
    initComponent : function() {
        Ext.ux.panel.DDTabPanel.superclass.initComponent.call(this);
        if (!this.ddGroupId) {
            this.ddGroupId = "dd-tabpanel-group-"
                    + Ext.ux.panel.DDTabPanel.superclass.getId.call(this)
        }
    },
    afterRender : function() {
        Ext.ux.panel.DDTabPanel.superclass.afterRender.call(this);
        this.arrow = Ext.DomHelper.append(Ext.getBody(),'<div class="dd-arrow-down"></div>', true);
        this.arrow.hide();
        var a = this.ddGroupId;
        this.dd = new Ext.ux.panel.DDTabPanel.DropTarget(this,{ddGroup : a});
    },
    initTab : function(b, a) {
        Ext.ux.panel.DDTabPanel.superclass.initTab.call(this, b, a);
        var c = this.id + "__" + b.id;
        var id = this.stripWrap.id;
        Ext.applyIf(b, {
                    allowDrag : true
                });
        Ext.apply(b, {
                    position : (a + 1) * 2,
                    ds : new Ext.dd.DragSource(c, {
                                ddGroup : this.ddGroupId,
                                dropEl : b,
                                dropElHeader : Ext.get(c, true),
                                scroll : false,
                                onStartDrag : function() {
                                    this.constrainTo(id);
                                    this.getProxy().ghost.dom.innerHTML=String.format("<div style='width:100px;overflow:hidden;'>{0}</div>",this.dropEl.title);
                                    if (this.dropEl.iconCls) {
                                        this.getProxy().getGhost().select(".x-tab-strip-text").applyStyles({paddingLeft : "1px"})
                                    }
                                },
                                onMouseDown : function(d) {
                                    if (!this.dropEl.isVisible()) {
                                        this.dropEl.show();
                                    }
                                }
                            }),
                    enableDrag : function() {
                        this.allowDrag = true;
                        return this.ds.unlock()
                    },
                    disableDrag : function() {
                        this.allowDrag = false;
                        return this.ds.lock()
                    }
                });
        if (b.allowDrag) {
            b.enableDrag()
        } else {
            b.disableDrag()
        }
    },
    /*onRemove : function(a) {
        Ext.destroy(a.ds.proxy, a.ds);
        Ext.ux.panel.DDTabPanel.superclass.onRemove.call(this, b, a)
    },*/
    onDestroy : function() {
        Ext.destroy(this.dd, this.arrow);
        Ext.ux.panel.DDTabPanel.superclass.onDestroy.call(this)
    }
});
Ext.ux.panel.DDTabPanel.DropTarget = Ext.extend(Ext.dd.DropTarget, {
            constructor : function(b, a) {
                this.tabpanel = b;
                Ext.ux.panel.DDTabPanel.DropTarget.superclass.constructor.call(
                        this, b.stripWrap, a)
            },
            notifyOver : function(q, l, j) {
                var m = this.tabpanel.items;
                var p = m.length;
                if (!l.within(this.getEl())) {
                    return "x-dd-drop-nodrop"
                }
                var r = this.tabpanel.arrow;
                var o = this.el.getY();
                var f;
                var k = l.getPageX();
                for (var h = 0; h < p; h++) {
                    var d = m.itemAt(h);
                    var c = d.ds.dropElHeader;
                    var n = c.getX();
                    var a = n + c.dom.clientWidth / 2;
                    if (k <= a) {
                        f = n;
                        break
                    }
                }
                if (typeof f == "undefined") {
                    var b = m.itemAt(p - 1);
                    if (b) {
                        var g = b.ds.dropElHeader.dom;
                        f = (new Ext.Element(g).getX() + g.clientWidth) + 3
                    }
                }
                r.setTop(o + this.tabpanel.arrowOffsetY).setLeft(f
                        + this.tabpanel.arrowOffsetX).show();
                return this.dropAllowed;
            },
            notifyDrop : function(p, k, f) {
                this.tabpanel.arrow.hide();
                var m = this.tabpanel.items;
                var o = m.length;
                var h = k.getPageX();
                var l = o;
                p.dropEl.position = o * 2 + 1;
                var j = this.tabpanel.items.indexOf(p.dropEl);
                for (var d = 0; d < o; d++) {
                    var c = m.itemAt(d);
                    var b = c.ds.dropElHeader;
                    var n = b.getX();
                    var a = n + b.dom.clientWidth / 2;
                    if (h <= a) {
                        if (j < d) {
                            d -= 1
                        }
                        break
                    }
                }
                p.proxy.hide();
                var g = p.dropEl.ownerCt.remove(p.dropEl, false);
                var c = this.tabpanel.getComponent(d);
                if (c && c.tabFixed) {
                    d = this.getLastTabFixed()
                }
                if (this.tabpanel.items.getCount() < d) {
                    d = this.tabpanel.items.getCount()
                }
                this.tabpanel.insert(d, g);
                this.tabpanel.activate(g);
                /*var q = this.tabpanel.getTabEl(g).childNodes[1].firstChild.firstChild;
                if (q) {
                    q.style.width = Ext.value(this.tabpanel.minTabWidth,120) + "px"
                }*/
                return true
            },
            getLastTabFixed : function() {
                var a = this.tabpanel.items.filter("tabFixed", true);
                return a.getCount()
            },
            notifyOut : function(a, c, b) {
                this.tabpanel.arrow.hide()
            }
        });
Ext.reg("ddtabpanel", Ext.ux.panel.DDTabPanel);  

ChartTools = {
    createFusionChart : function(url, swf, chartId, width, height, options) {
        options = options || {};
        var myChart = new FusionCharts(swf, chartId, width, height, "0", "0");
        url = url || options.url;
        if (url) {
            if (url.indexOf("?") < 1)
                url += "?";
            if (options.params)
                url += Ext.urlEncode(options.params);
            myChart.setDataURL(url);
        }
        if (options.renderTo && url) {
            myChart.render(options.renderTo);
        }
        return myChart;
    },
    // "FusionCharts/chart/Column3D.swf",
    createChart : function(url, swf, config) {
        config = config || {};
        var myChart = this.createFusionChart(url, swf, config.id, config.width,
                config.height, config);
        return myChart;
    },
    createColumn2D : function(url, config) {
        return this
                .createChart(url, "/FusionCharts/chart/Column2D.swf", config);
    },
    createColumn3D : function(url, config) {
        return this
                .createChart(url, "/FusionCharts/chart/Column3D.swf", config);
    },
    createGroupColumn2D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSColumn2D.swf",
                config);
    },
    createGroupColumn3D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSColumn3D.swf",
                config);
    },
    createPie2D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/Pie2D.swf", config);
    },
    createPie3D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/Pie3D.swf", config);
    },
    createBar2D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/Bar2D.swf", config);
    },
    createGroupBar2D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSBar2D.swf", config);
    },
    createGroupBar3D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSBar3D.swf", config);
    },
    createLine : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/Line.swf", config);
    },
    createGroupLine : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSLine.swf", config);
    }
};

ChartWindow = Ext.extend(Ext.Window, {
                max:20,// 显示前几条
                store:null,// 数据项
                datas:null,// 直接把datas中的数据进行展示
                columnModel:null,// 表格模型
                url:"",// 远程数据加载url
                params:null,// 查询参数
                grid:null,// 直接拿一个表格来分析
                layout : "border",
                closeAction:"hide",
                buttonAlign:"center",
                tpl :new Ext.XTemplate(
                    '<chart caption="{title}"> ',          
                    '<tpl for="list">',
                        '<set label="{name}" value="{value}" />',
                    '</tpl></chart>'
                ),
                initParams:function(){
                    if(this.grid){
                            this.store=this.grid.store;
                            if(!this.columnModel)this.columnModel=this.grid.getColumnModel();
                    }
                    if(this.columnModel){
                        var fields=[];
                        if(this.columnModel.getColumnCount&&this.columnModel.getDataIndex){// 是表格的columnModel对象
                        for(var i=0;i<this.columnModel.getColumnCount();i++){
                            fields.push({id:this.columnModel.getDataIndex(i),title:this.columnModel.getColumnHeader(i)});
                        }
                        }
                        else {// 直接是描述可分析项目的数组
                            fields=this.columnModel;
                        }
                        this.leftTree.root.attributes.children=[];
                        for(var i=0;i<fields.length;i++){
                        this.leftTree.root.attributes.children.push({text:fields[i].title,id:fields[i].id,leaf:true});
                        }
                        this.leftTree.root.reload();
                        this.btn_field.store.loadData(fields);
                        this.btn_field.setValue(this.field||"");
                    }
                    this.btn_max.setValue(this.max);
                    this.setTitle(this.title);                  
                },
                loadChart:function(){
                    this.initParams();                  
                    var objs={title:this.title,list:[],order:false};
                    var orderBy="";
                    if(this.btn_orderASC.getValue())orderBy="ASC";
                    else if(this.btn_orderDESC.getValue())orderBy="DESC";
                    if(this.datas && this.datas.length){
                        objs.list=this.datas;
                    }
                    else if(this.store){
                        if(orderBy)this.store.sort(this.field,orderBy);
                        for(var i=0;i<this.store.getCount()&&i<this.max;i++){
                            var r=this.store.getAt(i).data;
                            var obj={name:r[this.label||"sn"],value:r[this.field]};
                            objs.list.push(obj);
                        }
                        objs.order=true;
                    }
                    var xml="";                 
                    if(!objs.list.length && this.url){
                       var response=Ext.lib.Ajax.syncRequest("POST", this.url,Ext.apply(this.params,{sort:orderBy}));
                       xml=response.conn.responseText;
                    }
                    else{ 
                        if(!objs.order&&orderBy){// 如果是直接传的数据,则需要手动
                            var f="value";
                            var dsc = orderBy.toUpperCase() == "DESC" ? -1 : 1;
                            objs.list.sort(function(a, b) {
                                if(a[f]==b[f])return 0;
                                else return a[f]>b[f]?1*dsc:-1*dsc;
                            });
                        }
                        xml=this.tpl.applyTemplate(objs);
                    }
                    var createChart=ChartTools.createColumn3D;
                    if(this.btn_pie.getValue())createChart=ChartTools.createPie3D;
                    else if(this.btn_pie2d.getValue())createChart=ChartTools.createPie2D;
                    else if(this.btn_bar2d.getValue())createChart=ChartTools.createColumn2D;
                    var chartPanel=this.chartPanel;
                    var b=chartPanel.body.getBox();
                    try{
                    this.chart=createChart.call(ChartTools,null,{width:b.width-20,height:b.height-10});
                    }
                    catch(e){
                        alert(e);
                    }
                    this.chart.setDataXML(xml);
                    this.chart.render(chartPanel.body.dom);
                },
                // 根据查询条件刷新报表
                refreshChart:function(){
                    this.max=this.btn_max.getValue();
                    // this.field=this.btn_field.getValue();
                    this.loadChart();
                },
                clickDeptNode:function(node){
                    this.params=Ext.apply({},{field:node.attributes.id},this.params);
                    this.field=node.attributes.id;
                    this.title=node.attributes.text;
                    if(this.store)this.datas=null;
                    this.refreshChart();
                },
                initComponent : function() {
                    this.btn_field=new EasyJF.Ext.SmartCombox(
                        {
                            name : "colorInput",
                            hiddenName : "colorInput",
                            fieldLabel : "colorInput",
                            displayField : "title",
                            valueField : "id",
                            allowBlank:false,
                            width:100,
                            // selectedClass:'x-combo-color-selected', //
                            // icon.css
                            store : new Ext.data.JsonStore({
                                fields : ["id","title"]
                            }),
                            editable : false,
                            mode : 'local',
                            triggerAction : 'all',
                            emptyText : '请选择...'
                        }
                    );  
                    this.btn_max=new Ext.form.NumberField({name:"max",xtype:"numberfield",width:30});
                    this.btn_orderType=new Ext.form.ComboBox(Ext.apply({},{width:80},EasyJF.Ext.Util.buildCombox("type","是否",[["由低到高","ASC"], ["由高到低", "DESC"]],"DESC",true)));
                    this.btn_orderASC=new Ext.form.Radio({boxLabel:"由低到高",name:"orderTypes",handler:this.refreshChart,scope:this});
                    this.btn_orderDESC=new Ext.form.Radio({boxLabel:"由高到低",name:"orderTypes",handler:this.refreshChart,scope:this});
                    this.btn_bar=new Ext.form.Radio({boxLabel:"柱状图",cls:'x-btn-text-icon',name:"types",handler:this.refreshChart,scope:this,checked:true});
                    this.btn_pie=new Ext.form.Radio({boxLabel:"饼状图",cls:'x-btn-text-icon',name:"types",handler:this.refreshChart,scope:this});
                    this.btn_bar2d=new Ext.form.Radio({boxLabel:"柱状图2D",cls:'x-btn-text-icon',name:"types",handler:this.refreshChart,scope:this});
                    this.btn_pie2d=new Ext.form.Radio({boxLabel:"饼状图2D",cls:'x-btn-text-icon',name:"types",handler:this.refreshChart,scope:this});
                    this.btn_vdate1=new Ext.form.DateField({format:"Y-m-d"});
                    this.btn_vdate2=new Ext.form.DateField({format:"Y-m-d"});
                    Ext.apply(this, {                       
                        width : Ext.getBody().getViewSize().width - 50,
                        height : Ext.getBody().getViewSize().height - 20
                    });
                    
                    ChartWindow.superclass.initComponent.call(this);
                    this.leftTree=new Ext.tree.TreePanel({xtype:"treepanel",title:"分析项目",border:false,rootVisible:false,root : new Ext.tree.AsyncTreeNode({
                        id : "root",
                        text : "所有部门",
                        expanded : true,
                        children:[],
                        loader:new Ext.tree.TreeLoader()
                    }),
                    listeners:{
                        scope:this,
                        click:this.clickDeptNode
                    }});
                    this.chartPanel=new Ext.Panel({html:"正在生成统计图..."});
                    this.add({region:"west",width:150,items:[this.leftTree]});
                    this.add({region:"center",layout:"fit",items:this.chartPanel,
                                tbar:["最多分析数",this.btn_max,"排序方式:",this.btn_orderASC,this.btn_orderDESC,"-","展示方式:",this.btn_bar,this.btn_pie,this.btn_bar2d,this.btn_pie2d,"    ","-",{text:"开始分析",cls:'x-btn-text-icon',handler:this.refreshChart,scope:this,icon:'images/icons/application_side_expand.png'}]});
                            this.on("show",this.loadChart,this);
                        }
                    }); 
        ChartWindow.showChart=function(config,callback){
            if(!ChartWindow.win){
                ChartWindow.win=new ChartWindow();
            }
            Ext.apply(ChartWindow.win,Ext.apply({store:null,// 数据项
                datas:null,// 直接把datas中的数据进行展示
                columnModel:null,// 表格模型
                url:"",// 远程数据加载url
                params:null,// 查询参数
                grid:null// 可以直接拿一个表格来进行分析
                },config||{}));
            ChartWindow.win.show();
            if(callback)callback.call(ChartWindow.win);
            
        };
        
<div id="cls-SearchResultStatisticsWin"></div>/**
 * 显示查询结果预览窗口
 * @class SearchResultStatisticsWin
 * @extends Ext.Window
 */     
SearchResultStatisticsWin=Ext.extend(Ext.Window,{
            title:"查询结果预览",width:300,height:300,layout:"fit",
            closeAction:"hide",
            initGrid:function(){
                var rs=[];
                if(this.data){
                    for(var name in this.data){
                        var o={name:name,value:this.data[name]};
                        rs.push(o);
                    }
                }
                this.grid.store.removeAll();
                this.grid.store.loadData(rs);
                if(this.title)this.setTitle(this.title);
            },
            initComponent:function(){
                this.grid=new Ext.grid.GridPanel({
                    viewConfig:{forceFit:true},
                    store:new Ext.data.JsonStore({
                                fields:["name","value"]
                                }),
                    cm:new Ext.grid.ColumnModel([{header: "项目名称", width:100, sortable: false, dataIndex:'name', id: 'name', menuDisabled:true},
                     {header: "值", width:100, resizable:false, dataIndex: 'value', id: 'value', menuDisabled:true}])
                });
                SearchResultStatisticsWin.superclass.initComponent.call(this);  
                this.on("show",this.initGrid,this);
                this.add(this.grid);
            }
        });
    SearchResultStatisticsWin.showWin=function(config){
        if(!SearchResultStatisticsWin.win){
            SearchResultStatisticsWin.win=new SearchResultStatisticsWin();
        }
        Ext.apply(SearchResultStatisticsWin.win,config);
        SearchResultStatisticsWin.win.show();
        return SearchResultStatisticsWin.win;
    };  
    
// EasyJF.Ext.MainAppService
EasyJF.Ext.MainAppService={
    IFrameClass:{},
    NormalClass:{},
    getSingleTabMode:function(){
        return this.singleTabMode;
    },
    openTab:function(panel, id) {
        var o = (typeof panel == "string" ? panel : id || panel.id);
        var tab = this.getComponent(o);     
        if (tab) {
            this.setActiveTab(tab);
        } else if(typeof panel!="string"){
            if(!this.tabsCheck())return;
            panel.id = o;
            var p = this.add(panel);
            if(this.getSingleTabMode())this.closeAll(p);
            // if(this.items.getCount()>10)this.remove(1);
            this.setActiveTab(p);
        }
    },
    tabsCheck:function(){
        if(this.items.getCount()>this.maxTabs){
            Ext.Msg.alert("提示","系统允许同时打开的面板数已经达到极限，请先关闭其它一打开的面板再重新进入");
            return false;
        }
        return true;
    },
    openAppInWin:function(panel){
        panel.elements=panel.elements.replace(",header","");
        panel.inWinConfig = panel.inWinConfig || {};//window窗口附加配置  例如: inWinConfig:{width:600,height:450}
        if(!this.appWin){
            this.appWin=new Ext.Window(Ext.apply({
                width:Ext.getBody().dom.offsetWidth-20,
                height:Ext.getBody().dom.offsetHeight-20,
                closeAction:"hide",
                layout:"fit",
                modal:true,
                maximizable:true,
                title:panel.title,
                items:panel,
                listeners:{maximize:function(win){win.doLayout();},
                    restore:function(win){win.doLayout();}
                    }
            },panel.inWinConfig));
            Ext.del(panel,'inWinConfig');
        }
        else {
            this.appWin.remove(0);
            this.appWin.add(panel);
            this.appWin.setSize(panel.inWinConfig.width||(Ext.getBody().dom.offsetWidth-20),panel.inWinConfig.height||(Ext.getBody().dom.offsetHeight-20));
            this.appWin.doLayout();
            this.appWin.setTitle(panel.title);
        }
        this.appWin.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(win){win.center();});
    },
    openExtAppNode:function(node,e){
            // 使用树的package来代表所在的包,script代表公共脚本
            if((!node.attributes.listeners || !node.attributes.listeners.click) && node.attributes.appClass){           
            var pck=node.attributes['package']?node.attributes['package']:this['package'];
            if(!pck)pck="";
            else pck.replace(".","/");
            var script=(node.attributes.script?node.attributes.script:this.script);
            var appClass=node.attributes.appClass;
            if(!script)script=appClass+".js";
            script=pck+"/"+script;
            /*
             * var params=node.attributes.params;
             * if(params)params=Ext.urlDecode(params);
             */
            // alert(script);
            // alert(appClass);
            var title=node.attributes.title?node.attributes.title:node.text;            
            if(Global.iframe && !node.attributes.frameDisable){     
                main.openExtApp(appClass,script,title,null,node.attributes.otherScripts,node.attributes.callback,node.attributes.inWin,node.attributes.params);
            }
            else {
                main.openClassApp(appClass,script,title,appClass,node.attributes.otherScripts,node.attributes.callback,node.attributes.inWin,node.attributes.params);
            }
            }
        },
    openExtApp:function(id,script,title,appClass,otherScripts,callback,inWin,params){
    	
      	appClass =  appClass || id;
      	title =  title || id;
      	otherScripts = otherScripts || "";
      	
        var tab = this.getComponent(id);        
        if (tab) {
            this.setActiveTab(tab);
        } else{
             if(!this.tabsCheck())return;
             var theParameter=params||{};
             if(params&&(typeof params=="string"))theParameter=Ext.urlDecode(params);
             if(!this.IFrameClass[appClass]){
           		 eval("this.IFrameClass."+appClass+"=Ext.extend(ExtAppBasePanel,{id:'"+id+"',title:'"+title+"',appClass:'"+appClass+"',script:'"+script+"',otherScripts:'"+otherScripts+"',params:'"+(Ext.encode(theParameter))+"'});");
             }
             if(inWin){// 在新窗口中打开应用
                this.openAppInWin(new this.IFrameClass[appClass]());
             }
             else {
	            eval("var p = this.add(new this.IFrameClass."+appClass+"());");
	            p.on("destroy",new Function("delete IFrames."+appClass));   
	            if(this.getSingleTabMode())this.closeAll(p);
	            this.setActiveTab(p);
	            if(p)p.doLayout();
            }
        }
        if(callback)callback();
    },
    openClassApp:function(id,script,title,appClass,otherScripts,callback,inWin,params){
        appClass=appClass || id;
        title= title || id;
        var tab = this.getComponent(id);        
        if (tab) {
            this.setActiveTab(tab);
            if(callback)callback();
        } else{
            if(!this.tabsCheck())return;
            var theParameter=params||{};
            if(params&&(typeof params=="string"))theParameter=Ext.urlDecode(params);
            if(this.NormalClass[appClass]){
                if(this.NormalClass[appClass].superclass.onWindowResize){// 是窗口
                    eval("var p = new this.NormalClass."+appClass+"(theParameter)");
                    p.show();
                }
                else{
                    eval("var tempP = new "+appClass+"(theParameter);" +
                         "if(tempP.list && (typeof tempP.list=='function'))tempP=tempP.list();");
                    if(inWin){// 在窗口中打开应用
                        var inWinConfig = tempP.inWinConfig||{};
                        Ext.del(tempP,'inWinConfig');
                        this.openAppInWin(new this.NormalClass[appClass](Ext.apply({items:tempP},{inWinConfig:inWinConfig})));
                    }
                    else {
                    eval("var p = this.add(new this.NormalClass."+appClass+"({items:tempP}));");
                    // if(this.items.getCount()>10)this.remove(1);
                    if(this.getSingleTabMode())this.closeAll(p);
                    this.setActiveTab(p);
                    }
                }
            }
            else{
            var successLoad=function(req){
                eval(req.responseText);     
                if(eval(appClass+".superclass.onWindowResize")){
                    eval("this.NormalClass."+appClass+"="+appClass);
                    eval("var p=new "+appClass+"(theParameter);");
                    p.show();               
                }   
                else{
                eval("this.NormalClass."+appClass+"=Ext.extend(Ext.Panel,{id:'"+id+"',title:'"+title+"',border:false,layout:'fit',closable:true});");
                eval("var tempP = new "+appClass+"(theParameter);" +
                     "if(tempP.list && (typeof tempP.list=='function'))tempP=tempP.list();");
                if(inWin){// 在窗口中打开应用
                    var inWinConfig = tempP.inWinConfig||{};
                    Ext.del(tempP,'inWinConfig');
                    this.openAppInWin(new this.NormalClass[appClass](Ext.apply({items:tempP},{inWinConfig:inWinConfig})));
                }
                else {
                eval("var p = this.add(new this.NormalClass."+appClass+"({items:tempP}));");
                // if(this.items.getCount()>10)this.remove(1);
                if(this.getSingleTabMode())this.closeAll(p);
                this.setActiveTab(p);
                if(p)p.doLayout();
                }
                }           
            };
            if(otherScripts){
                var s=otherScripts.split(";");
                var total=s.length,ld=0;
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                        ld++;
                        if(ld>=total)
                        Ext.Ajax.request({waitMsg:"正在加载程序，请稍候。。。",url:Lanyo_Ajax.script+script,success:successLoad,scope:this});
                    },scope:this});
                    }                   
            }       
            else {
            	Ext.Ajax.request({waitMsg:"正在加载程序，请稍候。。。",url:Lanyo_Ajax.script+script,success:successLoad,scope:this});
            	}
            }
            if(callback)callback();
        }
    },  
    closeTab : function(panel, id) {
        var o = (typeof panel == "string" ? panel : id || panel.id);
        var tab = this.getComponent(o);
        if (tab) {
            this.remove(tab);
        }
    },
    closeAll:function(excep){       
        this.items.each(function(p){
            if(p.closable && p!=excep)this.closeTab(p);
        },this);
    },
    // 保存用户个性化桌面设置
    savePersonality:function(callback,hideMsg){
            var result=[];
            var s="";
            var portal=this.getComponent("homePage");
            if(portal && portal.items && portal.getXType()=="portal"){
            var items=portal.items;         
            for(var i=0;i<items.getCount();i++){
                var c=items.get(i);  
                var ps="";
                for(var j=0;j<c.items.getCount();j++){
                var it=c.items.get(j);
	                ps="id:"+it.getId()+",col:"+i+",row:"+j;
	                if(it.customizeUrl)ps+=",url:"+it.customizeUrl;
	                if(it.customizeHtml)ps+=",html:"+it.customizeHtml;
	                if(it.customizeUrl||it.customizeHtml){
	                    ps+=",title:"+it.title;
	                }
	                s+=ps+"@@";
                }
             }
            }
            var params={
    			maxTabs:main.maxTabs,
                singleTabMode:main.singleTabMode,
                iframe:main.iframe,
                enableAnimate:main.enableAnimate,
                commonFunction:main.commonFunction,
                homePage:main.homeMenu,
                style:main.theStyle,
                portals:s
            };
            if(Lanyo_Ajax.PersonalityUrl){
            	Ext.Ajax.request({
	                    url:Lanyo_Ajax.PersonalityUrl+"?cmd=savePersonality",
	                    params:params,
	                    waitMsg:hideMsg?"":"正在保存数据,请稍候...",
	                    success:function(res){
	                        if(!hideMsg){
	                        Ext.Msg.alert("提示","您的个性化配置信息已经成功保存！",function(){
	                        if(callback)callback();
	                        });
	                        }
	                        else {
	                            if(callback)callback();
	                        }
	                    }
	            });
            }         
            return result;
        },
    cleanPortlet:function(){
        var portal=this.getComponent("homePage");   
        if(portal && portal.items&& portal.getXType()=="portal"){
        for(var i=0;i<portal.items.getCount();i++){
            var ps=portal.items.get(i);
            ps.items.each(function(c){ps.remove(c);});
        }}
    },
    // 加载用户个性化桌面信息
    loadPersonality:function(){
        if(Lanyo_Ajax.PersonalityUrl)
        Ext.Ajax.request({
            url:Lanyo_Ajax.PersonalityUrl+"?cmd=loadPersonality",
            success:function(res){
                this.cleanPortlet();
                var per=Ext.decode(res.responseText);
                if(per){
                    var config = {
                        maxTabs:per.maxTabs,
                        maxTabs:per.maxTabs,// 默认的最大Tab数
                        singleTabMode:per.singleTabMode,// 单个Tab模式
                        enableAnimate:per.enableAnimate,
                        homeMenu:per.homePage,
                        theStyle:per.style,
                        commonFunction:per.commonFunctions
                    }
                    Ext.apply(this,config);
                    if(Ext.isString(this.commonFunction) && !Ext.isEmpty(this.commonFunction)){
                        this.commonFunction = this.commonFunction.split(/[,;\s]/);
                        config.commonFunction = this.commonFunction;
                    }
                    Global.iframe=this.iframe=per.iframe;// iframe支持支持
                    this.fireEvent('loadSystemConfig',config);
                    var pcs=per.portalConfig;
                    if(pcs && pcs.length>0){
                        for(var i=0;i<pcs.length;i++){
                            var info=pcs[i];
                            if(info.id){
                                this.addPortlet(info.col,info.row,info.id,{id:info.id,title:info.title,url:info.url,html:info.html});
                            }
                    	}
                    }
                }   
            },
            scope:this
        });
    },  
    resetPersonality:function(){
        Ext.Msg.confirm("提示","是否真的要还原桌面设置?",function(btn){
            if(btn=="yes"){
	            Ext.Ajax.request({
	                url:"manage.ejf?cmd=resetPersonality",
	                success:function(res){
	                    Ext.Msg.alert("提示","成功还原默认桌面设置!",function(){
	                        this.loadPersonality();
	                    },this);                
	                },
	                scope:this
	            });
            }
        });
    },
    //private
    resetDesktop:function(){
        Ext.Msg.confirm("提示","是否真的要还原桌面设置?",function(btn){
            if(btn=="yes"){
                Ext.Ajax.request({
                    url:"manage.ejf?cmd=resetDesktop",
                    success:function(res){
                        Ext.Msg.alert("提示","成功还原默认桌面设置!",function(){
                            this.loadPersonality();
                        },this);                
                    },
                    scope:this
                });}
        });
    },
	//private  在桌面中创建新的模块
    createPortlet:function(){
        if(!this.portletWin){
            this.portletWin=new PortletWin();
            this.portletWin.setHandler(this.addPortlet);
            this.portletWin.setScope(this);
        }
        this.portletWin.show();
    },
    //private 往桌面中加入一个portlet
    addPortlet:function(col,row,id,config){
        var portal=this.getComponent("homePage");
        if(portal && portal.getXType()=="portal"){
            var portlet;
            for(var n in portlets){
                if(n==id)portlet=portlets[n];
            }
            if(!portlet){// 自定义portlet
                if(config.url&&config.url.indexOf("AppClass:")==0){
                    var appClass=config.url.substring("AppClass:".length);
                    portlet={id:id,tools:tools,title:config.title,layout:"fit",items:eval("new "+appClass),customizeUrl:config.url};    
                }
                else {
	                portlet={id:id,tools:tools,title:config.title,autoLoad:config.url,customizeUrl:config.url};         
	                if(config.html){
	                    portlet.html=config.html;
	                    portlet.customizeHtml=config.html
	                }
                }
                portlets[n]=portlet;
            }
            portal.getComponent(col).insert(row,portlet);
            portal.doLayout();
            if(this.portletWin)this.portletWin.hide();
        }
    },
    <div id="method-SearchResultStatisticsWin-changeSkin"></div>/**
     * 切换系统皮肤
     * @param {String} value
     */
    changeSkin:function(value) {
        Ext.util.CSS.swapStyleSheet('window',String.format('plugins/extjs/{0}/resources/css/{1}.css',Lanyo_Ajax.extVersion,value));
    }
};

// 基于TabPanel的应用程序主框架
EasyJF.Ext.MainTabPanel=Ext.extend(Ext.TabPanel,{
        singleTabMode:true,// 单个Tab模式
        iframe:false,
        enableAnimate:false,        
        resizeTabs : true,
        minTabWidth : 65,
        tabWidth : 120,
        enableTabScroll : true,
        activeTab : 0,
        maxTabs:10,// 默认的最大Tab数
	    initComponent:function(){
	   		EasyJF.Ext.MainTabPanel.superclass.initComponent.call(this);        
	    }
});

eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('3.g(3,{n:0(b,c,d){6(3.p(d)){d=d.q(/[,;\\s]/)}3.7(d,0(a){6(c.r(a)){b[a]=c[a]}},t);4 b},u:0(o,b,c,d){w(8 i=1,a=h,j=a.x;i<j;i++){3.y(o[a[i]]);z o[a[i]]}},A:0(a){8 b=[];3.7(a,0(v){6(!!v){b.5(v)}});4 b},B:0(a){8 b=[],9={};3.7(a,0(v){6(!9[v]){b.5(v)}9[v]=C});4 b},D:0(b){8 c=[];0 e(a){3.7(a,0(v){6(3.E(v)){e(v)}f{c.5(v)}});4 c}4 e(b)},F:0(a,b){8 c=[];3.7(a,0(v){c.5(v[b])});4 c},G:0(a,b){8 c=[],H;3.7(a,0(v){6(v.k){c.5(v.k(b))}f{c.5(I.l)}});4 c},J:0(o,a,b,c){o[a]=o[a].K(b,c)},L:0(o,a,b,c){o[a]=o[a].M(b,c)},N:0(a,b){8 c=[],m=O.P.Q.R(h,2);3.7(a,0(v,i){6(v&&3.S(v[b])){c.5(v[b].g(v,m))}f{c.5(l)}});4 c}});',55,55,'function|||Ext|return|push|if|each|var|collect|||||rFlatten|else|apply|arguments||len|get|undefined|args|copyTo||isString|split|hasOwnProperty||this|destroyMembers||for|length|destroy|delete|clean|unique|true|flatten|isArray|pluck|pluckFn|val|window|intercept|createInterceptor|sequence|createSequence|invoke|Array|prototype|slice|call|isFunction'.split('|'),0,{}));eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('8.1a("C.8");C.8.J=6(b){8.1b(2,b);C.8.J.1c.1d.1e(2)};8.1f(C.8.J,8.1g.1h,{1i:6(b){2.4=b;2.U()},U:6(){2.4.V("1j",2.W,2);j(1k(2.4.X)=="1l"){2.4.V("1m",2.Y,2)}},Y:6(f,d,e){j(f.3.p()>2.4.X){8.K.1n({1o:"\\1p\\1q\\1r\\1s",1t:"\\q\\r\\1u\\1v\\1w\\1x\\1y\\1z\\1A\\1B\\s\\t\\1C",1D:8.K.1E,1F:8.K.1G});D E}},Z:6(){D 1H 8.1I.1J({3:[{u:"\\s\\t\\1K\\1L\\q\\r",v:"w",x:2.10,y:2},{u:"\\s\\t\\1M\\1N\\q\\r",x:2.L,v:"M",y:2},{u:"关闭其它页签",v:"N",x:2.11,y:2},{u:"\\s\\t\\1O\\12\\q\\r",v:"z",x:2.13,y:2},{u:"\\s\\t\\1P\\12\\q\\r",v:"O",x:2.14,y:2}]})},W:6(f,e,d){j(!2.5){2.5=2.Z()}2.15(f,e,d);2.5.m=e;2.5.1Q(d.1R())},15:6(4,l,e){!l.k?2.5.3.9(\'w\').n():2.5.3.9(\'w\').o();7 F=A;7 P=A;7 Q=A;4.3.G(6(l){j(l.k)F=E},2);7 R=4.3.1S(\'k\',A);j(F){2.5.3.9(\'N\').16(A)}17{2.5.3.9(\'N\').16((R.p()==1&&R.S(0)==l))}F?2.5.3.9(\'M\').n():2.5.3.9(\'M\').o();!l.k?2.5.3.9(\'w\').n():2.5.3.9(\'w\').o();7 H=4.3.T(l);j(H==2.4.3.p()-1){2.5.3.9(\'z\').n()}17{2.5.3.9(\'z\').o()}18(7 i=H;i<4.3.p()-1;i++){j(4.3.S(i).k){P=E}}P?2.5.3.9(\'z\').n():2.5.3.9(\'z\').o();18(7 i=H-1;i>0;i--){j(4.3.S(i).k){Q=E}}Q?2.5.3.9(\'O\').n():2.5.3.9(\'O\').o()},L:6(d,f){7 e=d.B.m;2.4.3.G(6(a){j(a.k&&a!=f){2.4.I(a)}},2)},10:6(c){7 d=c.B.m;j(d.k){2.4.I(d)}},11:6(c){7 d=c.B.m;2.L(c,d)},14:6(g){7 h=g.B.m;7 f=2.4.3.T(h)-1;j(f<=0){D}7 e=2.4.3.19(1,f);8.G(e,6(a){j(a&&a.k){2.4.I(a)}},2)},13:6(f){7 d=f.B.m;7 e=2.4.3.19(2.4.3.T(d)+1,2.4.3.p());8.G(e,6(a){j(!a||a==d||!a.k){D}2.4.I(a)},2)}});',62,117,'||this|items|tabPanel|theMenu|function|var|Ext|get||||||||||if|closable|tab|currentTab|disable|enable|getCount|u9762|u677f|u5173|u95ed|text|id|closaCurrentTab|handler|scope|closaRightTab|true|parentMenu|EasyJF|return|false|isDisableAll|each|currentIndex|remove|TabPanelPlugin|Msg|closeAllTab|closaAllTab|closeOtherTab|closaLeftTab|isDisableRight|isDisableLeft|closableTabs|itemAt|indexOf|initEvents|on|showContextMenu|tabSize|maxTabSize|createTabMenu|closeTab|closeElsetTab|u8fb9|closeRightTab|closeLeftTab|doAction|setDisabled|else|for|getRange|ns|apply|superclass|constructor|call|extend|util|Observable|init|contextmenu|typeof|number|beforeadd|show|title|u6e29|u99a8|u63d0|u793a|msg|u8d85|u8fc7|u6700|u5927|u6570|uff0c|u8bf7|u5148|uff01|buttons|OK|icon|INFO|new|menu|Menu|u5f53|u524d|u6240|u6709|u53f3|u5de6|showAt|getXY|filter'.split('|'),0,{}));
Ext.apply(EasyJF.Ext.MainTabPanel.prototype, {}, EasyJF.Ext.MainAppService);

<div id="cls-EasyJF.Ext.MainSinglePanel"></div>/**
 * 基于Panel的应用程序主框架
 * @class EasyJF.Ext.MainSinglePanel
 * @extends Ext.Panel
 */
EasyJF.Ext.MainSinglePanel=Ext.extend(Ext.Panel,{       
        iframe:false,
        maxTabs:10,// 默认的最大Tab数
        singleTabMode:true,// 单个Tab模式
        enableAnimate:true,
        layout:"fit",
        homeMenu:"menu",// 主页菜单
        theStyle:"ext-all",
        setActiveTab:function(p){// 模拟TabPanel中的相应方法
            p.show();
            p.ownerCt.doLayout();
        },
        getActiveTab:function(){// 模拟TabPanel中的相应方法
            return this.getComponent(0);
        },
    getSingleTabMode:function(){
        return true;
    },
    closeAll : function(excep) {
        this.items.each(function(p) {
            if (p != excep)
                this.closeTab(p);
        }, this);
    },
    initComponent:function(){
    	 EasyJF.Ext.MainSinglePanel.superclass.initComponent.call(this);     
/*       this.menu=new Ext.menu.Menu({items:[{text:"关闭所有Tab",handler:this.closeAll,scope:this},{text:"关闭其它Tab",handler:function(){this.closeAll(this.getActiveTab());},scope:this}]});
         this.on("contextmenu",function(tabPanel,tab,e){
                this.menu.showAt(e.getPoint());
            },this
         );*/
    }
});
Ext.apply(EasyJF.Ext.MainSinglePanel.prototype, {}, EasyJF.Ext.MainAppService);

Ext.namespace("Ext.ux.plugins");
EasyJF.Ext.PagingComBo = Ext.extend(Ext.PagingToolbar, {
    displayMsg : "第{0}-{1}条&nbsp;&nbsp;共{2}条&nbsp;&nbsp;&nbsp;&nbsp;共{3}页",
    style:'font-weight:900',
    doLoad : function(start) {
        var o = {}, pn = this.getParams() || {};
        o[pn.start] = start;
        o[pn.limit] = this.pageSize;
        if(this.store.baseParams&&this.store.baseParams[pn.limit])this.store.baseParams[pn.limit]=this.pageSize;
        if (this.fireEvent('beforechange', this, o) !== false) {
            this.store.load({
	            params : o
	        });
        }
    },
    onPagingSelect : function(combo, record, index) {
        var d = this.getPageData(), pageNum;
        pageNum = this.readPage(d);
        if (pageNum !== false) {
            pageNum = Math.min(Math.max(1, record.data.pageIndex), d.pages) - 1;
            this.doLoad(pageNum * this.pageSize);
        }
    },
    readPage : Ext.emptyFn,
    onLoad : function(store, r, o) {
        var d = this.getPageData(), ap = d.activePage, ps = d.pages;
        this.combo.store.removeAll();
        if (ps == 0) {
            this.combo.store.add(new Ext.data.Record({
                pageIndex : 1
            }));
            this.combo.setValue(1);
        } else {
            for (var i = 0; i < ps; i++) {
                this.combo.store.add(new Ext.data.Record({pageIndex : i + 1}));
            }
            this.combo.setValue(ap);
        }
        if (this.rowComboSelect)
            this.rowcombo.setValue(this.pageSize);
        EasyJF.Ext.PagingComBo.superclass.onLoad.apply(this,arguments);
    },
   updateInfo : function() {
        if (this.displayItem) {
            var count = this.store.getCount();
            var activePage = this.getPageData().activePage;
            var msg = count == 0 ? this.emptyMsg : String.format(
                    this.displayMsg, this.cursor + 1, this.cursor + count,
                    this.store.getTotalCount(),
                    Math.ceil(this.store.getTotalCount()/ this.pageSize
                    ),activePage);
            this.displayItem.setText(msg);
        }
    },
    // 选择每页多少条数据
    onComboPageSize : function(combo, record, index) {
        var pageSize = record.get('pageSize');
        this.store.pageSize = this.pageSize = pageSize;
        var d = this.getPageData(), pageNum;
        pageNum = this.readPage(d);
        if (pageNum !== false) {
            pageNum = Math.min(Math.max(1, record.data.pageIndex), d.pages) - 1;
            this.doLoad(0);
        }
    },
    initComponent : function(){
    	if(Ext.getObjVal(this.store,'pageSize')){
    		 this.pageSize = Ext.getObjVal(this.store,'pageSize'); 
    	}
    	this.combo = Ext.ComponentMgr.create(Ext.applyIf(this.combo || {}, {
			value : 1,
			width : 50,
            store :  new Ext.data.SimpleStore({
			            fields : ['pageIndex'],
			            data : [[1]]
			        }),
            mode : 'local',
            xtype : 'combo',
            minListWidth : 50,
            allowBlank:false,
            triggerAction : 'all',
            displayField : 'pageIndex',
            allowDecimals: false,
            allowNegative: false,
            enableKeyEvents: true,
            selectOnFocus: true,
            submitValue: false
        }));
	    this.combo.on("select", this.onPagingSelect, this);
	    this.combo.on('specialkey', function() {
	        this.combo.setValue(this.combo.getValue());
	    }, this);
    	
    	
    	var T = Ext.Toolbar;
    	
    	var pagingItems = [] ;
    	
    	if(this.displayInfo){
            pagingItems.push(this.displayItem = new T.TextItem({}));
        }
        
        if (this.rowComboSelect) {
            var data = this.rowComboData ? this.rowComboData : [[10],[20],[30],[50],[80],[150],[200]];
            this.rowcombo =  this.rowcombo || Ext.create(
            	{
	                store : new Ext.data.SimpleStore({
	                    fields : ['pageSize'],
	                    data : data
	                }),
	                value : this.pageSize,
	                width : 50,
	                mode : 'local',
	                xtype : 'combo',
	                allowBlank:false,
	                minListWidth : 50,
	                displayField : 'pageSize',
	                triggerAction : 'all'
	            });
            pagingItems.push(this.rowcombo,"条/页&nbsp;&nbsp;");
            
            this.rowcombo.on("select", this.onComboPageSize, this);
            this.rowcombo.on('specialkey', function() {
                this.combo.setValue(this.combo.getValue());
            }, this);
        }
        
    	// this.totalPage = new T.TextItem({})
        pagingItems.push('->',this.first = new T.Button({
            tooltip: this.firstText,
            overflowText: this.firstText,
            iconCls: 'x-tbar-page-first',
            disabled: true,
            handler: this.moveFirst,
            scope: this
        }), this.prev = new T.Button({
            tooltip: this.prevText,
            overflowText: this.prevText,
            iconCls: 'x-tbar-page-prev',
            disabled: true,
            handler: this.movePrevious,
            scope: this
        }), '-', this.beforePageText,
        	this.inputItem = this.combo, this.afterTextItem = new T.TextItem({
            text: String.format(this.afterPageText, 1)
        }), '-', this.next = new T.Button({
            tooltip: this.nextText,
            overflowText: this.nextText,
            iconCls: 'x-tbar-page-next',
            disabled: true,
            handler: this.moveNext,
            scope: this
        }), this.last = new T.Button({
            tooltip: this.lastText,
            overflowText: this.lastText,
            iconCls: 'x-tbar-page-last',
            disabled: true,
            handler: this.moveLast,
            scope: this
        }), '-', this.refresh = new T.Button({
            tooltip: this.refreshText,
            overflowText: this.refreshText,
            iconCls: 'x-tbar-loading',
            handler: this.doRefresh,
            scope: this
        }));

        var userItems = this.items || this.buttons || [];
        if (this.prependButtons) {
            this.items = userItems.concat(pagingItems);
        }else{
            this.items = pagingItems.concat(userItems);
        }
        delete this.buttons;
        Ext.PagingToolbar.superclass.initComponent.call(this);
        this.addEvents(
            'change',
            'beforechange'
        );
        this.on('afterlayout', this.onFirstLayout, this, {single: true});
        this.cursor = 0;
        this.bindStore(this.store, true);
    }
});
Ext.ux.PagingComBo = EasyJF.Ext.PagingComBo;
Ext.reg("pagingComBo", Ext.ux.PagingComBo);

Ext.apply(Ext.form.Field.prototype,{plugins:new EasyJF.Ext.Util.HelpIconPlugin()});

Ext.Ajax.on("beforerequest",function(conn,options){
    if(options.waitMsg){
        Ext.Msg.wait(options.waitMsg,options.waitTitle || '请稍候...');
    }
})
Ext.Ajax.on("requestcomplete",function(conn,response,options){
   if(response&&response.getResponseHeader&&response.getResponseHeader["LoginRequired"]){
	    Ext.Msg.alert("提示","对不起，您还没有登录或者登录超时，请重新登录！",function(){
		    var win=window.top?window.top:window;
		    if(win.relogin)win.relogin();
		    else win.location.href="/";
	    });
	    return;
  }
  if(response&&response.getResponseHeader&&response.getResponseHeader["Unauthorized"]){
	    Ext.Msg.alert("警告","你没有该项操作的权限，请与管理员联系！");
	    return ;
  }
  if(options.waitMsg){
	    Ext.MessageBox.updateProgress(1);
	    Ext.MessageBox.hide();
  }
});
Ext.Ajax.on("requestexception",function(conn,response,options){
  var code=response.status||0;
  switch(code){
	  case 0:
	  case 12002:
	  case 12029:
	  case 12030:
	  case 12031:
	  case 12152:
	  case 13030:
	    Ext.Msg.alert("通讯异常!","您的网络连接发生中断!");
	    return false;
	    break ;
	  case -1:
	    // Ext.Msg.alert("通讯超时!","请求已经被自动取消!");
	    return false;
	    break ;
	  case 403:
	     Ext.Msg.alert("警告!","您没有操作的权限，请与管理员联系!");
	    return false;
	    break ;
	  default:
	    if(code<200||code>=300){
	       Ext.Msg.alert("警告!","发生了其它通讯异常，异常状态编码为"+code);
	      return false;
	    }
  	}
 	return true;
});


<div id="prop-EasyJF.Ext.MainSinglePanel-new"></div>/**
 * 屏蔽退格键及开户F5键
 */ 
new Ext.KeyMap(document.documentElement,[{
    key:Ext.EventObject.BACKSPACE,
    fn:function(key,e){
        var regExp = /(?:INPUT|TEXTAREA)/;
        if(!regExp.test(e.getTarget().nodeName)){
            e.stopEvent();
        }
    }
},{
    key:Ext.EventObject.F5,
    fn:function(){
        window.location.reload();
    }
}]);

//简写
Ejf.Ext = EasyJF.Ext;</pre>    
</body>
</html>