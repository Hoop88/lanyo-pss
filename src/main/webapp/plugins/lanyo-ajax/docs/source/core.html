<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />    
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">﻿/* * 用户信息列表
 */
Lanyo_Ajax={
    version:"1.0",
    title:"蓝源Ajax快速开发框架",
    permissionCheck:true,
    permissionCheckAction:"permissionCheck.ejf",
    script:'extApp.ejf?cmd=loadScript&script=',
    PersonalityUrl:"manage.ejf",
    formatUrl:function(baseUrl,cmd){
        return   baseUrl+"?cmd="+cmd;
        //for struts2的动态方法调用，使用下面的方案
        //return baseUrl+"!"+cmd+".action"  
    }
}
Ext.BLANK_IMAGE_URL = '/plugins/extjs/ext-2.2/resources/images/default/s.gif';

Ext.namespace("EasyJF.Ext","EasyJF.Ext.Msg");
<div id="prop-EasyJF.Ext.TabHistoryPlugin-override"></div>/**
 * ext bug!
 * 二进制表单 
 * baseParams['key']=[1,2,3,5] 情况下 extBug 提交数据为 '1,2,3,5'的字符串
 */
//Ext.override(Ext.data.Connection,{doFormUpload:function(k,r,q){var p=Ext.id();var i=document.createElement("iframe");i.id=p;i.name=p;i.className="x-hidden";if(Ext.isIE){i.src=Ext.SSL_SECURE_URL}document.body.appendChild(i);if(Ext.isIE){document.frames[p].name=p}var o=Ext.getDom(k.form);o.target=p;o.method="POST";o.enctype=o.encoding="multipart/form-data";if(q){o.action=q}var s,u;if(r){s=[];r=Ext.urlDecode(r,false);for(var w in r){if(r.hasOwnProperty(w)){if(Ext.isArray(r[w])){Ext.each(r[w],function(a){u=document.createElement("input");u.type="hidden";u.name=w;u.value=a;o.appendChild(u);s.push(u)})}else{u=document.createElement("input");u.type="hidden";u.name=w;u.value=r[w];o.appendChild(u);s.push(u)}}}}function x(){var b={responseText:"",responseXML:null};b.argument=k?k.argument:null;try{var c;if(Ext.isIE){c=i.contentWindow.document}else{c=(i.contentDocument||window.frames[p].document)}if(c&&c.body){b.responseText=c.body.innerHTML}if(c&&c.XMLDocument){b.responseXML=c.XMLDocument}else{b.responseXML=c}}catch(a){}Ext.EventManager.removeListener(i,"load",x,this);this.fireEvent("requestcomplete",this,b,k);Ext.callback(k.success,k.scope,[b,k]);Ext.callback(k.callback,k.scope,[k,true,b]);setTimeout(function(){Ext.removeNode(i)},100)}Ext.EventManager.on(i,"load",x,this);o.submit();if(s){for(var v=0,t=s.length;v<t;v++){Ext.removeNode(s[v])}}}});
Ext.apply(EasyJF.Ext.Msg,{
	alert:function(msg,title,fn,scope,type){
		var obj = {
				title:title||'操作提示',
				msg:msg,
				scope:scope||window,
				fn:fn,
				icon : type||Ext.Msg.INFO,
				buttons:Ext.Msg.OK,width:240
			};
		if(typeof msg == 'object')
			Ext.apply(obj,msg);
		Ext.Msg.show(obj);
	},
	error:function(msg,title,fn,scope){
		var expargs = EasyJF.Ext.Msg.error.length;
		var args = Array.prototype.slice.call(arguments,0,expargs);
		if (expargs != args.length) {
			if (args.length < expargs) {
				var i = args.length;
				for (i; i < expargs; i++) {
					args.push(null);
				}
				args.push(Ext.Msg.ERROR);
			}
		} else {
			args.push(Ext.Msg.ERROR);
		}
		EasyJF.Ext.Msg.alert.apply(this, args);
	}
});
EasyJF.Ext.Window = function() {
	var components = new Ext.util.MixedCollection();
	components.on('add',function(length, o, key){
		if(length>50){
			components.removeAt(0);
		}
	},this)
	var all = new Ext.util.MixedCollection();
	var buttonText =  {
            ok : "確定",
            cancel : "重置",
            yes : "確定",
            no : "取消"
        };
	var buttonHandler = function(button,btn){
		 var win = button.ownerCt;
		 Ext.callback(win.handler,win.scope||win,[btn,win,win.getComponent(0)]);
		 if(win.autoHide)win.hide();
	}
	return {
		defaultConfig : {
			maxWin:5,
			width : 500,
			height : 300,
			modal : true,
			layout : 'fit',
			single:true,
			constrain : true,
			buttonAlign:'center',
			closeAction : 'hide'
		},
		components:components,
		autoDestroyWin:function(win){
			if(this.all.getCount()>this.defaultConfig.maxWin){
				win.destroy();
				this.autoRemoveProperty.call(win);
				this.all.remove(win);
			}
		},
		autoRemoveProperty:function(){
			delete this.handler;
			delete this.scope;
			delete this.autoHide;
		},
		destroyComp:function(){
			var args = Array.prototype.slice.call(arguments,0);
			Ext.each(args,function(c){
				if(Ext.type(c.destroy)=='function'){
					c.destroy();
				}
				components.remove(c);
			},this)
		},
		show : function(obj) {
			var config = Ext.apply({},obj,this.defaultConfig);
				var win = this.getFreeWin(config);
				win.on('beforehide',this.autoDestroyWin,this,{single:true});
				if (config.single) {
					win.on('hide', function(win) {
						win.remove(0, true);
						components.remove(win.getComponent(0));
						this.autoRemoveProperty.call(win);
					}, this, {single : true});
				}
				win.show();
				win.setTitle(config.title);
				win.setWidth(config.width);
				win.setHeight(config.heigth);
		},
		buildComponent:function(cmp,compId){
			if(components.get(compId)){
					return components.get(compId);
			}else if(Ext.type(cmp)=='object'){
				var component = null;
				if(cmp.constructor.prototype.ctype == 'Ext.Component'){
					component = cmp;	
				}else if(cmp.constructor==Object){
					component = Ext.ComponentMgr.create(cmp,'panel');
				}else{
					component = cmp;
				}
				if(compId){
					components.add(compId,component);
				}
				return component;
			}
		},
		updateButtons:function(win,buttons){
			if(Ext.isArray(buttons) && buttons.length){
					Ext.each(win.buttons,function(btn){
						if(buttons.indexOf(btn.id)>=0){
							btn.show();
						}else{
							btn.hide();
						}
					},win);
			}else{
				Ext.each(win.buttons,function(btn){btn.hide();},win);
			}
		},
		getFreeWin:function(config){
			var win = null;
			all.each(function(o){
				if(o.hidden){
					win = o;
					return false;
				}
			},this);
			var cmp = config.items;
			var buttons = config.buttons;
			var handler = config.handler;
			var scope = config.scope;
			var autoHide = config.autoHide;
			Ext.del(config,'buttons','items','handler','autoHide','scope');
			cmp=this.buildComponent(cmp,config.compId);
			var win = win || this.getWin(Ext.apply(config,{buttons:this.getButtons.call(this)}));
			
			win.autoHide=autoHide;
			win.handler=handler;
			win.scope=scope;
			
			this.updateButtons(win,buttons);
			if(win.items && win.items.getCount()>0)win.remove(0,false);
			win.add(cmp);
			return win;
		},
		all:all,
		getWin : function(config) {
			var win = new Ext.Window(Ext.apply(config, {manager : this.group}));
			all.add(win);
			return win;
		},
		YESNO:['yes','no'],
		YESNOCANCEL:['yes','cancel','no'],
		YES:['yes'],
		getButtons:(function(){
			return [
					{text:buttonText['yes'],id:'yes',handler:buttonHandler.createDelegate(this,['yes'],1),scope:this},
					{text:buttonText['cancel'],id:'cancel',handler:buttonHandler.createDelegate(this,['cancel'],1),scope:this},
					{text:buttonText['no'],id:'no',handler:buttonHandler.createDelegate(this,['no'],1),scope:this}
				]
		})
	}
}();

<div id="prop-EasyJF.Ext.TabHistoryPlugin-apply"></div>/**
 * 日期验证器 用于验证起始日期必须早于结束日期
 */
Ext.apply(Ext.form.VTypes, {
            daterange : function(val, field) {
                var date = field.parseDate(val);
                if (!date) {
                    return;
                }
                if (field.startDateField
                        && (!this.dateRangeMax || (date.getTime() != this.dateRangeMax
                                .getTime()))) {
                    var start = Ext.getCmp(field.startDateField);
                    start.setMaxValue(date);
                    start.validate();
                    this.dateRangeMax = date;
                } else if (field.endDateField
                        && (!this.dateRangeMin || (date.getTime() != this.dateRangeMin
                                .getTime()))) {
                    var end = Ext.getCmp(field.endDateField);
                    end.setMinValue(date);
                    end.validate();
                    this.dateRangeMin = date;
                }
                return true;
            }
        });
<div id="prop-EasyJF.Ext.TabHistoryPlugin-override"></div>/**
 * @author xiaoxinxin
 */
Ext.override(Ext.form.CheckboxGroup,{
    onRender : function(ct, position) {
        if (!this.el) {
            var panelCfg = {
                cls : this.groupCls,
                layout : 'column',
                border : false,
                renderTo : ct
            };
            var colCfg = {
                defaultType : this.defaultType,
                layout : 'form',
                border : false,
                defaults : {
                    hideLabel : true,
                    name:this.name,
                    anchor : '100%'
                }
            }
            if (this.items[0].items) {
                // The container has standard ColumnLayout configs, so pass them
                // in directly
                Ext.apply(panelCfg, {
                            layoutConfig : {
                                columns : this.items.length
                            },
                            defaults : this.defaults,
                            items : this.items
                        })
                for (var i = 0, len = this.items.length; i < len; i++) {
                    Ext.applyIf(this.items[i], colCfg);
                };

            } else {

                // The container has field item configs, so we have to generate
                // the column
                // panels first then move the items into the columns as needed.

                var numCols, cols = [];

                if (typeof this.columns == 'string') { // 'auto' so create a
                                                        // col per item
                    this.columns = this.items.length;
                }
                if (!Ext.isArray(this.columns)) {
                    var cs = [];
                    for (var i = 0; i < this.columns; i++) {
                        cs.push((100 / this.columns) * .01); // distribute by
                                                                // even %
                    }
                    this.columns = cs;
                }

                numCols = this.columns.length;

                // Generate the column configs with the correct width setting
                for (var i = 0; i < numCols; i++) {
                    var cc = Ext.apply({
                                items : []
                            }, colCfg);
                    cc[this.columns[i] <= 1 ? 'columnWidth' : 'width'] = this.columns[i];
                    if (this.defaults) {
                        cc.defaults = Ext.apply(cc.defaults || {},
                                this.defaults)
                    }
                    cols.push(cc);
                };

                // Distribute the original items into the columns
                if (this.vertical) {
                    var rows = Math.ceil(this.items.length / numCols), ri = 0;
                    for (var i = 0, len = this.items.length; i < len; i++) {
                        if (i > 0 && i % rows == 0) {
                            ri++;
                        }
                        if (this.items[i].fieldLabel) {
                            this.items[i].hideLabel = false;
                        }
                        cols[ri].items.push(this.items[i]);
                    };
                } else {
                    for (var i = 0, len = this.items.length; i < len; i++) {
                        var ci = i % numCols;
                        if (this.items[i].fieldLabel) {
                            this.items[i].hideLabel = false;
                        }
                        cols[ci].items.push(this.items[i]);
                    };
                }

                Ext.apply(panelCfg, {
                            layoutConfig : {
                                columns : numCols
                            },
                            items : cols
                        });
            }

            this.panel = new Ext.Panel(panelCfg);
            this.el = this.panel.getEl();

            if (this.forId && this.itemCls) {
                var l = this.el.up(this.itemCls).child('label', true);
                if (l) {
                    l.setAttribute('htmlFor', this.forId);
                }
            }

            var fields = this.panel.findBy(function(c) {
                        return c.isFormField;
                    }, this);

            this.items = new Ext.util.MixedCollection(false,function(o){
                return o.inputValue || o.value;
            });
            this.items.addAll(fields);
        }
        Ext.form.CheckboxGroup.superclass.onRender.call(this, ct, position);
    },
    getValue:function(){
        var val = [];
        this.items.filter('checked',true).each(function(item){
        	var v = Ext.value(item.inputValue,item.value);
        	if(!Ext.isEmpty(v))val.push(v);
        },this);
        return val;
    },
    getName:function(){
        return this.name || this.id;
    },
    setValue:function(v){
    	//为了方便比较统一用字符串来比较
    	if(Ext.isArray(v)){
            v = v.toString().split(',');
    		
    	}else if(v){
    		v = v.split(/[,;\s]/);
    	}
        var arr = [].concat(v||[]);
        this.items.eachKey(function(key,item,i,len){
        	var checked = arr.indexOf(String(key))>=0;
        	item.setValue(checked);
        },this);
    },
    initValue:function(){
		if (this.value !== undefined && this.value!==null) {
			this.setValue(this.value);
		}
    }
});

Ext.override(Ext.form.RadioGroup,{
    setValue:function(v){
        this.items.each(function(item){
            if(item.inputValue==v)item.setValue(true);
        },this);
    }
})
<div id="prop-EasyJF.Ext.TabHistoryPlugin-apply"></div>/**
 * findSomeThing用来查询id或name为指定指的组件
 */
Ext.apply(Ext.Container.prototype,{findSomeThing:function(id) {
    var m, ct = this;
    this.cascade(function(c) {
        if (ct != c&& c.id === id || (c.isFormField && (c.dataIndex == id || c.id == id || c.getName() == id))) {
            m = c;
            return false;
        }
    });
    return m || null;
}});
<div id="prop-EasyJF.Ext.TabHistoryPlugin-apply"></div>/**
 * 对ComboBox的onTriggerClick进行增强，支持父容器disabled值判断功能
 */
Ext.apply(Ext.form.ComboBox.prototype,{onTriggerClick: function() {
    var disabled = false;
    if (this.ownerCt)
        this.ownerCt.bubble(function(c) {
            if (c.disabled)
                disabled = true;
        });
    if (this.disabled || disabled) {
        return;
    }
    if (this.isExpanded()) {
        this.collapse();
        this.el.focus();
    } else {
        this.onFocus({});
        if (this.triggerAction == 'all') {
            this.doQuery(this.allQuery, true);
        } else {
            this.doQuery(this.getRawValue());
        }
        this.el.focus();
    }
}});
<div id="prop-EasyJF.Ext.TabHistoryPlugin-apply"></div>/**
 * 对DateField进行扩展
 */
Ext.apply(Ext.form.DateField.prototype,{onTriggerClick:function() {
    var disabled = false;
    if (this.ownerCt)
        this.ownerCt.bubble(function(c) {
            if (c.disabled)
                disabled = true;
        });
    if (this.disabled || disabled) {
        return;
    }
    if (this.menu == null) {
        this.menu = new Ext.menu.DateMenu();
    }
    Ext.apply(this.menu.picker, {
                minDate : this.minValue,
                maxDate : this.maxValue,
                disabledDatesRE : this.ddMatch,
                disabledDatesText : this.disabledDatesText,
                disabledDays : this.disabledDays,
                disabledDaysText : this.disabledDaysText,
                format : this.format,
                showToday : this.showToday,
                minText : String.format(this.minText, this
                                .formatDate(this.minValue)),
                maxText : String.format(this.maxText, this
                                .formatDate(this.maxValue))
            });
    this.menu.on(Ext.apply({}, this.menuListeners, {
                scope : this
            }));
    this.menu.picker.setValue(this.getValue() || new Date());
    this.menu.show(this.el, "tl-bl?");
}});
<div id="prop-EasyJF.Ext.TabHistoryPlugin-apply"></div>/**
 * 修改时间选择控件，自动选择时间
 */
Ext.apply(Ext.DatePicker.prototype,{handleDateClick: function(e, t) {
    e.stopEvent();
    if (t.dateValue && !Ext.fly(t.parentNode).hasClass("x-date-disabled")) {
        var now = new Date();
        var d = new Date(t.dateValue);
        d.setHours(now.getHours());
        d.setMinutes(now.getMinutes());
        d.setSeconds(now.getSeconds());
        this.setValue(d, true);
        this.fireEvent("select", this, this.value);
    }
    },
    selectToday:function() {
        if (this.todayBtn && !this.todayBtn.disabled) {
            this.setValue(new Date(), true);
            this.fireEvent("select", this, this.value);
        }
    },
    setValue:function(value, keepTime) {
        var old = this.value;
        this.value = keepTime ? value : value.clearTime(true);
        if (this.el) {
            this.update(this.value);
        }
    }});
    
Ext.form.LabelField = Ext.extend(Ext.form.Field, {
    defaultAutoCreate: {tag: 'div'},
    fieldClass:"x-form-item-label",
    style:"padding-top:3px",
    onRender : function(ct, position){
      Ext.form.LabelField.superclass.onRender.call(this, ct, position);
      this.el.dom.name=this.initialConfig.name;
      this.el.dom.value='';      
    },  
    setValue : function(v){
       Ext.form.LabelField.superclass.setValue.call(this,v);  
       var t=v;    
       if(this.renderer)t=this.renderer(v);
       if(typeof t == window.undefined)t= '';
       this.el.update(t);
    },
    markInvalid : Ext.emptyFn,
    clearInvalid : Ext.emptyFn
});
Ext.reg('labelfield', Ext.form.LabelField);

Ext.form.LabelFieldReadonly = Ext.extend(Ext.form.LabelField,{getValue:Ext.emptyFn});
Ext.reg('labelfieldreadonly', Ext.form.LabelField);

Ext.apply(Ext.form.ComboBox.prototype,{
    PleaseSelectedValue:"--PleaseSelectedValue--",
    PleaseSelectedText:"--请选择--",
    disableChoice:false,
    reload:function(){      
        this.store.reload();
    },
    bindStore:function(store, initial){
        if(this.store && !initial){
            this.store.un('beforeload', this.onBeforeLoad, this);
            this.store.un('load', this.onLoad, this);
            this.store.un('loadexception', this.collapse, this);
            if(!store){
                this.store = null;
                if(this.view){
                    this.view.setStore(null);
                }
            }
        }
        if(store){
            this.store = Ext.StoreMgr.lookup(store);
            if(this.view){
                this.view.setStore(store);
            }
           if(this.store.data.getCount()>0 && (this.allowBlank||this.nullText) && !this.disableChoice){
                var o={};               
                o[this.valueField]=this.PleaseSelectedValue;
                var nullText=this.nullText?this.nullText:this.PleaseSelectedText;
                this.nullText=nullText;
                o[this.displayField]=nullText;
                this.store.insert(0,new Ext.data.Record(o));            
           }
           if(!this.lastOptions){
            this.store.on('beforeload', this.onBeforeLoad, this);
            this.store.on('loadexception', this.collapse, this);
            if((this.allowBlank||this.nullText)&& !this.disableChoice){
            this.store.on("load",function(A,B){
                        var o={};
                        o[this.valueField]=this.PleaseSelectedValue;
                        o[this.displayField]=this.nullText?this.nullText:this.PleaseSelectedText;
                        this.nullText=nullText;
                        if(this.store&&this.store.insert&&this.store.find(this.valueField,o[this.valueField])<0)
                        this.store.insert(0,new Ext.data.Record(o));
                    },this);
            }       
            this.store.on('load', this.onLoad, this);
           }
        }
        
},
setValue : function(v){
        var text = v;
        if(this.valueField){
            var r = this.findRecord(this.valueField, v);
            if(r){
                text = r.data[this.displayField];
            }else if(this.valueNotFoundText !== undefined){
                text = this.valueNotFoundText;
            }
        }
        this.lastSelectionText = text;
        if(this.hiddenField){
            this.hiddenField.value =(v==this.PleaseSelectedValue?"":v);
        }
        Ext.form.ComboBox.superclass.setValue.call(this, text);
        this.value = v;
    },
getValue : function(){
        // alert(this.value);
        if(this.value==this.PleaseSelectedValue||this.value==this.nullText){return "";}
        else if(this.valueField){
            return typeof this.value != 'undefined' ? this.value : '';
        }else{
            return Ext.form.ComboBox.superclass.getValue.call(this);
        }
    }  
});
<div id="prop-EasyJF.Ext.TabHistoryPlugin-apply"></div>/**
 * 对工具栏进行扩展，添加insert方法，可以插入任意工具栏选项
 */
Ext.apply(Ext.Toolbar.prototype,{
    getValues:function(){
        var c = this;
        var values={};
        if(!c.items || !c.items.getCount())return values;
        c.items.each(function(item){
            if(item.isFormField){
                var name = (item.itemId||item.name||item.id);
                var v = item.getValue();
                if(v instanceof Date) v = v.format('Y-m-d');
                values[name] = v;
            }
        },this);
        return values;
    },
    insert:function(index,item){    
       if(item instanceof Array){
            var buttons = [];
            for(var i = 0, len = item.length; i < len; i++) {
               buttons.push(this.insert(index + i, item[i]));
            }
            return buttons;
        }
        var td = document.createElement("td");
        if(this.tr.childNodes.length<=index)index=this.tr.childNodes.length-1;
        this.tr.insertBefore(td, this.tr.childNodes[index]);
       
        this.initMenuTracking(item);
        
        if(item.isFormField){ // some kind of form field
                item.render(td);
                var ti = new Ext.Toolbar.Item(td.firstChild);
                ti.render(td);
            }else if(item.render){ // some kind of Toolbar.Item
                item.render(td);
            }else if(typeof item == "string"){ // string
                if(item == "separator" || item == "-"){
                   item=new Ext.Toolbar.Separator();
                }else if(item == " "){
                    item=new Ext.Toolbar.Spacer();
                }else if(item == "->"){
                   item=new Ext.Toolbar.Fill();
                }else{
                   item=new Ext.Toolbar.TextItem(item);
                }
                item.render(td);
            }else if(item.tagName){ // element
                item=new Ext.Toolbar.Item(item);
            }else if(typeof item == "object"){ // must be button config?
                if(item.xtype){
                    item=(Ext.ComponentMgr.create(item, 'button'));
                }else{
                    item=new Ext.Toolbar.Button(item);
                }
                item.render(td);
            }           
        this.items.insert(index, item);
        return item;        
}});


/**
 * 搜索框
 * 
 * @class SearchField
 * @extends Ext.form.TwinTriggerField
 */
SearchField = Ext.extend(Ext.form.TwinTriggerField, {
            initComponent : function() {
                if (!this.store.baseParams) {
                    this.store.baseParams = {};
                }
                SearchField.superclass.initComponent.call(this);
                this.addEvents('beforeClick');
                this.on('specialkey', function(f, e) {
                            if (e.getKey() == e.ENTER) {
                                this.onTrigger2Click();
                            }
                        }, this);
            },
            validationEvent : false,
            validateOnBlur : false,
            emptyText : '内容关键字......',
            trigger1Class : 'x-form-clear-trigger',
            trigger2Class : 'x-form-search-trigger',
            hideTrigger1 : true,
            width : 180,
            hasSearch : false,
            paramName : 'searchKey',
            reset:function(){
                this.el.dom.value = '';
                this.triggers[0].hide();
                this.hasSearch = false;
                SearchField.superclass.reset.call(this);
            },
            onTrigger1Click : function() {
                if(this.fireEvent('beforeClick',this)!==false){
                    if (this.hasSearch) {
                        this.store.baseParams={};
                        this.store.baseParams[this.paramName] = '';
                        this.store.removeAll();
                        this.store.reload();
                        this.el.dom.value = '';
                        this.triggers[0].hide();
                        this.hasSearch = false;
                        this.focus();
                    }
                }
            },
            onTrigger2Click : function() {
                if(this.fireEvent('beforeClick',this)!==false){
                    var v = this.getRawValue();
                    if (v.length < 1)return this.onTrigger1Click();
                    this.store.removeAll();
                    this.store.baseParams = {};
                    this.store.baseParams[this.paramName] = v;
                    var o = {start : 0,searchType:'simple'};
                    this.store.reload({
                        params : o,
                        callback:function(rs){
                            if(!rs || rs.length<1){
                                Ext.Msg.alert("提示","没有找到符合条件的记录！");
                            }
                        }
                    });
                    this.hasSearch = true;
                    this.triggers[0].show();
                    this.focus();
                }
            }
        });
    
// Ext实用工具
EasyJF.Ext.Util={};
Ext.apply(EasyJF.Ext.Util,{
    NormalClass:{},
    theStatus : [["启用", 0],["停用", -1]],
    readOnlyGridCellColor:"#F2F2F2",
    successTag:"<font color=green>&#8730;</font>",
    failureTag:"<font color=red>X</font>",
    objectToString:function(){return this.id?this.id:this},
    recentYears:function(){
        var thisYear=new Date().getFullYear();
        var years=[];
        for(var i=thisYear-5,j=0;i<thisYear+5;i++,j++){
            years[j]=[i,i];
        }
        return years;
    }(),
    isNumber:function(oNum)     // 判断是否是数字
     {
      if(!oNum) return false;
      var strP=/^(-)?\d+(\.\d+)?$/;
      if(!strP.test(oNum)) return false;
      try{
      if(parseFloat(oNum)!=oNum) return false;
      }
      catch(ex)
      {
       return false;
      }
      return true;
     },
    theMonth:function(){
        var m=[];
        for(var i=1;i<=12;i++){
            m[i-1]=[i,i];
        }
    }(),
    linkRenderer : function(v) {
        if (!v)
            return "";
        else
            return String.format("<a style=\"color:blue;font-weight:800;\" title=\"点击后将在新窗口中打开{0}\" href='{0}' target='_blank'>{0}</a>", v);
    },
    booleanRender : function(value, p, record) {
       return value ? "<span style=\"color:green;\">是</span>" : "<span style=\"color:red;\">否</span>";
    },
    dateRender : function(format) {
        format = format || "Y-m-d G:i";
        return Ext.util.Format.dateRenderer(format);
    },
    imgRender : function(v){
        if(!v)
            return "";
        else
            return String.format("<a style=\"color:green;font-weight:800\" title=\"点击后将在新窗口中打开{0}\" href='{0}' target='_blank'>查看</a>",v)
    },
    moneyRender:function(v){
        if(v){
            if(v.toFixed){
            if(v<0)return "<font color=red>"+v.toFixed(2)+"<font>";
            else return v.toFixed(2);
            }
            else return v;
        }
    },
    userRender : function(user) {
        name = user.name || "guest";
        return name;
    },
    objectRender : function(p,backgroundColor) {
        return function(v, meta) {
            if(backgroundColor)meta.attr = 'style="background-color:'+backgroundColor+';"';
            var s="";
            try{
                s=v?eval("v." + p) : ""
            }
            catch(e){                
            }
            return s;
        }
    },
    comboxRender:function(v){       
        if(v){
        	return v.text || v.title || v;  
        }
    },
    typesRender:function(types){
        return function(v){         
            for(var i=0;i<types.length;i++){
                try{
                    
                if(types[i][1]===v)return types[i][0];
                }
                catch(e){alert(types)}
            }
            return "";
        }
    },
    readOnlyRender:function(innerRender){
        return function(v, meta){
        var d=v;
        if(innerRender)d=innerRender(d);
        meta.attr = 'style="background-color:'+EasyJF.Ext.Util.readOnlyGridCellColor+';"';
        return d;
        }
    },
    operaterTemplate:new Ext.Template("<a href='{2}' theid='{2}' op='{1}' onclick='return false'><font color='blue'>{0}</font></a>"),
    operaterRender:function(cmd,title){
        return function(v,p,r){
            if(r.get("id"))
            return EasyJF.Ext.Util.operaterTemplate.applyTemplate([title?title:(v?v:""),cmd,r.get("id")]);
        }
    },
    autoCloseMsg:function(){
        Ext.Msg.hide();     
    },
    executeUrl : function(url, params,fn) {
            return function() {
                Ext.Ajax.request({
                    waitMsg:"正在执行操作，请稍候...",
                    url : url,
                    method : 'POST',
                    params : params,
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            Ext.Msg.alert("提示",
                                    "操作失败，失败原因为：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"));
                        else {
                            Ext.Msg.alert("提示",
                                    "操作成功", fn?fn:Ext.emptyFn, this);
                        }
                    },
                    scope : this
                });
            }
    },
    submitForm:function(form,url,callback,scope,failure){
        form.submit({
            url:url,
            waitTitle:"请稍候",
            waitMsg:"正在保存，请稍候",
            success:function(form,action){
                if(callback)callback.call(scope||this,form,action);
        },
        failure : function(form, action) {
                if(failure)failure.call(scope||this,form,action);
                else {
                var msg = "";
                if (action.failureType == Ext.form.Action.SERVER_INVALID) {
                    if(form.notAlert) return "";// 这个在form中配置的一个开关，表示这个form在服务返回有错误信息的时候不弹出信息。
                    for (var p in action.result.errors) {
                        msg += action.result.errors[p] + "  ";
                    }
                } else
                    msg = "数据录入不合法或不完整！";
                    
                Ext.MessageBox.alert("保存失败！", msg);
                }
            },
        scope:scope||this
        });
    }});

    
Ext.apply(EasyJF.Ext.Util,{
    getEditGridData:function(editGrid,prefix,key,filter){
        function getV(v){
            if(v&&v.value!==undefined)v=v.value;// 根据value属性来得到
            else if(v&& v.id!==undefined)v=v.id;// 根据id属性来得到
            if(v && typeof v=="object" && v.clearTime)v=v.format("Y-m-d");
            return v;       
        }
        var o={};
        var mc=editGrid.getColumnModel().getColumnCount();
        for(var i=0;i<mc;i++){
            var n=editGrid.getColumnModel().getDataIndex(i);
            if(n)o[(prefix?prefix:"")+n]=[];
        }  
        var store=editGrid.store;
        var j=0;
        var numbererField=editGrid.getColumnModel().getColumnById("numberer")?editGrid.getColumnModel().getColumnById("numberer").dataIndex:"";
        for(var i=0;i<store.getCount();i++){
            if(key){// 如果指定了必填项，则要作必填项判断
                var v=store.getAt(i).get(key);
                v=getV(v);
                if(!v)continue;// 如果必填项没有值，则退出
                if(filter && !filter(store.getAt(i))) continue;
                if(typeof v=="object" && !String(v))continue;// 对Object类型进行处理
            }
            for(var n in o){                            
                var f=prefix?n.replace(prefix,""):n;
                if(f==numbererField)o[n][j]=j;// 处理自动排序字段
                else {
                    var v=store.getAt(i).get(f);                
                    v=getV(v);      
                    o[n][j]=(v!==null?v:"");
                }
            }
            j++;
        }       
        return j>0?o:{};
    },
    editGrid2form:function(editGrid,fp){// 把EditorGridPnael中的数据保存到表单隐藏域中
        var c=[];
        var mc=editGrid.getColumnModel().getColumnCount();
        for(var i=0;i<mc;i++){
            c[c.length]=editGrid.getColumnModel().getDataIndex(i);
        }   
        for(var j=0;j<c.length;j++){ 
            var n=c[j];
            // alert(n);
            if(fp.form.findField(n)){
            var s="";   
            for(var i=0;i<editGrid.store.getCount();i++){
                var v=editGrid.store.getAt(i).get(n);
                if(v&&v.value)v=v.value;// 根据value属性来得到
                else if(v&&v.id)v=v.id;// 根据id属性来得到
                s+=(v?v:" ")+";";
            }
            fp.form.findField(n).setValue(s);
            }           
        }
    },
    getGridDataAsString:function(grid){
        var s = [];
        grid.store.each(function(r){
        	s.push(r.get("id"))
        });
        return s.join(',');
    },
   appendGridRows:function(grid,storeMapping,rs,dataHandler,keepLastEmptyRow){
        if(rs.length==undefined)rs=[rs];
        var selectRow=grid.getSelectionModel().getSelectedCell?grid.getSelectionModel().getSelectedCell():null;
        var lastSecondRow=grid.store.getCount()-(keepLastEmptyRow?2:1);
        var appendTo=lastSecondRow;
        if(selectRow)
        appendTo=selectRow[0];
        if(appendTo<-1)appendTo=-1;
        if(appendTo==lastSecondRow+1)appendTo=lastSecondRow;        
        for(var i=0;i<rs.length;i++){
        var r=rs[i];
        var obj=dataHandler(r)
        EasyJF.Ext.Util.addGridRow(grid,storeMapping,obj,appendTo+i);
        }
    },
    loadDataGrid:function(grid,data,append){
        grid.getView().scrollToTop();//如果有滚动条,而且滚动条在底部,折可能出现页面闪烁
        var s = grid.getStore();
        s.removeAll();
        if(Ext.isArray(data)){
            var root = s.reader.meta.root;
            if(Ext.isEmpty(root)){
                s.loadData(data,append);
            }else{
                var totalProperty = s.reader.meta.totalProperty;
                var o = {};
                o[root] = data;
                o[totalProperty] = data.length;
                s.loadData(o,append);   
            }
        }else{
            s.loadData(data,append);
        }
    },
    addGridRow:function(grid,storeMapping,obj,appendTo){
        var row=appendTo;
        if(row==undefined){
        var selModel=grid.getSelectionModel();
        var record =selModel.getSelectedCell?selModel.getSelectedCell():null;   
        row=grid.store.getCount()-1;    
        if(record){
            row=record[0];
        }
        }
        var create=Ext.data.Record.create(storeMapping);
        var obj=new create(Ext.apply({},obj||{}));      
        if(grid.stopEditing)grid.stopEditing();
        grid.store.insert(row+1,obj);
        grid.getView().refresh();
    },
    removeGridRow:function(grid,callback){   
        var record = grid.getSelectionModel().getSelectedCell();    
        if(record){
        var store=grid.store;
        Ext.MessageBox.confirm("请确认","确定要删除吗？",function(ret){
            if(ret=="yes"){
                var r=store.getAt(record[0]);
                if(callback) callback(r);
                store.remove(r);
                grid.getView().refresh();
                if(store.getCount()>0)grid.getSelectionModel().select(record[0]-1<0?0:record[0]-1,record[1]);
            }});
        }
        else Ext.MessageBox.alert("提示","请选择要删除的记录!");
    },
    reloadGrid:function(grid){
        grid.getStore().removeAll();
        grid.getStore().reload();
    },
    removeGridRows:function(grid){  
        if(!grid.getSelectionModel().getSelections && grid.getSelectionModel().getSelectedCell ){//
            EasyJF.Ext.Util.removeGridRow(grid);
        }
        else{
        var rs = grid.getSelectionModel().getSelections();  
        if(rs&&rs.length>0){
        var store=grid.store;
        Ext.MessageBox.confirm("请确认","确定要删除吗？",function(ret){
            if(ret=="yes"){
                for(var i=0;i<rs.length;i++)store.remove(rs[i]); 
                grid.getView().refresh();
            }});
        }
        }
    },
    setGridColumnHidden:function(fields,hidden,grid){
        if(grid!=null && fields!=null && fields.length){
        for(var i=0;i<fields.length;i++){
        var index = grid.getColumnModel().findColumnIndex(fields[i]);
        if(index>=0){
           grid.getColumnModel().config[index].hideable=!hidden;
           grid.getColumnModel().setHidden(index, hidden);
        }
        }
        }
    }});
  
    
  Ext.apply(EasyJF.Ext.Util,{   
    columnPanelBuild:function(){
        var args = Array.prototype.slice.call(arguments,0);
        var formConfig = {};
        if(args[0]){
            if(args[0].FC||args[0].formConfig){
                Ext.apply(formConfig,(args[0].FC||args[0].formConfig));
                args.shift();
            }
        }
        var obj={layout:'column',anchor:"100%",defaults:{border:false},items:[],xtype:"panel",border:false,bodyBorder:false};
        var defaultColumn=(1/args.length).toFixed(2);
        for(var i=0;i<args.length;i++){
            var o=args[i];
            var c={columnWidth:o.columnWidth||defaultColumn,
               layout:'form',
               defaultType:o.defaultType||"textfield",
               defaults:o.defaults||{anchor:"-20"},
               items:o.items
               };
         obj.items[i]=Ext.apply(c,formConfig);
        }
      return obj;
    },
    twoColumnPanelBuild:function(){     
        var args = Array.prototype.slice.call(arguments,0);
        var formConfig = {};
        var obj={layout:'column',anchor:"100%",defaults:{border:false},items:[],xtype:"panel",border:false,bodyBorder:false};
        var max=2;
        if(typeof args[0]=="number"){
            max=args[0];
            args.shift();
        }
        if(args[0]){
            if(args[0].FC||args[0].formConfig){
                Ext.apply(formConfig,(args[0].FC||args[0].formConfig));
                args.shift();
            }
        }
        var cs=[];
        for(var i=0;i<max;i++)
                cs[i]=Ext.apply({
                columnWidth:1/max,
                layout:'form',
                defaultType:"textfield",
                defaults:{anchor:"-20"},
                items:[]
         },formConfig);
         for(var i=0;i<args.length;){
            for(var j=0;j<max;j++,i++){
                    cs[j].items[cs[j].items.length]=(i<args.length?args[i]:{xtype:"panel",border:false});   
            }
        }
        obj.items=cs;
        return obj;
    },     
    oneColumnPanelBuild:function(){
        var obj={layout:'column',anchor:"100%",defaults:{border:false},items:[],xtype:"panel",border:false,bodyBorder:false};
        var lx=arguments.length;
        for(var i=0;i<arguments.length;i++){
            if(arguments[i].hidden)lx--;
        }
        var defaultColumn=(1/lx).toFixed(2),lastColumn=defaultColumn;
        if(defaultColumn*lx>1)lastColumn=defaultColumn-(defaultColumn*lx-1);
        var begin=0,cws=null;
        if(typeof arguments[0]=="object" && arguments[0].constructor==Array){// 第一个如果是数组则用来指定列宽
            cws=arguments[0];
            begin=1;
        }
        for(var i=begin;i<arguments.length;i++){
            var field= arguments[i];
            if(field.xtype=="labelfield" && !field.anchor)field.anchor="-5";
            var c={columnWidth:cws?cws[i-1]:((i==arguments.length-1)?lastColumn:defaultColumn),
               layout:'form',
               defaultType:"textfield",
               defaults:{anchor:field.xtype=="labelfield"?"-10":"-20"},
               items:field                 
               };
            obj.items[i]=c;
        }      
        return obj;
    }});
    
    
    
    
Ext.apply(EasyJF.Ext.Util,{  
    TRANS_ID : 0,
    loadScript:function(className,script,callback,scope){
        if(!window[className]){
            Ext.Ajax.request({url:script,success:function(req){
                eval(req.responseText);
                if(callback){
                    callback.call(scope||window,window[className]);                      
                }
           },scope:this});
       }
       else if(callback) callback.call(scope||window,window[className]);       
    },
    load : function(appName) {
        var transId = ++EasyJF.Ext.Util.TRANS_ID;
        var head = document.getElementsByTagName("head")[0];
        var script = document.createElement("script");
        script.setAttribute("src", appName);
        script.setAttribute("type", "text/javascript");
        script.setAttribute("id","lanyoScript_"+EasyJF.Ext.Util.TRANS_ID);
        head.appendChild(script);
    },
    <div id="method-SearchField-loadJSON2Collection"></div>/**
     * 从指定的url加载数组或PageResult类型的JSON对象，并自动存放到本地缓存中
     * 
     * @param {}
     *            varName 缓存明称
     * @param {}
     *            url JSON数据url
     * @param {}
     *            callback 可选参数，回调函数
     * @param {}
     *            shareCache 可选参数，是否共享缓存
     * @param {}
     *            collectionType 可选参数，缓存类型，默认为MixedCollection
     */
    loadJSON2Collection : function(varName,url, callback,shareCache,collectionType) {
         Ext.Ajax.request({
                url : url,
                success : function(req) {
                    try{
                        var ret = Ext.decode(req.responseText);
                        var collection =shareCache||eval("new "+(collectionType||"Ext.util.MixedCollection")+"()");
                        if(Ext.type(ret)=='array'){
                            collection.addAll(ret);
                            EasyJF.Ext.CachedRemoteObject.DATAS[varName]=collection;
                        }
                        else if(Ext.type(ret)=='object' && Ext.type(ret.result)=='array'){
                            collection.addAll(ret.result);
                            EasyJF.Ext.CachedRemoteObject.DATAS[varName]=collection;
                        }
                    }catch(e){}
                    if (callback)callback();    
                },
                scope : this
            });
    },
    loadJSONObject:function(varName,script,callback){     
        Ext.Ajax.request({url:script,success:function(req){
            var ret=Ext.decode(req.responseText);
            if(varName)eval("("+varName+"=ret)");
            if(callback)callback();                      
       },scope:this});         
    },
    asLoadScript : function(script) {
        Ext.Ajax.request({
                url : script,
                success : function(req) {
                    eval(req.responseText);
                },
                scope : this
            });
    },
     <div id="method-SearchField-loadJS"></div>/**
         * 在页面打开的时候动态加载脚本程序
         * 
         * @param {}
         *            script 脚本名称
         */
    loadJS:function(script){
        document.write("<script src='"+script+"'></script>");
    },
    // 拷贝一颗树节点及所有子节点
    cloneTreeNode : function(nodes) {
        var ns = [];
        for (var i = 0; i < nodes.length; i++) {
            var o = Ext.apply({}, nodes[i]);
            if (nodes[i].children && nodes[i].children.length) {
                o.children = this.cloneTreeNode(nodes[i].children);
            } else
                o.children = [];
            ns.push(o);
        }
        return ns;
    },
    addObject:function(crudClass,callback,script,otherScripts,winReadyAction){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            o.createObject(callback,winReadyAction);
        }
        else {// 从脚本中加载
            var loadSuccess=function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                o.createObject(callback,winReadyAction);                
            };
            if(otherScripts){
                var s=otherScripts.split(";");
                var total=s.length,ld=0;
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);
                        ld++;
                        if(ld>=total){
                            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:loadSuccess,scope:this});
                        }
                    },scope:this});
                    }
            }
            else {
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:loadSuccess,scope:this});
            }
        }
    },
    listObject:function(crudClass,callback,script,otherScripts){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            if(o.list && (typeof o.list=="function"))o=o.list();
            if(callback)callback(o);
        }
        else {// 从脚本中加载
            if(otherScripts){
                var s=otherScripts.split(";");
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                    }});
                    }
            }   
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                if(o.list && (typeof o.list=="function"))o=o.list();
                if(callback)callback(o);
            },scope:this});     
        }
    },
    editObject:function(crudClass,callback,script,otherScripts,id,winReadyAction){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            o.editObject(id,callback,winReadyAction);
        }
        else {// 从脚本中加载
            if(otherScripts){
                var s=otherScripts.split(";");
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                    }});
                    }
            }   
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                o.editObject(id,callback,winReadyAction);
            },scope:this});     
        }
    },
    viewObject:function(crudClass,callback,script,otherScripts,id){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            o.viewObject(id,callback);
        }
        else {// 从脚本中加载
            if(otherScripts){
                var s=otherScripts.split(";");
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                    }});
                    }
            }   
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                o.viewObject(id,callback);
            },scope:this});     
        }
    },
    removeObject:function(crudClass,callback,script,otherScripts,id){
        if(this.NormalClass[crudClass]){
            var clz=this.NormalClass[crudClass];
            var o=new clz();
            o.removeObject(id,callback);
        }
        else {// 从脚本中加载
            if(otherScripts){
                var s=otherScripts.split(";");
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                    }});
                    }
            }   
            Ext.Ajax.request({url:Lanyo_Ajax.script+script,success:function(req){
                eval(req.responseText);                 
                eval("this.NormalClass."+crudClass+"="+crudClass);
                var clz=this.NormalClass[crudClass];
                var o=new clz();
                o.removeObject(id,callback);
            },scope:this});     
        }
    },
    buildCombox:function(name,fieldLabel,data,defaultValue,allowBlank){
        return {
                                xtype : "combo",
                                name : name,
                                hiddenName : name,
                                fieldLabel : fieldLabel,
                                displayField : "title",
                                valueField : "value",
                                store : new Ext.data.SimpleStore({
                                    fields : ['title', 'value'],
                                    data :  data
                                }),
                                editable : false,
                                value:defaultValue,
                                allowBlank:allowBlank,
                                mode : 'local',
                                triggerAction : 'all',
                                emptyText : '请选择...'
                            };
    },
    buildRemoteCombox:function(name,fieldLabel,url,fields,displayField,valueField,allowBlank,localStoreVar){
        var config = {xtype:"smartcombo",
                 name:name,
                 hiddenName:name,
                 displayField:displayField?displayField:"title",
                 valueField:valueField?valueField:"id",
                 lazyRender:true,
                 triggerAction:"all",
                 typeAhead: true,
                 editable:false,
                 allowBlank:allowBlank,
                 fieldLabel:fieldLabel
                };
        var storeConfig = {
            id:"id",
            url:url,        
            root:"result",
            totalProperty:"rowCount",
            remoteSort:true,    
            baseParams:{pageSize:"-1"}, 
            pageSize:"-1",
            fields:fields
        }               
        if(!Ext.isString(localStoreVar)){
            config.store=new Ext.data.JsonStore(storeConfig);
        }else{
            config.store = new EasyJF.Ext.CachedRemoteStore(Ext.apply({varName:localStoreVar},storeConfig));
        }
        return config;
    },
    printGrid:function(grid){
        var win=window.open("");
        win.document.write("<link rel='stylesheet' type='text/css' href='/stylesheet/print.css' />");
        win.document.write(grid.el.dom.innerHTML);
        win.document.close();
    },
    getSelectWin:function(winName,title,width,height,gridClz,config){
            if(!EasyJF.Ext.SelectWin)EasyJF.Ext.SelectWin={};
            if(!EasyJF.Ext.SelectWin[winName]){
                config=config||{};
                var glist=config.grid;
                if(!glist&&gridClz)glist=eval("new "+gridClz+"(config)");
                config=Ext.apply({},{title:title,width:width,height:height,grid:glist},config);
                EasyJF.Ext.SelectWin[winName]=new EasyJF.Ext.GridSelectWin(config);
            }
            return EasyJF.Ext.SelectWin[winName];
    }
});
    
// FCKeditorAPI
Ext.apply(EasyJF.Ext.Util,{
    setDelayEditorContent:function(name,html){
        if(typeof FCKeditorAPI=="object"){
            var editor=FCKeditorAPI.GetInstance(name)
            if(editor)editor.SetHTML(html||"");
        }
    },
    setFCKEditorContent:function(name,html){
        if(typeof FCKeditorAPI=="object"){
            var editor=FCKeditorAPI.GetInstance(name)
            if(editor)editor.SetHTML(html||"");
            else this.setDelayEditorContent.createCallback(name,html).defer(2000);
        }
        else this.setDelayEditorContent.createCallback(name,html).defer(2000);
    },
    getFckById:function(id){
		var fckApi = window.FCKeditorAPI;
		if(!fckApi)return null;
		return fckApi.GetInstance(id);
    },
    getFCKEditorContent:function(name){
        if(typeof FCKeditorAPI=="object"){
            var editor=FCKeditorAPI.GetInstance(name)
            return editor.GetHTML();
        }
        else return "";
    },
    autoFocusFirstRow:function(grid){
        grid.store.on("load",function(){
            if(grid.rendered){
                var sel=grid.getSelectionModel();
                if(!sel.hasSelection() && grid.store.getCount()){
                // grid.getSelectionModel().selectFirstRow();
                grid.getView().focusRow(0);
                }else if(sel.hasSelection()) {
                    grid.getView().focusRow(grid.store.indexOf(grid.getSelectionModel().getSelected()));
                }
                else {
                    grid.focus();
                }
            }
            else {
                grid.on("render",function(g){
                EasyJF.Ext.Util.autoFocusFirstRow(g);
                })
            }
        })
    },
    getExportForm:function(){
            var exportForm=Ext.getCmp("global_export_form");
            if(!exportForm){
                exportForm=new Ext.form.FormPanel({fileUpload:true,hidden:true,items:{}});
                var fe=document.createElement("div");
                document.body.appendChild(fe);
                exportForm.render(fe);
            }
            return exportForm;
    },
    <div id="method-SearchField-executePanleButtons"></div>/**
     * 执行Panel上的某一个按钮
     * 
     * @param {}
     *            p
     * @param {}
     *            btn
     */
    executePanleButtons:function(p,btn){
        if(p.buttons&&p.buttons.length){
        for(var i=0,bs=p.buttons;i<bs.length;i++){
            if(bs[i].id==btn){
                if(!(bs[i].disabled||bs[i].hidden) && bs[i].handler)bs[i].handler.call();
                break;
            }
        }
        }
    },  
    <div id="method-SearchField-executeLocalCommand"></div>/**
     * 执行本地命令
     * 
     * @param {}
     *            cmd 命令名称
     * @param {}
     *            value 参数值
     */
    executeLocalCommand:function(cmd,value,callback){
        LanyoBrowser.executeLocalCommand(cmd,value,callback);
    },
    ajaxRequest:function(url, params, scope, success, failure,
        successOp) {
    Ext.Ajax.request({
                url : url,
                params : params || {},
                scope : scope || this,
                success : success || function(response,options) {
                    var data = Ext.decode(response.responseText);
                    if (data.success) {
                        if (successOp)
                            successOp.call(this,data,options);
                        else if(data.msg){
                            EasyJF.Ext.Msg.alert(data.msg);
                        }
                    } else if(data.msg){
                        Ext.Msg.errorMsg(null, data.msg);
                    }
                },
            failure : failure || function(response) {
                var data = Ext.decode(response.responseText);
                Ext.Msg.errorMsg(null, data.msg? data.msg: (data.errors && data.errors.msg? data.errors.msg: "未知错误原因!"));
            }
        });
}
});


LanyoBrowser = {
    client: { serverUrl: "", usbKey: "", loginKey: "", orgId: "", userName: "" },
    user: {},
    usb: {},
    ids: [],
    cmds: [],
    getId: function() {
        var id = Math.random(1000).toString();
        while (this.cmds.indexOf(id) >= 0) {
            id = Math.random(1000).toString();
        }
        return id;
    },   
    executeLocalCommand: function(cmd, value, callback) {
        var id = this.getId();
        this.ids.push(id);
        if (callback) {
            var o = { id: id, fn: callback };
            this.cmds.push(o);
        }
        window.status = "LOCALCMD:" + id + ":" + cmd + ":" + (value || "");
        return id;
    },   
    sendLocalCommandResult: function(id, value) {
        var cmd = null;
        for (var i = 0; i < this.cmds.length; i++) {
            if (this.cmds[i].id == id) {
                cmd = this.cmds[i];
                break;
            }
        }
        if (cmd) {
            if (cmd.fn) cmd.fn(value);
            this.cmds.remove(cmd);
        }
        this.ids.remove(id);
        var sdom = document.getElementById(id);
        if (sdom) {
            document.getElementsByTagName("head")[0].removeChild(sdom);
        }
    }
}

EasyJF.Ext.FormWindow=Ext.extend(Ext.Window,{
    confirmSave:false,
    checkFormDirty:function(){
        var fp=this.getComponent(0);
        /*fp.form.items.each(function(f){
            if(f.isDirty())console.log(f.name);
        })*/
        if(fp&&fp.form){
        return fp.form.isDirty();
        }       
        else return false;
        },
    hide : function(animateTarget, cb, scope){
        if(this.hidden || this.fireEvent("beforehide", this) === false){
            return;
        }
        if(this.confirmSave && this.checkFormDirty()){
            Ext.MessageBox.show({
                   title:'是否要保存录入的数据?',
                   msg: '您所编辑的表单中含有末保存的数据,是否要保存修改后的内容?',
                   buttons: Ext.Msg.YESNOCANCEL,
                   fn:function(btn){
                    if(btn=="no"){
                        EasyJF.Ext.FormWindow.superclass.hide.call(this,animateTarget, cb, scope);
                    }else if(btn=="yes"){
                        if(this.crudService){
                            this.crudService.save(EasyJF.Ext.FormWindow.superclass.hide.createDelegate(this,[animateTarget, cb, scope]),this.autoClose);
                        }
                    }
                    else if(btn=="cancel"){
                        // doNothing
                    }
                   },
                   icon: Ext.MessageBox.QUESTION,
                   scope:this
                });
        }
        else {
            EasyJF.Ext.FormWindow.superclass.hide.call(this,animateTarget, cb, scope);
        }
    }
    
});

<div id="prop-SearchField-CrudFunction"></div>/**
 * 增删改查相关功能
 */
EasyJF.Ext.CrudFunction={
    layout : "fit",
    border : false,
    closable : true,
    autoScroll : true,
    exportData : false,// 是否显示导出excel按钮
    importData:false,// 是否显示导入exdel数据
    printData:false,
    clearData:false, // 是否清楚查询
    allowSearch : true,// 是否允许自定义查询
    showMenu : true,// 用来定义是否显示右键菜单
    showAdd:true,// 默认显示添加按钮
    showEdit:true,// 默认显示编辑按钮
    showRemove:true,// 默认显示删除按钮
    showView : true,// 用来定义是否显示查看面板
    showRefresh:true,// 用来控制CRUD中的refresh按钮显示
    showSearchField:true,// 用来控制searchField按钮显示
    gridForceFit : true,// 强制表格自动适应
    batchRemoveMode:false,// 是否是批量删除模式
    autoLoadGridData:true,// 自动加载表格数据
    columnLock:false,// 表格列锁定
    summaryGrid:false,// 统计表格
    dirtyFormCheck:true,// 是否自动检查编辑表单中的数据项已经修改
    operatorButtonStyle:1,// 1为图文混合,2为文字,3为图标
    customizeQueryObject:false,// 是否开始自定义查询支持
    queryObjectName:null,// 自定义查询对象的名称
    winWidth : 500,// 默认的窗口宽度
    winHeight : 400,// 默认的窗口高度
    winTitle : "数据管理",// 默认的窗口标题
    pageSize : 10,// 每页显示条数
        pagingToolbar : true,// 是否显示工具栏
        defaultCmd:true,// 默认用cmd=list
        viewSave : Ext.emptyFn,// 用来处理视图查看时，保存按钮的回调函数
        initComponent:Ext.emptyFn,
        linkRenderer : EasyJF.Ext.Util.linkRenderer,
        linkRender:EasyJF.Ext.Util.linkRenderer,
        imgRender :EasyJF.Ext.Util.imgRender,
        booleanRender :  EasyJF.Ext.Util.booleanRender,
        dateRender :EasyJF.Ext.Util.dateRender,
        userRender : EasyJF.Ext.Util.userRender,
        objectRender : EasyJF.Ext.Util.objectRender,
        typesRender : EasyJF.Ext.Util.typesRender,
        readOnlyRender:EasyJF.Ext.Util.readOnlyRender,
        operaterRender:EasyJF.Ext.Util.operaterRender,
        singleWindowMode:false,
        booleans:[["是",true],["否",false]],
        crud_operators:[{
            name:"btn_add",
            text : "添加(<u>A</u>)",
            cls : "x-btn-text-icon",
            icon : "images/lanyo-ajax/add.png",
            method : "create",
            cmd:"save",
            noneSelectRow:true,
            hidden:true
        },{
            name:"btn_edit",
            text : "编辑(<u>E</u>)",
            cls : "x-btn-text-icon",
            icon : "images/lanyo-ajax/edit.png",
            disabled:true,
            method : "edit",
            cmd:"update",
            hidden:true
        },{
            name:"btn_view",
            text : "查看(<u>V</u>)",
            cls : "x-btn-text-icon",
            icon : "images/lanyo-ajax/view.png",
            method : "view",
            disabled:true,
            hidden : true
        },{
            name:"btn_remove",
            text : "删除(<u>D</u>)",
            cls : "x-btn-text-icon",
            icon : "images/lanyo-ajax/delete.png",
            disabled:false,
            method : "removeData",
            cmd:"remove",
            hidden : true
        },{
            name:"btn_refresh",
            text : "刷新",
            cls : "x-btn-text-icon",
            icon : "images/lanyo-ajax/f5.png",
            method : "refresh",
            noneSelectRow:true
        },{
            name:"btn_advancedSearch",
            text : "高级查询(<u>S</u>)",
            cls : "x-btn-text-icon",
            icon : "images/lanyo-ajax/srsearch.gif",
            method : "advancedSearch",
            cmd:"list",
            hidden : true,
            noneSelectRow:true,
            clientOperator:true
        },{
            name:"btn_clearSearch",
            text : "显示全部",
            cls : "x-btn-text-icon",
            icon : "images/lanyo-ajax/search.png",
            noneSelectRow:true,
            method : "clearSearch",
            hidden : true
        },{
            name:"btn_print",
            text : "打印(<u>P</u>)",
            iconCls:"print-icon",
            disabled:true,
            method : "printRecord",
            hidden : true
        },{
            name:"btn_export",
            text : "导出Excel(<u>O</u>)",
            iconCls : 'export-icon',
            method : "exportExcel",
            noneSelectRow:true,
            hidden : true
        },{
            name:"btn_import",
            text : "导入数据(<u>I</u>)",
            iconCls : 'import-icon',
            method : "importExcel",
            noneSelectRow:true,
            hidden : true
        },'->',{
            type:"SearchField",
            name:"searchField",
            width : 100,
            noneSelectRow:true,
            paramName : 'searchKey',
            clientOperator:true
        }],
        objectAutoRender:function(v){
            if(v&&v.id){
                for(var d in v){
                    if(d!="id" && v[d])return v[d];
                }
                return v.id;
            }else return v;
        },
        search : function() {
            Ext.apply(this.store.baseParams, {
                        searchKey : this.searchField?this.searchField.getValue():""
                    });
            if(this.store.lastOptions&&this.store.lastOptions.params){
            this.store.lastOptions.params.start=0;
            this.store.lastOptions.params.pageSize=this.store.baseParams.pageSize||this.pageSize;
            }
            this.refresh();
        },
        formatUrl:function(cmd){
          return   Lanyo_Ajax.formatUrl(this.baseUrl,cmd);
        },
        importExcel:function(){
            if(!EasyJF.Ext.ImportPanel){
                EasyJF.Ext.ImportPanel=new Ext.form.FormPanel({
                        id:"crudExportPanel",
                        fileUpload:true,
                        items:[{xtype:"fieldset",title:"选择数据文件",autoHeight:true,items:{xtype:"textfield",hideLabel:true,inputType:"file",name:"file",anchor:"100%"}},
                        {xtype:"fieldset",title:"导入说明",html:"",height:60}
                    ]});
            }
            
            var win=this.createGlobalWin("CrudExportWindow",300,210,"导入数据",EasyJF.Ext.ImportPanel,function(){
                var form=EasyJF.Ext.ImportPanel.form;           
                if(form.findField("file").getValue().length<2){
                    Ext.Msg.alert("提示","你没有选择要导入的文件！");
                    return ;
                }
                EasyJF.Ext.ImportPanel.form.submit({
                    url:this.baseUrl,
                    params:{cmd:"import"},
                    waitMsg:"请稍候，正在导入数据",
                    success:function(){
                        Ext.Msg.alert("提示","数据导入成功!",function(){form.findField("file").reset();win.hide();this.store.reload();},this)
                    },
                    failure:function(){
                        this.alert("数据导入出错，请检测所选择的文件格式是否正确?","提示信息");
                    },
                    scope:this
                })
            });
        },
        getExportForm:EasyJF.Ext.Util.getExportForm,
        <div id="method-SearchField-exportExcel"></div>/**
         * 导出数据为Excel格式
         */
        exportExcel : function() {
            var params = this.store.baseParams;
            Ext.apply(params, {
                        searchKey : this.searchField?this.searchField.getValue():""
                    });
            /*
             * var s = Ext.urlEncode(params); window.open(this.baseUrl +
             * '?cmd=export&' + s);
             */
            var exportForm=this.getExportForm();
            exportForm.form.submit({
                    url:this.baseUrl,
                    params:Ext.apply({cmd:"export"},this.store.baseParams)
            });
        },  
        printList:function(cmd){
            return function(){
             var params=    Ext.apply(this.store.baseParams,{cmd:(cmd?cmd:"printList")});
             var s = Ext.urlEncode(params);
             window.open(this.baseUrl+"?" + s);
            }              
        },
        printRecord:function(){
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            window.open(this.baseUrl+"?cmd=print&id=" + record.get("id"));  
        },
        clearSearch:function(){
             this.store.baseParams = {};
             this.store.removeAll();
             this.store.load({params:{start:0,pageSize:this.pageSize}});
            // this.refresh();
        },  
        <div id="method-SearchField-refresh"></div>/**
         * 重新加载数据
         */
        refresh : function() {
            this.store.removeAll();
            this.store.reload({callback:function(rs){
                if(rs && rs.length<1){this.alert("没有符合条件的数据！","提示信息");
                EasyJF.Ext.Util.autoCloseMsg.defer(2000);}
                },scope:this});
            this.disableOperaterItem("btn_remove","btn_edit","btn_view","btn_print");
            this.focus();
        },  
        initWin : function(width, height, title,callback,autoClose,resizable,maximizable) {
            this.winWidth = width;
            this.winHeight = height;
            this.winTitle = title;
            var winName=autoClose?"CrudEditNewWindow":"CrudEditWindow";
            if(this.singleWindowMode)winName=winName+this.id;
            var win=this.createGlobalWin(winName,width,height,title,this.fp,null,"fp",[{
                                id : "btnSave",
                                text : "保存(<u>K</u>)",
                                handler : function() {
                                    EasyJF.Ext[winName].crudService.save(callback,autoClose);
                                },
                                iconCls : 'save',
                                scope : this
                            }, {
                                id : "btnReset",
                                text : "重置(<u>R</u>)",
                                iconCls : 'clean',
                                handler : function() {
                                    EasyJF.Ext[winName].crudService.reset()
                                },
                                scope : this
                            }, {
                                id : "btnClose",
                                text : "取消(<u>X</u>)",
                                iconCls : 'delete',
                                handler : function() {
                                    EasyJF.Ext[winName].crudService.closeWin(autoClose)
                                },
                                scope : this
                            }],autoClose,resizable?true:false,maximizable?true:false);
            win.confirmSave=this.dirtyFormCheck;
            return win;
        },
        getViewWin : function(autoClose) {
            var width = this.viewWin.width;
            var height = this.viewWin.height;
            var title = this.viewWin.title;
            return  this.createGlobalWin("CrudViewWindow",width,height,title,this.viewPanel,function() {
                                    var w = EasyJF.Ext.CrudViewWindow;
                                    if (w.crudService)
                                        w.crudService.viewSave(this.viewPanel);
                                    w.hide();
                                },"viewPanel",null,autoClose);
        },  
        doSomeWork : function(width,height,title,panel,createPanel,cmd,workWinName,url,autoClose){
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            if(!this[panel])this[panel]=this[createPanel]();
            var win=this.getWorkWin(width,height,title,this[panel],function(){
                if(!this[panel].form.isValid()) return false;
                this[panel].form.submit({
                    url:url?url:this.baseUrl,
                    waitMsg:"正在执行操作，请稍候",
                    params:{cmd:cmd},
                    success:function(){
                        win.hide();
                        this.refresh()
                    },          
                    failure : function(form, action) {
                        var msg = "";
                        if (action.failureType == Ext.form.Action.SERVER_INVALID) {
                            for (var p in action.result.errors) {
                                msg += action.result.errors[p] + "&nbsp;";
                            }
                        } else
                            msg = "数据录入不合法或不完整！";
                        this.alert(msg,"保存失败!");
                    },
                    scope:this          
                });
            },panel,workWinName,autoClose);     
            return win;
           
        },
        // 根据当前的数据创建一个工作窗口
        getWorkWin : function(width,height,title,workPanel,save,pname,winName,autoClose) {
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            var id = record.get("id");
            var win=this.createGlobalWin(winName?winName:"CrudWorkWindow",width,height,title,workPanel,save,pname,null,autoClose);      
            // 显示数据
            for (var n in record.data) {
                var c = win.getComponent(0).findSomeThing(n);
                // if(!c &&
                // win.getComponent(0).getXType()=="form")c=win.getComponent(0).form.findField(n);
                if (c) {
                    var v = record.get(n);
                    if (c.isFormField) {
                        c.setValue(v);
                        c.clearDirty();
                    } else{
                        if(c.renderer)v=c.renderer(v);
                         if (c.setText)
                        c.setText(v);
                        else if (c.getXType && c.getXType() == "panel")
                        c.body.update(v);
                    }
                }
            }
            return win;
        },
        alert:function(msg,title){
            Ext.Msg.alert(title||"提示",msg,function(){
                this.focus();
            },this);
        },
        confirm:function(title,msg,callback){
            Ext.Msg.confirm(title,msg,function(btn){
                if(btn=="yes"){
                    callback();
                }
                else {
                    this.focus();
                }
            },this);
        },
        focusFirstField:function(fp,win){
            fp=fp||this.fp;
            win=win||this.win;
            var fp=win.findByType("form");
                    win.currentFocus=false;
                    if(fp&&fp[0].form.items){
                        fp[0].form.items.each(function(o){
                            if(o.canFocus()){
                                o.focus("",10);
                                win.currentFocus=o;
                                return false;
                            }
                        });
                    }
                    if(!win.currentFocus){
                        if(win.buttons && win.buttons.length){
                            win.buttons[0].focus("",10);
                            win.currentFocus=win.buttons[0];
                        }
            }
        },
        // 得到一个全局的操作窗口，参数width表示窗口宽度，height表示窗口高度，title表示窗口标题，workPanel表示窗口名称，save表示回调函数，作用域为this,pname表示属性名称，比如viewPanel
        createGlobalWin : function(winName,width,height,title,workPanel,save,pname,buttons,autoClose,resizable,maximizable) {
            var win = EasyJF.Ext[winName];
            if (!win) {
                this[pname?pname:workPanel.id]=workPanel;
                var tools=[];
                tools.push({id:"help",handler:this.help});
                EasyJF.Ext[winName] = new EasyJF.Ext.FormWindow({
                    width : width,
                    layout : 'fit',
                    border : false,
                    resizable : resizable,
                    height : height,
                    buttonAlign : "center",
                    title : title,
                    modal : true,
                    defaultButton:0,
                    shadow : true,
                    maximized:false,
                    maximizable:maximizable,// this.enableMaxime,
                    // constrain:true,
                    tools:tools,
                    closeAction : autoClose||this.singleWindowMode?"close":"hide",
                    autoClose:autoClose||this.singleWindowMode,
                    listeners:{close:function(win){
                        if(win.crudService.store && win.crudService.closeSaveWin===false && winName!="CrudSearchWindow"){
                            win.crudService.store.reload();
                        }
                        win.crudService.focusCrudGrid();
                        delete EasyJF.Ext[winName];
                    },maximize:function(win){if(win.maximizable){win.doLayout();win.maximized=true}},// 如果需要实现可最大化和最小化，就要重写maximize和restore事件
                    restore:function(win){if(win.maximizable){win.doLayout();win.maximized=false}},
                    show:function(win){
                    if(win.maximizable)
                    win.tools[win.maximized?"maximize":"restore"].setVisible(win.crudService.maximizable===true);
                    win.tools.help.setVisible(win.crudService.showHelp!=undefined);                 
                    var fp=win.findByType("form");
                    win.crudService.focusFirstField(fp,win);
                    },
                    hide:function(win){
                        if(win.crudService.store && win.crudService.closeSaveWin===false && winName!="CrudSearchWindow"){
                            win.crudService.store.reload();
                        }
                        win.crudService.focus();
                    }
                    },
                    items : [workPanel],
                    buttons : buttons?buttons:[{
                                id : "btnSave",
                                text : "确定(<u>K</u>)",
                                handler : function() {
                                    var w = EasyJF.Ext[winName];
                                    var h=true;
                                    if (save)
                                        h=save.call(w.crudService,autoClose);
                                    if(h){
                                        if(autoClose)w.close();
                                        else w.hide();
                                        }
                                },
                                iconCls : 'save',
                                scope : this
                            }, {
                                id : "btnClose",
                                text : "退出(<u>X</u>)",
                                iconCls : 'delete',
                                handler : function() {
                                    if(autoClose||this.singleWindowMode)EasyJF.Ext[winName].close();
                                    else EasyJF.Ext[winName].hide();
                                },
                                scope : this
                            }],
                    keys:[{key:"k",alt:true,stopEvent:true,fn:function(){
                        EasyJF.Ext.Util.executePanleButtons(win,"btnSave");
                    }
                    },{
                    key:"x",stopEvent:true,alt:true,fn:function(){
                        EasyJF.Ext.Util.executePanleButtons(win,"btnClose");
                    }
                    },{
                    key:"r",stopEvent:true,alt:true,fn:function(){
                        EasyJF.Ext.Util.executePanleButtons(win,"btnReset");
                    }
                    }]      
                });
                win=EasyJF.Ext[winName];                
            } else if (workPanel) {// 更改窗口中的内容，包括全局的事件响应函数等
                if(win.crudService!=this){
                win.resizable = resizable;
                win.maximizable=maximizable;
// if(win.maximizable&&win.tools["restore"])win.tools["restore"].setVisible(false);
                }
                win.setTitle(title);
                win.setWidth(width);
                win.setHeight(height);
                if (win.getComponent(0) != workPanel) {
                    var p=win.remove(0);
                    delete win.crudService[pname?pname:p.id];// 删除上一个
                    win.add(workPanel);
                    this[pname?pname:workPanel.id]=workPanel;
                    win.doLayout();
                }
            }
            win.crudService = this; // crudService用来定义全局的添删改查服务
            this[winName]=win;
            win.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(){win.center();},this);
            return win;
        },
        showWin : function() {
            if (!this.fp) {
                if(!this.createViewPanel && this.viewPanel){
                    this.fp = this.viewPanel;
                }else{
                    this.fp = this.createForm();
                }
            }
            this.win = this.createWin();
            this.win.on("close", function() {
                            delete this.win;
                            delete this.fp;
                        }, this);
            this.win.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(){this.win.center();},this);
        },
        onCreate:function(){
            
        },
        create : function() {
            this.showWin();
            this.fp.form.clearData();
            this.reset();
            this.fp.form.isValid();
            this.onCreate();
            this.formFocus.defer(500,this);
        },
        // 供外部调用创建一个新的对象
        createObject : function(callback,winReadyAction) {
            this.fp = this.createForm();
            this.win = this.createWin(callback,true);
            this.win.on("close", function() {
                            delete this.win;
                            delete this.fp;
            }, this);
            this.win.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(){this.win.center();},this);
            this.reset();
            if(winReadyAction){
                winReadyAction(this.win,this);
            }
            this.fp.form.isValid();
            this.onCreate();
            this.formFocus.defer(500,this);
        },
        onEdit:function(ret,data){
            
        },
        editObject : function(id,callback,winReadyAction) {
            this.fp = this.createForm();
            this.win = this.createWin(callback,true);
            this.win.on("close", function() {
                            delete this.win;
                            delete this.fp;
            }, this);
            this.win.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(){this.win.center();},this);
            var viewCmd=this.viewCmd||"view";
            Ext.Ajax.request({url:this.baseUrl+"?cmd="+viewCmd,params:{id:id},waitMsg:"正在加载数据,请稍侯...",callback:function(options,success,response){
                var r = Ext.decode(response.responseText);
                this.fp.form.setValues(r);
                if(winReadyAction){
                    winReadyAction(this.win,r,this);
                }
                this.onEdit(true,r);
                this.fp.form.isValid();
                this.formFocus.defer(500,this);
                this.fp.form.clearDirty();
            },scope:this});
        },
        edit : function() {
            if(this.btn_edit && this.btn_edit.disabled){this.view();return false;}
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            var id = record.get("id");
            this.showWin();
            this.fp.form.reset();
            this.fp.form.loadRecord(record);
            this.onEdit(true,record.data);
            this.fp.form.clearDirty();
            this.formFocus.defer(500,this);
            return true;
        },
        removeObject : function(id,callback) {
            this.confirm("删除确认","确定要删除吗？", function(ret) {
                            Ext.Ajax.request({
                                url : this.baseUrl + '?cmd=remove',
                                params : {
                                    'id' : id
                                },
                                method : 'POST',
                                success : function(response) {
                                    var r = Ext.decode(response.responseText);
                                    if (!r.success){
                                        this.alert("操作失败，失败原因为：<br/>"+ (r.errors.msg? r.errors.msg: "未知"),"提示信息");
                                    }
                                    else {
                                        this.alert("删除成功","提示信息");
                                        if(callback)callback();
                                    }
                                },
                                scope : this
                            });
                    }.createDelegate(this), this);
        },
        formFocus:function(){
            var field=this.fp.form.items.get(1);// 默认从第一个元素开始
            if(!field || field.disabled)
             this.items.each(function(f){
                if(!f.disabled){
                field=f;
                return false;
                }
             });
             if(field && !field.disabled)
             field.focus("",100);
        },
        validateForm:function(form){
            if(!form.isValid()){
                this.alert("表单数据不合法,请注意必填项及录入的数据格式!","提示",function(){
                this.formFocus();
                },this);
                // Ext.Msg.hide.defer(3000,Ext.Msg);
                return false;
            }
            return true;
        },
        onSave:function(form,action){
            
        },
        beforeSave:function(){
            return true;
        },
        save : function(callback,autoClose,ignoreBeforeSave) {
            if(!this.validateForm(this.fp.form))return false;
            if(ignoreBeforeSave!==true){
                if(this.beforeSave && this.beforeSave()===false)return false;
            }
            var id = this.fp.form.findField("id").getValue();
            var url = this.baseUrl;
            if (this.fp.form.fileUpload) {
                var cmd = this.fp.form.findField("cmd");
                if (cmd == null) {
                    cmd = new Ext.form.Hidden({
                        name : "cmd"
                    });
                    this.fp.add(cmd);
                    this.fp.doLayout();
                }
                cmd.setValue((id ? "update" : "save"));
            } else {
                 url=this.formatUrl((id ? "update" : "save"));
            }
            EasyJF.Ext.Util.submitForm(this.fp.form,url,function(form,action){
                this.fp.form.clearDirty();
                if(this.closeSaveWin!==false)this.closeWin(autoClose);
                if(this.store && this.closeSaveWin!==false){
                    this.store.reload();
                }
                if(callback)callback();
                this.fireEvent("saveobject",this,form,action);
                this.onSave(form,action);
                /*
                 * if(this.win && this.closeSaveWin===false){ this.formFocus(); }
                 */
            },this);
        },
        <div id="method-SearchField-preview"></div>/**
         * 打印预览
         * 
         * @param {}
         *            callback
         * @param {}
         *            autoClose
         * @return {Boolean}
         */
        preview : function(callback,autoClose) {
            if(!this.validateForm(this.fp.form))return false;
            var id = this.fp.form.findField("id").getValue();
            var url = this.baseUrl;
            if (this.fp.form.fileUpload) {
                var cmd = this.fp.form.findField("cmd");
                if (cmd == null) {
                    cmd = new Ext.form.Hidden({
                        name : "cmd"
                    });
                    this.fp.add(cmd);
                    this.fp.doLayout();
                }
                cmd.setValue("preview");
            } else {
                url =this.formatUrl("preview");
            }
            var tempHiddens=[];
            var ps = this.fp.form.baseParams;
            if(ps&& typeof ps == 'string')ps=Ext.urlDecode(bp);
            var form=this.fp.form.el.dom;
            function addHiddenKey(key,value){
                var hd = document.createElement('input');
                    hd.type = 'hidden';
                    hd.name = key;
                    hd.value = value;
                    form.appendChild(hd);
                    tempHiddens.push(hd);
            }
            for(var k in ps){
                if(Ext.isArray(ps[k])){
                    for(var i=0;i<ps[k].length;i++){
                        addHiddenKey(k,ps[k][i]?ps[k][i]:"");
                        
                    }                   
                }else if(ps.hasOwnProperty(k)){                 
                    addHiddenKey(k,ps[k]?ps[k]:"");                   
                }
            }
            this.fp.form.el.dom.action=url;
            this.fp.form.el.dom.target="_blank";
            this.fp.form.el.dom.submit();
            if(tempHiddens){ // 删除动态的参数
            for(var i = 0, len = tempHiddens.length; i < len; i++){
                Ext.removeNode(tempHiddens[i]);
                }
            }
        },
       reset : function() {
            if (this.win && this.fp){
                this.fp.form.reset();
            }
        },
        closeWin : function(autoClose) {
            if(this.beforeClose){
                this.beforeClose(function(){
                    if (this.win){
                        if(autoClose)this.win.close();
                        else this.win.hide();
                    }
                    if(this.store && this.closeSaveWin===false){
                        // this.store.reload();
                    }
                });
            }else{
                if (this.win){
                    if(autoClose)this.win.close();
                    else this.win.hide();
                }
                if(this.store && this.closeSaveWin===false){
                    // this.store.reload();
                }
            }
        },      
        removeData : function() {
            if(this.btn_remove.disabled)return false;
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！","提示信息");
                return false;
            }
            var mulitId = "";
            if(this.batchRemoveMode){       
                var rs = this.grid.getSelectionModel().getSelections(); 
                for (var i = 0; i < rs.length; i++)
                    mulitId += rs[i].get("id") + ",";
            }
            var m =this.confirm("删除确认",
                    "确定要删除吗？", function(ret) {                      
                            Ext.Ajax.request({
                                url : this.formatUrl('remove'),
                                params : {
                                    'id' : record.get("id"),
                                    'mulitId' : mulitId
                                },
                                method : 'POST',
                                success : function(response,options) {
                                    var r = Ext.decode(response.responseText);
                                    if (r && !r.success)
                                    	EasyJF.Ext.Msg.error("失败原因为：<br/>"+ (r.errors.msg? r.errors.msg: "未知"));
                                    else {
                                        Ext.Msg.alert("提示","删除成功",
                                                function() {
                                                    this.store.removeAll();
                                                    this.store.reload();
                                                    this.focus();
                                                }, this);
                                    }
                                    this.fireEvent("removeobject",this,r,options);
                                },
                                scope : this
                            });
                        
                    }.createDelegate(this), this);
            return true;
        },
        executeUrl : function(url, params,fn) {
            return function() {
                Ext.Ajax.request({
                    waitMsg:"正在执行操作，请稍候...",
                    url : url,
                    method : 'POST',
                    params : params,
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            this.alert("操作失败，失败原因为：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"));
                        else {
                            Ext.Msg.alert("提示","操作成功", fn?fn:Ext.emptyFn, this);
                        }
                    },
                    scope : this
                });
            }
        },
        executeCmd : function(cmd, allowBlank) {
            return function(c) {
                var sel=this.grid.getSelectionModel();
                var record = sel.getSelectedCell?(sel.getSelectedCell()?this.grid.store.getAt(sel.getSelectedCell()[0]):null):sel.getSelected();
                if(!c.noneSelectRow){
                if (!record && !allowBlank) {
                    this.alert("请先选择要操作的数据！");
                    return;
                }}
                var id = record ? record.get("id") : "";
                
                Ext.Ajax.request({
                    waitMsg:"正在执行操作，请稍候...",
                    url : this.formatUrl(cmd),
                    params : {
                        'id' : id
                    },
                    method : 'POST',
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            this.alert(
                                    "操作失败，失败原因为：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"));
                        else {
                        Ext.Msg.alert("提示", r.data ? r.data : "操作成功",
                                function() {
                                    this.store.reload();
                                    this.focus();
                                }, this);
                    }
                    },
                    scope : this
                });
            }
        },
        executeMulitCmd : function(cmd) {
            return function() {
                var record = this.grid.getSelectionModel().getSelections();
                if (!record || record.length < 1) {
                    this.alert("请先选择要操作的数据！");
                    return;
                }
                var mulitId = "";
                for (var i = 0; i < record.length; i++){
                    if(record[i].get("id"))
                    mulitId += record[i].get("id") + ",";
                }
                Ext.Ajax.request({
                    waitMsg:"正在执行操作，请稍候...",
                    url : this.formatUrl(cmd),
                    params : {
                        'mulitId' : mulitId
                    },
                    method : 'POST',
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            this.alert(
                                    "操作失败，失败原因为：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"));
                        else {
                        Ext.Msg.alert("提示", r.data ? r.data : "操作成功",
                                function() {
                                    this.store.reload();
                                    this.focus();
                                }, this);
                    }
                    },
                    scope : this
                });
            }
        },
        onView:function(){},
        view : function() {// 通用的查看数据窗口
            if (this.readInfo)
                return this.readInfo();
            var record = this.grid.getSelectionModel().getSelected();
            if (!record) {
                this.alert("请先选择要操作的数据！");
                return false;
            }
            var id = record.get("id");
            var win = this.showViewWin();
            for (var n in record.data) {
                var c = win.getComponent(0).findSomeThing(n);
                // if(!c &&
                // win.getComponent(0).getXType()=="form")c=win.getComponent(0).form.findField(n);
                if (c) {                
                    var v = record.get(n);  
                    // alert(n+":"+v);
                    if (c.isFormField) {
                        c.setValue(v);
                        c.clearDirty();
                    } else{
                        if(c.renderer)v=c.renderer(v);
                         if (c.setText)
                        c.setText(v);
                        else if (c.getXType && c.getXType() == "panel")
                        c.body.update(v);
                    }
                    // alert(c.ownerCt.el.dom.innerHTML);
                }
            }
            this.onView(win,record.data);
            // this.fp.form.loadRecord(record);
            return win;
        },
        viewObject:function(id,callback){
            var win = this.showViewWin(true);
            var viewCmd=this.viewCmd||"view";
            Ext.Ajax.request({url:this.formatUrl(viewCmd),params:{id:id},waitMsg:"正在加载数据,请稍侯...",callback:function(options,success,response){
                var r = Ext.decode(response.responseText);
                for (var n in r) {
                var c = win.getComponent(0).findSomeThing(n);
                
                if (c) {                
                    var v = r[n];   
                    if (c.isFormField) {
                        c.setValue(v);
                        c.clearDirty();
                    } else{
                        if(c.renderer)v=c.renderer(v);
                         if (c.setText)
                        c.setText(v);
                        else if (c.getXType && c.getXType() == "panel")
                        c.body.update(v);
                    }
                }
            }
            if(callback)callback(win,r);
            this.onView(win,r);
            },scope:this});
        },
        showViewWin : function(autoClose) {
            if (!this.viewPanel) {
                if(this.createViewPanel){
                    this.viewPanel = this.createViewPanel();
                }else{
                    if(this.fp){
                        this.viewPanel = this.fp;
                    }else{
                        this.viewPanel = this.createForm();
                    }
                }
            }
            var win = this.getViewWin(autoClose);
            return win;
        },
        doSearch:function(){
            var win = EasyJF.Ext.CrudSearchWindow;
            var o = win.getComponent(0).form.getValues(false);          
            var service=win.crudService;
            service.store.baseParams = Ext.apply(o,{searchType:'advancedSearch',pageSize:service.store.baseParams.pageSize||service.pageSize});
            win.hide();
            if(service.searchField&&service.cleanQuickSearch){
                service.searchField.reset();
            }
            service.search();
        },
        advancedSearch : function() {
            return this.superSearchWin(this.searchWin.width, this.searchWin.height,
                    this.searchWin.title);
        },
        <div id="method-SearchField-superSearchWin"></div>/**
         * 高级查询
         */
        superSearchWin : function(width, height, title) {
            var isNew = !EasyJF.Ext.CrudSearchWindow;           
            if (!this.searchPanel) {
                if (this.searchFP || this.searchFormPanel) {
                    this.searchPanel = this.searchFP ? this.searchFP() : this
                            .searchFormPanel();
                }
            }
            if (!this.searchPanel)
                return null;// 如果没有定义searchFP或searchFormPanel，则返回
            var win=this.createGlobalWin("CrudSearchWindow",width,height,title,this.searchPanel,null,"searchPanel",[{
                                id:"tb_search",
                                text : "查询",
                                handler : this.doSearch,
                                iconCls : 'search',
                                scope:this
                            }, {
                                text : "重置",
                                iconCls : 'clean',
                                handler : function() {
                                    EasyJF.Ext.CrudSearchWindow.getComponent(0).form
                                            .reset();
                                }
                            }, {
                                text : "关闭",
                                iconCls : 'delete',
                                handler : function() {
                                    EasyJF.Ext.CrudSearchWindow.hide()
                                }
                            }]);
            if(isNew){
                /*
                 * var map = new Ext.KeyMap(win.el,{ key: 13, fn: this.doSearch
                 * });
                 */
            }                                           
            return win;             
        },
        <div id="method-SearchField-toggleDetails"></div>/**
         * 改变grid视图的显示方式
         */
        toggleDetails : function(obj) {
            var view = this.grid.getView();
            if (view.showPreview)
                view.showPreview = false;
            else
                view.showPreview = true;
            view.refresh();
        },
        swapSequence : function(down,inform) {
            return function() {
                var record = this.grid.getSelectionModel().getSelected();
                if (!record) {
                    this.alert("请先选择要操作的数据！","提示");
                    return;
                }
                var id = record.get("id");
                Ext.Ajax.request({
                    url : this.formatUrl("swapSequence"),
                    params : {
                        'id' : record.get("id"),
                        down : down ? down : "",
                        parentId : this.parentId,
                        sq : this.grid.store.find("id", id) + 1
                    },
                    method : 'POST',
                    success : function(response) {
                        var r = Ext.decode(response.responseText);
                        if (!r.success)
                            this.alert("操作失败，失败原因：<br/>"
                                            + (r.errors.msg
                                                    ? r.errors.msg
                                                    : "未知"),"提示信息");
                        else {
                            if(inform){
                            Ext.Msg.alert("提示","操作成功", function() {
                                        this.store.reload();
                                        this.focus();
                                    }, this);
                            }
                            else {
                                this.store.reload();
                            }
                        }
                    },
                    scope : this
                });
            }
        },
        insertGridButton : function() {
            this.gridButtons.splice(10, 0, arguments);
        },
        showContextMenu : function(g, i, e) {
            if(this.menu){
            var evn = e ? e : g;
            evn.preventDefault();
            if (i>=0) {
                this.grid.getSelectionModel().selectRow(i, false);
            }
            this.menu.showAt(evn.getPoint());
            }
        },
        doOperate:function(grid,rowIndex,columnIndex,e){
                    var tag=e.getTarget("A",3);
                    if(tag){
                        var id=tag.getAttribute("theid");
                        var cmd=tag.getAttribute("op");
                        var cf=tag.getAttribute("cf");
                        if(id&&cmd)
                        this.operate(cmd,id,cf,grid,rowIndex,columnIndex,e);
                    }
        },
        operate:function(cmd,id,cf,grid,rowIndex,columnIndex,e){
            if(cmd=="edit")this.edit();
            else if(cmd=="view")this.view();
            else if(cmd=="remove")this.removeData();
            else {
            if(!cf)this.executeUrl(this.baseUrl,{cmd:cmd,id:id},this.refresh.createDelegate(this))();
            else Ext.Msg.confirm("提示","确认要执行该操作吗?",function(btn){
                if(btn=="yes")this.executeUrl(this.baseUrl,{cmd:cmd,id:id},this.refresh.createDelegate(this))();
                else this.focus();
            },this);
            }
        },
        findOperatorByProperty:function(name,value){
            return this.findOperatorBy(function(o){if(o[name]==value)return true;});
        },
        findOperatorBy:function(callback){
            var objs=[];
            this.operators.each(function(o){
                if(typeof o !="string"){
                    if(callback && callback(o))objs.push(o);
                }
            });
            return objs;
        },
        toggleSingleRowOperator:function(enable){
            var ids=this.findOperatorByProperty("singleRow",true);
            var args=[];
            if(ids && ids.length){
                for(var i=0;i<ids.length;i++)args.push(ids[i].name||ids[i].id);
            }
            if(enable)this.enableOperaterItem(args);
            else this.disableOperaterItem(args);
        },
        toggleAllOperator:function(enable){
            var args=[];
            this.operators.each(function(o){
                if(typeof o !="string"){
                    args.push(o.name||o.id);
                }
            });
            if(enable){
                this.enableOperaterItem(args);
            }
            else {this.disableOperaterItem(args);}
        },
        // 子类中可以重写该钩字方法可用状态
        onRowSelection:function(record,index,sel){
            var sel=this.grid.getSelections();
            if(sel&&sel.length>1){
                this.toggleSingleRowOperator(false);
            }else this.toggleSingleRowOperator(true);
            var ids=this.findOperatorByProperty("batch",true);// 打开支持批量操作的按钮
            var args=[];
            if(ids && ids.length){
                for(var i=0;i<ids.length;i++)args.push(ids[i].name||ids[i].id);
            }
            this.enableOperaterItem(args);
        },
        changeOperaterItem:function(args,callback){
            if(args.length==1 && Ext.isArray(args[0]))args=args[0];
            if(this.grid.getTopToolbar()&&this.grid.getTopToolbar().items){// 已经渲染
                for(var i=0;i<args.length;i++){
                    if(this.menu && this.menu.items){
                    var o=this.menu.items.find(function(c){
                        var n1=c.name||c.id;
                        if(n1==args[i])return true;
                    });
                    if(o)callback(o); 
                    }
                    o=this.grid.getTopToolbar().items.find(function(c){
                        var n1=c.name||c.id;
                        if(n1==args[i])return true;
                    });
                    if(o)callback(o);
                }
            }
            else {
                this.grid.on("render",function(){
                    for(var i=0;i<args.length;i++){
                        var o=this.grid.getTopToolbar().items.find(function(c){
                            var n1=c.name||c.id;
                            if(n1==args[i])return true;
                        });;
                        if(o)callback(o);
                    }
                },this);
            }
        },
        // 让一系列的菜单项变成可用状态
        enableOperaterItem:function(){
            var args=arguments;
            this.changeOperaterItem(args,function(o){if(o.enable)o.enable();});
        },
        // 禁用一系列的菜单项
        disableOperaterItem:function(){
            var args=arguments;
            this.changeOperaterItem(args,function(o){if(o.disable)o.disable();});
        },
        // 显示一系列的菜单及工具栏项
        showOperaterItem:function(){
            var args=arguments;
            this.changeOperaterItem(args,function(o){if(o.show)o.show();});
        },
        // 隐藏一系列的菜单及工具栏项
        hideOperaterItem:function(){
            var args=arguments;
            this.changeOperaterItem(args,function(o){if(o.hide){o.hide();}});
        },
        operatorConfig2Component:function(o,isMenu){
            var co=Ext.apply({},o);
            if(!co.handler){
                    if(co.method && this[co.method]){
                    co.handler=this[co.method];
                    }else
                    if(co.cmd)co.handler=co.batch?this.executeMulitCmd(co.cmd):this.executeCmd(co.cmd);
            }
            if(co.handler&&!co.scope)co.scope=this;
            if(!isMenu){//对按钮的样式作处理
            if(this.operatorButtonStyle==2){
                if(co.icon){co.cls="x-btn-icon";co.text="";}
            }
            else if(this.operatorButtonStyle==3){
                co.icon="";
                co.cls="";
            }}
            var key=co.name||co.id;
            if(key=="searchField")co.store=this.store;
            else if(key=="btn_advancedSearch"){
            co.hidden=!((this.searchFormPanel || this.searchFP) && this.allowSearch);
            }
            return co;
        },
        buildCrudOperator:function(){
            if(!this.operators)this.initOperator();
            var bs=[];
            this.operators.each(function(c){
                if(typeof c =="string"){
                    bs.push(c);
                }
                else {
                if(!c.showInMenuOnly){  
                var co=this.operatorConfig2Component(c);
                var key=co.name||co.id;
                try{
                this[key]= eval("new "+(co.type||"Ext.Toolbar.Button")+"(co)");
                bs.push(this[key]);
                }
                catch(e){
                    alert(key+":"+e);
                }}
                }
            },this);
            
            // 创建菜单
            if (!this.menu) {
                var ms=[];
                this.operators.each(function(c){
                    if(typeof c =="string" ){
                        if(c=="-")ms.push(c);
                    }   
                    else {
                        if(!c.showInToolbarOnly){
                        var co=this.operatorConfig2Component(c,true);
                        if(!co.type)ms.push(co);
                        }
                    }
                },this);
                ms.push({
                                name:"btn_help",
                                text : "帮助",
                                handler:this.help,
                                scope:this
                            })
                this.menu = new Ext.menu.Menu({
                    items : ms
                });
            }
            return bs;
        },
        initOperator:function(){
            this.initDisableOperators();
            this.operators=new Ext.util.MixedCollection();
            for(var i=0;i<this.crud_operators.length;i++){
                var co=this.crud_operators[i];
                if(typeof co =="object"){
                co=Ext.apply({},co);
                if(!co.batch && !co.noneSelectRow)co.singleRow=true;// noneSelectRow表示不需要进行行选择
                }
                var key=co.name||co.id;
                if(key && this.disable_operators.indexOf(key)>=0)continue;// 如果被禁用,则不用加入到operators中
                this.operators.add(co);
            }
            if(this.customizeQueryObject){
                this.operators.add({showInToolbarOnly:true,name:"btn_customizeQuery",cls : "x-btn-icon",icon : "images/icon-png/srsearch.gif", tooltip:"自定义查询",text:"", menu:["-",{text:"保存当前查询条件",handler:this.createQueryObject,scope:this},{text:"管理自定义查询",handler:this.manageQueryObject,scope:this}]}) 
            }
            if (this.gridButtons){
                var bi=(this.disable_operators.indexOf("searchField")>=0?this.operators.getCount()-1:this.operators.getCount()-2);
                this.insertOperator(bi,this.gridButtons);
            }
        },
        insertOperator:function(index,items){
            if(!this.operators){
                this.initOperator();
            }
            if(!Ext.isArray(items))items=[items];
            if(this.operators.getCount()<index)index=this.operators.getCount();
            var haveRender=this.grid&&this.grid.getTopToolbar&&this.grid.getTopToolbar()&&this.grid.getTopToolbar().items;
            for(var i=0;i<items.length;i++){
                var co=items[i];
                if(typeof co =="object"){
                co=Ext.apply({},co);
                if(!co.batch && !co.noneSelectRow)co.singleRow=true;// noneSelectRow表示不需要进行行选择
                }
                this.operators.insert(index+i,co);
                if(haveRender){
                    if(!co.showInMenuOnly){
                    var bo=this.operatorConfig2Component(Ext.apply({},co));
                    this.grid.getTopToolbar().insert(index+i,bo);
                    }
                    if(!co.showInToolbarOnly){
                    var mo=this.operatorConfig2Component(co,true);
                    if(this.menu)this.menu.insert(index+i, new Ext.menu.Item(mo));
                    }
                }
            }
        },
        initDisableOperators:function(){
            if(!this.disable_operators){this.disable_operators=[];}
            if(!this.exportData)this.disable_operators.push("btn_export");
            if(!this.importData)this.disable_operators.push("btn_import");
            if(!this.printData)this.disable_operators.push("btn_print");
            if(!this.clearData)this.disable_operators.push("btn_clearSearch");
            if(!this.allowSearch)this.disable_operators.push("btn_advancedSearch");
            if(!this.showAdd)this.disable_operators.push("btn_add");
            if(!this.showEdit)this.disable_operators.push("btn_edit");
            if(!this.showRemove)this.disable_operators.push("btn_remove");
            if(!this.showView)this.disable_operators.push("btn_view");
            if(!this.showRefresh)this.disable_operators.push("btn_refresh");
            if(!this.showSearchField)this.disable_operators.push("searchField");
        },
        manageQueryObject:function(){
            var win=new UserQueryObjectWin({crudService:this,objName:this.queryObjectName});
            win.show();
        },
        createQueryObject:function(){
            if (!this.searchQueryObjectPanel) {
                if (this.searchFP || this.searchFormPanel) {
                    this.searchQueryObjectPanel= this.searchFP ? this.searchFP() : this.searchFormPanel();
                    this.searchQueryObjectPanel.insert(0,{fieldLabel : '查询器名称',xtype:"textfield",name:"queryObjectName",anchor:"-20",allowBlank:false});
                    this.searchQueryObjectPanel.insert(1,{fieldLabel : '关键字',xtype:"textfield",name:"searchKey",anchor:"-20"});
                }
            }
            if (!this.searchQueryObjectPanel)
                return null;// 如果没有定义searchFP或searchFormPanel，则返回
            var win=this.createGlobalWin("CrudQueryObjectWindow",this.searchWin.width, this.searchWin.height+60,"保存查询条件",this.searchQueryObjectPanel,null,"searchQueryObjectPanel",[{
                                id:"tb_search",
                                text : "保存",
                                handler : this.saveQueryObject,
                                iconCls : 'search'
                            },{
                                text : "取消",
                                iconCls : 'delete',
                                handler : function() {
                                    EasyJF.Ext.CrudQueryObjectWindow.hide()
                                }
                            }]);
            win.getComponent(0).form.setValues(this.store.baseParams||{});
            win.getComponent(0).form.findField("queryObjectName").setValue("");
        },
        saveQueryObject:function(){
            var win = EasyJF.Ext.CrudQueryObjectWindow;
            if(!win.getComponent(0).form.isValid()){
                Ext.Msg.alert("提示","必填项必须填写!");
                return ;
            }
            var o = win.getComponent(0).form.getValues(false);
            var title=o.queryObjectName;
            delete o.queryObjectName;
            var service=win.crudService;
            
            var params={title:title,content:Ext.urlEncode(o),objName:service.queryObjectName};
            Ext.Ajax.request({url:"userQueryObject.ejf?cmd=save",params:params,success:function(response){
                var ret=Ext.decode(response.responseText);
                if(ret.success){
                this.addQueryObjectOperator([params]);
                Ext.Msg.alert("提示","操作成功!",this.focus,this);
                win.hide();
                }
                else {
                    Ext.Msg.alert("无法保存",ret.errors.msg,function(){win.getComponent(0).form.findField("searchKey").focus();});
                }
            },scope:service});
        },
        searchByQueryObject:function(c){
            if(c.content){
                var params=Ext.urlDecode(c.content);
                if(this.searchField)
                this.searchField.setValue(params.searchField||"");
                this.store.baseParams=params;
                if(this.store.lastOptions&&this.store.lastOptions.params)
                this.store.lastOptions.params.start=0;
            }
            this.refresh();
        },
        addQueryObjectOperator:function(objs){
            if(objs&&objs.length){
                var o=this.operators.find(function(c){
                    var n1=c.name||c.id;
                    if(n1=="btn_customizeQuery")return true;
                });
                if(!o)return;
                var haveRender=this.grid&&this.grid.getTopToolbar&&this.grid.getTopToolbar()&&this.grid.getTopToolbar().items;
                var btn_customizeQuery=this["btn_customizeQuery"];
                for(var i=0;i<objs.length;i++){
                    var co=objs[i];
                    co.scope=this;
                    co.text=co.title;
                    co.name="query_menu"+co.title;
                    co.handler=this.searchByQueryObject;
                    o.menu.splice(0,0,co);
                    if(btn_customizeQuery){
                        btn_customizeQuery.menu.insert(0,new Ext.menu.Item(co));
                    }
                }
                
            }
        },
        removeQueryObjectOperator:function(name){
            var btn_customizeQuery=this["btn_customizeQuery"];
            if(btn_customizeQuery){
                var item=btn_customizeQuery.menu.items.find(function(c){
                    var n1=c.name||c.id;
                    if(n1=="query_menu"+name)return true;
                });
                if(item)btn_customizeQuery.menu.remove(item);
            }
        },
        useOperatorsPermission:function(args){
            var ret=args||this.permissions;
            var args=[];
            for(var i=0;i<ret.length;i++){
                args.push(ret[i]);
                var o=this.operators.find(function(c){
                            var n1=c.name||c.id;
                            if(n1==args[i])return true;
                });
                if(o)o.hidden=false;
            }
            this.showOperaterItem(args);
            this.fireEvent("usepermission",this);
        },
        loadOperatorsPermission:function(){
            var args={},names=[],actions=[],cmds=[];
            var baseUrl=this.baseUrl;
            this.operators.each(function(o){
                if(typeof o !="string"){
                    if(!o.clientOperator && (o.cmd||o.method)){
                        actions.push(o.action||baseUrl);
                        cmds.push(o.cmd||o.method||"");
                        names.push(o.name||o.id||"");
                    }
                }
            });
            if(!this.permissions){
                var objs={names:names,actions:actions,cmds:cmds};
                if(this.customizeQueryObject&&this.queryObjectName){
                    objs.queryObjectName=this.queryObjectName;
                }
                if(Lanyo_Ajax.permissionCheck){
                Ext.Ajax.request({url:(Lanyo_Ajax.permissionCheckAction||"permissionCheck.ejf"),params:objs,callback:function(options,success,response){
                    var ret=Ext.decode(response.responseText);
                    if(ret&&ret.permissions&&ret.permissions.length){// 处理权限
                        this.permissions=ret.permissions;
                        this.useOperatorsPermission();
                    }
                    if(ret&&ret.queryObjects){
                        this.addQueryObjectOperator(ret.queryObjects);
                    }
                },scope:this});
                }
                else {
                     this.permissions=["btn_add","btn_edit","btn_view","btn_remove","btn_refresh"];
                     this.useOperatorsPermission();
                }
            }
            else {
                this.useOperatorsPermission();
            }
        },      
        checkAdnLoadColumnField:function(){
            if(!this.storeMapping){
                var url=this.formatUrl("loadColumnField");
                if(this.entityClzName){
                    url="extApp.ejf?cmd=loadColumnField&entityClzName="+this.entityClzName;
                }
                var ajax=Ext.lib.Ajax.syncRequest("POST",url,"");
                var ret=Ext.decode(ajax.conn.responseText);
                if(ret&&ret.fields){
                this.storeMapping=ret.fields;
                if(ret.columnMap && !this.columns && !this.cm){
                    this.columns=[];
                    for(var index in ret.columnMap){
                        var c=ret.columnMap[index];
                        c.dataIndex=c.name;
                        if(!c.header)c.header=c.name;
                        var d=[];
                        if(this.autoDisplayFields && this.autoDisplayFields.indexOf(c.name)<0){
                            c.hidden=true;
                        }
                        if(this.autoHideFields&&this.autoHideFields.indexOf(c.name)>=0){
                            c.hidden=true;
                        }
                        if(this.disableHideableFields &&this.disableHideableFields.indexOf(c.name)>=0 ){
                            c.hideable=false;
                        }
                        if(c.sortable===undefined){
                            if(c.type!="object"){
                                c.sortable=true;
                            }
                        }
                        if(!c.renderer){// 自动处理Renderer
                        if(c.type=="date"){
                            c.renderer=this.dateRender("Y-m-d");
                        }
                        else if(c.type=="object" || c.type=="map"){
                            c.renderer=this.objectAutoRender;
                        }
                        }
                        else {// 把renderer转换成javascript对象
                        try{c.renderer=Ext.decode(c.renderer);}catch(e){}
                        }
                        this.columns.push(c);
                    }                   
                }
                }
            }
        },
        haveOperatorRights:function(btn){
            return this[btn]&& (!(this[btn].disabled ||this[btn].hidden));
        },
        handleCrudKey:function(e){
            if(!(e.isSpecialKey()||e.altKey||e.getKey()==e.DELETE))return;
            if(e.getKey()==Ext.EventObject.ENTER && !e.ctrlKey){
                e.stopEvent();
                this.edit();
            }
            else if(e.altKey && e.getKey()=='c'.charCodeAt(0) && this.haveOperatorRights("btn_edit") && this.copy){
                e.stopEvent();
                this.copy();
            }
            else if(e.altKey&&e.getKey()=='a'.charCodeAt(0) && this.haveOperatorRights("btn_add")){
                e.stopEvent();
                this.create();
            }
            else if(e.altKey&&e.getKey()=='e'.charCodeAt(0)&& this.haveOperatorRights("btn_edit")){
                e.stopEvent();
                this.edit();
            }
            else if(e.altKey&&e.getKey()=='v'.charCodeAt(0)&& this.haveOperatorRights("btn_view")){
                e.stopEvent();
                this.view();
            }
            else if((e.getKey()==e.DELETE ||(e.altKey&&e.getKey()=='d'.charCodeAt(0))) &&this.haveOperatorRights("btn_remove") ){
                e.stopEvent();
                this.removeData();
            }
            else if(e.altKey&&e.getKey()=='s'.charCodeAt(0)){
                e.stopEvent();
                this.advancedSearch();
                
            }
            else if((e.getKey()==e.PRINT_SCREEN ||(e.altKey&&e.getKey()=='p'.charCodeAt(0))) &&this.haveOperatorRights("btn_print") ){
                e.stopEvent();
                this.printRecord();
            }
            else if(e.altKey&&e.getKey()=='o'.charCodeAt(0)&& this.haveOperatorRights("btn_export")){
                e.stopEvent();
                this.exportExcel();
                
            }
            else if(e.altKey&&e.getKey()=='i'.charCodeAt(0)&& this.haveOperatorRights("btn_import")){
                e.stopEvent();
                this.importExcel();
                
            }
            
        },
        initCrudEventHandler:function(){
            // 双击表格行进入编辑状态
            this.grid.on("celldblclick", this.edit, this);
            this.grid.on("cellclick",this.doOperate,this);
            this.grid.on("keypress",this.handleCrudKey,this);
            this.grid.getSelectionModel().on("rowselect",function(g,index,r){
                    this.onRowSelection(r,index,g);
                },this);
            if (this.showMenu) {
                this.grid.on("rowcontextmenu", this.showContextMenu, this);         
            }
            EasyJF.Ext.Util.autoFocusFirstRow(this.grid);
        },
        focus:function(){
            this.focusCrudGrid();
        },
        focusCrudGrid:function(grid){
            var g=grid||this.grid;
            if(g&&g.rendered){
            var sel=g.getSelectionModel();
            if(sel && sel.hasSelection()) {
                g.getView().focusRow(g.store.indexOf(g.getSelectionModel().getSelected()));
            }else if(g.store.getCount()){
                g.getView().focusRow(0);
            }else {
                g.focus();
            }}
        },
        help:function(){
            // Ext.Msg.show({title:"系统帮助",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,msg:"欢迎使用本系统，本系统由成都蓝源信息技术有限公司开发!<br/>联系电话:028-86272612
            // <br/>网址：<a href='http://www.vifir.com'
            // target='_blank'>http://www.vifir.com</a>",maxWidth:100});
            Ext.Msg.show({title:"系统帮助",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,msg:"欢迎使用本系统!",maxWidth:100});
        }
    }   
/**
 * 增、删、改、查基类
 * 
 * @class EasyJF.Ext.CrudPanel
 * @extends Ext.Panel
 */
EasyJF.Ext.CrudPanel = Ext.extend(Ext.Panel, {
    viewWin : {
        width : 650,
        height : 410,
        title : "详情查看"
    },
    searchWin : {
        width : 630,
        height : 300,
        title : "高级查询"
    },// 查询窗口的高度、宽度及标题
    gridViewConfig : {},// 表格显示视图的自定义配置
    gridConfig : {},// 表格的自定义配置
    baseQueryParameter : {},// 查询初始化参数
    localStoreVar:window.undefined,// 客户端cache的名称
    initComponent : function() {
        this.checkAdnLoadColumnField();
        var storeConfig = {
            id : this.storeId?this.storeId:"id",
            url : this.defaultCmd?(this.formatUrl('list')):this.baseUrl,
            root : "result",
            totalProperty : "rowCount",
            remoteSort : true,
            fields : this.storeMapping
        };
        if(Ext.isEmpty(this.localStoreVar,false)){
            this.store = new Ext.data.JsonStore(storeConfig);
        }else{
            this.store = new EasyJF.Ext.CachedRemoteStore(Ext.apply({varName:this.localStoreVar,pageSize:Ext.num(this.pageSize,20)},storeConfig));
        }
        
        this.store.baseParams=Ext.apply({},{limit:this.pageSize||""},this.initQueryParameter||{});
        if(Ext.objPcount(this.baseQueryParameter)){
            this.store.on('beforeload',function(store,options){
                Ext.apply(store.baseParams,{},this.baseQueryParameter);
            },this);
        }
        this.store.paramNames.sort = "orderBy";
        this.store.paramNames.dir = "orderType";
        // this.cm.defaultSortable = true;
        EasyJF.Ext.CrudPanel.superclass.initComponent.call(this);
        this.addEvents("saveobject","removeobject");// 增加saveobject及removeobject事件
        
        var buttons=this.buildCrudOperator();
        
        var viewConfig = Ext.apply({
                        forceFit : this.gridForceFit
                    }, this.gridViewConfig);
        var gridConfig = Ext.apply(this.gridConfig, {
                        store : this.store,
                        stripeRows : true,
                        trackMouseOver : false,
                        loadMask : true,
                        viewConfig : viewConfig,
                        tbar:buttons,
                        border : false,
                        bbar : this.pagingToolbar ? new Ext.ux.PagingComBo({
                            rowComboSelect:true,
                            pageSize : this.pageSize,
                            store : this.store,
                            displayInfo : true
                        }) : null
                    });
            if(this.summaryGrid){
                if(gridConfig.plugins){
                    if(typeof gridConfig.plugins=="object")gridConfig.plugins=[gridConfig.plugins];
                }
                else gridConfig.plugins=[];
                gridConfig.plugins[gridConfig.plugins.length]=new Ext.ux.grid.GridSummary();
            }   
            if(this.columns)gridConfig.columns=this.columns;
            else if(this.cm)gridConfig.cm=this.cm;
            if(this.columnLock && Ext.grid.LockingGridPanel){
                if(!gridConfig.columns && gridConfig.cm){
                    gridConfig.columns=gridConfig.cm.config;
                    delete gridConfig.cm;
                }   
            this.grid = new Ext.grid.LockingGridPanel(gridConfig);
            }
            else this.grid=new Ext.grid.GridPanel(gridConfig);
            
        this.grid.colModel.defaultSortable = true;// 设置表格默认排序
        
        this.loadOperatorsPermission();
        // 双击表格行进入编辑状态
        this.initCrudEventHandler();
        this.add(this.grid);
        // this.disableOperaterItem("btn_edit","btn_remove","btn_view");
        if(this.autoLoadGridData)this.store.load();
    }
});
Ext.applyIf(EasyJF.Ext.CrudPanel.prototype,EasyJF.Ext.CrudFunction);

// ExtApp的基类，用于实现通过iframe的方式把指定script文件中的指定appClass加载到iframe中显示
ExtAppBasePanel = Ext.extend(Ext.Panel, {
    appClass : "",
    script : "",
    otherScripts : "",
    border : false,
    layout : "fit",
    closable : true,
    initComponent : function() {
        // this.html="<iframe frameborder='0' scrolling='auto'
        // src='extApp.ejf?appClass=BBSDirManagePanel&script=bbs.js'></iframe>";
        ExtAppBasePanel.superclass.initComponent.call(this);
        this.on("resize", function(c) {
            if (!c.framePanel) {
                var h = "<iframe width='100%' height='"
                        + c.body.getHeight(true)
                        + "px' frameborder='0' scrolling='auto' src='extApp.ejf?appClass="
                        + this.appClass + "&script=" + this.script
                        + "&otherScripts=" + this.otherScripts + "&params="+this.params+"'></iframe>";
                c.body.update(h);
                c.framePanel = c.body.dom.firstChild;
            } else {
                c.framePanel.height = c.body.getHeight(true);
            }
        }, this)
    }
});


<div id="prop-EasyJF.Ext.CrudPanel-TreeComboField"></div>/**
 * 树状下拉框
 */
EasyJF.Ext.TreeComboField = Ext.extend(Ext.form.TriggerField, {
            valueField : "id",
            displayField : "name",
            minListWidth : 70,
            haveShow : false,
            editable : false,
            returnObject : false,
            leafOnly : false,
            clicksFinishEdit : 1,
            readOnly:false,
            hiddenNodes:[],
            initEvents : function(){
            EasyJF.Ext.TreeComboField.superclass.initEvents.call(this);
                this.keyNav = new Ext.KeyNav(this.el, {
                  "up" : function(e){
                    this.inKeyMode = true;
                    this.selectPrevious();
                },
    
                "down" : function(e){
                    if(!this.isExpanded()){
                        this.onTriggerClick();
                    }else{
                        this.inKeyMode = true;
                        this.selectNext();
                    }
                },
                "enter" : function(e){
                    var sm = this.tree.getSelectionModel();
                    if(sm.getSelectedNode()){
                        var node = sm.getSelectedNode();
                        this.choice(node);
                        sm.clearSelections();
                        return ;
                    }
                },
                "esc" : function(e){
                    this.collapse();
                },
            scope : this
        });
        this.queryDelay = Math.max(this.queryDelay || 10,
                this.mode == 'local' ? 10 : 250);
        this.dqTask = new Ext.util.DelayedTask(this.initQuery, this);
        if(this.typeAhead){
            this.taTask = new Ext.util.DelayedTask(this.onTypeAhead, this);
        }
        if(this.editable !== false){
            this.el.on("keyup", this.onKeyUp, this);
        }
        if(this.forceSelection){
            this.on('blur', this.doForce, this);
        }
        },
        selectPrevious:function(){
                var sm = this.tree.getSelectionModel();
                if(!sm.selectPrevious()){
                    var root = this.tree.getRootNode();
                    sm.select(root);
                    this.el.focus();
                }else{
                    this.el.focus();
                }
            },
            selectNext : function(){
                var sm = this.tree.getSelectionModel();
                if(!sm.selectNext()){
                    var root = this.tree.getRootNode();
                    sm.select(root);
                    this.el.focus();
                }else{
                    this.el.focus();
                }
            },
            onTriggerClick : function() {
                if(this.readOnly || this.disabled){
                    return false;
                }else if (!this.tree.rendered || !this.list) {
                    this.treeId = Ext.id();
                    this.list = new Ext.Layer({
                        id : this.treeId,
                        cls : "x-combo-list",
                        constrain:false
                    });                 
                    if(!this.innerDom)this.innerDom=Ext.getBody().dom;  
                    if(this.tree.rendered){
                        this.list.appendChild(this.tree.el);
                    }
                    else {                                                  
	                    this.tree.render(this.treeId);
	                    var lw = this.listWidth || Math.max(this.wrap.getWidth(), this.minListWidth);                                   
	                    this.tree.setWidth(lw);
	                    this.tree.on("expandnode",this.restrictHeight,this);
	                    this.tree.on("collapsenode",this.restrictHeight,this);
                    }
                }
                else this.restrictHeight();
                this.expand();
            },
            restrictHeight : function(){
                // this.list.dom.style.height = '';
                if(!this.list)return;
                var inner = this.innerDom;                                  
                var h=inner.clientHeight-this.wrap.getBottom();                 
                if(this.tree.el.dom.offsetHeight>=h){
                    this.tree.setHeight(h);
                }
                else {
                    this.tree.setHeight("auto");
                }
               // this.list.alignTo(this.getEl(), "tl-bl?");
            },
           
            filterTree:function(e){
                if(!this.isExpanded())this.expand();
                var text = e.target.value;
                Ext.each(this.hiddenNodes, function(n){
                    n.ui.show();
                });
                if(!text){
                    this.filter.clear();
                    return;
                }
                this.tree.expandAll();
                this.restrictHeight();
                this.filter.filterBy(function(n){
                    return (!n.attributes.leaf || n.text.indexOf(text)>=0);
                });
                
                // hide empty packages that weren't filtered
                this.hiddenNodes = [];
                this.tree.root.cascade(function(n){
                    if(!n.attributes.leaf && n.ui.ctNode.offsetHeight < 3){
                        n.ui.hide();
                        this.hiddenNodes.push(n);
                    }
                },this);
            },
            expand :function(){
                if(this.list){
                    Ext.getDoc().on('mousedown', this.hideIf, this);
                    this.list.show();
                    this.list.alignTo(this.getEl(), "tl-bl?");
                }
                else {
                    this.onTriggerClick();
                }
            },
            collapse : function(){
                 if(this.list){
                 this.list.hide();
                 Ext.getDoc().un('mousedown', this.hideIf, this);
                 }
            },
            onEnable: function(){
		        EasyJF.Ext.TreeComboField.superclass.onEnable.apply(this, arguments);
		        if(this.hiddenField){
		            this.hiddenField.disabled = false;
		        }
		    },
            onDisable: function(){
                EasyJF.Ext.TreeComboField.superclass.onDisable.apply(this, arguments);
                if(this.hiddenField){
                    this.hiddenField.disabled = true;
                }
                Ext.getDoc().un('mousedown',this.hideIf,this);
            },
            hideIf:function(e){
                if(!e.within(this.wrap) && !e.within(this.list)){
                   this.collapse();
                }
            },
            initComponent : function() {
                EasyJF.Ext.TreeComboField.superclass.initComponent.call(this);
                this.addEvents('beforeSetValue');
                this.filter = new Ext.tree.TreeFilter(this.tree, {
                    clearBlank: true,
                    autoClear: true
                });
            },
            onRender : function(ct, position) {
                EasyJF.Ext.TreeComboField.superclass.onRender.call(this, ct,
                        position);
                if (this.clicksFinishEdit > 1)
                    this.tree.on("dblclick", this.choice, this);
                else
                    this.tree.on("click", this.choice, this);
                if (this.hiddenName) {
                    this.hiddenField = this.el.insertSibling({
                                tag : 'input',
                                type : 'hidden',
                                name : this.hiddenName,
                                id : (this.hiddenId || this.hiddenName)
                            }, 'before', true);
                    this.hiddenField.value = this.hiddenValue !== undefined
                            ? this.hiddenValue
                            : this.value !== undefined ? this.value : '';
                    this.el.dom.removeAttribute('name');
                }
                if (!this.editable) {
                    this.editable = true;
                    this.setEditable(false);
                }
                else {
                    this.el.on('keydown', this.filterTree, this, {buffer: 350});
                }
            },
            getValue : function(returnObject) {
                if ((returnObject===true) || this.returnObject)
                    return typeof this.value != 'undefined' ? {
                        value : this.value,
                        text : this.text,
                        toString : function() {
                            return this.text;
                        }
                    } : "";
                return typeof this.value != 'undefined' ? this.value : '';
            },
            clearValue : function() {
                if (this.hiddenField) {
                    this.hiddenField.value = '';
                }
                this.setRawValue('');
                this.lastSelectionText = '';
                this.applyEmptyText();
                this.value="";
            },
validate : function(){
                if(this.disabled || this.validateValue(this.processValue(this.getValue()))){
                    this.clearInvalid();
                    return true;
                }
                return false;
            },
            isValid : function(preventMark){
                if(this.disabled){
                    return true;
                }
                var restore = this.preventMark;
                this.preventMark = preventMark === true;
                var v = this.validateValue(this.processValue(this.getValue()));
                this.preventMark = restore;
                return v;
            },
             <div id="method-EasyJF.Ext.CrudPanel-validateValue"></div>/**
                 * Validates a value according to the field's validation rules
                 * and marks the field as invalid if the validation fails
                 * 
                 * @param {Mixed}
                 *            value The value to validate
                 * @return {Boolean} True if the value is valid, else false
                 */
            validateValue : function(value){
                if(value.length < 1 || value === null){ // if it's blank
                     if(this.allowBlank){
                         this.clearInvalid();
                         return true;
                     }else{
                         this.markInvalid(this.blankText);
                         return false;
                     }
                }
                if(value.length < this.minLength){
                    this.markInvalid(String.format(this.minLengthText, this.minLength));
                    return false;
                }
                if(value.length > this.maxLength){
                    this.markInvalid(String.format(this.maxLengthText, this.maxLength));
                    return false;
                }
                if(this.vtype){
                    var vt = Ext.form.VTypes;
                    if(!vt[this.vtype](value, this)){
                        this.markInvalid(this.vtypeText || vt[this.vtype +'Text']);
                        return false;
                    }
                }
                if(typeof this.validator == "function"){
                    var msg = this.validator(value);
                    if(msg !== true){
                        this.markInvalid(msg);
                        return false;
                    }
                }
                if(this.regex && !this.regex.test(value)){
                    this.markInvalid(this.regexText);
                    return false;
                }
                return true;
            },
            readPropertyValue : function(obj, p) {
                var v = null;
                for (var o in obj) {
                    if (o == p)return true;
                        // v = obj[o];
                }
                return v;
            },
            setValue : function(obj) {
                if (!obj) {
                    this.clearValue();
                    return;
                }
                if(this.fireEvent('beforeSetValue',this,obj)===false){return;}
                var v = obj;
                var text = v;
                var value = this.valueField || this.displayField;
                if (typeof v == "object" && this.readPropertyValue(obj, value)) {
                    text = obj[this.displayField || this.valueField];
                    v = obj[value];
                }
                
                var node = this.tree.getNodeById(v);
                if (node) {
                    text = node.text;
                } else if (this.valueNotFoundText !== undefined) {
                    text = this.valueNotFoundText;
                }
                this.lastSelectionText = text;
                if (this.hiddenField) {
                    this.hiddenField.value = v;
                }
                EasyJF.Ext.TreeComboField.superclass.setValue.call(this, text);
                this.value = v;
                this.text = text;
            },
            setEditable : function(value) {
                if (value == this.editable) {
                    return;
                }
                this.editable = value;
                if (!value) {
                    this.el.dom.setAttribute('readOnly', true);
                    this.el.on('mousedown', this.onTriggerClick, this);
                    this.el.addClass('x-combo-noedit');
                } else {
                    this.el.dom.setAttribute('readOnly', false);
                    this.el.un('mousedown', this.onTriggerClick, this);
                    this.el.removeClass('x-combo-noedit');
                }
            },
            choice : function(node, eventObject) {
                if((!this.leafOnly || node.isLeaf())){
                    if (node.id != "root"){
                        this.setValue(node.id);
                    }
                    else {
                        this.clearValue();
                        this.el.dom.value=node.text;
                    }
                    this.fireEvent('select', this, node);
                    this.collapse();
                    this.fireEvent('collapse', this);
                }else{
                    if (node.id == "root"){
                        this.clearValue();
                        this.el.dom.value=node.text;
                        this.fireEvent('select', this, node);
                        this.collapse();
                        this.fireEvent('collapse', this);
                    }
                }
            },
            validateBlur : function() {
                return !this.list || !this.list.isVisible();
            },
            isExpanded : function(){
                return this.list && this.list.isVisible();
            },
            canFocus:function(){
                return !this.disabled ;
            },
            onDestroy : function() {
                if (this.tree.rendered && this.list) {
                    this.list.hide();                   
                     this.list.destroy();
                    delete this.list;                                   
                }
                EasyJF.Ext.TreeComboField.superclass.onDestroy.call(this);
            }
        });
Ext.reg('treecombo', EasyJF.Ext.TreeComboField);

/**
 * 复选框
 * 
 * @class EasyJF.Ext.CheckTreeComboField
 * @extends EasyJF.Ext.TreeComboField
 */
EasyJF.Ext.CheckTreeComboField = Ext.extend(EasyJF.Ext.TreeComboField, {            
            leafOnly : false,// 只允许选择子节点
            editable : true,
            onTriggerClick : function() {
                if(this.disabled)return;
                if (!this.listPanel.rendered || !this.list) {
                    this.treeId = Ext.id();
                    this.list = new Ext.Layer({
                        id : this.treeId,
                        cls : "x-combo-list",
                        constrain:false
                    });                 
                    if(!this.innerDom)this.innerDom=Ext.getBody().dom;
                    if(this.listPanel.rendered){                        
                        this.list.appendChild(this.listPanel.el);
                    }
                    else {                                                  
                    this.listPanel.render(this.treeId);
                    var lw = this.listWidth || Math.max(this.wrap.getWidth(), this.minListWidth);                                   
                    this.listPanel.setWidth(lw);
                    this.tree.on("expandnode",this.restrictHeight,this);
                    this.tree.on("collapsenode",this.restrictHeight,this);
                    }
                    if(this.value)this.setCheckdNode(this.value);
                }
                else this.restrictHeight();     
                this.expand();
            },  
            restrictHeight : function(){
                // this.list.dom.style.height = '';
                if(!this.list)return;
                var inner = this.innerDom;                                  
                var h=inner.clientHeight-this.wrap.getBottom();                 
                if(this.listPanel.el.dom.offsetHeight>=h){
                    this.listPanel.setHeight(h);                    
                }
                else {
                    this.listPanel.setHeight("auto");
                    this.tree.setHeight("auto");
                }
                // alert(this.listPanel.el.dom.offsetHeight);
               // this.list.alignTo(this.getEl(), "tl-bl?");
            },
            initComponent : function() {
                EasyJF.Ext.CheckTreeComboField.superclass.initComponent
                        .call(this);
                this.listPanel = new Ext.Panel({
                        border : false,
                        bodyBorder : false,
                        buttonAlign : "center",
                        layout:"fit",
                        items : this.tree,
                        bbar : [{
                                    text : "确定选择",
                                    handler : this.choice,
                                    scope : this
                                }, {
                                    text : "清空",
                                    handler : this.cleanChoice,
                                    scope : this
                                }, {
                                    text : "取消",
                                    handler : this.cancelChoice,
                                    scope : this
                                }]
                    }); 
                
    
            },
            onRender : function(ct, position) {
                EasyJF.Ext.CheckTreeComboField.superclass.onRender.call(this,
                        ct, position);
                this.tree.on("checkchange", this.checkNode, this);
                
            },
            setCheckdNode:function(v){
                this.cleanCheckNode(this.tree.root);
                var vs=v.split(",");
                for(var i=0;i<vs.length;i++){
                var node=null;
                var valueField=this.valueField;
                this.tree.root.cascade(function(n){                     
                    if(n.attributes[valueField]==vs[i]){                        
                        node=n;
                        return false;
                    }
                });         
                if(node)this.checkNode(node,true);
                }
            },
            cleanCheckNode:function(node){
                var checked=false;
                node.cascade(function(n){
                    if (n.ui.checkbox) {
                        n.attributes.checked = n.ui.checkbox.checked = checked;
                        n.attributes.selectAll = checked;
                        if (checked)
                            n.ui.addClass("x-tree-selected");
                        else
                            n.ui.removeClass("x-tree-selected");
                        }
                }, this);
            },
            checkNode : function(node, checked) {
                node.cascade(function(n) {
                            if (n.ui.checkbox) {
                                n.attributes.checked = n.ui.checkbox.checked = checked;
                                n.attributes.selectAll = checked;
                                if (checked)
                                    n.ui.addClass("x-tree-selected");
                                else
                                    n.ui.removeClass("x-tree-selected");
                            }
                        }, this);
                node.bubble(function(n) {
                    if (n != node) {
                        if (!checked) {
                            n.attributes.selectAll = checked;
                            if (n.attributes.checked) {
                                n.ui.removeClass("x-tree-selected");
                            }
                        } else if (!n.attributes.checked) {
                            n.attributes.checked = n.ui.checkbox.checked = checked;
                        }
                    }
                });
            },
            getValue : function() {
                return typeof this.value != 'undefined' ? this.value : '';
            },
            clearValue : function() {
                if (this.hiddenField) {
                    this.hiddenField.value = '';
                }
                this.setRawValue('');
                this.lastSelectionText = '';
                this.applyEmptyText();
                if(this.list)this.cleanCheckNode(this.tree.root);
            },          
            getNodeValue : function(node) {
                if (node.attributes.selectAll
                        && (!this.leafOnly || node.attributes.leaf)) {
                    if (this.t != "")
                        this.t += ",";
                    if (this.v != "")
                        this.v += ",";
                    var text=node.attributes[this.displayField || this.valueField];
                    if(text===undefined)text=node.text;
                    var value=node.attributes[this.valueField];
                    if(value===undefined)value=node.id;
                    this.t +=text ;
                    this.v += value;
                } else if (node.attributes.checked)
                    node.eachChild(this.getNodeValue, this)
            },
            setValue : function(obj) {
                if (!obj) {
                    this.clearValue();
                    return;
                }
                var v = obj;
                var text = v;
                var value = this.valueField || this.displayField;
                if (typeof v == "object" && this.readPropertyValue(obj, value)) {// 直接传入值
                    
                    text = obj[this.displayField || this.valueField];
                    v = obj[value];
                    if(this.list)this.setCheckdNode(v);
                                    
                } else {// 自动查找树中的选择节点，并设置值
                    var root = this.tree.root;
                    this.t = "";
                    this.v = "";
                    if (root.attributes.selectAll) {
                        this.t = root.text;
                    } else {
                        root.eachChild(this.getNodeValue, this);
                    }
                    text = this.t;
                    v = this.v;
                }
                /*
                 * var node = this.tree.getNodeById(v); if(node){ text =
                 * node.text; }else if(this.valueNotFoundText !== undefined){
                 * text = this.valueNotFoundText; }
                 */
                this.lastSelectionText = text;
                if (this.hiddenField) {
                    this.hiddenField.value = v;
                }
                EasyJF.Ext.TreeComboField.superclass.setValue.call(this, text);
                this.value = v;
                this.text = text;
            },          
            choice : function(notClean) {
                if (notClean)
                    this.setValue(true);
                else
                    this.clearValue();
                this.list.hide();
            },
            cleanChoice : function() {
                this.clearValue();
                this.list.hide();
            },
            cancelChoice : function() {
                this.list.hide();
            },          
            onDestroy : function() {
                if (this.listPanel.rendered && this.list) {
                    this.list.hide();
                    this.list.remove();
                }
                EasyJF.Ext.CheckTreeComboField.superclass.onDestroy.call(this);
            }
        });
Ext.reg('checktreecombo', EasyJF.Ext.CheckTreeComboField);

EasyJF.Ext.SmartCombox = Ext.extend(Ext.form.ComboBox, {
            returnObject : false,
            objectCreator:null,// 用来定义新建对象的相关属性
            createWinReady:function(win){
                if(this.fieldLabel)win.setTitle("新建"+this.fieldLabel);
            },
            newObject:function(){
                this.collapse();
                var title=this.fieldLabel;
                EasyJF.Ext.Util.addObject(this.objectCreator.appClass, this.reload.createDelegate(this),this.objectCreator.script,
                this.objectCreator.otherScripts,this.createWinReady.createDelegate(this));
            },
            initComponent : function() {
                if(this.objectCreator&&!this.disableCreateObject){
                this.operatorButtons=[{text:"新建",cls:"x-btn-text-icon",icon:"/images/icons/add.png",handler:this.newObject,scope:this}];
                }
                EasyJF.Ext.SmartCombox.superclass.initComponent.call(this);
            },
            initList:function(){
                if(!this.list){
                    EasyJF.Ext.SmartCombox.superclass.initList.call(this);
                    // this.operatorButtons=[{text:"ddd"}];
                    if(this.operatorButtons){// 增加对操作按钮的支持
                        if(this.pageTb){
                            this.pageTb.insert(0,this.operatorButtons);
                        }
                        else {
                        this.bottomBar = this.list.createChild({cls:'x-combo-list-ft'});
                        this.bottomToolbar = new Ext.Toolbar(this.operatorButtons);
                        this.bottomToolbar.render(this.bottomBar);
                        this.assetHeight += this.bottomBar.getHeight();
                        }
                    }
                }
            },
            getValueObject : function(field) {
                var val = "";
                if(this.returnObject){
                    val = this.getValue().value;
                }else{
                    val = this.getValue();
                }
                if (val){   
                    var index=this.store.find(field||"id",val);
                    if(index>=0){
                        var record = this.store.getAt(index);
                        return record;
                    }
                    return null;
                }
                return null;
            },  
            getValue : function() {                 
                if (this.returnObject){
                    var value=this.value;
                    if(this.el.dom.value==this.PleaseSelectedValue||this.el.dom.value==this.nullText)return null;
                    if(this.selectedIndex>=0){
                        var record=this.store.getAt(this.selectedIndex);
                        if(record&&record.data){
                        var t=record.data[this.displayField||this.valueField];
                        if(t!=this.el.dom.value)value=null;
                        }
                    }
                    return {
                        value : value,
                        text : this.el.dom.value,
                        toString : function() {
                            return this.text;
                        }
                    };
                }
                else
                    return EasyJF.Ext.SmartCombox.superclass.getValue.call(this);
            },          
            setValue : function(v) {                
                if (v && typeof v == "object" && eval("v." + this.valueField)) {
                    var value = eval("v." + this.valueField);
                    var text = eval("v." + this.displayField) ? eval("v."
                            + this.displayField) : this.valueNotFoundText;
                    this.lastSelectionText = text;
                    if (this.hiddenField) {
                        this.hiddenField.value = value;
                    }
                    Ext.form.ComboBox.superclass.setValue.call(this, text);
                    this.value = value;
                    if(this.store.find(this.valueField,value)<0){
                        var o={};
                        o[this.valueField]=value;
                        o[this.displayField]=text;
                        if(this.store&&this.store.insert){
                        this.store.insert(0,new Ext.data.Record(o));
                        // this.select(0);
                        }
                    }
                } else if (v === null){
                    EasyJF.Ext.SmartCombox.superclass.setValue.call(this, "");
                }
                else{
                    EasyJF.Ext.SmartCombox.superclass.setValue.call(this, v);   
                }
                    
            },
            onSelect : function(record, index) {
                if (this.fireEvent('beforeselect', this, record, index) !== false) {
                    this.setValue(record.data[this.valueField
                            || this.displayField]);
                    this.collapse();                    
                    this.fireEvent('select', this, record, index);
                }
            }
        });
Ext.reg('smartcombo', EasyJF.Ext.SmartCombox);

<div id="prop-EasyJF.Ext.CheckTreeComboField-PopupWindowField"></div>/**
 * 弹出窗口选择按钮
 */
EasyJF.Ext.PopupWindowField = Ext.extend(Ext.form.TriggerField, {
            valueField : "id",
            displayField : "name",
            haveShow : false,
            editable : false,
            win:null,
            callback:Ext.emptyFn,
            returnObject : false,
            choiceOnly:false,
            getValue : function() { 
                if(this.choiceOnly)return this.value;           
                if (this.returnObject)
                    return typeof this.value != 'undefined' ? {
                        value : this.value,
                        text : this.text,
                        toString : function() {                         
                            return this.text?this.text:this.value;
                        }
                    } : "";
                return typeof this.value != 'undefined' ? this.value : '';
            },
            setValue : function(v) {
                if(this.choiceOnly)return this.value=v;
                if (v && typeof v == "object" && eval("v." + this.valueField)) {
                    var value = eval("v." + this.valueField);
                    var text = eval("v." + this.displayField) ? eval("v."
                            + this.displayField) : this.valueNotFoundText;
                    this.lastSelectionText = text;
                    if (this.hiddenField) {
                        this.hiddenField.value = value;
                    }
                    EasyJF.Ext.PopupWindowField.superclass.setValue.call(this, text);
                    this.value = value;
                    this.text=text;
                } else if (v === null)
                    EasyJF.Ext.PopupWindowField.superclass.setValue.call(this, "");
                else
                    EasyJF.Ext.PopupWindowField.superclass.setValue.call(this, v);
            },          
            onTriggerClick : function() {
                if(this.win){
                    this.win.show();
                }
            },
            onRender : function(ct, position) {
                EasyJF.Ext.PopupWindowField.superclass.onRender.call(this,
                        ct, position);
                if(this.win){
                    this.win.on("select",this.choice,this);
                }
                if (this.hiddenName) {
                    this.hiddenField = this.el.insertSibling({
                                tag : 'input',
                                type : 'hidden',
                                name : this.hiddenName,
                                id : (this.hiddenId || this.hiddenName)
                            }, 'before', true);
                    this.hiddenField.value = this.hiddenValue !== undefined
                            ? this.hiddenValue
                            : this.value !== undefined ? this.value : '';
                    this.el.dom.removeAttribute('name');
                }
                if (!this.editable) {
                    this.editable = true;
                    this.setEditable(false);
                }
                if(this.choiceOnly)this.el.hide();
            },
            choice:function(data,win){
                this.setValue(data);
                this.fireEvent('select',data,win);
            },
            initComponent : function(){
                EasyJF.Ext.PopupWindowField.superclass.initComponent.call(this);
                this.addEvents("select");
                
            },
            validateBlur : function() {
                return !this.win || !this.win.isVisible();
            },
            onDestroy : function() {
                if (this.win&&this.win.isVisible()) {
                    this.win.hide();
                }
                EasyJF.Ext.PopupWindowField.superclass.onDestroy.call(this);
            },
            setEditable : function(value) {
                if (value == this.editable) {
                    return;
                }
                this.editable = value;
                if (!value) {
                    this.el.dom.setAttribute('readOnly', true);
                    this.el.on("dblclick",this.onTriggerClick, this);
                    this.el.on("click",this.onTriggerClick, this);
                    this.el.addClass('x-combo-noedit');
                } else {
                    this.el.dom.setAttribute('readOnly', false);
                    this.el.un('mousedown', this.onTriggerClick, this);
                    this.el.removeClass('x-combo-noedit');
                }
            }
        });
Ext.reg('popupwinfield', EasyJF.Ext.PopupWindowField);


EasyJF.Ext.GridSelectWin = Ext.extend(Ext.Window, {
            title : "选择数据",
            width : 540,
            height : 400,
            layout : "fit",
            buttonAlign : "center",
            closeAction : "hide",
            grid:null,// grid是必须传递的对象
            modal:true,         
            callback : Ext.emptyFn,
            choice : function() {
                var grid=this.grid.grid||this.grid;
                var records = grid.getSelectionModel()
                        .getSelections();
                if (!records || records.length < 1) {
                    Ext.Msg.alert("$!{lang.get('Prompt')}",
                            "$!{lang.get('Select first')}");
                    return false;
                }
                var datas = [];
                for (var i = 0; i < records.length; i++) {
                    datas[i] = records[i].data;
                }
                this.hide();
                this.fireEvent('select', datas, this);
            },
            initComponent : function() {
                this.buttons = [{
                            text : "确定",
                            handler : this.choice,
                            scope : this
                        }, {
                            text : "取消",
                            handler : function() {
                                this.hide();
                            },
                            scope : this
                        }];
                EasyJF.Ext.GridSelectWin.superclass.initComponent.call(this);               
                if(this.grid){
                    var grid=this.grid.grid||this.grid;// 兼容BaseGridList对象
                    grid.on("rowdblclick", this.choice, this);
                    this.add(this.grid);
                }
                this.addEvents("select");
            }
});
EasyJF.Ext.TreeNodeUtil={};
Ext.apply(EasyJF.Ext.TreeNodeUtil,{
            // 级联邮件节点对象，进行指定的操作
            cascadeNode : function(node, fn, scope, args) {
                if (fn.apply(scope || this, args || [node]) !== false) {
                    if (node.children && node.children.length) {
                        for (var i = 0, cs = node.children; i < cs.length; i++){
                            cs[i].parentNode = node; 
                            this.cascadeNode(cs[i], fn, scope, args);
                        }
                    }
                }
            },
            <div id="method-EasyJF.Ext.CheckTreeComboField-deepFindNode"></div>/**
             * 在指定节点中查询特定id的节点
             * 
             * @param {}
             *            id 所要查询的节点id
             * @param {}
             *            node
             * @return {}
             */
            deepFindNode : function(id, node) {
                var ret = null;
                this.cascadeNode(node, function(n) {
                            if (n.id == id) {
                                ret = n;
                                return false;
                            }
                        });
                return ret;
            },
            <div id="method-EasyJF.Ext.CheckTreeComboField-getNodeById"></div>/**
             * 根据节点id查找指定节点
             * 
             * @param {}
             *            id
             * @param {}
             *            objs
             * @return {}
             */
            getNodeById:function(id,objs){
                var ret = this.deepFindNode(id, {
                                id : "root",
                                children : objs
                });
                return ret || null ;
            },           
            findNode : function(id, objs) {
                if (id == "root")
                    return objs;
                else {
                    var ret = this.deepFindNode(id, {
                                id : "root",
                                children : objs
                            });
                    return ret && ret.children ? ret.children : null;
                }
            },
            // 删除缓存中的节点
            localRemove:function(id,cache){
                var obj = Ext.type(cache)=="string"?EasyJF.Cache.get(cache):cache;
                if(obj){
                    var objs = obj.items;
                    var node = this.getNodeById(id,objs);
                    if(node){
                        if(node.parentNode && node.parentNode.children)node.parentNode.children.remove(node);
                        else objs.remove(node);
                        if(obj.fireEvent)obj.fireEvent("removenode",node,obj);
                    }
                }
            },
            // 添加节点到指定缓存中
            localAdd:function(node,parentId,cache){
                var obj = Ext.type(cache)=="string"?EasyJF.Cache.get(cache):cache;
                if(obj){
                    var objs = obj.items;
                    if(parentId){
                    var parentNode = this.getNodeById(parentId,objs);
                    if(parentNode){
                       parentNode.children = parentNode.children || []; 
                       if(parentNode.children && parentNode.children.length==0){
                            parentNode.leaf=false;
                            parentNode.children = [node];
                       }else if(parentNode.children){
                            parentNode.children.push(node);
                       }
                       if(obj.fireEvent)obj.fireEvent("addnode",node,parentNode,obj);
                    }}
                    else {
                        objs.push(node);
                       if(obj.fireEvent)obj.fireEvent("addnode",node,null,obj);
                    }
                }
            },
            // 更新缓存中的节点
            localChange:function(node,cache){
                var obj = Ext.type(cache)=="string"?EasyJF.Cache.get(cache):cache;
                if(obj){
                    var objs = obj.items;
                    var no = this.getNodeById(node.id,objs);
                    if(no){
                        Ext.copyToIf(no,node,["children","cls","loader","parentNode"]);
                        if(obj.fireEvent)obj.fireEvent("updatenode",no,obj);
                    }
                }
            },
            // 移动缓存中的节点
            localMove:function(node,parentId,cache){
                this.localRemove(node.id,cache);
                this.localAdd(node,parentId,cache);
            }
});

/**
 * 树状节点数据存储器，提供了快速查询树节点及内在节点内容变更事件响应等相关方法
 * 
 * @class EasyJF.Ext.TreeCollection
 * @extends Ext.util.MixedCollection
 */
EasyJF.Ext.TreeCollection=Ext.extend(Ext.util.MixedCollection,{
            // 删除节点
            removeNode:function(id){
                 EasyJF.Ext.TreeNodeUtil.localRemove(id,this);
                 this.unregisterNode(id);
            },
            // 添加节点
            addNode:function(node,parentId){
                 var n = null; 
                 if(n = this.getNodeById(node.id)){
                    EasyJF.Ext.TreeNodeUtil.localChange(node,this);
                    return ;
                 }
                 EasyJF.Ext.TreeNodeUtil.localAdd(node,parentId ,this);
                 this.registerNode(node);
            },
            // 更新节点
            changeNode:function(node,cache){
                EasyJF.Ext.TreeNodeUtil.localChange(node,this);
            },
            // 移动节点
            moveNode:function(node,parentId,cache){
                EasyJF.Ext.TreeNodeUtil.localMove(node,parentId,this);
            },
            // 注销nodeHash中的节点
           unregisterNode:function(id){
                delete this.nodeHash[id];
           },
           // 往nodeHash中注册节点及所有子节点
           registerNode:function(node){
                 if(node.id)this.nodeHash[node.id] = node;   
                 var children = node.children || (node.attributes&&node.attributes.children) ;
                 if(children && children.length)
                 Ext.each(children,this.registerNode,this);
            },
            // 获得所有节点
            getAllNode:function(){
                return this.nodeHash || {};
            },
            // 根据ID返回节点
            getNodeById:function(id){
                return this.nodeHash[id];
            },
            // 重写MixCollection的addAll方法，并调用registerNode来注册节点
            addAll:function(objs){
                EasyJF.Ext.TreeCollection.superclass.addAll.call(this,objs);
                this.nodeHash = {};
                if(objs){
                    var obj = {id:'root',children:objs};
                    this.registerNode(obj)
                }
            },
            // 清空集合中的所有节点
            clear:function(){
                this.nodeHash = {};
                EasyJF.Ext.TreeCollection.superclass.clear.call(this);
            }
});
<div id="method-EasyJF.Ext.TreeCollection-Ext.CachedRemoteProxy"></div>/**
 * 客户端缓存对象,同时提供在本地执行查询及分页等操作
 * 
 * @param {}
 *            varName
 * @param {}
 *            url
 */
EasyJF.Ext.CachedRemoteProxy = function(c,store){
    this.enableCache=(c.enableCache==window.undefined ? true : c.enableCache);
    this.store = store;
    EasyJF.Ext.CachedRemoteProxy.superclass.constructor.call(this, {
                url : c.url
            });
    Ext.apply(this, c);  
};
EasyJF.Ext.CachedRemoteProxy.DATAS={};
EasyJF.Ext.CacheFilter=new Ext.util.MixedCollection();
EasyJF.Ext.CacheFilter.firstSearch=function(val,regexp){
    if(typeof regexp != 'regexp')regexp = new RegExp("^"+regexp);
    return regexp.test(val);
}
Ext.extend(EasyJF.Ext.CachedRemoteProxy, Ext.data.HttpProxy, {
    quickSearch:function(params,datas){
        if(!datas.getCount())return datas;
        var objs=datas;
        var o=datas.items[0];
        if(!this.disableClientFilter){
            for(var n in params){
                if(n && o[n]!==undefined){              
                    objs=objs.filter(n,params[n]);
                }
            }
        }
        objs = this.cacheFilter(params,objs);
        return objs;
    },
    cacheFilter:function(params,objs){
        var filter = EasyJF.Ext.CacheFilter.key(this.varName);
        if(filter && params){
            if(typeof filter == 'function'){
                return filter.call(this,objs,params);
            }
        }
        return objs;
    },
    getData:function(){
        return EasyJF.Ext.CachedRemoteProxy.DATAS[this.varName];
    },
    loadFromCache : function(params, reader, callback, scope, arg) {
                var datas = this.quickSearch(params, this.getData());
                var o = {
                    rowCount : datas.getCount(),
                    result : []
                };
                var start = 0, limit = -1;
                
                if (params.start)start = Ext.num(parseInt(params.start), 0);
                
                if (params.limit)limit = Ext.num(parseInt(params.limit), -1);
                
                var max = datas.getCount();
                
                if (limit > 0)max = start + limit;
                if (max > datas.getCount())max = datas.getCount();
                if (max < 0)max = this.pageSize;
                o.result = datas.getRange(start, max - 1);
                var result;
                try {
                    result = reader.readRecords(o);
                } catch (e) {
                    this.fireEvent("loadexception", this, o, response, e);
                    callback.call(scope, null, params, false);
                    return;
                }
                this.fireEvent("load", this, o, arg);
                callback.call(scope, result, arg, true);
            },
    /*
     * loadFromCache:function(params, reader, callback, scope, arg){ var
     * datas=this.quickSearch(params,this.getData()); var
     * o={rowCount:datas.getCount(),result:[]}; var start=0,limit=-1;
     * if(params.start)start=Ext.num(parseInt(params.start),0);
     * if(params.limit)limit=Ext.num(parseInt(params.limit),-1); if(limit<0)limit=this.pageSize;
     * var max=datas.getCount(); if(limit>0)max=start+limit; if(max<0)max =
     * this.pageSize; if(max>datas.getCount())max=datas.getCount();
     * //console.dir(params); o.result=datas.getRange(start,max-1); var result;
     * try { result = reader.readRecords(o); }catch(e){
     * this.fireEvent("loadexception", this, o, response, e);
     * callback.call(scope, null, params, false); return; }
     * this.fireEvent("load", this, o, arg); callback.call(scope, result, arg,
     * true); },
     */
    load : function(params, reader, callback, scope, arg){
        params = params || {};       
        if(this.fireEvent("beforeload", this, params) !== false){
            if(this.getData().getCount()){
                this.loadFromCache(params, reader, callback, scope, arg);
            }
            else {
                EasyJF.Ext.CachedRemoteProxy.superclass.load.call(this,params, reader, callback, scope, arg);
            }
        }   
    },
    loadResponse : function(o, success, response) {
                delete this.activeRequest;
                if (!success) {
                    this.fireEvent("loadexception", this, o, response);
                    o.request.callback.call(o.request.scope, null,
                            o.request.arg, false);
                    return;
                }
                if(this.enableCache){
                    try {
                        var json = response.responseText;
                        var obj = eval("(" + json + ")");
                        if(obj && (obj.enableCache===false || obj.enableCache===true)){
                            // this.store.remoteSort=obj.enableCache;
                            this.enableCache = obj.enableCache;
                        }
                        if(this.enableCache){
                            this.getData().clear();
                            this.getData().addAll(Ext.isArray(obj) ? obj : obj.result); 
                            o.params.limit = this.pageSize ? this.pageSize : 10;
                            this.loadFromCache(o.params, o.reader, o.request.callback,o.request.scope, o.request.arg);
                        }else{
                            var result;
                            try {
                                result = o.reader.read(response);
                            } catch (e) {
                                this.fireEvent("loadexception", this, o, response, e);
                                o.request.callback.call(o.request.scope, null,o.request.arg, false);
                                return;
                            }
                            this.fireEvent("load", this, o, o.request.arg);
                            o.request.callback.call(o.request.scope, result, o.request.arg,true);
                        }
                    } catch (e) {
                        this.fireEvent("loadexception", this, o, response, e);
                        o.request.callback.call(o.request.scope, null,o.request.arg, false);
                        return;
                    }
                }else{
                    var result;
                    try {
                        result = o.reader.read(response);
                    } catch (e) {
                        this.fireEvent("loadexception", this, o, response, e);
                        o.request.callback.call(o.request.scope, null,
                                o.request.arg, false);
                        return;
                    }
                    this.fireEvent("load", this, o, o.request.arg);
                    o.request.callback.call(o.request.scope, result, o.request.arg,true);
                }
            },
            add : function(key, obj) {// 增加
                this.getData().add(key, obj);
            },
            remove : function(obj) {// 删除
                this.getData().remove(obj);
            },
            removeKey : function(key) {// 删除
                this.getData().removeKey(key);
            },
            addOrUpdate:function(id, obj){
                this.getData().replace(id, obj);
            },
            update : function(id, obj) {// 修改
                this.getData().replace(id, obj);
            }
});

EasyJF.Ext.CachedRemoteStore = function(c){ 
    EasyJF.Ext.CachedRemoteStore.superclass.constructor.call(this, Ext.apply(c, {
        proxy: c.proxy || (!c.data ? new EasyJF.Ext.CachedRemoteProxy(c) : undefined),
        reader: new Ext.data.JsonReader(c, c.fields)
    }));
    if(!EasyJF.Ext.CachedRemoteProxy.DATAS[this.varName])
    EasyJF.Ext.CachedRemoteProxy.DATAS[this.varName]=new Ext.util.MixedCollection(true);    
};
Ext.extend(EasyJF.Ext.CachedRemoteStore, Ext.data.Store,{
    refreshCache:function(){// 刷新缓存数据,重新从服务器端加载数据
        this.proxy.getData().clear();
        this.reload();
    },
    enableCache : function(b){
                this.proxy.enableCache= b===window.undefined ? true : !!!b; 
            },
    isCache:function(){
                return this.proxy.enableCache;
    },
    sortFn:function(a,b){
                if(!a || b || !a.toUpperCase || !b.toUpperCase){
                    var v1 =a, v2 = b;
                    return v1 > v2 ? 1 : (v1 < v2 ? -1 : 0);
                }
                var i=a.toUpperCase()==b.toUpperCase();
                if(!i)return a.toUpperCase()<b.toUpperCase()?-1:1;
                else{
                    var ret=0;
                    for(var i=0;i<a.length;i++){
                        if(a[i]!==b[i]){
                            return a[i]<b[i]?1:-1;
                        }
                    }
                    return ret ;
                }
            },
      sortData : function(f, direction) {
                direction = direction || 'ASC';
                var st = this.fields.get(f).sortType;
                var fn =this.sortFn;
                this.data.sort(direction, fn);
                if (this.snapshot && this.snapshot != this.data) {
                    this.snapshot.sort(direction, fn);
                }
            },
      sort : function(fieldName, dir){
                if(this.isCache===false){
                   EasyJF.Ext.CachedRemoteStore.superclass.sort.call(this,fieldName, dir);
                        return;
                }
                var f = this.fields.get(fieldName);
                if(!f){
                    return false;
                }
                if(!dir){
                    if(this.sortInfo && this.sortInfo.field == f.name){ // toggle
                                                                        // sort
                                                                        // dir
                        dir = (this.sortToggle[f.name] || "ASC").toggle("ASC", "DESC");
                    }else{
                        dir = f.sortDir;
                    }
                }
                var st = (this.sortToggle) ? this.sortToggle[f.name] : null;
                var si = (this.sortInfo) ? this.sortInfo : null;
        
                this.sortToggle[f.name] = dir;
                this.sortInfo = {field: f.name, direction: dir};
                if(!this.remoteSort){
                    this.applySort();
                    this.fireEvent("datachanged", this);
                }else{
                     var direction = dir || 'ASC';
                     var st2 = this.fields.get(f.name).sortType;
                     var sortFn=this.sortFn;
                     var fn = function(r1, r2){             
                        var v1 = st2(r1[f.name]), v2 = st2(r2[f.name]);
                        return sortFn(v1,v2);
                      };
                    this.proxy.getData().sort(direction,fn);
                    if (!this.load(this.lastOptions)) {
                        if (st) {
                            this.sortToggle[f.name] = st;
                        }
                        if (si) {
                            this.sortInfo = si;
                        }
                    }
                }
            }
});

<div id="method-EasyJF.Ext.TreeCollection-Ext.CachedRemoteObject"></div>/**
 * 前端缓存对象，支持远程数据查询功能，当缓存中没有数据时，会自动通过指定的URL去取数据
 * 
 * @param {}
 *            varName 缓存的名称
 * @param {}
 *            url 获取数据的url
 * @param {}
 *            collectionType 集合类型，默认为MixedCollection
 * @param {}
 *            shareCache 是否共享缓存
 */
EasyJF.Ext.CachedRemoteObject = function(varName, url,collectionType,shareCache) {
    this.varName = varName;
    this.url = url;
    this.collectionType=collectionType;
    this.addEvents("load");
    if(shareCache){
        if(!EasyJF.Ext.CachedRemoteObject.shareCaches[varName])
        EasyJF.Ext.CachedRemoteObject.shareCaches[varName]=eval("new "+(collectionType||"Ext.util.MixedCollection")+"()");
    }
    EasyJF.Ext.CachedRemoteObject.superclass.constructor.call(this);
}

EasyJF.Cache=EasyJF.Ext.CachedRemoteObject.DATAS={};
EasyJF.shareCaches=EasyJF.Ext.CachedRemoteObject.shareCaches={};

Ext.extend(EasyJF.Ext.CachedRemoteObject, Ext.util.Observable, {
    varName:null,
    url:null,
    getData:function(){
        var obj=EasyJF.Ext.CachedRemoteObject.DATAS[this.varName];
        return obj;
    },
    onload:function(callback){
        this.fireEvent("load",this,EasyJF.Ext.CachedRemoteObject.DATAS[this.varName]);
        if(callback)callback();
    },
    clearData : function() {// 刷新缓存数据,重新从服务器端加载数据
         var obj = EasyJF.Ext.CachedRemoteObject.DATAS[this.varName]; 
         if(obj.clear)obj.clear();
          else  obj = null;
    },
    load:function(callback,params){
        if(EasyJF.Ext.CachedRemoteObject.DATAS[this.varName]){
            this.onload.call(this,callback,params);
            return;
        }
        if(this.varName&&this.url){
        EasyJF.Ext.Util.loadJSON2Collection("EasyJF.Ext.CachedRemoteObject.DATAS['"+this.varName+"']",this.url,this.onload.createDelegate(this,[callback]),EasyJF.shareCaches[this.varName],this.collectionType);   
        }
    }
});
Ext.override(Ext.tree.TreeLoader,{
    getParams:function(node){
        this.params = this.params || {};
        var buf = [], bp = this.baseParams;
        for (var key in bp) {
            if (typeof bp[key] != "function") {
                buf.push(encodeURIComponent(key), "=",
                        encodeURIComponent(bp[key]), "&");
            }
        }
        buf.push((this.params['node']|| "node")+"=",(node.id=='root') ? "" : encodeURIComponent(node.id));
        return buf.join("");
    }
});

CachedRemoteObject=EasyJF.Ext.CachedRemoteObject;

<div id="method-EasyJF.Ext.TreeCollection-Ext.MemoryTreeLoader"></div>/**
 * 支持本地缓存节点的树加载器
 * 
 * @param {}
 *            config
 */        
EasyJF.Ext.MemoryTreeLoader = function(config) {
    EasyJF.Ext.MemoryTreeLoader.superclass.constructor.call(this, config);
    if (this.varName && (this.dataUrl || this.url)) {
        this.remoteObject = new EasyJF.Ext.CachedRemoteObject(this.varName,
                (this.url || this.dataUrl),"EasyJF.Ext.TreeCollection",true);
        if (!this.lazyLoad) {
            this.remoteObject.load();
        }
    }
    this.shareCache = EasyJF.Ext.CachedRemoteObject.shareCaches[this.varName];
}
Ext.extend(EasyJF.Ext.MemoryTreeLoader, Ext.tree.TreeLoader, {
            varName : null,
            remoteObject : null,
            dataProxy : false,
            autoLeaf:true,
            remoteDataProxy : null,
            transferNode :window.undefined,
            cascadeNode : function(node, fn, scope, args) {
                if (fn.apply(scope || this, args || [node]) !== false) {
                    if (node.children && node.children.length) {
                        for (var i = 0, cs = node.children; i < cs.length; i++)
                            this.cascadeNode(cs[i], fn, scope, args);
                    }
                }
            },
            deepFindNode : function(id, node) {
                var ret = null;
                this.cascadeNode(node, function(n) {
                            if (n.id == id) {
                                ret = n;
                                return false;
                            }
                        });
                return ret;
            },
            findNode : function(id, objs) {
                if (id == "root")
                    return Ext.isArray(objs) ? objs : objs.items;
                else {
                    var ret = this.deepFindNode(id, {
                                id : "root",
                                children : (Ext.isArray(objs) ? objs : objs.items)
                            });
                   
                    return ret && ret.children ? ret.children : null;
                }
            },
            load : function(node, callback) {
                if (this.clearOnLoad) {
                    while (node.firstChild) {
                        node.removeChild(node.firstChild);
                    }
                }
                var objs = this.remoteObject.getData();
                if (objs && objs.length)
                    node.attributes.children = this.findNode(node.id, objs);
                if (this.doPreload(node)) {
                    if (typeof callback == "function") {
                        callback();
                    }
                } else if (this.dataUrl || this.url) {
                    this.requestData(node, callback);
                }
            },
            doPreload : function(node) {
                if (node.attributes.children && node.attributes.children.length) {
                    if (node.childNodes.length < 1) { // preloaded?
                        var cs = node.attributes.children;
                        node.beginUpdate();
                        for (var i = 0, len = cs.length; i < len; i++) {
                            var o=Ext.apply({},cs[i]);
                            var cn = this.createNode(o);
                            if(cn===false)continue;
                            var cn = node.appendChild(this.createNode(o));
                            if (this.preloadChildren) {
                                this.doPreload(cn);
                            }
                        }
                        node.endUpdate();
                    }
                    return true;
                } else {
                    return false;
                }
            },
            createNode : function(attr) {
                attr = Ext.apply({},attr);
                if (this.baseAttrs) {
                    Ext.applyIf(attr, this.baseAttrs);
                }
                if (this.transferNode != window.undefined) {
                    if(typeof this.transferNode == 'function'){
                        attr= this.transferNode(attr);
                    }else if(typeof this.transferNode == 'object'){
                        for(var o in this.transferNode){
                            if(this.transferNode.hasOwnProperty(o) && Ext.isEmpty(attr[o])){
                                attr[o] = attr[this.transferNode[o]];
                            }
                        }
                    } 
                }
                if(this.autoLeaf===true){
                    if(!attr.children || !attr.children.length){
                        attr.leaf = true;
                    }
                } 
                if (this.applyLoader !== false) {
                    attr.loader = this;
                }
                if (typeof attr.uiProvider == 'string') {
                    attr.uiProvider = this.uiProviders[attr.uiProvider]
                            || eval(attr.uiProvider);
                }
                if (attr.nodeType) {
                    return new Ext.tree.TreePanel.nodeTypes[attr.nodeType](attr);
                } else {
                    return attr.leaf
                            ? new Ext.tree.TreeNode(attr)
                            : new Ext.tree.AsyncTreeNode(attr);
                }
            },
            processResponse : function(response, parentNode, callback) {
                var json = response.responseText;
                try {
                    var o = eval("(" + json + ")");
                    
                    var collection = EasyJF.Ext.CachedRemoteObject.shareCaches[this.varName];
                    collection.clear();
                    collection.addAll(o);
                    EasyJF.Ext.CachedRemoteObject.DATAS[this.varName]=collection;
                    o = collection.items;
                    parentNode.beginUpdate();
                    collection.each(function(node){
                        var n = this.createNode(node);
                        if (n)parentNode.appendChild(n);
                    },this);
                    parentNode.endUpdate();
                    if (typeof callback == "function") {
                        callback(this, parentNode);
                    }
                } catch (e) {
                    this.handleFailure(response);
                }
            }
        });
Ext.ns('EasyJF.Ext.Tree'); 
<div id="method-EasyJF.Ext.TreeCollection-Ext.Tree.LocalPlugin"></div>/**
 * 邮件菜单树插件，支持数据同步更新
 * 
 * @param {}
 *            config
 */
EasyJF.Ext.Tree.LocalPlugin=function(config){
    Ext.apply(this,config);
    EasyJF.Ext.Tree.LocalPlugin.superclass.constructor.call(this, config);
}
Ext.extend(EasyJF.Ext.Tree.LocalPlugin,Ext.util.Observable,{
    init : function(tree) {
        this.tree = tree;
        this.loader = this.tree.loader;
        this.tree.on('render', this.initEvents, this);
        this.tree.on('beforedestroy', this.destroyCmp, this);
    },
    destroyCmp:function(){
         delete this.tree;
         delete this.loader;
         var shareCache = this.loader.shareCache;
         shareCache.un("addnode",this.addUINode,this);// 数据变化,则创建新的节点
         shareCache.un("updatenode",this.updateUINode,this);// 更新节点内容
         shareCache.un("removenode",this.removeUINode,this);// 删除节点内容
    },
    initEvents:function(){
         var shareCache = this.loader.shareCache;
         shareCache.on("addnode",this.addUINode,this);// 数据变化,则创建新的节点
         shareCache.on("updatenode",this.updateUINode,this);// 更新节点内容
         shareCache.on("removenode",this.removeUINode,this);// 删除节点内容
   },
    addUINode:function(node,parentNode){
        var parent = parent = this.getNodeById(parentNode.id);
        if(parent){
            parent.leaf=false;
            parent.appendChild(node);
        }
    },
    updateUINode:function(upateNode){
        var node = this.getNodeById(upateNode.id);
        if(node){
             if(Ext.type(this.loader.transferNode)=='function'){
                upateNode = Ext.apply({},upateNode);
                this.loader.transferNode(upateNode);
            }
            node.setText(upateNode.text);
            Ext.copyToIf(node.attributes,upateNode,["children","cls","loader","parentNode"]);
            if(node.getUI() instanceof Ext.ux.tree.ColumnNodeUI){
                node.getUI().updateNode(upateNode);
            }
            if(!Ext.isEmpty(upateNode.qtip)){
                if (node.getUI().getTextEl().setAttributeNS) {
                    node.getUI().getTextEl().setAttributeNS("ext","qtip",upateNode.qtip);
                } else {
                    node.getUI().getTextEl().setAttribute("ext:qtip",upateNode.qtip);
                }
            }
        }
    },
    removeUINode:function(node){
        var parentNode = node.parentNode;
        if(parentNode && parentNode.children.length==0){
            var parentNode = this.getNodeById(parentNode.id);
            if(parentNode){
                parentNode.leaf=true;
                parentNode.getUI().updateExpandIcon();
            }
        }
        var node = this.getNodeById(node.id);
        if(node){
            node.remove();
        }
    }
    ,
    getNodeById:function(id){
        return this.tree.getNodeById(id);
    }
});


BaseGridList = Ext.extend(Ext.Panel, {
            layout : "fit",
            loadData : false,
            pageSize : 10,
            closable : true,
            autoScroll : true,
            pagingToolbar : true,           
            gridForceFit : true,// 强制表格自动适应
            gridViewConfig : {},
            gridConfig : {},// 表格的自定义配置
            showMenu : true,
            menu_refresh: false,
            linkRenderer : EasyJF.Ext.Util.linkRenderer,
            linkRender:EasyJF.Ext.Util.linkRenderer,
            imgRender :EasyJF.Ext.Util.imgRender,
            booleanRender :  EasyJF.Ext.Util.booleanRender,
            dateRender :EasyJF.Ext.Util.dateRender,
            userRender : EasyJF.Ext.Util.userRender,
            objectRender : EasyJF.Ext.Util.objectRender,
            typesRender : EasyJF.Ext.Util.typesRender,
            operaterRender:EasyJF.Ext.Util.operaterRender,
            storeType:Ext.data.JsonStore,
            storeConfig:{},
            emailRender : function(v) {
                return v ? v.email : "未知";
            },  
            refresh : function() {
                this.store.removeAll();
                this.store.reload({callback:function(rs){
                    if(rs && rs.length<1){Ext.Msg.alert("提示","没有符合条件的数据！");EasyJF.Ext.Util.autoCloseMsg.defer(2000);}
                    }
                });
            },
            showContextMenu : function(g, i, e) {
                var evn = e ? e : g;
                evn.preventDefault();
                if (i) {
                    this.grid.getSelectionModel().selectRow(i, false);
                }
                this.menu.showAt(evn.getPoint());
            },  
            doOperate:function(grid,rowIndex,columnIndex,e){
                var tag = e.getTarget("A", 3);
                if (tag) {
                    var id = tag.getAttribute("theid");
                    var cmd = tag.getAttribute("op");
                    var cf=tag.getAttribute("cf");
                    if (id && cmd && this.operate)
                        this.operate(cmd, id, cf, grid, rowIndex, columnIndex, e);
                }
            },
            initComponent : function() {
                BaseGridList.superclass.initComponent.call(this);
                if(!this.store){
                    this.store = new this.storeType(Ext.apply({
                        id : "id",
                        url : this.url,
                        root : "result",
                        totalProperty : "rowCount",
                        remoteSort : true,
                        fields : this.storeMapping
                    },this.storeConfig));
                }
                this.store.paramNames.sort = "orderBy";
                this.store.paramNames.dir = "orderType";
                this.cm.defaultSortable = true;             
                var viewConfig = Ext.apply({
                            forceFit : this.gridForceFit
                        }, this.gridViewConfig);
                var gridConfig=Ext.apply({},{                   
                    store : this.store,
                    cm : this.cm,
                    trackMouseOver : false,
                    loadMask : true,
                    viewConfig : viewConfig,
                    bbar : this.pagingToolbar ? new Ext.PagingToolbar({
                        pageSize : this.pageSize,
                        store : this.store,
                        displayInfo : true
                    }) : null
                });
                Ext.apply(gridConfig,this.gridConfig);
                this.menus=this.menus||[];
                if(this.menu_refresh)
                this.menus[this.menus.length]={id:"menu_refresh",cls:"x-btn-text-icon",icon:"images/icons/arrow_refresh.png",text:"刷新",handler:this.refresh,scope:this};
                this.menu=new Ext.menu.Menu({items:this.menus});
                // if(this.gridConfig)gridConfig=Ext.apply(this.gridConfig,gridConfig);
                if(this.gridTbar)gridConfig.tbar=this.gridTbar;
                if(this.gridBorder===false||this.gridBorder)gridConfig.border=this.gridBorder;
                if(this.columnLock && Ext.grid.LockingGridPanel){
                if(!gridConfig.columns && gridConfig.cm){
                    gridConfig.columns=gridConfig.cm.config;
                    delete gridConfig.cm;
                }   
                this.grid = new Ext.grid.LockingGridPanel(gridConfig);
                }
                else this.grid=new Ext.grid.GridPanel(gridConfig);
                this.grid.on("rowcontextmenu",function(g,n,e){
                    if(!this.showMenu) return false;
                    if(g.getSelectionModel().selectRow)g.getSelectionModel().selectRow(n);
                    this.menu.showAt(e.getPoint());
                    e.preventDefault();
                },this);
                
                this.add(this.grid);
                if (this.loadData)
                    this.store.load();
                    // this.store.load({params:{}});
            }
        });

UserSelectCombo = Ext.extend(Ext.form.ComboBox, {
            editable : false,
            searchByUser : function(text, v) {
                this.store.baseParams.searchKey = v;
                this.store.reload();
            },
            initList : function() {
                UserSelectCombo.superclass.initList.call(this);
                if (this.pageTb) {
                    this.pageTb.add("用户名");
                    this.pageTb.add({
                        xtype : "textfield",
                        id : "searchKey",
                        width : 50,
                        listeners : {
                            "change" : this.searchByUser,
                            scope : this
                        }
                    });
                    this.pageTb.addButton({
                        text : "查询"
                    });
                }
            }
        });
Ext.reg('userselectcombo', UserSelectCombo);

HTMLEditor = Ext.extend(Ext.form.HtmlEditor, {
    // enableFont:false,
    codeStyle : '<br/><pre style="border-right: #999999 1px dotted; padding-right: 5px; border-top: #999999 1px dotted; padding-left: 5px; font-size: 12px; padding-bottom: 5px; margin-left: 10px; border-left: #999999 1px dotted; margin-right: 10px; padding-top: 5px; border-bottom: #999999 1px dotted; background-color: #eeeeee">{0}</pre><br/>',
    onRender : function(ct, position) {
        HTMLEditor.superclass.onRender.call(this, ct, position);        
        if (this.keys) {
            if (!this.keys.length) {
                this.keyMap = new Ext.KeyMap(this.getEditorBody(), this.keys);
            } else {
                this.keyMap = new Ext.KeyMap(this.getEditorBody(), this.keys[0]);
                for (var i = 1; i < this.keys.length; i++)
                    this.keyMap.addBinding(this.keys[i]);
            }
            this.keyMap.stopEvent = true;
        }
    },
    showEmoteSelect : function() {
        emoteSelectWin.editor = this;
        emoteSelectWin.show();
    },
    addImage : function() {
        function insertImage() {
            var editor = this;
            win.upload(function(ret) {
                if (ret) {
                    var s = "<br/><img src=" + ret.path;
                    if (ret.width)
                        s += " width=" + ret.width;
                    if (ret.height)
                        s += " height=" + ret.height;
                    s += " /><br/>";
                    editor.insertAtCursor(s);
                    win.close();
                }
            });
        };
        var win = new UploadImageWindow({
            modal : true,
            iconCls : "icon-img",
            buttons : [{
                        text : "确定",
                        handler : insertImage,
                        scope : this
                    }, {
                        text : "取消",
                        handler : function() {
                            win.close();
                        }
                    }]
        });
        win.show();
    },
    addCode : function() {
        function insertCode() {
            var value = win.getComponent("codes").getValue();
            this.insertAtCursor(String.format(this.codeStyle, value));
            win.close();
        };
        var win = new Ext.Window({
            title : "添加代码",
            width : 500,
            height : 300,
            modal : true,
            iconCls : "icon-code",
            layout : "fit",
            items : {
                xtype : "textarea",
                id : "codes"
            },
            buttons : [{
                        text : "确定",
                        handler : insertCode,
                        scope : this
                    }, {
                        text : "取消",
                        handler : function() {
                            win.close();
                        }
                    }]
        });
        win.show();
    },
    createToolbar : function(editor) {
        HTMLEditor.superclass.createToolbar.call(this, editor);
        this.tb.insertButton(16, {
                    cls : "x-btn-icon",
                    icon : "images/qq/img.gif",
                    handler : this.addImage,
                    scope : this
                });
        this.tb.insertButton(17, {
                    cls : "x-btn-icon",
                    icon : "images/qq/code.gif",
                    handler : this.addCode,
                    scope : this
                });
        this.tb.insertButton(18, {
                    cls : "x-btn-icon",
                    icon : "images/emote/main.jpg",
                    handler : this.showEmoteSelect,
                    scope : this
                });

    },
    validateValue : function(value) {
        if (value.length > this.maxLength) {
            var s = String.format(this.maxLengthText, this.maxLength);
            this.markInvalid(s);
            return false;
        }
        return true;
    }
});
Ext.reg('myhtmleditor', HTMLEditor);

// 用来存放IFrames中的panel引用，以id为单位
IFrames={};

EasyJF.Ext.CrudListPanel=function(config){
    var c= config || {};
    Ext.applyIf(c,{
        viewWin : {
            width : 650,
            height : 410,
            title : "详情查看"
        },
        searchWin : {
            width : 630,
            height : 300,
            title : "高级查询"
        },// 查询窗口的高度、宽度及标题
        gridViewConfig : {},// 表格显示视图的自定义配置
        gridConfig : {},// 表格的自定义配置
        baseQueryParameter : {}// 查询初始化参数
    })
    Ext.applyIf(this,c);
    this.addEvents("saveobject","removeobject");
    EasyJF.Ext.CrudListPanel.superclass.constructor.call(this);
};

Ext.extend(EasyJF.Ext.CrudListPanel, Ext.util.Observable);
Ext.apply(EasyJF.Ext.CrudListPanel.prototype,EasyJF.Ext.CrudFunction,{
    afterList:Ext.emptyFn,
    list:function(){
            this.initComponent();
            this.checkAdnLoadColumnField();
            this.store = new Ext.data.JsonStore({
                id : this.storeId?this.storeId:"id",
                url : this.formatUrl('list'),
                root : "result",
                totalProperty : "rowCount",
                remoteSort : true,
                fields : this.storeMapping
            });
            if(Ext.objPcount(this.baseQueryParameter)){
                this.store.on('beforeload',function(store,options){
                    Ext.apply(store.baseParams,{},this.baseQueryParameter);
                },this);
            }
            this.store.baseParams=Ext.apply({},{limit:this.pageSize||""},this.initQueryParameter||{});
            this.store.paramNames.sort = "orderBy";
            this.store.paramNames.dir = "orderType";
            
            var buttons=this.buildCrudOperator();
            var viewConfig = Ext.apply({
                        forceFit : this.gridForceFit
                    }, this.gridViewConfig);
            var gridConfig = Ext.apply(this.gridConfig, {
                        store : this.store,
                        stripeRows : true,
                        trackMouseOver : false,
                        loadMask : true,
                        viewConfig : viewConfig,
                        tbar:buttons,
                        border : false,
                        bbar : this.pagingToolbar ? new  Ext.ux.PagingComBo({
                            rowComboSelect:true,
                            pageSize : this.pageSize,
                            store : this.store,
                            displayInfo : true
                        }) : null
                    });
            if(this.summaryGrid){
                if(gridConfig.plugins){
                    if(typeof gridConfig.plugins=="object")gridConfig.plugins=[gridConfig.plugins];
                }
                else gridConfig.plugins=[];
                gridConfig.plugins[gridConfig.plugins.length]=new Ext.ux.grid.GridSummary();
            }       
            if(this.columns)gridConfig.columns=this.columns;
            else if(this.cm)gridConfig.cm=this.cm;
            if(this.columnLock && Ext.grid.LockingGridPanel){
                if(!gridConfig.columns && gridConfig.cm){
                    gridConfig.columns=gridConfig.cm.config;
                    delete gridConfig.cm;
                }   
            this.grid = new Ext.grid.LockingGridPanel(gridConfig);
            }
            else this.grid=new Ext.grid.GridPanel(gridConfig);
            
            this.grid.colModel.defaultSortable = true;// 设置表格默认排序
            this.panel=new Ext.Panel({
                id:this.id,
                title:this.title,               
                closable :this.closable,
                autoScroll : this.autoScroll,
                layout : this.layout,
                border : this.border,
                listeners:{close:function(){delete this.panel;},scope:this}
                });
            this.panel.add(this.grid);
            this.loadOperatorsPermission();
            // 双击表格行进入编辑状态
            this.initCrudEventHandler();
            // this.disableOperaterItem("btn_edit","btn_remove","btn_view");
            this.afterList();
            if(this.autoLoadGridData)this.store.load();
            this.panel.service=this;
            return this.panel;
        }
});

Ext.Ajax.on("beforerequest",function(conn,options){
    if(options.waitMsg){
        Ext.Msg.wait(options.waitMsg,options.waitTitle || '请稍候...');
    }
})
Ext.Ajax.on("requestcomplete",function(conn,response,options){
   if(response&&response.getResponseHeader&&response.getResponseHeader["LoginRequired"]){
    Ext.Msg.alert("提示","对不起，您还没有登录或者登录超时，请重新登录！",function(){
    var win=window.top?window.top:window;
    if(win.relogin)win.relogin();
    else win.location.href="/";
    });
    return;
  }
  if(response&&response.getResponseHeader&&response.getResponseHeader["Unauthorized"]){
    Ext.Msg.alert("警告","你没有该项操作的权限，请与管理员联系！");
    return ;
  }
  if(options.waitMsg){
    Ext.MessageBox.updateProgress(1);
    Ext.MessageBox.hide();
  }
});
Ext.Ajax.on("requestexception",function(conn,response,options){
  var code=response.status||0;
  switch(code){
  case 0:
  case 12002:
  case 12029:
  case 12030:
  case 12031:
  case 12152:
  case 13030:
    Ext.Msg.alert("通讯异常!","您的网络连接发生中断!");
    return false;
    break ;
  case -1:
    // Ext.Msg.alert("通讯超时!","请求已经被自动取消!");
    return false;
    break ;
  case 403:
     Ext.Msg.alert("警告!","您没有操作的权限，请与管理员联系!");
    return false;
    break ;
  default:
    if(code<200||code>=300){
       Ext.Msg.alert("警告!","发生了其它通讯异常，异常状态编码为"+code);
      return false;
    }
  }
  return true;
});
Ext.apply(Ext.lib.Ajax,{
    syncRequest:function(method, uri,data, callback,options){
            if(options){
                var hs = options.headers;
                if(hs){
                    for(var h in hs){
                        if(hs.hasOwnProperty(h)){
                            this.initHeader(h, hs[h], false);
                        }
                    }
                }
                if(options.xmlData){
                    if (!hs || !hs['Content-Type']){
                        this.initHeader('Content-Type', 'text/xml', false);
                    }
                    method = (method ? method : (options.method ? options.method : 'POST'));
                    data = options.xmlData;
                }else if(options.jsonData){
                    if (!hs || !hs['Content-Type']){
                        this.initHeader('Content-Type', 'application/json', false);
                    }
                    method = (method ? method : (options.method ? options.method : 'POST'));
                    data=options.jsonData;
                    
                }
            }
            var o = this.getConnectionObject();
            if (!o) {
                return null;
            }
            else {
                o.conn.open(method, uri, false);

                if (this.useDefaultXhrHeader) {
                    if (!this.defaultHeaders['X-Requested-With']) {
                        this.initHeader('X-Requested-With', this.defaultXhrHeader, true);
                    }
                }

                if(data && this.useDefaultHeader && (!this.hasHeaders || !this.headers['Content-Type'])){
                    this.initHeader('Content-Type', this.defaultPostHeader);
                }

                 if (this.hasDefaultHeaders || this.hasHeaders) {
                    this.setHeader(o);
                }  
                if(typeof data == 'object')data = Ext.urlEncode(data);
                o.conn.send(data || null);
                if(callback)callback.call((options ? options['scope']:this),o.conn);
                return o;
            }
        }
});

Ext.apply(Ext.lib.Ajax,{
    isScriptLoading : function(){
        return this.scriptTrans ? true : false;
    },
    abortScript : function(){
        if(this.isScriptLoading()){
            this.destroyScriptTrans(this.scriptTrans);
        }
    },

    // private
    destroyScriptTrans : function(trans, isLoaded){
        this.head.removeChild(document.getElementById(trans.scriptId));
        clearTimeout(trans.timeoutId);
        if(isLoaded){
            window[trans.cb] = undefined;
            try{
                delete window[trans.cb];
            }catch(e){}
        }else{
            // if hasn't been loaded, wait for load to remove it to prevent script error
            window[trans.cb] = function(){
                window[trans.cb] = undefined;
                try{
                    delete window[trans.cb];
                }catch(e){}
            };
        }
    },

    // private
    handleScriptResponse : function(o, trans){
        this.scriptTrans = false;
        this.destroyScriptTrans(trans, true);
        var result;
        try {
            result = o;
        }catch(e){
            this.fireEvent("loadexception", this, o, trans.params, e);
            trans.callback.call(trans.scope||window, null, trans.params, false);
            return;
        }
        trans.callback.call(trans.scope||window, result, trans.params, true);
    },

    // private
    handleScriptFailure : function(trans){
        this.scriptTrans = false;
        this.destroyScriptTrans(trans, false);
        this.fireEvent("loadexception", this, null, trans.params);
        trans.callback.call(trans.scope||window, null, trans.params, false);
    },
    scriptRequest:function(options){
            if(!this.head)this.head = document.getElementsByTagName("head")[0];
            options=options||{};
            var p = Ext.urlEncode(options.params);

            var url = options.url;
            url += (url.indexOf("?") != -1 ? "&" : "?") + p;
            if(options.nocache){
                url += "&_dc=" + (new Date().getTime());
            }
            var transId = ++Ext.data.ScriptTagProxy.TRANS_ID;
            var trans = {
                id : transId,
                cb : "stcCallback"+transId,
                scriptId : "stcScript"+transId,
                params : options.params,
                url : url,
                callback : options.callback,
                scope : options.scope
            };
            var conn = this;
            
            window[trans.cb] = function(o){
                conn.handleScriptResponse(o, trans);
            };

            url += String.format("&{0}={1}", options.callbackParam||"callback", trans.cb);

           
            trans.timeoutId = this.handleScriptFailure.defer(options.timeout||30000, this, [trans]);

            var script = document.createElement("script");
            script.setAttribute("src", url);
            script.setAttribute("type", "text/javascript");
            script.setAttribute("id", trans.scriptId);
            this.head.appendChild(script);
            this.scriptTrans = trans;
        }
});

EasyJF.Ext.Util.HelpIconPlugin = Ext.extend(Ext.util.Observable, {
    init:function(field) {
    Ext.apply(field, {
      onRender:field.onRender.createSequence(function(ct, position) {
        // If field has the fieldLabel object, add the helpIcon
        if(this.fieldLabel && this.helpText) {
          var label = this.el.findParent('.x-form-element', 5, true) || this.el.findParent('.x-form-field-wrap', 5, true);
          
          this.helpIcon = label.createChild({
            cls:(this.helpIconCls || 'ux-helpicon-icon')
          ,    style:'width:16px; height:18px; position:absolute; left:0; top:0; display:block; background:transparent no-repeat scroll 0 2px;'
          });
          
          this.alignHelpIcon = function(){
            var el = this.wrap ? this.wrap : this.el; 
            this.helpIcon.alignTo(el, 'tl-tr', [2, 0]);
          }
          // Redefine alignErrorIcon to move the errorIcon (if it exist) to
            // the right of helpIcon
          if(this.alignErrorIcon) {
            this.alignErrorIcon = function() {
              this.errorIcon.alignTo(this.helpIcon, 'tl-tr', [2, 0]);
            }
          }
          
          this.on('resize', this.alignHelpIcon, this);
          // Register QuickTip for icon
          Ext.QuickTips.register({
            target:this.helpIcon
          , title:(this.helpTitle || '')
          , text:(this.helpText || 'No help defined yet!')
          , enabled:true
          });
        }
      }) 
    }); 
    } 
}); 

Ext.apply(Ext.Window.prototype,{
    onRender : function(ct, position){
        Ext.Window.superclass.onRender.call(this, ct, position);

        if(this.plain){
            this.el.addClass('x-window-plain');
        }

        // this element allows the Window to be focused for keyboard events
        this.focusEl = this.el.createChild({
                    tag: "a", href:"#", cls:"x-dlg-focus",
                    tabIndex:"-1", html: "&#160;"});
        this.focusEl.swallowEvent('click', true);

        this.proxy = this.el.createProxy("x-window-proxy");
        this.proxy.enableDisplayMode('block');

        if(this.modal){
            this.mask = this.container.createChild({cls:"ext-el-mask"}, this.el.dom);
            this.mask.enableDisplayMode("block");
            this.mask.hide();
        }
        new Ext.KeyMap(this.el,[{
                            key:"x",
                            alt:true,
                            fn: function(){this.hide();},
                            scope: this
                        },{
                            key:Ext.EventObject.TAB,
                            fn:function(k,e){
                                if(this.buttons&&this.buttons.length){
                                    if(this.buttons[this.buttons.length-1].el.hasClass("x-btn-focus")){
                                    e.stopEvent();
                                    var firstField=[];
                                    // 此处有问题,影响效率
                                    this.cascade(function(c){                                       
                                        if(c.isFormField && c.canFocus()){
                                            firstField.push(c);
                                            return false;
                                        }
                                    });
                                    if(firstField.length){
                                        firstField[0].focus();
                                    }
                                    }
                                }
                            },
                            scope:this
                        }]);
    }
});
<div id="prop-EasyJF.Ext.TreeCollection-apply"></div>/**
 * 对Field及BasicForm进行了简单扩展,支持clearDirty
 */
Ext.apply(Ext.form.Field.prototype,{// msgTarget:"side",
        plugins:new EasyJF.Ext.Util.HelpIconPlugin(),
        clearDirty:function(){
            this.originalValue=this.getValue();
        },
        clearData:function(){// 把字段设置为最原始的值,通过initialConfig的value属性得到
            var v=this.initialConfig.value;
            if(v === this.emptyText || v === undefined){
            v = '';
            }
            this.originalValue=v;
        },
        setOriginalValue:function(v){// 设置字段原始值
            this.setValue(v);
            this.clearDirty();
        },
        getCursorPosition:function(){
            var d = this.el.dom;
            if(d.setSelectionRange){
                return d.selectionStart||0;
            }else if(d.createTextRange){
                 var   currentRange=document.selection.createRange();  
                 var   workRange=currentRange.duplicate();  
                    d.select();  
                    var   allRange=document.selection.createRange();  
                    var   len=0;
                    while(workRange.compareEndPoints("StartToStart",allRange)>0){  
                      workRange.moveStart("character",-1);  
                      len++;  
                    }
                    currentRange.select();  
                    return len;
            }
        },
        canFocus:function(){
            return !(/hidden|labelfield|checkbox|radio/.test(this.getXType())||this. disabled||this.hidden|| (this.el.dom.readOnly=== true));
        }
    });
Ext.namespace("Ext.ux.panel");
Ext.ux.panel.DDTabPanel = Ext.extend(Ext.TabPanel, {
	arrowOffsetX : -9,
	arrowOffsetY : -8,
	border : false,
	enableTabScroll : true,
	layoutOnTabChange : true,
	autoScroll : true,
	resizeTabs : true,
	tabWidth : 136,
	minTabWidth : 136,
	titleLength : 100,
	initComponent : function() {
		Ext.ux.panel.DDTabPanel.superclass.initComponent.call(this);
		if (!this.ddGroupId) {
			this.ddGroupId = "dd-tabpanel-group-"
					+ Ext.ux.panel.DDTabPanel.superclass.getId.call(this)
		}
	},
	afterRender : function() {
		Ext.ux.panel.DDTabPanel.superclass.afterRender.call(this);
		this.arrow = Ext.DomHelper.append(Ext.getBody(),
				'<div class="dd-arrow-down"></div>', true);
		this.arrow.hide();
		var a = this.ddGroupId;
		this.dd = new Ext.ux.panel.DDTabPanel.DropTarget(this, {
					ddGroup : a
				})
	},
	initTab : function(b, a) {
		Ext.ux.panel.DDTabPanel.superclass.initTab.call(this, b, a);
		var c = this.id + "__" + b.id;
		Ext.applyIf(b, {
					allowDrag : true
				});
		Ext.apply(b, {
					position : (a + 1) * 2,
					ds : new Ext.dd.DragSource(c, {
								ddGroup : this.ddGroupId,
								dropEl : b,
								dropElHeader : Ext.get(c, true),
								scroll : false,
								onStartDrag : function() {
									this.getProxy().ghost.dom.innerHTML=this.dropEl.title;
									if (this.dropEl.iconCls) {
										this.getProxy().getGhost()
												.select(".x-tab-strip-text")
												.applyStyles({
															paddingLeft : "20px"
														})
									}
								},
								onMouseDown : function(d) {
									if (!this.dropEl.isVisible()) {
										this.dropEl.show()
									}
								}
							}),
					enableDrag : function() {
						this.allowDrag = true;
						return this.ds.unlock()
					},
					disableDrag : function() {
						this.allowDrag = false;
						return this.ds.lock()
					}
				});
		if (b.allowDrag) {
			b.enableDrag()
		} else {
			b.disableDrag()
		}
	},
	onRemove : function(b, a) {
		Ext.destroy(a.ds.proxy, a.ds);
		Ext.ux.panel.DDTabPanel.superclass.onRemove.call(this, b, a)
	},
	onDestroy : function() {
		Ext.destroy(this.dd, this.arrow);
		Ext.ux.panel.DDTabPanel.superclass.onDestroy.call(this)
	}
});
Ext.ux.panel.DDTabPanel.DropTarget = Ext.extend(Ext.dd.DropTarget, {
			constructor : function(b, a) {
				this.tabpanel = b;
				Ext.ux.panel.DDTabPanel.DropTarget.superclass.constructor.call(
						this, b.stripWrap, a)
			},
			notifyOver : function(q, l, j) {
				var m = this.tabpanel.items;
				var p = m.length;
				if (!l.within(this.getEl())) {
					return "x-dd-drop-nodrop"
				}
				var r = this.tabpanel.arrow;
				var o = this.el.getY();
				var f;
				var k = l.getPageX();
				for (var h = 0; h < p; h++) {
					var d = m.itemAt(h);
					var c = d.ds.dropElHeader;
					var n = c.getX();
					var a = n + c.dom.clientWidth / 2;
					if (k <= a) {
						f = n;
						break
					}
				}
				if (typeof f == "undefined") {
					var b = m.itemAt(p - 1);
					if (b) {
						var g = b.ds.dropElHeader.dom;
						f = (new Ext.Element(g).getX() + g.clientWidth) + 3
					}
				}
				r.setTop(o + this.tabpanel.arrowOffsetY).setLeft(f
						+ this.tabpanel.arrowOffsetX).show();
				return this.dropAllowed;
			},
			notifyDrop : function(p, k, f) {
				this.tabpanel.arrow.hide();
				var m = this.tabpanel.items;
				var o = m.length;
				var h = k.getPageX();
				var l = o;
				p.dropEl.position = o * 2 + 1;
				var j = this.tabpanel.items.indexOf(p.dropEl);
				for (var d = 0; d < o; d++) {
					var c = m.itemAt(d);
					var b = c.ds.dropElHeader;
					var n = b.getX();
					var a = n + b.dom.clientWidth / 2;
					if (h <= a) {
						if (j < d) {
							d -= 1
						}
						break
					}
				}
				p.proxy.hide();
				var g = p.dropEl.ownerCt.remove(p.dropEl, false);
				var c = this.tabpanel.getComponent(d);
				if (c && c.tabFixed) {
					d = this.getLastTabFixed()
				}
				if (this.tabpanel.items.getCount() < d) {
					d = this.tabpanel.items.getCount()
				}
				this.tabpanel.insert(d, g);
				this.tabpanel.activate(g);
				/*var q = this.tabpanel.getTabEl(g).childNodes[1].firstChild.firstChild;
				if (q) {
					q.style.width = Ext.value(this.tabpanel.minTabWidth,120) + "px"
				}*/
				return true
			},
			getLastTabFixed : function() {
				var a = this.tabpanel.items.filter("tabFixed", true);
				return a.getCount()
			},
			notifyOut : function(a, c, b) {
				this.tabpanel.arrow.hide()
			}
		});
Ext.reg("ddtabpanel", Ext.ux.panel.DDTabPanel);  
 
Ext.apply(Ext.form.BasicForm.prototype,{
        clearDirty:function(){
            this.items.each(function(f){
               f.clearDirty();
            });
            return this;
        },
        clearData:function(){// 清除所有通过value属赋值的属性值
            this.items.each(function(f){
               f.clearData();
            });
        },
        focusFirstButton:function(fp){
            if(fp){
                var buttons=fp.buttons;
                if(!buttons){
                    fp.bubble(function(c){if(c.buttons){buttons=c.buttons;return false;}});
                }
                for(var i=0;buttons&&i<buttons.length;i++){
                if(!buttons[i].disabled){
                    buttons[i].focus();
                    break;
                }}
            }
        },
        focusPreviousField:function(f,e){
            var n=f.name||f.id;
            // 通过navigationSequences定义的顺序来导航
            var sequence=-1,key=null;
            if(this.navigationSequences && ((sequence=this.navigationSequences.indexOf(n))>0)){
                key=this.navigationSequences[sequence-1];
            }
            else {
                 this.items.each(function(field){// 查找当前field所在的位置
                      sequence++;
                      if(f.id==field.id || f.name==field.name){
                        return false;
                      }
                    });
                while(sequence>0){
                        if(!this.items.get(sequence-1).canFocus()){
                        sequence--;
                        }
                        else {
                            break;
                        }
                }   
                if(sequence>0){
                    key=this.items.get(sequence-1).id;
                }               
            }
            if(key){// 如果找到下一个key
                var field=this.findField(key);
                    if(!field){// 通过表单来找
                        var fp=f.findParentByType("form");
                        if(fp)field=fp.findSomeThing(key);
                    }
                    if(field){
                            if(e)e.stopEvent();
                            field.focus();
                        }
            }
        },
        focusNextField:function(f,e){
            var n=f.name||f.id;
            // 通过navigationSequences定义的顺序来导航
            var sequence=-1,key=null;
            if(this.navigationSequences && ((sequence=this.navigationSequences.indexOf(n))>=0)){
                if(sequence>=this.navigationSequences.length-1){
                    var fp=f.findParentByType("form");
                    this.focusFirstButton(fp);// 导航到按钮
                }
                else {
                    key=this.navigationSequences[sequence+1];
                }
            }
            else {
                 this.items.each(function(field){// 查找当前field所在的位置
                      sequence++;
                      if(f.id==field.id || f.name==field.name){
                        return false;
                      }
                    });
                while(sequence<this.items.getCount()-1){
                        if(!this.items.get(sequence+1).canFocus()){
                        sequence++;
                        }
                        else {
                            break;
                        }
                }
                if(sequence>=this.items.getCount()-1){
                    var fp=f.findParentByType("form");
                    this.focusFirstButton(fp);// 导航到按钮
                }
                else {
                    key=this.items.get(sequence+1).id;
                }
            }
            if(key){// 如果找到下一个key
                var field=this.findField(key);
                    if(!field){// 通过表单来找
                        var fp=f.findParentByType("form");
                        if(fp)field=fp.findSomeThing(key);
                    }
                    if(field){
                        try{
                            field.focus();
                        }
                        catch(e){
                            if(e)e.keyCode=9;
                        }
                }
            }
        },
        handleNavigation:function(f,e){         
            var k = e.getKey();
            if(k==e.ENTER && this.enterNavigationKey){
                if(f.getValue()||f.allowBlank!==false){
                    this.focusNextField(f,e);
                    // alert("go next");
                }
                // else return false;
            }
            else if(k==e.UP||(k==e.LEFT && f.getCursorPosition()===0)){
                this.focusPreviousField(f,e);
            }           
        },
        add : function(){
            for(var i=0;i<arguments.length;i++){    
                var f=arguments[i];
                f.on("specialkey",this.handleNavigation,this);
            }
            this.items.addAll(Array.prototype.slice.call(arguments, 0));
            return this;
        }
    });
Ext.apply(Ext.form.FormPanel.prototype,{
	findField:function(id){
		return this.getForm().findField(id);
	}
});
Ext.apply(Ext.form.TextArea.prototype,{
    autoSize : function(){
        if(!this.grow || !this.textSizeEl){
            return;
        }
        var el = this.el;
        var v = el.dom.value;
        var ts = this.textSizeEl;
        ts.innerHTML = '';
        ts.appendChild(document.createTextNode(v));
        v = ts.innerHTML;
        Ext.fly(ts).setWidth(this.el.getWidth());
        if(v.length < 1){
            v = "& #160;& #160;";
        }else{
            v += this.growAppend;
            if(Ext.isIE){
                v = v.replace(/\n/g, '<br />');
            }
        }
        ts.innerHTML = v;
        var h = Math.min(this.growMax, el.dom.value<1?25:Math.max(ts.offsetHeight, this.growMin)+this.growPad);
        if(h != this.lastHeight){
            this.lastHeight = h;
            this.el.setHeight(h);
            this.fireEvent("autosize", this, h);
        }
    }
})  


ChartTools = {
    createFusionChart : function(url, swf, chartId, width, height, options) {
        options = options || {};
        var myChart = new FusionCharts(swf, chartId, width, height, "0", "0");
        url = url || options.url;
        if (url) {
            if (url.indexOf("?") < 1)
                url += "?";
            if (options.params)
                url += Ext.urlEncode(options.params);
            myChart.setDataURL(url);
        }
        if (options.renderTo && url) {
            myChart.render(options.renderTo);
        }
        return myChart;
    },
    // "FusionCharts/chart/Column3D.swf",
    createChart : function(url, swf, config) {
        config = config || {};
        var myChart = this.createFusionChart(url, swf, config.id, config.width,
                config.height, config);
        return myChart;
    },
    createColumn2D : function(url, config) {
        return this
                .createChart(url, "/FusionCharts/chart/Column2D.swf", config);
    },
    createColumn3D : function(url, config) {
        return this
                .createChart(url, "/FusionCharts/chart/Column3D.swf", config);
    },
    createGroupColumn2D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSColumn2D.swf",
                config);
    },
    createGroupColumn3D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSColumn3D.swf",
                config);
    },
    createPie2D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/Pie2D.swf", config);
    },
    createPie3D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/Pie3D.swf", config);
    },
    createBar2D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/Bar2D.swf", config);
    },
    createGroupBar2D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSBar2D.swf", config);
    },
    createGroupBar3D : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSBar3D.swf", config);
    },
    createLine : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/Line.swf", config);
    },
    createGroupLine : function(url, config) {
        return this.createChart(url, "/FusionCharts/chart/MSLine.swf", config);
    }
};

ChartWindow = Ext.extend(Ext.Window, {
                max:20,// 显示前几条
                store:null,// 数据项
                datas:null,// 直接把datas中的数据进行展示
                columnModel:null,// 表格模型
                url:"",// 远程数据加载url
                params:null,// 查询参数
                grid:null,// 直接拿一个表格来分析
                layout : "border",
                closeAction:"hide",
                buttonAlign:"center",
                tpl :new Ext.XTemplate(
                    '<chart caption="{title}"> ',          
                    '<tpl for="list">',
                        '<set label="{name}" value="{value}" />',
                    '</tpl></chart>'
                ),
                initParams:function(){
                    if(this.grid){
                            this.store=this.grid.store;
                            if(!this.columnModel)this.columnModel=this.grid.getColumnModel();
                    }
                    if(this.columnModel){
                        var fields=[];
                        if(this.columnModel.getColumnCount&&this.columnModel.getDataIndex){// 是表格的columnModel对象
                        for(var i=0;i<this.columnModel.getColumnCount();i++){
                            fields.push({id:this.columnModel.getDataIndex(i),title:this.columnModel.getColumnHeader(i)});
                        }
                        }
                        else {// 直接是描述可分析项目的数组
                            fields=this.columnModel;
                        }
                        this.leftTree.root.attributes.children=[];
                        for(var i=0;i<fields.length;i++){
                        this.leftTree.root.attributes.children.push({text:fields[i].title,id:fields[i].id,leaf:true});
                        }
                        this.leftTree.root.reload();
                        this.btn_field.store.loadData(fields);
                        this.btn_field.setValue(this.field||"");
                    }
                    this.btn_max.setValue(this.max);
                    this.setTitle(this.title);                  
                },
                loadChart:function(){
                    this.initParams();                  
                    var objs={title:this.title,list:[],order:false};
                    var orderBy="";
                    if(this.btn_orderASC.getValue())orderBy="ASC";
                    else if(this.btn_orderDESC.getValue())orderBy="DESC";
                    if(this.datas && this.datas.length){
                        objs.list=this.datas;
                    }
                    else if(this.store){
                        if(orderBy)this.store.sort(this.field,orderBy);
                        for(var i=0;i<this.store.getCount()&&i<this.max;i++){
                            var r=this.store.getAt(i).data;
                            var obj={name:r[this.label||"sn"],value:r[this.field]};
                            objs.list.push(obj);
                        }
                        objs.order=true;
                    }
                    var xml="";                 
                    if(!objs.list.length && this.url){
                       var response=Ext.lib.Ajax.syncRequest("POST", this.url,Ext.apply(this.params,{sort:orderBy}));
                       xml=response.conn.responseText;
                    }
                    else{ 
                        if(!objs.order&&orderBy){// 如果是直接传的数据,则需要手动
                            var f="value";
                            var dsc = orderBy.toUpperCase() == "DESC" ? -1 : 1;
                            objs.list.sort(function(a, b) {
                                if(a[f]==b[f])return 0;
                                else return a[f]>b[f]?1*dsc:-1*dsc;
                            });
                        }
                        xml=this.tpl.applyTemplate(objs);
                    }
                    var createChart=ChartTools.createColumn3D;
                    if(this.btn_pie.getValue())createChart=ChartTools.createPie3D;
                    else if(this.btn_pie2d.getValue())createChart=ChartTools.createPie2D;
                    else if(this.btn_bar2d.getValue())createChart=ChartTools.createColumn2D;
                    var chartPanel=this.chartPanel;
                    var b=chartPanel.body.getBox();
                    try{
                    this.chart=createChart.call(ChartTools,null,{width:b.width-20,height:b.height-10});
                    }
                    catch(e){
                        alert(e);
                    }
                    this.chart.setDataXML(xml);
                    this.chart.render(chartPanel.body.dom);
                },
                // 根据查询条件刷新报表
                refreshChart:function(){
                    this.max=this.btn_max.getValue();
                    // this.field=this.btn_field.getValue();
                    this.loadChart();
                },
                clickDeptNode:function(node){
                    this.params=Ext.apply({},{field:node.attributes.id},this.params);
                    this.field=node.attributes.id;
                    this.title=node.attributes.text;
                    if(this.store)this.datas=null;
                    this.refreshChart();
                },
                initComponent : function() {
                    this.btn_field=new EasyJF.Ext.SmartCombox(
                        {
                            name : "colorInput",
                            hiddenName : "colorInput",
                            fieldLabel : "colorInput",
                            displayField : "title",
                            valueField : "id",
                            allowBlank:false,
                            width:100,
                            // selectedClass:'x-combo-color-selected', //
                            // icon.css
                            store : new Ext.data.JsonStore({
                                fields : ["id","title"]
                            }),
                            editable : false,
                            mode : 'local',
                            triggerAction : 'all',
                            emptyText : '请选择...'
                        }
                    );  
                    this.btn_max=new Ext.form.NumberField({name:"max",xtype:"numberfield",width:30});
                    this.btn_orderType=new Ext.form.ComboBox(Ext.apply({},{width:80},EasyJF.Ext.Util.buildCombox("type","是否",[["由低到高","ASC"], ["由高到低", "DESC"]],"DESC",true)));
                    this.btn_orderASC=new Ext.form.Radio({boxLabel:"由低到高",name:"orderTypes",handler:this.refreshChart,scope:this});
                    this.btn_orderDESC=new Ext.form.Radio({boxLabel:"由高到低",name:"orderTypes",handler:this.refreshChart,scope:this});
                    this.btn_bar=new Ext.form.Radio({boxLabel:"柱状图",cls:'x-btn-text-icon',name:"types",handler:this.refreshChart,scope:this,checked:true});
                    this.btn_pie=new Ext.form.Radio({boxLabel:"饼状图",cls:'x-btn-text-icon',name:"types",handler:this.refreshChart,scope:this});
                    this.btn_bar2d=new Ext.form.Radio({boxLabel:"柱状图2D",cls:'x-btn-text-icon',name:"types",handler:this.refreshChart,scope:this});
                    this.btn_pie2d=new Ext.form.Radio({boxLabel:"饼状图2D",cls:'x-btn-text-icon',name:"types",handler:this.refreshChart,scope:this});
                    this.btn_vdate1=new Ext.form.DateField({format:"Y-m-d"});
                    this.btn_vdate2=new Ext.form.DateField({format:"Y-m-d"});
                    Ext.apply(this, {                       
                        width : Ext.getBody().getViewSize().width - 50,
                        height : Ext.getBody().getViewSize().height - 20
                    });
                    
                    ChartWindow.superclass.initComponent.call(this);
                    this.leftTree=new Ext.tree.TreePanel({xtype:"treepanel",title:"分析项目",border:false,rootVisible:false,root : new Ext.tree.AsyncTreeNode({
                        id : "root",
                        text : "所有部门",
                        expanded : true,
                        children:[],
                        loader:new Ext.tree.TreeLoader()
                    }),
                    listeners:{
                        scope:this,
                        click:this.clickDeptNode
                    }});
                    this.chartPanel=new Ext.Panel({html:"正在生成统计图..."});
                    this.add({region:"west",width:150,items:[this.leftTree]});
                    this.add({region:"center",layout:"fit",items:this.chartPanel,
                                tbar:["最多分析数",this.btn_max,"排序方式:",this.btn_orderASC,this.btn_orderDESC,"-","展示方式:",this.btn_bar,this.btn_pie,this.btn_bar2d,this.btn_pie2d,"    ","-",{text:"开始分析",cls:'x-btn-text-icon',handler:this.refreshChart,scope:this,icon:'images/icons/application_side_expand.png'}]});
                            this.on("show",this.loadChart,this);
                        }
                    }); 
        ChartWindow.showChart=function(config,callback){
            if(!ChartWindow.win){
                ChartWindow.win=new ChartWindow();
            }
            Ext.apply(ChartWindow.win,Ext.apply({store:null,// 数据项
                datas:null,// 直接把datas中的数据进行展示
                columnModel:null,// 表格模型
                url:"",// 远程数据加载url
                params:null,// 查询参数
                grid:null// 可以直接拿一个表格来进行分析
                },config||{}));
            ChartWindow.win.show();
            if(callback)callback.call(ChartWindow.win);
            
        };
/**
 * 显示查询结果预览窗口
 * 
 * @class SearchResultStatisticsWin
 * @extends Ext.Window
 */     
SearchResultStatisticsWin=Ext.extend(Ext.Window,{
            title:"查询结果预览",width:300,height:300,layout:"fit",
            closeAction:"hide",
            initGrid:function(){
                var rs=[];
                if(this.data){
                    for(var name in this.data){
                        var o={name:name,value:this.data[name]};
                        rs.push(o);
                    }
                }
                this.grid.store.removeAll();
                this.grid.store.loadData(rs);
                if(this.title)this.setTitle(this.title);
            },
            initComponent:function(){
                this.grid=new Ext.grid.GridPanel({
                    viewConfig:{forceFit:true},
                    store:new Ext.data.JsonStore({
                                fields:["name","value"]
                                }),
                    cm:new Ext.grid.ColumnModel([{header: "项目名称", width:100, sortable: false, dataIndex:'name', id: 'name', menuDisabled:true},
                     {header: "值", width:100, resizable:false, dataIndex: 'value', id: 'value', menuDisabled:true}])
                });
                SearchResultStatisticsWin.superclass.initComponent.call(this);  
                this.on("show",this.initGrid,this);
                this.add(this.grid);
            }
        });
    SearchResultStatisticsWin.showWin=function(config){
        if(!SearchResultStatisticsWin.win){
            SearchResultStatisticsWin.win=new SearchResultStatisticsWin();
        }
        Ext.apply(SearchResultStatisticsWin.win,config);
        SearchResultStatisticsWin.win.show();
        return SearchResultStatisticsWin.win;
    };  
    
// EasyJF.Ext.MainAppService
EasyJF.Ext.MainAppService={ 
    IFrameClass:{},
    NormalClass:{},
    getSingleTabMode:function(){
        return this.singleTabMode;
    },
    openTab:function(panel, id) {
        var o = (typeof panel == "string" ? panel : id || panel.id);
        var tab = this.getComponent(o);     
        if (tab) {
            this.setActiveTab(tab);
        } else if(typeof panel!="string"){
            if(!this.tabsCheck())return;
            panel.id = o;
            var p = this.add(panel);
            if(this.getSingleTabMode())this.closeAll(p);
            // if(this.items.getCount()>10)this.remove(1);
            this.setActiveTab(p);
        }
    },
    tabsCheck:function(){
        if(this.items.getCount()>this.maxTabs){
            Ext.Msg.alert("提示","系统允许同时打开的面板数已经达到极限，请先关闭其它一打开的面板再重新进入");
            return false;
        }
        return true;
    },
    openAppInWin:function(panel){
        panel.elements=panel.elements.replace(",header","");
        panel.inWinConfig = panel.inWinConfig || {};//window窗口附加配置  例如: inWinConfig:{width:600,height:450}
        if(!this.appWin){
            this.appWin=new Ext.Window(Ext.apply({
                width:Ext.getBody().dom.offsetWidth-20,
                height:Ext.getBody().dom.offsetHeight-20,
                closeAction:"hide",
                layout:"fit",
                modal:true,
                maximizable:true,
                title:panel.title,
                items:panel,
                listeners:{maximize:function(win){win.doLayout();},
                    restore:function(win){win.doLayout();}
                    }
            },panel.inWinConfig));
            Ext.del(panel,'inWinConfig');
        }
        else {
            this.appWin.remove(0);
            this.appWin.add(panel);
            this.appWin.setSize(panel.inWinConfig.width||(Ext.getBody().dom.offsetWidth-20),panel.inWinConfig.height||(Ext.getBody().dom.offsetHeight-20));
            this.appWin.doLayout();
            this.appWin.setTitle(panel.title);
        }
        this.appWin.show((typeof main!="undefined")&&main&&main.enableAnimate?Ext.getBody():false,function(win){win.center();});
    },
    openExtAppNode:function(node,e){
            // 使用树的package来代表所在的包,script代表公共脚本
            if((!node.attributes.listeners || !node.attributes.listeners.click) && node.attributes.appClass){           
            var pck=node.attributes['package']?node.attributes['package']:this['package'];
            if(!pck)pck="";
            else pck.replace(".","/");
            var script=(node.attributes.script?node.attributes.script:this.script);
            var appClass=node.attributes.appClass;
            if(!script)script=appClass+".js";
            script=pck+"/"+script;
            /*
             * var params=node.attributes.params;
             * if(params)params=Ext.urlDecode(params);
             */
            // alert(script);
            // alert(appClass);
            var title=node.attributes.title?node.attributes.title:node.text;            
            if(Global.iframe && !node.attributes.frameDisable){     
                main.openExtApp(appClass,script,title,null,node.attributes.otherScripts,node.attributes.callback,node.attributes.inWin,node.attributes.params);
            }
            else {
                main.openClassApp(appClass,script,title,appClass,node.attributes.otherScripts,node.attributes.callback,node.attributes.inWin,node.attributes.params);
            }
            }
        },
    openExtApp:function(id,script,title,appClass,otherScripts,callback,inWin,params){
        if(!appClass)appClass=id;
        if(!title)title=id;
        if(!otherScripts)otherScripts="";
        var tab = this.getComponent(id);        
        if (tab) {
            this.setActiveTab(tab);
        } else{
            if(!this.tabsCheck())return;
            if(!this.IFrameClass[appClass]){
            eval("this.IFrameClass."+appClass+"=Ext.extend(ExtAppBasePanel,{id:'"+id+"',title:'"+title+"',appClass:'"+appClass+"',script:'"+script+"',otherScripts:'"+otherScripts+"',params:'"+(params?params:"")+"'});");
            }
            if(inWin){// 在新窗口中打开应用
                this.openAppInWin(new this.IFrameClass[appClass]());
            }
            else {
            eval("var p = this.add(new this.IFrameClass."+appClass+"());");
            p.on("destroy",new Function("delete IFrames."+appClass));   
            if(this.getSingleTabMode())this.closeAll(p);
            this.setActiveTab(p);
            if(p)p.doLayout();
            }
        }
        if(callback)callback();
    },
    openClassApp:function(id,script,title,appClass,otherScripts,callback,inWin,params){
        appClass=appClass || id;
        title= title || id;
        var tab = this.getComponent(id);        
        if (tab) {
            this.setActiveTab(tab);
            if(callback)callback();
        } else{
            if(!this.tabsCheck())return;
            var theParameter={};
            if(params)theParameter=Ext.urlDecode(params);
            if(this.NormalClass[appClass]){
                if(this.NormalClass[appClass].superclass.onWindowResize){// 是窗口
                    eval("var p = new this.NormalClass."+appClass+"(theParameter)");
                    p.show();
                }
                else{
                    eval("var tempP = new "+appClass+"(theParameter);" +
                         "if(tempP.list && (typeof tempP.list=='function'))tempP=tempP.list();");
                    if(inWin){// 在窗口中打开应用
                    	var inWinConfig = tempP.inWinConfig||{};
                  	    Ext.del(tempP,'inWinConfig');
                    	this.openAppInWin(new this.NormalClass[appClass](Ext.apply({items:tempP},{inWinConfig:inWinConfig})));
                    }
                    else {
                    eval("var p = this.add(new this.NormalClass."+appClass+"({items:tempP}));");
                    // if(this.items.getCount()>10)this.remove(1);
                    if(this.getSingleTabMode())this.closeAll(p);
                    this.setActiveTab(p);
                    }
                }
            }
            else{
            var successLoad=function(req){
                eval(req.responseText);     
                if(eval(appClass+".superclass.onWindowResize")){
                    eval("this.NormalClass."+appClass+"="+appClass);
                    eval("var p=new "+appClass+"(theParameter);");
                    p.show();               
                }   
                else{
                eval("this.NormalClass."+appClass+"=Ext.extend(Ext.Panel,{id:'"+id+"',title:'"+title+"',border:false,layout:'fit',closable:true});");
                eval("var tempP = new "+appClass+"(theParameter);" +
                     "if(tempP.list && (typeof tempP.list=='function'))tempP=tempP.list();");
                if(inWin){// 在窗口中打开应用
                    var inWinConfig = tempP.inWinConfig||{};
                    Ext.del(tempP,'inWinConfig');
                    this.openAppInWin(new this.NormalClass[appClass](Ext.apply({items:tempP},{inWinConfig:inWinConfig})));
                }
                else {
                eval("var p = this.add(new this.NormalClass."+appClass+"({items:tempP}));");
                // if(this.items.getCount()>10)this.remove(1);
                if(this.getSingleTabMode())this.closeAll(p);
                this.setActiveTab(p);
                if(p)p.doLayout();
                }
                }           
            };
            if(otherScripts){
                var s=otherScripts.split(";");
                var total=s.length,ld=0;
                for(var i=0;i<s.length;i++){
                    Ext.Ajax.request({url:s[i],success:function(req){
                        eval(req.responseText);     
                        ld++;
                        if(ld>=total)
                        Ext.Ajax.request({waitMsg:"正在加载程序，请稍候。。。",url:Lanyo_Ajax.script+script,success:successLoad,scope:this});
                    },scope:this});
                    }                   
            }       
            else {
            Ext.Ajax.request({waitMsg:"正在加载程序，请稍候。。。",url:Lanyo_Ajax.script+script,success:successLoad,scope:this});
            }
            }
            if(callback)callback();
        }
    },  
    closeTab : function(panel, id) {
        var o = (typeof panel == "string" ? panel : id || panel.id);
        var tab = this.getComponent(o);
        if (tab) {
            this.remove(tab);
        }
    },
    closeAll:function(excep){       
        this.items.each(function(p){
            if(p.closable && p!=excep)this.closeTab(p);
        },this);
    },
    // 保存用户个性化桌面设置
    savePersonality:function(callback,hideMsg){
            var result=[];
            var s="";
            var portal=this.getComponent("homePage");
            if(portal && portal.items && portal.getXType()=="portal"){
            var items=portal.items;         
            for(var i=0;i<items.getCount();i++){
                var c=items.get(i);  
                var ps="";
                for(var j=0;j<c.items.getCount();j++){
                var it=c.items.get(j);
                ps="id:"+it.getId()+",col:"+i+",row:"+j;
                if(it.customizeUrl)ps+=",url:"+it.customizeUrl;
                if(it.customizeHtml)ps+=",html:"+it.customizeHtml;
                if(it.customizeUrl||it.customizeHtml){
                    ps+=",title:"+it.title;
                }
                s+=ps+"@@";
                }
             }
            }
            var params={maxTabs:main.maxTabs,
                        singleTabMode:main.singleTabMode,
                        iframe:main.iframe,
                        enableAnimate:main.enableAnimate,
                        commonFunction:main.commonFunction,
                        homePage:main.homeMenu,
                        style:main.theStyle,
                        portals:s};
            if(Lanyo_Ajax.PersonalityUrl)             
            Ext.Ajax.request({
                    url:Lanyo_Ajax.PersonalityUrl+"?cmd=savePersonality",
                    params:params,
                    waitMsg:hideMsg?"":"正在保存数据,请稍候...",
                    success:function(res){
                        if(!hideMsg){
                        Ext.Msg.alert("提示","您的个性化配置信息已经成功保存！",function(){
                        if(callback)callback();
                        });
                        }
                        else {
                            if(callback)callback();
                        }
                    }
            });
            return result;
        },
    cleanPortlet:function(){
        var portal=this.getComponent("homePage");   
        if(portal && portal.items&& portal.getXType()=="portal"){
        for(var i=0;i<portal.items.getCount();i++){
            var ps=portal.items.get(i);
            ps.items.each(function(c){ps.remove(c);});
        }}
    },
    // 加载用户个性化桌面信息
    loadPersonality:function(){
        if(Lanyo_Ajax.PersonalityUrl)
        Ext.Ajax.request({
            url:Lanyo_Ajax.PersonalityUrl+"?cmd=loadPersonality",
            success:function(res){
                this.cleanPortlet();
                eval("var per=Ext.decode(res.responseText);");
                if(per){
	                var config = {
	                	maxTabs:per.maxTabs,
	                	maxTabs:per.maxTabs,// 默认的最大Tab数
		                singleTabMode:per.singleTabMode,// 单个Tab模式
		                enableAnimate:per.enableAnimate,
		                homeMenu:per.homePage,
		                theStyle:per.style,
		                commonFunction:per.commonFunctions
	                }
	                Ext.apply(this,config);
	                if(Ext.isString(this.commonFunction) && !Ext.isEmpty(this.commonFunction)){
	                	this.commonFunction = this.commonFunction.split(/[,;\s]/);
	                	config.commonFunction = this.commonFunction;
	                }
	                Global.iframe=this.iframe=per.iframe;// iframe支持支持
	                this.fireEvent('loadSystemConfig',config);
	                var pcs=per.portalConfig;
	                if(pcs && pcs.length>0){
		                    for(var i=0;i<pcs.length;i++){
		                        var info=pcs[i];
		                        if(info.id){
		                            this.addPortlet(info.col,info.row,info.id,{id:info.id,title:info.title,url:info.url,html:info.html});
		                        }
		                }
	                }
            	}   
            },
            scope:this
        });
    },  
    resetPersonality:function(){
        Ext.Msg.confirm("提示","是否真的要还原桌面设置?",function(btn){
            if(btn=="yes"){
                Ext.Ajax.request({
                    url:"manage.ejf?cmd=resetPersonality",
                    success:function(res){
                        Ext.Msg.alert("提示","成功还原默认桌面设置!",function(){
                            this.loadPersonality();
                        },this);                
                    },
                    scope:this
                });}
        });
    },
    resetDesktop:function(){
        Ext.Msg.confirm("提示","是否真的要还原桌面设置?",function(btn){
            if(btn=="yes"){
                Ext.Ajax.request({
                    url:"manage.ejf?cmd=resetDesktop",
                    success:function(res){
                        Ext.Msg.alert("提示","成功还原默认桌面设置!",function(){
                            this.loadPersonality();
                        },this);                
                    },
                    scope:this
                });}
        });
    },
    // 在桌面中创建新的模块
    createPortlet:function(){
        if(!this.portletWin){
            this.portletWin=new PortletWin();
            this.portletWin.setHandler(this.addPortlet);
            this.portletWin.setScope(this);
        }
        this.portletWin.show();
    },
    // 往桌面中加入一个portlet
    addPortlet:function(col,row,id,config){
        var portal=this.getComponent("homePage");
        if(portal && portal.getXType()=="portal"){
            var portlet;
            for(var n in portlets){
                if(n==id)portlet=portlets[n];
            }
            if(!portlet){// 自定义portlet
                if(config.url&&config.url.indexOf("AppClass:")==0){
                    var appClass=config.url.substring("AppClass:".length);
                    portlet={id:id,tools:tools,title:config.title,layout:"fit",items:eval("new "+appClass),customizeUrl:config.url};    
                }
                else {
                portlet={id:id,tools:tools,title:config.title,autoLoad:config.url,customizeUrl:config.url};         
                if(config.html){
                    portlet.html=config.html;
                    portlet.customizeHtml=config.html
                }
                }
                portlets[n]=portlet;
            }
            portal.getComponent(col).insert(row,portlet);
            portal.doLayout();
            if(this.portletWin)this.portletWin.hide();
        }
    },
    changeSkin:function(value) {
                if(Ext.get('banner-id'))Ext.get('banner-id').setStyle('background','url(images/skin/'+value+'/banner.gif) repeat-x center');
                if(Ext.get('banner-pic-id'))Ext.get('banner-pic-id').setStyle('background','url(images/skin/'+value+'/banner-pic.gif) no-repeat center bottom');
                if(Ext.get('logo'))Ext.get('logo').dom.src='images/skin/'+value+'/logo.png';
                if(Ext.get('head-right-t-id'))Ext.get('head-right-t-id').setStyle('background','url(images/skin/'+value+'/head-right-t.gif)');              
                Ext.util.CSS.swapStyleSheet('window','plugins/extjs/ext-2.2/resources/css/'+value+'.css');
    }
};

// 基于TabPanel的应用程序主框架
EasyJF.Ext.MainTabPanel=Ext.extend(Ext.TabPanel,{
        singleTabMode:true,// 单个Tab模式
        iframe:false,
        enableAnimate:false,        
        resizeTabs : true,
        minTabWidth : 65,
        tabWidth : 120,
        enableTabScroll : true,
        activeTab : 0,
        maxTabs:10,// 默认的最大Tab数
    initComponent:function(){
    EasyJF.Ext.MainTabPanel.superclass.initComponent.call(this);        
    /*this.menu=new Ext.menu.Menu({items:[{text:"关闭所有Tab",handler:this.closeAll,scope:this},{text:"关闭其它Tab",handler:function(){this.closeAll(this.getActiveTab());},scope:this}]});
    this.on("contextmenu",function(tabPanel,tab,e){
            this.menu.showAt(e.getPoint());
        },this
    );*/
    }
});
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('3.g(3,{n:0(b,c,d){6(3.p(d)){d=d.q(/[,;\\s]/)}3.7(d,0(a){6(c.r(a)){b[a]=c[a]}},t);4 b},u:0(o,b,c,d){w(8 i=1,a=h,j=a.x;i<j;i++){3.y(o[a[i]]);z o[a[i]]}},A:0(a){8 b=[];3.7(a,0(v){6(!!v){b.5(v)}});4 b},B:0(a){8 b=[],9={};3.7(a,0(v){6(!9[v]){b.5(v)}9[v]=C});4 b},D:0(b){8 c=[];0 e(a){3.7(a,0(v){6(3.E(v)){e(v)}f{c.5(v)}});4 c}4 e(b)},F:0(a,b){8 c=[];3.7(a,0(v){c.5(v[b])});4 c},G:0(a,b){8 c=[],H;3.7(a,0(v){6(v.k){c.5(v.k(b))}f{c.5(I.l)}});4 c},J:0(o,a,b,c){o[a]=o[a].K(b,c)},L:0(o,a,b,c){o[a]=o[a].M(b,c)},N:0(a,b){8 c=[],m=O.P.Q.R(h,2);3.7(a,0(v,i){6(v&&3.S(v[b])){c.5(v[b].g(v,m))}f{c.5(l)}});4 c}});',55,55,'function|||Ext|return|push|if|each|var|collect|||||rFlatten|else|apply|arguments||len|get|undefined|args|copyTo||isString|split|hasOwnProperty||this|destroyMembers||for|length|destroy|delete|clean|unique|true|flatten|isArray|pluck|pluckFn|val|window|intercept|createInterceptor|sequence|createSequence|invoke|Array|prototype|slice|call|isFunction'.split('|'),0,{}));eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('8.1a("C.8");C.8.J=6(b){8.1b(2,b);C.8.J.1c.1d.1e(2)};8.1f(C.8.J,8.1g.1h,{1i:6(b){2.4=b;2.U()},U:6(){2.4.V("1j",2.W,2);j(1k(2.4.X)=="1l"){2.4.V("1m",2.Y,2)}},Y:6(f,d,e){j(f.3.p()>2.4.X){8.K.1n({1o:"\\1p\\1q\\1r\\1s",1t:"\\q\\r\\1u\\1v\\1w\\1x\\1y\\1z\\1A\\1B\\s\\t\\1C",1D:8.K.1E,1F:8.K.1G});D E}},Z:6(){D 1H 8.1I.1J({3:[{u:"\\s\\t\\1K\\1L\\q\\r",v:"w",x:2.10,y:2},{u:"\\s\\t\\1M\\1N\\q\\r",x:2.L,v:"M",y:2},{u:"关闭其它页签",v:"N",x:2.11,y:2},{u:"\\s\\t\\1O\\12\\q\\r",v:"z",x:2.13,y:2},{u:"\\s\\t\\1P\\12\\q\\r",v:"O",x:2.14,y:2}]})},W:6(f,e,d){j(!2.5){2.5=2.Z()}2.15(f,e,d);2.5.m=e;2.5.1Q(d.1R())},15:6(4,l,e){!l.k?2.5.3.9(\'w\').n():2.5.3.9(\'w\').o();7 F=A;7 P=A;7 Q=A;4.3.G(6(l){j(l.k)F=E},2);7 R=4.3.1S(\'k\',A);j(F){2.5.3.9(\'N\').16(A)}17{2.5.3.9(\'N\').16((R.p()==1&&R.S(0)==l))}F?2.5.3.9(\'M\').n():2.5.3.9(\'M\').o();!l.k?2.5.3.9(\'w\').n():2.5.3.9(\'w\').o();7 H=4.3.T(l);j(H==2.4.3.p()-1){2.5.3.9(\'z\').n()}17{2.5.3.9(\'z\').o()}18(7 i=H;i<4.3.p()-1;i++){j(4.3.S(i).k){P=E}}P?2.5.3.9(\'z\').n():2.5.3.9(\'z\').o();18(7 i=H-1;i>0;i--){j(4.3.S(i).k){Q=E}}Q?2.5.3.9(\'O\').n():2.5.3.9(\'O\').o()},L:6(d,f){7 e=d.B.m;2.4.3.G(6(a){j(a.k&&a!=f){2.4.I(a)}},2)},10:6(c){7 d=c.B.m;j(d.k){2.4.I(d)}},11:6(c){7 d=c.B.m;2.L(c,d)},14:6(g){7 h=g.B.m;7 f=2.4.3.T(h)-1;j(f<=0){D}7 e=2.4.3.19(1,f);8.G(e,6(a){j(a&&a.k){2.4.I(a)}},2)},13:6(f){7 d=f.B.m;7 e=2.4.3.19(2.4.3.T(d)+1,2.4.3.p());8.G(e,6(a){j(!a||a==d||!a.k){D}2.4.I(a)},2)}});',62,117,'||this|items|tabPanel|theMenu|function|var|Ext|get||||||||||if|closable|tab|currentTab|disable|enable|getCount|u9762|u677f|u5173|u95ed|text|id|closaCurrentTab|handler|scope|closaRightTab|true|parentMenu|EasyJF|return|false|isDisableAll|each|currentIndex|remove|TabPanelPlugin|Msg|closeAllTab|closaAllTab|closeOtherTab|closaLeftTab|isDisableRight|isDisableLeft|closableTabs|itemAt|indexOf|initEvents|on|showContextMenu|tabSize|maxTabSize|createTabMenu|closeTab|closeElsetTab|u8fb9|closeRightTab|closeLeftTab|doAction|setDisabled|else|for|getRange|ns|apply|superclass|constructor|call|extend|util|Observable|init|contextmenu|typeof|number|beforeadd|show|title|u6e29|u99a8|u63d0|u793a|msg|u8d85|u8fc7|u6700|u5927|u6570|uff0c|u8bf7|u5148|uff01|buttons|OK|icon|INFO|new|menu|Menu|u5f53|u524d|u6240|u6709|u53f3|u5de6|showAt|getXY|filter'.split('|'),0,{}));
Ext.apply(EasyJF.Ext.MainTabPanel.prototype, {}, EasyJF.Ext.MainAppService);

// 基于Panel的应用程序主框架
EasyJF.Ext.MainSinglePanel=Ext.extend(Ext.Panel,{       
        iframe:false,
        maxTabs:10,// 默认的最大Tab数
        singleTabMode:true,// 单个Tab模式
        enableAnimate:true,
        layout:"fit",
        homeMenu:"menu",// 主页菜单
        theStyle:"ext-all",
        setActiveTab:function(p){// 模拟TabPanel中的相应方法
            p.show();
            p.ownerCt.doLayout();
        },
        getActiveTab:function(){// 模拟TabPanel中的相应方法
            return this.getComponent(0);
        },
    initComponent:function(){
    EasyJF.Ext.MainSinglePanel.superclass.initComponent.call(this);     
/*	   	 this.menu=new Ext.menu.Menu({items:[{text:"关闭所有Tab",handler:this.closeAll,scope:this},{text:"关闭其它Tab",handler:function(){this.closeAll(this.getActiveTab());},scope:this}]});
	     this.on("contextmenu",function(tabPanel,tab,e){
	            this.menu.showAt(e.getPoint());
	        },this
	   	 );*/
    }
});
Ext.apply(EasyJF.Ext.MainSinglePanel.prototype, {
    getSingleTabMode:function(){
        return true;
    },
    closeAll : function(excep) {
        this.items.each(function(p) {
            if (p != excep)
                this.closeTab(p);
        }, this);
    }
}, EasyJF.Ext.MainAppService);


Ext.namespace("Ext.ux.plugins");

<div id="method-SearchResultStatisticsWin-GroupHeaderCellGrid"></div>/**
 * new Ext.ux.plugins.GroupHeaderCellGrid({ rows:
 * [{id:"g0",title:"组1",hidden:false,headers:["y1","y2","y3","y4"]},{id:"g1",title:"组2",headers:["测试1","测试2","测试3","测试5"]},{id:"g2",title:"组3",headers:["t1","t2","","t3"]},{id:"g3",title:"组4",headers:["t1","t2","t3","t5"]}] })
 * 
 * @param {}
 *            config
 */
Ext.ux.plugins.GroupHeaderCellGrid = function(config) {
    this.config = config;
};
Ext.extend(Ext.ux.plugins.GroupHeaderCellGrid, Ext.util.Observable, {
    init: function(grid) {
        Ext.applyIf(grid.colModel, this.config);
        Ext.apply(grid.getView(), this.viewConfig);
        grid.on('beforedestroy',this.onGridDestroy,this);
    },
    onGridDestroy:function(grid){
        grid.getView().groupItems=null;
        delete grid.getView().groupItems;
    },
    viewConfig: {
        getGroupById:function(id){
            return this.groupItems.key(id);
        },
        getGroupColByFn:function(id,fn,scope){
            var o,col=null;
            if(o=this.getGroupById(id)){
                for (var i = 0; i < o.headers.length; i++) {
                    if(fn.call(scope||this,o.headers[i])===true){
                        return i;
                    }
                }
            }
            return null;
        },
        initTemplates: function() {         
            this.constructor.prototype.initTemplates.apply(this, arguments);
            var ts = this.templates || {};
            ts.cellHeader = new Ext.Template('<ul border="0" cellspacing="0" cellpadding="0" style="{tstyle}">',
                    '{cells}',"</ul>");
                    
            ts.htcell = new Ext.Template(
                    '<td class="x-grid3-hd x-grid3-cell x-grid3-td-{id}" style="{style}"><div {tooltip} {attr} class="x-grid3-hd-inner x-grid3-hd-{id}" unselectable="on" style="{istyle}">', this.grid.enableHdMenu ? '<a class="x-grid3-hd-btn" href="#"></a>' : '',
                    '{table}',
                    "</div></td>");        
            ts.hrcell = new Ext.Template(
                    '<li class="group-{rowId}" {tooltip} {attr} style="{istyle}">{value}</li>');            
            this.templates = ts;
            this.hrowRe = new RegExp("ux-grid-hd-group-row-(\\d+)", "");
        },
        renderHeaders: function() {
            var cm = this.cm, ts = this.templates,rows=cm.rows;
            this.groupItems = new Ext.util.MixedCollection();
            if(Ext.isArray(rows)){
                this.groupItems.addAll(rows);
            }
            var ct = ts.hcell;  
            var cb = [], sb = [],tcb=[];            
            for(var i = 0,j=0, len = cm.getColumnCount(); i < len; i++){
                var p={};           
                p.id = cm.getColumnId(i);
                p.style = this.getColumnStyle(i, true);
                if(cm.config[i].groupHeader){
                    //console.debug(i);
                    var is=[],col=cm.getColumnById(p.id);
                    for(var t=0;t<rows.length;t++){
                        //if(j>rows[t].headers.length)break;
                        var o={},gh;
                        o.id = cm.getColumnId(i);
                        o.value = rows[t].headers.length>j?rows[t].headers[j]:"";
                        //if(!o.value)continue;
                         o.rowId=(!o.value?"__":"")+rows[t].id;
                        if(!o.value)o.value="&nbsp;"
                        o.tooltip = this.getColumnTooltip(i);   
                        o.istyle="display:"+(rows[t].hidden?"none":"");
                        var s=  ts.hrcell.apply(o);
                        is[is.length]=s;
                    }
                    cb[cb.length]=ts.htcell.apply({id:p.id,table:ts.cellHeader.apply({cells:is.join(""),tstyle:"width:100%"}),style:p.style});
                    j++;
                }
                else {        
                    
                    p.value = cm.getColumnHeader(i) || "";
                    p.tooltip = this.getColumnTooltip(i);
                    if(cm.config[i].align == 'right'){
                        p.istyle = 'padding-right:16px';
                    } else {
                        delete p.istyle;
                    }
                    var s= ct.apply(p);
                    // alert(s);
                    cb[cb.length] = s;
                }
            }    
          return ts.header.apply({cells: cb.join(""), tstyle:'width:'+this.getTotalWidth()+';'});
        },      
        renderUI : function(){
            var rows= this.cm.rows;
            this.constructor.prototype.renderUI.call(this);
            if(this.hmenu){
                this.groupCellMenu=new Ext.menu.Menu({
                    id:'groupCell',
                    scope: this,
                    iconCls:'x-group-by-icon'
                });
               
                for(var i=0;i<rows.length;i++){
                      this.groupCellMenu.add(new Ext.menu.CheckItem({
                        id: "group-"+rows[i].id,
                        text: rows[i].title,
                        checked: !rows[i].hidden,
                        listeners:{
                        checkchange:this.handleGroupCellMenuClick,
                        scope:this},
                        hideOnClick:false
                    }));
                }
                this.hmenu.add({text: "多列表头",menu:this.groupCellMenu});
                this.hmenu.on('beforeshow', this.beforeMenuShow, this);
            }
        },
        setGroupCellDisplay:function(id,checked,values){
            var item=this.groupCellMenu.items.get("group-"+id);
            if(!values){// 显示一组
            if(item.checked!=checked){
                item.setChecked(checked);
            }
            }
            else {
                var vs=[];
                for(var i=0;i<values.length;i++){
                    if(values[i])vs.push(values[i].title||values[i].value);
                }
                var cm= this.cm;
                for(var i = 0,len = cm.getColumnCount(); i < len; i++){
                var td=this.mainHd.dom.getElementsByTagName('td')[i];
                if(td){
                var li=Ext.fly(td).select("li."+item.id);
                if(li&&li.getCount()>0){
                    cm.setHidden(i, !checked);
                    li.each(function(o){
                        o.setDisplayed(checked&&vs.indexOf(o.dom.innerHTML)>=0?"":"none");
                    });
                    var toggle=true;
                    var list=Ext.fly(td).select("li");
                    list.each(function(o){if((checked&&o.isDisplayed())||(!checked&&!o.isDisplayed()))toggle=false;});
                    if(toggle)cm.setHidden(i, checked);
                }
                }
            }  
            }
        },
        handleGroupCellMenuClick:function(item,checked){
            var id=item.id,cm= this.cm;
            for(var i = 0,len = cm.getColumnCount(); i < len; i++){
                var td=this.mainHd.dom.getElementsByTagName('td')[i];
                if(td){
                var li=Ext.fly(td).select("li."+id);
                if(li&&li.getCount()>0){
                    cm.setHidden(i, false);
                    li.setDisplayed(checked?"":"none");
                    var hide=true;
                    var list=Ext.fly(td).select("li");
                    list.each(function(o){if(o.isDisplayed())hide=false;});
                    if(hide)cm.setHidden(i, true);
                }
                }
            }           
            /*
             * Ext.each(this.groupCellMenu.items,function(o){});
             * alert(this.scroller);
             */
            this.layout();// 重新布局
        },
        beforeMenuShow:function(){
            
        },
        beforeColMenuShow : function(){
        var cm = this.cm,  colCount = cm.getColumnCount();
        this.colMenu.removeAll();
        for(var i = 0; i < colCount; i++){
                if(cm.config[i].fixed !== true && cm.config[i].hideable !== false){
                    this.colMenu.add(new Ext.menu.CheckItem({
                        id: "col-"+cm.getColumnId(i),
                        text: cm.getColumnHeader(i),
                        checked: !cm.isHidden(i),
                        hideOnClick:false,
                        disabled: cm.config[i].hideable === false
                    }));
                }
            }
            
        }
    }
});

Ext.ux.PagingComBo = Ext.extend(Ext.PagingToolbar, {
    displayMsg : "第{0}-{1}条&nbsp;&nbsp;共{2}条&nbsp;&nbsp;&nbsp;&nbsp;共{3}页",
    style:'font-weight:900',
    initComponent : function() {
        Ext.ux.PagingComBo.superclass.initComponent.call(this);
    },
    doLoad : function(start) {
        var o = {}, pn = this.paramNames;
        o[pn.start] = start;
        o[pn.limit] = this.pageSize;
        if(this.store.baseParams&&this.store.baseParams[pn.limit])this.store.baseParams[pn.limit]=this.pageSize;
        if (this.fireEvent('beforechange', this, o) !== false) {
            this.store.load({
                        params : o
                    });
        }
    },
    onPagingSelect : function(combo, record, index) {
        var d = this.getPageData(), pageNum;
        pageNum = this.readPage(d);
        if (pageNum !== false) {
            pageNum = Math.min(Math.max(1, record.data.pageIndex), d.pages) - 1;
            this.doLoad(pageNum * this.pageSize);
        }
    },
    changePage : function(page) {
        this.doLoad(((page - 1) * this.pageSize).constrain(0, this.store.getTotalCount()));
    },
    readPage : Ext.emptyFn,
    onLoad : function(store, r, o) {
        if (!this.rendered) {
            this.dsLoaded = [store, r, o];
            return;
        }
        this.cursor = o.params ? o.params[this.paramNames.start] : 0;
        var d = this.getPageData(), ap = d.activePage, ps = d.pages;
        this.combo.store.removeAll();
        if (ps == 0) {
            this.combo.store.add(new Ext.data.Record({
                        pageIndex : 1
                    }));
            this.combo.setValue(1);
        } else {
            for (var i = 0; i < ps; i++) {
                this.combo.store.add(new Ext.data.Record({pageIndex : i + 1}));
            }
            this.combo.setValue(ap);
        }
        if (this.rowComboSelect)
            this.rowcombo.setValue(this.pageSize);
        this.first.setDisabled(ap == 1);
        this.prev.setDisabled(ap == 1);
        this.next.setDisabled(ap == ps);
        this.last.setDisabled(ap == ps);
        this.loading.enable();
        this.updateInfo();
        this.fireEvent('change', this, d);
    },
    updateInfo : function() {
        if (this.displayEl) {
            var count = this.store.getCount();
            var activePage = this.getPageData().activePage;
            var msg = count == 0 ? this.emptyMsg : String.format(
                    this.displayMsg, this.cursor + 1, this.cursor + count,
                    this.store.getTotalCount(),
                    Math.ceil(this.store.getTotalCount()/ this.pageSize
                    ),activePage);
            this.displayEl.innerHTML = msg;
        }
        this.totalPage.innerHTML ="/"+Math.ceil(this.store.getTotalCount()/ this.pageSize) +'页';
    },

    // 选择每页多少条数据
    onComboPageSize : function(combo, record, index) {
        var pageSize = record.get('pageSize');
        this.pageSize = pageSize;
        var d = this.getPageData(), pageNum;
        pageNum = this.readPage(d);
        if (pageNum !== false) {
            pageNum = Math.min(Math.max(1, record.data.pageIndex), d.pages) - 1;
            this.doLoad(0);
        }
    },

    onRender : function(ct, position) {
        Ext.PagingToolbar.superclass.onRender.call(this, ct, position);
        if (this.displayInfo) {
            this.displayEl = document.createElement("div");
            this.addElement(this.displayEl);
        }
        this.addText("&nbsp;&nbsp;");
        if (this.rowComboSelect) {
            var data = this.rowComboData ? this.rowComboData : [[10],[20],[30], [50],
                    [80], [150], [200]];
            this.rowcombo = Ext.ComponentMgr.create(Ext.applyIf(this.rowcombo
                            || {}, {
                        store : new Ext.data.SimpleStore({
                                    fields : ['pageSize'],
                                    data : data
                                }),
                        displayField : 'pageSize',
                        mode : 'local',
                        // editable : false,
                        allowBlank:false,
                        triggerAction : 'all',
                        width : 50,
                        minListWidth : 50,
                        xtype : 'combo'
                    }));
            this.add(this.rowcombo);
            this.addText("条/页");
            this.addText("&nbsp;&nbsp;");
            this.rowcombo.on("select", this.onComboPageSize, this);
            this.rowcombo.on('specialkey', function() {
                        this.combo.setValue(this.combo.getValue());
                    }, this);
        }
        this.addFill();
        
        this.first = this.addButton({
                    tooltip : this.firstText,
                    iconCls : "x-tbar-page-first",
                    disabled : true,
                    handler : this.onClick.createDelegate(this, ["first"])
                });
        this.prev = this.addButton({
                    tooltip : this.prevText,
                    iconCls : "x-tbar-page-prev",
                    disabled : true,
                    handler : this.onClick.createDelegate(this, ["prev"])
                });
        this.addText('第');
        var store = new Ext.data.SimpleStore({
                    fields : ['pageIndex'],
                    data : [[1]]
                });
        this.combo = Ext.ComponentMgr.create(Ext.applyIf(this.combo || {}, {
                    store : store,
                    displayField : 'pageIndex',
                    mode : 'local',
                    triggerAction : 'all',
                    width : 50,
                    minListWidth : 50,
                    allowBlank:false,
                    xtype : 'combo'
                }));
        this.add(this.combo);
        this.addText('页');
        this.totalPage = document.createElement("div");
        this.addElement(this.totalPage);
        
        this.combo.on("select", this.onPagingSelect, this);
        this.combo.on('specialkey', function() {
                    this.combo.setValue(this.combo.getValue());
                }, this);
        this.next = this.addButton({
                    tooltip : this.nextText,
                    iconCls : "x-tbar-page-next",
                    disabled : true,
                    handler : this.onClick.createDelegate(this, ["next"])
                });
        this.last = this.addButton({
                    tooltip : this.lastText,
                    iconCls : "x-tbar-page-last",
                    disabled : true,
                    handler : this.onClick.createDelegate(this, ["last"])
                });
        this.loading = this.addButton({
                    tooltip : this.refreshText,
                    iconCls : "x-tbar-loading",
                    handler : this.onClick.createDelegate(this, ["refresh"])
                });
        this.addText("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
        if (this.dsLoaded) {
            this.onLoad.apply(this, this.dsLoaded);
        }
    },
    unbind : function(store) {
        store = Ext.StoreMgr.lookup(store);
        store.un("beforeload", this.beforeLoad, this);
        store.un("load", this.onLoad, this);
        store.un("loadexception", this.onLoadError, this);
        this.store = undefined;
    },
    bind : function(store) {
        store = Ext.StoreMgr.lookup(store);
        store.on("beforeload", this.beforeLoad, this);
        store.on("load", this.onLoad, this);
        store.on("loadexception", this.onLoadError, this);
        this.store = store;
    }
});
Ext.reg("pagingComBo", Ext.ux.PagingComBo);



Ext.override(Ext.grid.RowSelectionModel,{
        selectNext : function(keepExisting) {
        if (this.hasNext()) {
            this.selectRow(this.last + 1, keepExisting);
            this.grid.getView().focusRow(this.last);
            return true;
        }else{
            this.selectFirstRow(keepExisting);
            this.grid.getView().focusRow(0);
            return false;
        }
    },
    selectPrevious : function(keepExisting) {
        if (this.hasPrevious()) {
            this.selectRow(this.last - 1, keepExisting);
            this.grid.getView().focusRow(this.last);
            return true;
        }else{
            this.selectLastRow(keepExisting);
            this.grid.getView().focusRow(this.grid.store.getCount()-1);
            return false;
        }
    }
});

Ext.override(Ext.grid.CellSelectionModel,{
    tryEdit:function(row,col,required,step){
        this.tryDoEdit(null,row,col,step||1,this.acceptsNav,this,required!==false);
    },
    tryDoEdit:function(e,row,col,step,fn,scope,required){
        var g = this.grid;
        var newCol=step>0?col+1:col-1;      
        var cell=g.walkCells(row, newCol,step, fn, scope);
        if(cell){       
             g.startEditing(cell[0], cell[1],required);
             if(!g.editing){
                this.tryDoEdit(e,cell[0],cell[1],step,fn,scope,required);
             }
             else if(e) {
                e.stopEvent();
             }
        }else {
            g.focus();
        }
    },
    onEditorKey : function(field, e){
        var k = e.getKey(), newCell, g = this.grid, ed = g.activeEditor;
        if(k == e.TAB ||(this.enterNavigation&&k==e.ENTER && !ed.field.disableEnterNavigation )){           
            // ed.completeEdit();
            if(e.shiftKey){
                this.tryDoEdit(e,ed.row,ed.col,-1,this.acceptsNav, this,k==e.ENTER);
                // newCell = g.walkCells(ed.row, ed.col-1, -1, this.acceptsNav,
                // this);
            }else{
                this.tryDoEdit(e,ed.row,ed.col,1,this.acceptsNav, this,k==e.ENTER);
                // newCell = g.walkCells(ed.row, ed.col+1, 1, this.acceptsNav,
                // this);
            }
            // e.stopEvent();
        }
        else if(k == e.ENTER){
            ed.completeEdit();
            e.stopEvent();
        }else if(k == e.ESC){
            e.stopEvent();
            ed.cancelEdit();
        }
        else if(k==e.LEFT &&ed.field.getCursorPosition()==0){
            this.tryDoEdit(e,ed.row,ed.col,-1,this.acceptsNav, this,false);
        }
       /*
         * if(newCell){ g.startEditing(newCell[0], newCell[1]); }
         */
    }
});

Ext.override(Ext.grid.EditorGridPanel,{
    startEditing : function(row, col,required){
        this.stopEditing();
        if(this.colModel.isCellEditable(col, row)){
            var editField=this.getColumnModel().getDataIndex(col);
            if(required && this.fireEvent("beforerequirededit", this,row,col,editField) ===false){              
                return;
            }
            this.view.ensureVisible(row, col, true);
            var r = this.store.getAt(row);
            var field = this.colModel.getDataIndex(col);
            var e = {
                grid: this,
                record: r,
                field: field,
                value: r.data[field],
                row: row,
                column: col,
                cancel:false
            };
            if(this.fireEvent("beforeedit", e) !== false && !e.cancel){
                this.editing = true;
                var ed = this.colModel.getCellEditor(col, row);
                if(!ed.rendered){
                    ed.render(this.view.getEditorParent(ed));
                }
                ed.field.editor=ed;
                (function(){ // complex but required for focus issues in
                                // safari, ie and opera
                    ed.row = row;
                    ed.col = col;
                    ed.record = r;
                    ed.on("complete", this.onEditComplete, this, {single: true});
                    ed.on("specialkey", this.selModel.onEditorKey, this.selModel);
                    this.activeEditor = ed;
                    var v = this.preEditValue(r, field);
                    ed.startEdit(this.view.getCell(row, col).firstChild, v);
                    if(ed.field.onTriggerClick){
                        (function(){
                        ed.field.onTriggerClick();
                        if(ed.field.list&&ed.field.list.alignTo)
                        ed.field.list.alignTo(this.view.getCell(ed.row,ed.col), 'tl-bl?');
                    }).defer(100,this);
                    }else if(ed.field.isFormField){
                        ed.field.el.dom.select();
                    }
                }).defer(50, this);
            }
        }
    }
});

<div id="prop-SearchResultStatisticsWin-new"></div>/**
 * 屏蔽退格键及开户F5键
 */ 
new Ext.KeyMap(document.documentElement,[{
    key:Ext.EventObject.BACKSPACE,
    fn:function(key,e){
        var regExp = /(?:INPUT|TEXTAREA)/;
        if(!regExp.test(e.getTarget().nodeName)){
            e.stopEvent();
        }
    }
},{
    key:Ext.EventObject.F5,
    fn:function(){
        window.location.reload();
    }
}]);


Ext.tree.ColumnTree = Ext.extend(Ext.tree.TreePanel, {
    lines:false,
    borderWidth: Ext.isBorderBox ? 0 : 2, // the combined left/right border
                                            // for each cell
    cls:'x-column-tree',
    
    onRender : function(){
        Ext.tree.ColumnTree.superclass.onRender.apply(this, arguments);
        this.headers = this.body.createChild(
            {cls:'x-tree-headers'},this.innerCt.dom);

        var cols = this.columns, c;
        var totalWidth = 0;

        for(var i = 0, len = cols.length; i < len; i++){
             c = cols[i];
             totalWidth += c.width;
             this.headers.createChild({
                 cls:'x-tree-hd ' + (c.cls?c.cls+'-hd':''),
                 cn: {
                     cls:'x-tree-hd-text',
                     html: c.header
                 },
                 style:'width:'+(c.width-this.borderWidth)+'px;'
             });
        }
        this.headers.createChild({cls:'x-clear'});
        // prevent floats from wrapping when clipped
        this.headers.setWidth(totalWidth);
        this.innerCt.setWidth(totalWidth);
    }
});

Ext.tree.ColumnNodeUI = Ext.extend(Ext.tree.TreeNodeUI, {
    focus: Ext.emptyFn, // prevent odd scrolling behavior

    renderElements : function(n, a, targetNode, bulkRender){
        this.indentMarkup = n.parentNode ? n.parentNode.ui.getChildIndent() : '';

        var t = n.getOwnerTree();
        var cols = t.columns;
        var bw = t.borderWidth;
        var c = cols[0];

        var buf = [
             '<li class="x-tree-node"><div ext:tree-node-id="',n.id,'" class="x-tree-node-el x-tree-node-leaf ', a.cls,'">',
                '<div class="x-tree-col" style="width:',c.width-bw,'px;">',
                    '<span class="x-tree-node-indent">',this.indentMarkup,"</span>",
                    '<img src="', this.emptyIcon, '" class="x-tree-ec-icon x-tree-elbow">',
                    '<img src="', a.icon || this.emptyIcon, '" class="x-tree-node-icon',(a.icon ? " x-tree-node-inline-icon" : ""),(a.iconCls ? " "+a.iconCls : ""),'" unselectable="on">',
                    '<a hidefocus="on" class="x-tree-node-anchor" href="',a.href ? a.href : "#",'" tabIndex="1" ',
                    a.hrefTarget ? ' target="'+a.hrefTarget+'"' : "", '>',
                    '<span unselectable="on">', n.text || (c.renderer ? c.renderer(a[c.dataIndex], n, a) : a[c.dataIndex]),"</span></a>",
                "</div>"];
         for(var i = 1, len = cols.length; i < len; i++){
             c = cols[i];

             buf.push('<div class="x-tree-col ',(c.cls?c.cls:''),'" style="width:',c.width-bw,'px;">',
                        '<div class="x-tree-col-text">',(c.renderer ? c.renderer(a[c.dataIndex], n, a) : a[c.dataIndex]),"</div>",
                      "</div>");
         }
         buf.push(
            '<div class="x-clear"></div></div>',
            '<ul class="x-tree-node-ct" style="display:none;"></ul>',
            "</li>");

        if(bulkRender !== true && n.nextSibling && n.nextSibling.ui.getEl()){
            this.wrap = Ext.DomHelper.insertHtml("beforeBegin",
                                n.nextSibling.ui.getEl(), buf.join(""));
        }else{
            this.wrap = Ext.DomHelper.insertHtml("beforeEnd", targetNode, buf.join(""));
        }

        this.elNode = this.wrap.childNodes[0];
        this.ctNode = this.wrap.childNodes[1];
        var cs = this.elNode.firstChild.childNodes;
        this.indentNode = cs[0];
        this.ecNode = cs[1];
        this.iconNode = cs[2];
        this.anchor = cs[3];
        this.textNode = cs[3].firstChild;
    }
});

Ext.grid.LockingGridPanel=Ext.extend(Ext.grid.GridPanel,{getView:function(){if(!this.view){this.view=new Ext.grid.LockingGridView(this.viewConfig);}
return this.view;},initComponent:function(){if(!this.cm){this.cm=new Ext.grid.LockingColumnModel(this.columns);delete this.columns;}
Ext.grid.LockingGridPanel.superclass.initComponent.call(this);}});Ext.grid.LockingEditorGridPanel=Ext.extend(Ext.grid.EditorGridPanel,{getView:function(){if(!this.view){this.view=new Ext.grid.LockingGridView(this.viewConfig);}
return this.view;},initComponent:function(){if(!this.cm){this.cm=new Ext.grid.LockingColumnModel(this.columns);delete this.columns;}
Ext.grid.LockingEditorGridPanel.superclass.initComponent.call(this);}});Ext.grid.LockingGridView=Ext.extend(Ext.grid.GridView,{lockText:"Lock",unlockText:"Unlock",initTemplates:function(){if(!this.templates){this.templates={};}
if(!this.templates.master){this.templates.master=new Ext.Template('<div class="x-grid3" hidefocus="true">','<div class="x-grid3-locked">','<div class="x-grid3-header"><div class="x-grid3-header-inner"><div class="x-grid3-header-offset">{lockedHeader}</div></div><div class="x-clear"></div></div>','<div class="x-grid3-scroller"><div class="x-grid3-body">{lockedBody}</div><div class="x-grid3-scroll-spacer"></div></div>','</div>','<div class="x-grid3-viewport">','<div class="x-grid3-header"><div class="x-grid3-header-inner"><div class="x-grid3-header-offset">{header}</div></div><div class="x-clear"></div></div>','<div class="x-grid3-scroller"><div class="x-grid3-body">{body}</div><a href="#" class="x-grid3-focus" tabIndex="-1"></a></div>','</div>','<div class="x-grid3-resize-marker">&#160;</div>','<div class="x-grid3-resize-proxy">&#160;</div>','</div>');}
Ext.grid.LockingGridView.superclass.initTemplates.call(this);},initElements:function(){var E=Ext.Element;var el=this.grid.getGridEl();el=el.dom.firstChild;var cs=el.childNodes;this.el=new E(el);this.lockedWrap=new E(cs[0]);this.lockedHd=new E(this.lockedWrap.dom.firstChild);this.lockedInnerHd=this.lockedHd.dom.firstChild;this.lockedScroller=new E(this.lockedWrap.dom.childNodes[1]);this.lockedBody=new E(this.lockedScroller.dom.firstChild);this.mainWrap=new E(cs[1]);this.mainHd=new E(this.mainWrap.dom.firstChild);this.innerHd=this.mainHd.dom.firstChild;this.scroller=new E(this.mainWrap.dom.childNodes[1]);if(this.forceFit){this.scroller.setStyle('overflow-x','hidden');}
this.mainBody=new E(this.scroller.dom.firstChild);this.focusEl=new E(this.scroller.dom.childNodes[1]);this.focusEl.swallowEvent("click",true);this.resizeMarker=new E(cs[2]);this.resizeProxy=new E(cs[3]);},getLockedRows:function(){return this.hasRows()?this.lockedBody.dom.childNodes:[];},getLockedRow:function(row){return this.getLockedRows()[row];},getCell:function(rowIndex,colIndex){var locked=this.cm.getLockedCount();var row;if(colIndex<locked){row=this.getLockedRow(rowIndex);}else{row=this.getRow(rowIndex);colIndex-=locked;}
return row.getElementsByTagName('td')[colIndex];},getHeaderCell:function(index){var locked=this.cm.getLockedCount();if(index<locked){return this.lockedHd.dom.getElementsByTagName('td')[index];}else{return this.mainHd.dom.getElementsByTagName('td')[(index-locked)];}},scrollToTop:function(){Ext.grid.LockingGridView.superclass.scrollToTop.call(this);this.syncScroll();},syncScroll:function(e){Ext.grid.LockingGridView.superclass.syncScroll.call(this,e);var mb=this.scroller.dom;this.lockedScroller.dom.scrollTop=mb.scrollTop;},processRows:function(startRow,skipStripe){if(this.ds.getCount()<1){return;}
skipStripe=skipStripe||!this.grid.stripeRows;startRow=startRow||0;var cls=' x-grid3-row-alt ';var rows=this.getRows();var lrows=this.getLockedRows();for(var i=startRow,len=rows.length;i<len;i++){var row=rows[i];var lrow=lrows[i];row.rowIndex=i;lrow.rowIndex=i;if(!skipStripe){var isAlt=((i+1)%2===0);var hasAlt=(' '+row.className+' ').indexOf(cls)!=-1;if(isAlt==hasAlt){continue;}
if(isAlt){row.className+=" x-grid3-row-alt";lrow.className+=" x-grid3-row-alt";}else{row.className=row.className.replace("x-grid3-row-alt","");lrow.className=lrow.className.replace("x-grid3-row-alt","");}}}},updateSortIcon:function(col,dir){var sc=this.sortClasses;var clen=this.cm.getColumnCount();var lclen=this.cm.getLockedCount();var hds=this.mainHd.select('td').removeClass(sc);var lhds=this.lockedHd.select('td').removeClass(sc);if(lclen>0&&col<lclen){lhds.item(col).addClass(sc[dir=="DESC"?1:0]);}else{hds.item(col-lclen).addClass(sc[dir=="DESC"?1:0]);}},updateColumnHidden:function(col,hidden){var tw=this.cm.getTotalWidth();var lw=this.cm.getTotalLockedWidth();var lclen=this.cm.getLockedCount();this.innerHd.firstChild.firstChild.style.width=tw+'px';var display=hidden?'none':'';var hd=this.getHeaderCell(col);hd.style.display=display;var ns,gw;if(col<lclen){ns=this.getLockedRows();gw=lw;this.lockedHd.dom.firstChild.firstChild.style.width=gw+'px';this.mainWrap.dom.style.left=this.cm.getTotalLockedWidth()+'px';}else{ns=this.getRows();gw=tw-lw;col-=lclen;this.innerHd.firstChild.firstChild.style.width=gw+'px';}
for(var i=0,len=ns.length;i<len;i++){ns[i].style.width=gw+'px';ns[i].firstChild.style.width=gw+'px';ns[i].firstChild.rows[0].childNodes[col].style.display=display;}
this.onColumnHiddenUpdated(col,hidden,tw);delete this.lastViewWidth;this.layout();},syncHeaderHeight:function(){if(this.lockedInnerHd===undefined||this.innerHd===undefined){return;}
this.lockedInnerHd.firstChild.firstChild.style.height="auto";this.innerHd.firstChild.firstChild.style.height="auto";var height=(this.lockedInnerHd.firstChild.firstChild.offsetHeight>this.innerHd.firstChild.firstChild.offsetHeight)?this.lockedInnerHd.firstChild.firstChild.offsetHeight:this.innerHd.firstChild.firstChild.offsetHeight;this.lockedInnerHd.firstChild.firstChild.style.height=height+'px';this.innerHd.firstChild.firstChild.style.height=height+'px';},doRender:function(cs,rs,ds,startRow,colCount,stripe){var ts=this.templates,ct=ts.cell,rt=ts.row,last=colCount-1;var tw=this.cm.getTotalWidth();var lw=this.cm.getTotalLockedWidth();var clen=this.cm.getColumnCount();var lclen=this.cm.getLockedCount();var tstyle='width:'+this.getTotalWidth()+';';var buf=[],lbuf=[],cb,lcb,c,p={},rp={tstyle:tstyle},r;for(var j=0,len=rs.length;j<len;j++){r=rs[j];cb=[];lcb=[];var rowIndex=(j+startRow);for(var i=0;i<colCount;i++){c=cs[i];p.id=c.id;p.css=i===0?'x-grid3-cell-first ':(i==last?'x-grid3-cell-last ':'');p.attr=p.cellAttr="";p.value=c.renderer(r.data[c.name],p,r,rowIndex,i,ds);p.style=c.style;if(p.value===undefined||p.value===""){p.value="&#160;";}
if(r.dirty&&typeof r.modified[c.name]!=='undefined'){p.css+=' x-grid3-dirty-cell';}
if(c.locked){lcb[lcb.length]=ct.apply(p);}else{cb[cb.length]=ct.apply(p);}}
var alt=[];if(stripe&&((rowIndex+1)%2===0)){alt[0]="x-grid3-row-alt";}
if(r.dirty){alt[1]=" x-grid3-dirty-row";}
rp.cols=colCount;if(this.getRowClass){alt[2]=this.getRowClass(r,rowIndex,rp,ds);}
rp.alt=alt.join(" ");rp.cells=lcb.join("");rp.tstyle='width:'+lw+'px;';lbuf[lbuf.length]=rt.apply(rp);rp.cells=cb.join("");rp.tstyle='width:'+(tw-lw)+'px;';buf[buf.length]=rt.apply(rp);}
return[buf.join(""),lbuf.join("")];},layout:function(){if(!this.mainBody){return;}
var g=this.grid;var c=g.getGridEl(),cm=this.cm,expandCol=g.autoExpandColumn,gv=this;var lw=cm.getTotalLockedWidth();var csize=c.getSize(true);var vw=csize.width;if(vw<20||csize.height<20){return;}
this.syncHeaderHeight();if(g.autoHeight){this.scroller.dom.style.overflow='visible';this.lockedScroller.dom.style.overflow='visible';}else{this.el.setSize(csize.width,csize.height);var vh=csize.height-this.mainHd.getHeight();this.lockedScroller.setSize(lw,vh);this.scroller.setSize(vw-lw,vh);if(this.innerHd){this.innerHd.style.width=(vw)+'px';}}
if(this.forceFit){if(this.lastViewWidth!=vw){this.fitColumns(false,false);this.lastViewWidth=vw;}}else{this.autoExpand();lw=cm.getTotalLockedWidth();}
this.mainWrap.dom.style.left=lw+'px';this.onLayout(vw,vh);},renderHeaders:function(){var cm=this.cm,ts=this.templates;var ct=ts.hcell;var tw=this.cm.getTotalWidth();var lw=this.cm.getTotalLockedWidth();var cb=[],lb=[],sb=[],lsb=[],p={};for(var i=0,len=cm.getColumnCount();i<len;i++){p.id=cm.getColumnId(i);p.value=cm.getColumnHeader(i)||"";p.style=this.getColumnStyle(i,true);p.tooltip=this.getColumnTooltip(i);if(cm.config[i].align=='right'){p.istyle='padding-right:16px';}
if(cm.isLocked(i)){lb[lb.length]=ct.apply(p);}else{cb[cb.length]=ct.apply(p);}}
return[ts.header.apply({cells:cb.join(""),tstyle:'width:'+(tw-lw)+';'}),ts.header.apply({cells:lb.join(""),tstyle:'width:'+(lw)+';'})];},getColumnTooltip:function(i){var tt=this.cm.getColumnTooltip(i);if(tt){if(Ext.QuickTips.isEnabled()){return'ext:qtip="'+tt+'"';}else{return'title="'+tt+'"';}}
return"";},updateHeaders:function(){var hd=this.renderHeaders();this.innerHd.firstChild.innerHTML=hd[0];this.lockedInnerHd.firstChild.innerHTML=hd[1];},insertRows:function(dm,firstRow,lastRow,isUpdate){if(firstRow===0&&lastRow==dm.getCount()-1){this.refresh();}else{if(!isUpdate){this.fireEvent("beforerowsinserted",this,firstRow,lastRow);}
var html=this.renderRows(firstRow,lastRow);var before=this.getRow(firstRow);if(before){Ext.DomHelper.insertHtml('beforeBegin',before,html[0]);}else{Ext.DomHelper.insertHtml('beforeEnd',this.mainBody.dom,html[0]);}
var beforeLocked=this.getLockedRow(firstRow);if(beforeLocked){Ext.DomHelper.insertHtml('beforeBegin',beforeLocked,html[1]);}else{Ext.DomHelper.insertHtml('beforeEnd',this.lockedBody.dom,html[1]);}
if(!isUpdate){this.fireEvent("rowsinserted",this,firstRow,lastRow);this.processRows(firstRow);}}},removeRow:function(row){Ext.removeNode(this.getRow(row));if(this.cm.getLockedCount()>0){Ext.removeNode(this.getLockedRow(row));}},getColumnData:function(){var cs=[],cm=this.cm,colCount=cm.getColumnCount();for(var i=0;i<colCount;i++){var name=cm.getDataIndex(i);cs[i]={name:(typeof name=='undefined'?this.ds.fields.get(i).name:name),renderer:cm.getRenderer(i),id:cm.getColumnId(i),style:this.getColumnStyle(i),locked:cm.isLocked(i)};}
return cs;},renderBody:function(){var markup=this.renderRows();return[this.templates.body.apply({rows:markup[0]}),this.templates.body.apply({rows:markup[1]})];},refresh:function(headersToo){this.fireEvent("beforerefresh",this);this.grid.stopEditing();var result=this.renderBody();this.mainBody.update(result[0]);this.lockedBody.update(result[1]);if(headersToo===true){this.updateHeaders();this.updateHeaderSortState();}
this.processRows(0,true);this.layout();this.applyEmptyText();this.fireEvent("refresh",this);},handleLockChange:function(){this.refresh(true);},onDenyColumnHide:function(){},onColumnLock:function(){this.handleLockChange.apply(this,arguments);},addRowClass:function(row,cls){var r=this.getRow(row);if(r){this.fly(r).addClass(cls);r=this.getLockedRow(row);this.fly(r).addClass(cls);}},removeRowClass:function(row,cls){var r=this.getRow(row);if(r){this.fly(r).removeClass(cls);r=this.getLockedRow(row);this.fly(r).removeClass(cls);}},handleHdMenuClick:function(item){var index=this.hdCtxIndex;var cm=this.cm,ds=this.ds,lc;switch(item.id){case"asc":ds.sort(cm.getDataIndex(index),"ASC");break;case"desc":ds.sort(cm.getDataIndex(index),"DESC");break;case"lock":lc=cm.getLockedCount();if(cm.getColumnCount(true)<=lc+1){this.onDenyColumnLock();return;}
if(lc!=index){cm.setLocked(index,true,true);cm.moveColumn(index,lc);this.grid.fireEvent("columnmove",index,lc);}else{cm.setLocked(index,true);}
break;case"unlock":lc=cm.getLockedCount();if((lc-1)!=index){cm.setLocked(index,false,true);cm.moveColumn(index,lc-1);this.grid.fireEvent("columnmove",index,lc-1);}else{cm.setLocked(index,false);}
break;default:index=cm.getIndexById(item.id.substr(4));if(index!=-1){if(item.checked&&cm.getColumnsBy(this.isHideableColumn,this).length<=1){this.onDenyColumnHide();return false;}
cm.setHidden(index,item.checked);}}
return true;},handleHdDown:function(e,t){if(Ext.fly(t).hasClass('x-grid3-hd-btn')){e.stopEvent();var hd=this.findHeaderCell(t);Ext.fly(hd).addClass('x-grid3-hd-menu-open');var index=this.getCellIndex(hd);this.hdCtxIndex=index;var ms=this.hmenu.items,cm=this.cm;ms.get("asc").setDisabled(!cm.isSortable(index));ms.get("desc").setDisabled(!cm.isSortable(index));if(this.grid.enableColLock!==false){ms.get("lock").setDisabled(cm.isLocked(index));ms.get("unlock").setDisabled(!cm.isLocked(index));}
this.hmenu.on("hide",function(){Ext.fly(hd).removeClass('x-grid3-hd-menu-open');},this,{single:true});this.hmenu.show(t,"tl-bl?");}},renderUI:function(){var header=this.renderHeaders();var body=this.templates.body.apply({rows:''});var html=this.templates.master.apply({body:body,header:header[0],lockedBody:body,lockedHeader:header[1]});var g=this.grid;g.getGridEl().dom.innerHTML=html;this.initElements();Ext.fly(this.innerHd).on("click",this.handleHdDown,this);Ext.fly(this.lockedInnerHd).on("click",this.handleHdDown,this);this.mainHd.on("mouseover",this.handleHdOver,this);this.mainHd.on("mouseout",this.handleHdOut,this);this.mainHd.on("mousemove",this.handleHdMove,this);this.lockedHd.on("mouseover",this.handleHdOver,this);this.lockedHd.on("mouseout",this.handleHdOut,this);this.lockedHd.on("mousemove",this.handleHdMove,this);this.mainWrap.dom.style.left=this.cm.getTotalLockedWidth()+'px';this.scroller.on('scroll',this.syncScroll,this);if(g.enableColumnResize!==false){this.splitone=new Ext.grid.GridView.SplitDragZone(g,this.lockedHd.dom);this.splitone.setOuterHandleElId(Ext.id(this.lockedHd.dom));this.splitone.setOuterHandleElId(Ext.id(this.mainHd.dom));}
if(g.enableColumnMove){this.columnDrag=new Ext.grid.GridView.ColumnDragZone(g,this.innerHd);this.columnDrop=new Ext.grid.HeaderDropZone(g,this.mainHd.dom);}
if(g.enableHdMenu!==false){if(g.enableColumnHide!==false){this.colMenu=new Ext.menu.Menu({id:g.id+"-hcols-menu"});this.colMenu.on("beforeshow",this.beforeColMenuShow,this);this.colMenu.on("itemclick",this.handleHdMenuClick,this);}
this.hmenu=new Ext.menu.Menu({id:g.id+"-hctx"});this.hmenu.add({id:"asc",text:this.sortAscText,cls:"xg-hmenu-sort-asc"},{id:"desc",text:this.sortDescText,cls:"xg-hmenu-sort-desc"});if(this.grid.enableColLock!==false){this.hmenu.add('-',{id:"lock",text:this.lockText,cls:"xg-hmenu-lock"},{id:"unlock",text:this.unlockText,cls:"xg-hmenu-unlock"});}
if(g.enableColumnHide!==false){this.hmenu.add('-',{id:"columns",text:this.columnsText,menu:this.colMenu,iconCls:'x-cols-icon'});}
this.hmenu.on("itemclick",this.handleHdMenuClick,this);}
if(g.enableDragDrop||g.enableDrag){var dd=new Ext.grid.GridDragZone(g,{ddGroup:g.ddGroup||'GridDD'});}
this.updateHeaderSortState();},afterRender:function(){var bd=this.renderRows();if(bd===''){bd=['',''];}
this.mainBody.dom.innerHTML=bd[0];this.lockedBody.dom.innerHTML=bd[1];this.processRows(0,true);if(this.deferEmptyText!==true){this.applyEmptyText();}},updateAllColumnWidths:function(){var tw=this.cm.getTotalWidth();var lw=this.cm.getTotalLockedWidth();var clen=this.cm.getColumnCount();var lclen=this.cm.getLockedCount();var ws=[];var i;for(i=0;i<clen;i++){ws[i]=this.getColumnWidth(i);}
this.innerHd.firstChild.firstChild.style.width=(tw-lw)+'px';this.mainWrap.dom.style.left=lw+'px';this.lockedInnerHd.firstChild.firstChild.style.width=lw+'px';for(i=0;i<clen;i++){var hd=this.getHeaderCell(i);hd.style.width=ws[i]+'px';}
var ns=this.getRows();var lns=this.getLockedRows();for(var i=0,len=ns.length;i<len;i++){ns[i].style.width=(tw-lw)+'px';ns[i].firstChild.style.width=(tw-lw)+'px';lns[i].style.width=lw+'px';lns[i].firstChild.style.width=lw+'px';var j,row;for(j=0;j<lclen;j++){row=lns[i].firstChild.rows[0];row.childNodes[j].style.width=ws[j]+'px';}
for(j=lclen;j<clen;j++){row=ns[i].firstChild.rows[0];row.childNodes[j].style.width=ws[j]+'px';}}
this.onAllColumnWidthsUpdated(ws,tw);},updateColumnWidth:function(col,width){var w=this.getColumnWidth(col);var tw=this.cm.getTotalWidth();var lclen=this.cm.getLockedCount();var lw=this.cm.getTotalLockedWidth();var hd=this.getHeaderCell(col);hd.style.width=w;var ns,gw;var ncol=col;if(col<lclen){ns=this.getLockedRows();gw=lw;this.lockedInnerHd.firstChild.firstChild.style.width=gw+'px';this.mainWrap.dom.style.left=this.cm.getTotalLockedWidth()+'px';this.mainWrap.dom.style.display='none';this.mainWrap.dom.style.display='';}else{ns=this.getRows();gw=tw-lw;ncol-=lclen;this.innerHd.firstChild.firstChild.style.width=gw+'px';}
for(var i=0,len=ns.length;i<len;i++){ns[i].style.width=gw+'px';ns[i].firstChild.style.width=gw+'px';ns[i].firstChild.rows[0].childNodes[ncol].style.width=w;}
this.onColumnWidthUpdated(col,w,tw);this.layout();},getEditorParent:function(ed){return this.el.dom;},refreshRow:function(record){Ext.grid.LockingGridView.superclass.refreshRow.call(this,record);var index=this.ds.indexOf(record);this.getLockedRow(index).rowIndex=index;}});

Ext.grid.LockingColumnModel = Ext.extend(Ext.grid.ColumnModel,{
    getTotalLockedWidth : function(){
        var totalWidth = 0;
        for(var i = 0; i < this.config.length; i++){
            if(this.isLocked(i) && !this.isHidden(i)){
                totalWidth += this.getColumnWidth(i);
            }
        }
        return totalWidth;
    },
    isLocked : function(colIndex){
        return this.config[colIndex].locked === true||this.config[colIndex].chkLocked === true;
    }
});
Ext.apply(Ext.grid.LockingGridView.prototype,{lockText:"锁定",unlockText:"解锁"});


Ext.ux.plugins.GroupHeaderGrid=function(config){this.config=config;};Ext.extend(Ext.ux.plugins.GroupHeaderGrid,Ext.util.Observable,{init:function(grid){Ext.applyIf(grid.colModel,this.config);Ext.apply(grid.getView(),this.viewConfig);},viewConfig:{initTemplates:function(){this.constructor.prototype.initTemplates.apply(this,arguments);var ts=this.templates||{};if(!ts.gcell){ts.gcell=new Ext.XTemplate('<td class="x-grid3-hd {cls} x-grid3-td-{id} ux-grid-hd-group-row-{row}" style="{style}">','<div {tooltip} class="x-grid3-hd-inner x-grid3-hd-{id}" unselectable="on" style="{istyle}">','<tpl if="values.btn"><a class="x-grid3-hd-btn" href="#"></a></tpl>','{value}</div>','</td>');}
this.templates=ts;this.hrowRe=new RegExp("ux-grid-hd-group-row-(\\d+)","");},renderHeaders:function(){var ts=this.templates,headers=[],cm=this.cm,rows=cm.rows,tstyle='width:'+this.getTotalWidth()+';';for(var row=0,rlen=rows.length;row<rlen;row++){var r=rows[row],cells=[];for(var i=0,gcol=0,len=r.length;i<len;i++){var group=r[i];group.colspan=group.colspan||1;var id=this.getColumnId(group.dataIndex?cm.findColumnIndex(group.dataIndex):gcol);var gs=Ext.ux.plugins.GroupHeaderGrid.prototype.getGroupStyle.call(this,group,gcol);cells[i]=ts.gcell.apply({cls:group.header?'ux-grid-hd-group-cell':'ux-grid-hd-nogroup-cell',id:id,row:row,style:'width:'+gs.width+';'+(gs.hidden?'display:none;':'')+(group.align?'text-align:'+group.align+';':''),tooltip:group.tooltip?(Ext.QuickTips.isEnabled()?'ext:qtip':'title')+'="'+group.tooltip+'"':'',istyle:group.align=='right'?'padding-right:16px':'',btn:this.grid.enableHdMenu&&group.header,value:group.header||'&nbsp;'});gcol+=group.colspan;}
headers[row]=ts.header.apply({tstyle:tstyle,cells:cells.join('')});}
headers.push(this.constructor.prototype.renderHeaders.apply(this,arguments));return headers.join('');},onColumnWidthUpdated:function(){this.constructor.prototype.onColumnWidthUpdated.apply(this,arguments);Ext.ux.plugins.GroupHeaderGrid.prototype.updateGroupStyles.call(this);},onAllColumnWidthsUpdated:function(){this.constructor.prototype.onAllColumnWidthsUpdated.apply(this,arguments);Ext.ux.plugins.GroupHeaderGrid.prototype.updateGroupStyles.call(this);},onColumnHiddenUpdated:function(){this.constructor.prototype.onColumnHiddenUpdated.apply(this,arguments);Ext.ux.plugins.GroupHeaderGrid.prototype.updateGroupStyles.call(this);},getHeaderCell:function(index){return this.mainHd.query(this.cellSelector)[index];},findHeaderCell:function(el){return el?this.fly(el).findParent('td.x-grid3-hd',this.cellSelectorDepth):false;},findHeaderIndex:function(el){var cell=this.findHeaderCell(el);return cell?this.getCellIndex(cell):false;},updateSortIcon:function(col,dir){var sc=this.sortClasses;var hds=this.mainHd.select(this.cellSelector).removeClass(sc);hds.item(col).addClass(sc[dir=="DESC"?1:0]);},beforeColMenuShow:function(){var cm=this.cm,rows=this.cm.rows;this.colMenu.removeAll();for(var col=0,clen=cm.getColumnCount();col<clen;col++){var menu=this.colMenu,text=cm.getColumnHeader(col);if(cm.config[col].fixed!==true&&cm.config[col].hideable!==false){for(var row=0,rlen=rows.length;row<rlen;row++){var r=rows[row],group,gcol=0;for(var i=0,len=r.length;i<len;i++){group=r[i];if(col>=gcol&&col<gcol+group.colspan){break;}
gcol+=group.colspan;}
if(group&&group.header){if(cm.hierarchicalColMenu){var gid='group-'+row+'-'+gcol;var item=menu.items.item(gid);var submenu=item?item.menu:null;if(!submenu){submenu=new Ext.menu.Menu({id:gid});submenu.on("itemclick",this.handleHdMenuClick,this);menu.add({id:gid,text:group.header,menu:submenu});}
menu=submenu;}else{text=group.header+' '+text;}}}
menu.add(new Ext.menu.CheckItem({id:"col-"+cm.getColumnId(col),text:text,checked:!cm.isHidden(col),hideOnClick:false,disabled:cm.config[col].hideable===false}));}}},renderUI:function(){this.constructor.prototype.renderUI.apply(this,arguments);Ext.apply(this.columnDrop,Ext.ux.plugins.GroupHeaderGrid.prototype.columnDropConfig);}},columnDropConfig:{getTargetFromEvent:function(e){var t=Ext.lib.Event.getTarget(e);return this.view.findHeaderCell(t);},positionIndicator:function(h,n,e){var data=Ext.ux.plugins.GroupHeaderGrid.prototype.getDragDropData.call(this,h,n,e);if(data===false){return false;}
var px=data.px+this.proxyOffsets[0];this.proxyTop.setLeftTop(px,data.r.top+this.proxyOffsets[1]);this.proxyTop.show();this.proxyBottom.setLeftTop(px,data.r.bottom);this.proxyBottom.show();return data.pt;},onNodeDrop:function(n,dd,e,data){var h=data.header;if(h!=n){var d=Ext.ux.plugins.GroupHeaderGrid.prototype.getDragDropData.call(this,h,n,e);if(d===false){return false;}
var cm=this.grid.colModel,right=d.oldIndex<d.newIndex,rows=cm.rows;for(var row=d.row,rlen=rows.length;row<rlen;row++){var r=rows[row],len=r.length,fromIx=0,span=1,toIx=len;for(var i=0,gcol=0;i<len;i++){var group=r[i];if(d.oldIndex>=gcol&&d.oldIndex<gcol+group.colspan){fromIx=i;}
if(d.oldIndex+d.colspan-1>=gcol&&d.oldIndex+d.colspan-1<gcol+group.colspan){span=i-fromIx+1;}
if(d.newIndex>=gcol&&d.newIndex<gcol+group.colspan){toIx=i;}
gcol+=group.colspan;}
var groups=r.splice(fromIx,span);rows[row]=r.splice(0,toIx-(right?span:0)).concat(groups).concat(r);}
for(var c=0;c<d.colspan;c++){var oldIx=d.oldIndex+(right?0:c),newIx=d.newIndex+(right?-1:c);cm.moveColumn(oldIx,newIx);this.grid.fireEvent("columnmove",oldIx,newIx);}
return true;}
return false;}},getGroupStyle:function(group,gcol){var width=0,hidden=true;for(var i=gcol,len=gcol+group.colspan;i<len;i++){if(!this.cm.isHidden(i)){var cw=this.cm.getColumnWidth(i);if(typeof cw=='number'){width+=cw;}
hidden=false;}}
return{width:(Ext.isBorderBox?width:Math.max(width-this.borderWidth,0))+'px',hidden:hidden};},updateGroupStyles:function(col){var tables=this.mainHd.query('.x-grid3-header-offset > table'),tw=this.getTotalWidth(),rows=this.cm.rows;for(var row=0;row<tables.length;row++){tables[row].style.width=tw;if(row<rows.length){var cells=tables[row].firstChild.firstChild.childNodes;for(var i=0,gcol=0;i<cells.length;i++){var group=rows[row][i];if((typeof col!='number')||(col>=gcol&&col<gcol+group.colspan)){var gs=Ext.ux.plugins.GroupHeaderGrid.prototype.getGroupStyle.call(this,group,gcol);cells[i].style.width=gs.width;cells[i].style.display=gs.hidden?'none':'';}
gcol+=group.colspan;}}}},getGroupRowIndex:function(el){if(el){var m=el.className.match(this.hrowRe);if(m&&m[1]){return parseInt(m[1],10);}}
return this.cm.rows.length;},getGroupSpan:function(row,col){if(row<0){return{col:0,colspan:this.cm.getColumnCount()};}
var r=this.cm.rows[row];if(r){for(var i=0,gcol=0,len=r.length;i<len;i++){var group=r[i];if(col>=gcol&&col<gcol+group.colspan){return{col:gcol,colspan:group.colspan};}
gcol+=group.colspan;}
return{col:gcol,colspan:0};}
return{col:col,colspan:1};},getDragDropData:function(h,n,e){if(h.parentNode!=n.parentNode){return false;}
var cm=this.grid.colModel;var x=Ext.lib.Event.getPageX(e);var r=Ext.lib.Dom.getRegion(n.firstChild);var px,pt;if((r.right-x)<=(r.right-r.left)/2){px=r.right+this.view.borderWidth;pt="after";}else{px=r.left;pt="before";}
var oldIndex=this.view.getCellIndex(h);var newIndex=this.view.getCellIndex(n);if(cm.isFixed(newIndex)){return false;}
var row=Ext.ux.plugins.GroupHeaderGrid.prototype.getGroupRowIndex.call(this.view,h);var oldGroup=Ext.ux.plugins.GroupHeaderGrid.prototype.getGroupSpan.call(this.view,row,oldIndex);var newGroup=Ext.ux.plugins.GroupHeaderGrid.prototype.getGroupSpan.call(this.view,row,newIndex);oldIndex=oldGroup.col;newIndex=newGroup.col+(pt=="after"?newGroup.colspan:0);if(newIndex>=oldGroup.col&&newIndex<=oldGroup.col+oldGroup.colspan){return false;}
var parentGroup=Ext.ux.plugins.GroupHeaderGrid.prototype.getGroupSpan.call(this.view,row-1,oldIndex);if(newIndex<parentGroup.col||newIndex>parentGroup.col+parentGroup.colspan){return false;}
return{r:r,px:px,pt:pt,row:row,oldIndex:oldIndex,newIndex:newIndex,colspan:oldGroup.colspan};}});


Ext.ns('Ext.ux.grid');

Ext.ux.grid.GridSummary = function(config) {
        Ext.apply(this, config);
};

Ext.extend(Ext.ux.grid.GridSummary, Ext.util.Observable, {
    init : function(grid) {
        this.grid = grid;
        this.cm = grid.getColumnModel();
        this.view = grid.getView();

        var v = this.view;

        // override GridView's onLayout() method
        v.onLayout = this.onLayout;

        v.afterMethod('render', this.refreshSummary, this);
        v.afterMethod('refresh', this.refreshSummary, this);
        v.afterMethod('syncScroll', this.syncSummaryScroll, this);
        v.afterMethod('onColumnWidthUpdated', this.doWidth, this);
        v.afterMethod('onAllColumnWidthsUpdated', this.doAllWidths, this);
        v.afterMethod('onColumnHiddenUpdated', this.doHidden, this);

        // update summary row on store's add/remove/clear/update events
        grid.store.on({
            add: this.refreshSummary,
            remove: this.refreshSummary,
            clear: this.refreshSummary,
            update: this.refreshSummary,
            scope: this
        });

        if (!this.rowTpl) {
            this.rowTpl = new Ext.Template(
                '<div class="x-grid3-summary-row x-grid3-gridsummary-row-offset">',
                    '<table class="x-grid3-summary-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">',
                        '<tbody><tr>{cells}</tr><tr style="display:{totalDisplay}">{tcells}</tr></tbody>',
                    '</table>',
                '</div>'
            );
            this.rowTpl.disableFormats = true;
        }
        this.rowTpl.compile();

        if (!this.cellTpl) {
            this.cellTpl = new Ext.Template(
                '<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} {css}" style="{style}">',
                    '<div class="x-grid3-cell-inner x-grid3-col-{id}" unselectable="on" {attr}>{value}</div>',
                "</td>"
            );
            this.cellTpl.disableFormats = true;
        }
        this.cellTpl.compile();
    },

    calculate : function(rs, cm,isTotal) {
        var data = {}, cfg = cm.config;
        for (var i = 0, len = cfg.length; i < len; i++) { // loop through all
                                                            // columns in
                                                            // ColumnModel
            var cf = cfg[i], // get column's configuration
                cname = cf.dataIndex; // get column dataIndex

            // initialise grid summary row data for
            // the current column being worked on
            data[cname+(isTotal?"_total":"")] = 0;

            if (cf.summaryType) {
                for (var j = 0, jlen = rs.length; j < jlen; j++) {
                    var r = rs[j]; // get a single Record
                    if(isTotal){
                        data[cname+"_total"] = Ext.ux.grid.GridSummary.Calculations[cf.summaryType](r[cname], r, cname+"_total", data, j);
                    }
                    else {
                        data[cname] = Ext.ux.grid.GridSummary.Calculations[cf.summaryType](r.get(cname), r, cname, data, j);
                    }
                }
            }
        }

        return data;
    },

    onLayout : function(vw, vh) {
        if (Ext.type(vh) != 'number') { // handles grid's height:'auto' config
            return;
        }
        // note: this method is scoped to the GridView
        if (!this.grid.getGridEl().hasClass('x-grid-hide-gridsummary')) {
            // readjust gridview's height only if grid summary row is visible
            this.scroller.setHeight(vh - this.summary.getHeight());
        }
    },

    syncSummaryScroll : function() {
        var mb = this.view.scroller.dom;

        this.view.summaryWrap.dom.scrollLeft = mb.scrollLeft;
        this.view.summaryWrap.dom.scrollLeft = mb.scrollLeft; // second time
                                                                // for IE (1/2
                                                                // time first
                                                                // fails, other
                                                                // browsers
                                                                // ignore)
    },

    doWidth : function(col, w, tw) {
        var s = this.view.summary.dom;

        s.firstChild.style.width = tw;
        s.firstChild.rows[0].childNodes[col].style.width = w;
    },

    doAllWidths : function(ws, tw) {
        var s = this.view.summary.dom, wlen = ws.length;

        s.firstChild.style.width = tw;

        var cells = s.firstChild.rows[0].childNodes;

        for (var j = 0; j < wlen; j++) {
            cells[j].style.width = ws[j];
        }
    },

    doHidden : function(col, hidden, tw) {
        var s = this.view.summary.dom,
            display = hidden ? 'none' : '';

        s.firstChild.style.width = tw;
        s.firstChild.rows[0].childNodes[col].style.display = display;
    },

    renderSummary : function(o, cs, cm) {
        cs = cs || this.view.getColumnData();
        var cfg = cm.config, buf = [],tbuf=[], last = cs.length - 1;
        for (var i = 0, len = cs.length; i < len; i++) {
            var c = cs[i], cf = cfg[i], p = {};

            p.id = c.id;
            p.style = c.style;
            p.css = i == 0 ? 'x-grid3-cell-first ' : (i == last ? 'x-grid3-cell-last ' : '');
            var tp=Ext.apply({},p);
          
            if (cf.summaryType || cf.summaryRenderer) {             
                p.value = (cf.summaryRenderer || c.renderer)(o.data[c.name], p, o);
                tp.value=(cf.summaryTotalRenderer||cf.summaryRenderer || c.renderer)(o.data[c.name+"_total"], p, o);
            } else {
                p.value = '';
                tp.value='';
            }
              
            if (p.value == undefined || p.value === "") p.value = "&#160;";
            if (tp.value == undefined || tp.value === "") tp.value = "&#160;";
            buf[buf.length] = this.cellTpl.apply(p);
            tbuf[tbuf.length]=this.cellTpl.apply(tp);
            
        }

        return this.rowTpl.apply({
            tstyle: 'width:' + this.view.getTotalWidth() + ';',
            cells: buf.join(''),
            tcells:tbuf.join(''),
            totalDisplay:this.grid.store.refreshCache?"display":"none"
        });
    },

    refreshSummary : function() {
        var g = this.grid, ds = g.store,
            cs = this.view.getColumnData(),
            cm = this.cm,
            rs = ds.getRange();
            var data = this.calculate(rs, cm);
            if(ds.refreshCache){
                var total=this.calculate(ds.proxy.getData().getRange(), cm,true);
                Ext.apply(data,total);
            }       
            var buf = this.renderSummary({data: data}, cs, cm);
            
        if (!this.view.summaryWrap) {        
            this.view.summaryWrap = Ext.DomHelper.insertAfter(this.view.scroller, {
                tag: 'div',
                cls: 'x-grid3-gridsummary-row-inner'
            }, true);           
        }
        this.view.summary = this.view.summaryWrap.update(buf).first();
        // alert(this.view.summary.dom.innerHTML);
       /*
         * Ext.DomHelper.insertAfter(this.view.summary.parent(),'<div
         * class="x-grid3-summary-row x-grid3-gridsummary-row-offset"><table
         * class="x-grid3-summary-table" border="0" cellspacing="0"
         * cellpadding="0" style="width:210px;"><tbody><tr><td class="x-grid3-col x-grid3-cell x-grid3-td-0 x-grid3-cell-first " style="width:98px;display:none;"><div
         * class="x-grid3-cell-inner x-grid3-col-0" unselectable="on" >&#160;</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-1 " style="width:18px;"><div
         * class="x-grid3-cell-inner x-grid3-col-1" unselectable="on" >&#160;</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-2 " style="width:18px;"><div
         * class="x-grid3-cell-inner x-grid3-col-2" unselectable="on" >&#160;</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-3 " style="width:18px;text-align:right;"><div
         * class="x-grid3-cell-inner x-grid3-col-3" unselectable="on" >0</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-4 " style="width:18px;text-align:right;"><div
         * class="x-grid3-cell-inner x-grid3-col-4" unselectable="on" >0</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-5 " style="width:18px;text-align:right;"><div
         * class="x-grid3-cell-inner x-grid3-col-5" unselectable="on" >0</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-6 " style="width:18px;text-align:right;"><div
         * class="x-grid3-cell-inner x-grid3-col-6" unselectable="on" >0</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-7 " style="width:18px;text-align:right;"><div
         * class="x-grid3-cell-inner x-grid3-col-7" unselectable="on" >0</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-8 " style="width:18px;text-align:right;"><div
         * class="x-grid3-cell-inner x-grid3-col-8" unselectable="on" >0</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-9 " style="width:13px;text-align:right;"><div
         * class="x-grid3-cell-inner x-grid3-col-9" unselectable="on" >&#160;</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-10 " style="width:13px;text-align:right;"><div
         * class="x-grid3-cell-inner x-grid3-col-10" unselectable="on" >&#160;</div></td><td class="x-grid3-col x-grid3-cell x-grid3-td-11 x-grid3-cell-last " style="width:18px;"><div
         * class="x-grid3-cell-inner x-grid3-col-11" unselectable="on" >&#160;</div></td></tr></tbody></table></div>');
         * alert(111);
         */
    },

    toggleSummary : function(visible) { // true to display summary row
        var el = this.grid.getGridEl();

        if (el) {
            if (visible === undefined) {
                visible = el.hasClass('x-grid-hide-gridsummary');
            }
            el[visible ? 'removeClass' : 'addClass']('x-grid-hide-gridsummary');

            this.view.layout(); // readjust gridview height
        }
    },

    getSummaryNode : function() {
        return this.view.summary
    }
});
Ext.reg('gridsummary', Ext.ux.grid.GridSummary);

/*
 * all Calculation methods are called on each Record in the Store with the
 * following 5 parameters:
 * 
 * v - cell value record - reference to the current Record colName - column name
 * (i.e. the ColumnModel's dataIndex) data - the cumulative data for the current
 * column + summaryType up to the current Record rowIdx - current row index
 */
Ext.ux.grid.GridSummary.Calculations = {
    sum : function(v, record, colName, data, rowIdx) {
        return data[colName] + Ext.num(v, 0);
    },

    count : function(v, record, colName, data, rowIdx) {
        return rowIdx + 1;
    },

    max : function(v, record, colName, data, rowIdx) {
        return Math.max(Ext.num(v, 0), data[colName]);
    },

    min : function(v, record, colName, data, rowIdx) {
        return Math.min(Ext.num(v, 0), data[colName]);
    },

    average : function(v, record, colName, data, rowIdx) {
        var t = data[colName] + Ext.num(v, 0), count = record.store.getCount();
        try{
        var result= rowIdx == count - 1 ? (t / count) : t;
         return result;
        }
        catch(e){
            alert(e);
        }
       
        
    },
    last:function(v, record, colName, data, rowIdx) {
        return v;
    }
}


/*
 * Ext JS Library 2.2 Copyright(c) 2006-2008, Ext JS, LLC. licensing@extjs.com
 * 
 * http://extjs.com/license
 */

Ext.grid.GroupSummary = function(config){
    Ext.apply(this, config);
};

Ext.extend(Ext.grid.GroupSummary, Ext.util.Observable, {
    init : function(grid){
        this.grid = grid;
        this.cm = grid.getColumnModel();
        this.view = grid.getView();

        var v = this.view;
        v.doGroupEnd = this.doGroupEnd.createDelegate(this);

        v.afterMethod('onColumnWidthUpdated', this.doWidth, this);
        v.afterMethod('onAllColumnWidthsUpdated', this.doAllWidths, this);
        v.afterMethod('onColumnHiddenUpdated', this.doHidden, this);
        v.afterMethod('onUpdate', this.doUpdate, this);
        v.afterMethod('onRemove', this.doRemove, this);

        if(!this.rowTpl){
            this.rowTpl = new Ext.Template(
                '<div class="x-grid3-summary-row" style="{tstyle}">',
                '<table class="x-grid3-summary-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">',
                    '<tbody><tr>{cells}</tr></tbody>',
                '</table></div>'
            );
            this.rowTpl.disableFormats = true;
        }
        this.rowTpl.compile();

        if(!this.cellTpl){
            this.cellTpl = new Ext.Template(
                '<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} {css}" style="{style}">',
                '<div class="x-grid3-cell-inner x-grid3-col-{id}" unselectable="on">{value}</div>',
                "</td>"
            );
            this.cellTpl.disableFormats = true;
        }
        this.cellTpl.compile();
    },

    toggleSummaries : function(visible){
        var el = this.grid.getGridEl();
        if(el){
            if(visible === undefined){
                visible = el.hasClass('x-grid-hide-summary');
            }
            el[visible ? 'removeClass' : 'addClass']('x-grid-hide-summary');
        }
    },

    renderSummary : function(o, cs){
        cs = cs || this.view.getColumnData();
        var cfg = this.cm.config;

        var buf = [], c, p = {}, cf, last = cs.length-1;
        for(var i = 0, len = cs.length; i < len; i++){
            c = cs[i];
            cf = cfg[i];
            p.id = c.id;
            p.style = c.style;
            p.css = i == 0 ? 'x-grid3-cell-first ' : (i == last ? 'x-grid3-cell-last ' : '');
            if(cf.summaryType || cf.summaryRenderer){
                p.value = (cf.summaryRenderer || c.renderer)(o.data[c.name], p, o);
            }else{
                p.value = '';
            }
            if(p.value == undefined || p.value === "") p.value = "&#160;";
            buf[buf.length] = this.cellTpl.apply(p);
        }

        return this.rowTpl.apply({
            tstyle: 'width:'+this.view.getTotalWidth()+';',
            cells: buf.join('')
        });
    },

    calculate : function(rs, cs){
        var data = {}, r, c, cfg = this.cm.config, cf;
        for(var j = 0, jlen = rs.length; j < jlen; j++){
            r = rs[j];
            for(var i = 0, len = cs.length; i < len; i++){
                c = cs[i];
                cf = cfg[i];
                if(cf.summaryType){
                    data[c.name] = Ext.grid.GroupSummary.Calculations[cf.summaryType](data[c.name] || 0, r, c.name, data);
                }
            }
        }
        return data;
    },

    doGroupEnd : function(buf, g, cs, ds, colCount){
        var data = this.calculate(g.rs, cs);
        buf.push('</div>', this.renderSummary({data: data}, cs), '</div>');
    },

    doWidth : function(col, w, tw){
        var gs = this.view.getGroups(), s;
        for(var i = 0, len = gs.length; i < len; i++){
            s = gs[i].childNodes[2];
            s.style.width = tw;
            s.firstChild.style.width = tw;
            s.firstChild.rows[0].childNodes[col].style.width = w;
        }
    },

    doAllWidths : function(ws, tw){
        var gs = this.view.getGroups(), s, cells, wlen = ws.length;
        for(var i = 0, len = gs.length; i < len; i++){
            s = gs[i].childNodes[2];
            s.style.width = tw;
            s.firstChild.style.width = tw;
            cells = s.firstChild.rows[0].childNodes;
            for(var j = 0; j < wlen; j++){
                cells[j].style.width = ws[j];
            }
        }
    },

    doHidden : function(col, hidden, tw){
        var gs = this.view.getGroups(), s, display = hidden ? 'none' : '';
        for(var i = 0, len = gs.length; i < len; i++){
            s = gs[i].childNodes[2];
            s.style.width = tw;
            s.firstChild.style.width = tw;
            s.firstChild.rows[0].childNodes[col].style.display = display;
        }
    },

    // Note: requires that all (or the first) record in the
    // group share the same group value. Returns false if the group
    // could not be found.
    refreshSummary : function(groupValue){
        return this.refreshSummaryById(this.view.getGroupId(groupValue));
    },

    getSummaryNode : function(gid){
        var g = Ext.fly(gid, '_gsummary');
        if(g){
            return g.down('.x-grid3-summary-row', true);
        }
        return null;
    },

    refreshSummaryById : function(gid){
        var g = document.getElementById(gid);
        if(!g){
            return false;
        }
        var rs = [];
        this.grid.store.each(function(r){
            if(r._groupId == gid){
                rs[rs.length] = r;
            }
        });
        var cs = this.view.getColumnData();
        var data = this.calculate(rs, cs);
        var markup = this.renderSummary({data: data}, cs);

        var existing = this.getSummaryNode(gid);
        if(existing){
            g.removeChild(existing);
        }
        Ext.DomHelper.append(g, markup);
        return true;
    },

    doUpdate : function(ds, record){
        this.refreshSummaryById(record._groupId);
    },

    doRemove : function(ds, record, index, isUpdate){
        if(!isUpdate){
            this.refreshSummaryById(record._groupId);
        }
    },

    showSummaryMsg : function(groupValue, msg){
        var gid = this.view.getGroupId(groupValue);
        var node = this.getSummaryNode(gid);
        if(node){
            node.innerHTML = '<div class="x-grid3-summary-msg">' + msg + '</div>';
        }
    }
});

Ext.grid.GroupSummary.Calculations = {
    'sum' : function(v, record, field){
        return v + (record.data[field]||0);
    },

    'count' : function(v, record, field, data){
        return data[field+'count'] ? ++data[field+'count'] : (data[field+'count'] = 1);
    },

    'max' : function(v, record, field, data){
        var v = record.data[field];
        var max = data[field+'max'] === undefined ? (data[field+'max'] = v) : data[field+'max'];
        return v > max ? (data[field+'max'] = v) : max;
    },

    'min' : function(v, record, field, data){
        var v = record.data[field];
        var min = data[field+'min'] === undefined ? (data[field+'min'] = v) : data[field+'min'];
        return v < min ? (data[field+'min'] = v) : min;
    },

    'average' : function(v, record, field, data){
        var c = data[field+'count'] ? ++data[field+'count'] : (data[field+'count'] = 1);
        var t = (data[field+'total'] = ((data[field+'total']||0) + (record.data[field]||0)));
        return t === 0 ? 0 : t / c;
    },
    'last':function(v, record, field, data) {
        return v;
    }
}

Ext.grid.HybridSummary = Ext.extend(Ext.grid.GroupSummary, {
    calculate : function(rs, cs){
        var gcol = this.view.getGroupField();
        var gvalue = rs[0].data[gcol];
        var gdata = this.getSummaryData(gvalue);
        return gdata || Ext.grid.HybridSummary.superclass.calculate.call(this, rs, cs);
    },

    updateSummaryData : function(groupValue, data, skipRefresh){
        var json = this.grid.store.reader.jsonData;
        if(!json.summaryData){
            json.summaryData = {};
        }
        json.summaryData[groupValue] = data;
        if(!skipRefresh){
            this.refreshSummary(groupValue);
        }
    },

    getSummaryData : function(groupValue){
        var json = this.grid.store.reader.jsonData;
        if(json && json.summaryData){
            return json.summaryData[groupValue];
        }
        return null;
    }
});


<div id="prop-SearchResultStatisticsWin-apply"></div>/**
 * 修正在加载分页数据时,由于result为null引起的分页工具栏不正常工作等Bug
 */
Ext.apply(Ext.data.JsonReader.prototype,{
    readRecords : function(o){      
        <div id="prop-SearchResultStatisticsWin-jsonData"></div>/**
         * After any data loads, the raw JSON data is available for further
         * custom processing. If no data is loaded or there is a load exception
         * this property will be undefined.
         * 
         * @type Object
         */
        this.jsonData = o;
        if(o.metaData){
            delete this.ef;
            this.meta = o.metaData;
            this.recordType = Ext.data.Record.create(o.metaData.fields);
            this.onMetaChange(this.meta, this.recordType, o);
        }
        var s = this.meta, Record = this.recordType,
            f = Record.prototype.fields, fi = f.items, fl = f.length;

// Generate extraction functions for the totalProperty, the root, the id, and
// for each field
        if (!this.ef) {
            if(s.totalProperty) {
                this.getTotal = this.getJsonAccessor(s.totalProperty);
            }
            if(s.successProperty) {
                this.getSuccess = this.getJsonAccessor(s.successProperty);
            }
            this.getRoot = s.root ? this.getJsonAccessor(s.root) : function(p){return p;};
            if (s.id) {
                var g = this.getJsonAccessor(s.id);
                this.getId = function(rec) {
                    var r = g(rec);
                    return (r === undefined || r === "") ? null : r;
                };
            } else {
                this.getId = function(){return null;};
            }
            this.ef = [];
            for(var i = 0; i < fl; i++){
                f = fi[i];
                var map = (f.mapping !== undefined && f.mapping !== null) ? f.mapping : f.name;
                this.ef[i] = this.getJsonAccessor(map);
            }
        }
        var root = this.getRoot(o), c =root&&root.length?root.length:0, totalRecords = c, success = true;
        if(s.totalProperty){
            var v = parseInt(this.getTotal(o), 10);
            if(!isNaN(v)){
                totalRecords = v;
            }
        }
        if(s.successProperty){
            var v = this.getSuccess(o);
            if(v === false || v === 'false'){
                success = false;
            }
        }
        var records = [];
        for(var i = 0; i < c; i++){
            var n = root[i];
            var values = {};
            var id = this.getId(n);
            for(var j = 0; j < fl; j++){
                f = fi[j];
                var v = this.ef[j](n);
                values[f.name] = f.convert((v !== undefined) ? v : f.defaultValue, n);
            }
            var record = new Record(values, id);
            record.json = n;
            records[i] = record;
        }
        return {
            success : success,
            records : records,
            totalRecords : totalRecords
        };
    }
});
Ext.override(Ext.form.ComboBox,{
    processValue:function(value) {
        if(this.comboBlank===false){
            return this.getValue();
        }else{
            return Ext.form.ComboBox.superclass.processValue.call(this,value);
        }           
    } 
});
</pre>    
</body>
</html>